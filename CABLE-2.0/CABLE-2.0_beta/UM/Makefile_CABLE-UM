## this Makefile builds the CABLE executable from f90 source code 


##user section

##########################################################################
## this first section needs to be configured by the user depending 
## on the build platform, specifically compiler, location of netcdf 
## headers and libraries 
##########################################################################
   
### includes/libraries (netcdf mainly) ###
               
## vayu.nci.org.au
#NCDIR = /apps/netcdf/3.6.3/lib/Intel
#NCMOD = /apps/netcdf/3.6.3/include/Intel/

## shine-cl
NCDIR = /usr/local/intel/lib/            
NCMOD = /usr/local/intel/include/       

### compilers ###

##ifort compiler options
FC = ifort
#offline uses
#CFLAGS = -O2 -fp-model precise -ftz -fpe0
#CFLAGS = -O0 -traceback -g -fp-model precise -ftz -fpe0 

#taken from UM Makefile
CFLAGS = -O0 -g -i8 -r8 -traceback -fp-model precise -ftz -fpe0  
#CFLAGS = -O0 -g -i8 -r8 -traceback -fp-model precise -ftz -fpe0  
CINC = -I$(NCMOD)
LDFLAGS = -O0 
LD =  -L$(NCDIR) -lnetcdf 

### gfortran compiler options
#FC = gfortran                    
###CFLAGS = -O0 -x f95-cpp-input -v -g3 -ffree-line-length-132 
#CFLAGS = -O0 -x f95-cpp-input 
#CINC = -I$(NCMOD)
#LDFLAGS = -O0  
#LD =  -L$(NCDIR) -lnetcdf -lnetcdff #OS X

##########################################################################
##########################################################################

##END user section

SHELL = /bin/sh

# these are all the files we are compiling
LSRC = cable_data.F90 cable_common.F90 cable_define_types.F90 cable_soilsnow.F90 cable_air.F90 cable_albedo.F90 cable_radiation.F90 cable_roughness.F90 cable_carbon.F90 cable_canopy.F90 cable_cbm.F90 cable_um_tech.F90 cable_um_init.F90 cable_um_init_subrs.F90 cable_explicit_driver.F90 cable_implicit_driver.F90 cable_hyd_driver.F90 cable_rad_driver.F90 

# this is the executable we are building
PROG = cable

OBJS	= ${LSRC:.F90=.o} 

#suffixes we use
.SUFFIXES:.F90 
#default rules for these suffixes
.F90.o:
	$(FC) $(CFLAGS) $(CINC) -c $<

# default target by convention is ``all''
all : 

#build PROG (cable executable) by linking all objects
#$(PROG) : $(OBJS)
#$(PROG) : cable_driver.o 
#	$(FC) $(LDFLAGS) -o $@ $(OBJS) $(LD) 


# dependencies
#these build anyway, courtesy of above use of .SUFFIXES etc AND they have NO dependencies

cable_data.o: cable_data.F90 

cable_define_types.o: cable_define_types.F90

cable_common.o: cable_common.F90 cable_define_types.o  

cable_carbon.o: cable_carbon.F90 cable_define_types.o cable_data.o

cable_air.o: cable_air.F90 cable_define_types.o cable_data.o

cable_albedo.o: cable_albedo.F90 cable_define_types.o 

cable_canopy.o: cable_canopy.F90 cable_define_types.o cable_radiation.o cable_roughness.o cable_air.o cable_data.o

cable_cbm.o: cable_cbm.F90 cable_carbon.o cable_soilsnow.o cable_canopy.o cable_define_types.o cable_roughness.o cable_radiation.o cable_albedo.o

cable_roughness.o: cable_roughness.F90 cable_define_types.o 

cable_soilsnow.o: cable_soilsnow.F90 cable_define_types.o

cable_radiation.o: cable_radiation.F90 cable_define_types.o cable_common.o  

cable_um_tech.o: cable_um_tech.F90

cable_um_init.o: cable_um_init.F90 cable_um_init_subrs.o cable_define_types.o cable_um_init_subrs.o

cable_um_init_subrs.o: cable_um_init_subrs.F90 cable_define_types.o cable_data.o cable_um_tech.o cable_common.o

cable_explicit_driver.o: cable_explicit_driver.F90 cable_common.o cable_um_tech.o cable_define_types.o cable_um_init.o cable_cbm.o cable_define_types.o cable_data.o

cable_implicit_driver.o: cable_implicit_driver.F90 cable_common.o cable_um_tech.o cable_define_types.o cable_um_init.o cable_cbm.o cable_data.o

cable_hyd_driver.o: cable_hyd_driver.F90 cable_common.o cable_um_tech.o cable_define_types.o cable_um_init.o cable_cbm.o cable_data.o

cable_rad_driver.o: cable_rad_driver.F90 cable_common.o cable_um_tech.o cable_define_types.o cable_um_init.o cable_cbm.o cable_data.o

all: cable_rad_driver.o cable_hyd_driver.o cable_implicit_driver.o cable_explicit_driver.o cable_um_init_subrs.o  cable_um_init.o cable_data.o cable_define_types.o cable_common.o cable_carbon.o cable_air.o cable_albedo.o cable_canopy.o cable_cbm.o cable_roughness.o cable_soilsnow.o cable_radiation.o cable_um_tech.o 
clean:
	rm -f *.o *.mod 

