#---------------------------------------------------------------------
# Script: FCM_BLD_COMMAND
#---------------------------------------------------------------------
#
# Purpose: generates build command(s) depending on models 
#          chosen and links separate builds to the top 
#          level bin directory
#
# Created from umui vn8.2
#---------------------------------------------------------------------


# Load default programming environment for Other
# No default environment specified

#---------------------------------------------
# User defined environment variables
#---------------------------------------------
export ANCIL=/short/p66/pfu599/ancil_files/HG3A31_cal365
export DATADIR=/short/$PROJECT/$USER
export SPECTRAL=${UMDIR}/vn${VN}/ctldata/spectral/ga3_0
export ACCESS_ANCIL=/data/projects/access/ancil/access_v2

#---------------------------------------------
# Job specific variables
#---------------------------------------------
export RUNID=uakfd
export USERID=jxs599
export DATAW=$DATADIR/$RUNID

UM_ROUTDIR=/short/p66/mrd599/UM_ROUTDIR/$USERID/$RUNID
UM_RDATADIR=$DATADIR/$RUNID

# Build command common part
BLD_CMD="fcm build -v 3 -j 2 "     

# Loop through all sub-models and build if requested
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
typeset -l blddir

for item in UMSCRIPTS UMATMOS UMRECON NEMO CICE NEMO_CICE UM_NEMO_CICE
do
  eval compval=\$COMP_${item}
  blddir=$item

  if test $compval = "true" ; then
    echo COMP_${item} is true - run build command
    $BLD_CMD $UM_ROUTDIR/$blddir/cfg/bld.cfg

    RC=$?
    if test $RC -eq 0 ; then
      echo ${item} build is OK
    else
      echo ${item} build failed
      exit $RC
    fi
  fi
done

# Link separate builds to the top level bin dir
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

mkdir -p $UM_RDATADIR/bin
RC=$?
if test $RC -ne 0 ; then
  echo mkdir $UM_RDATADIR/bin failed
  exit $RC
fi

for item in UMSCRIPTS UMATMOS UMRECON NEMO CICE NEMO_CICE UM_NEMO_CICE
do
  blddir=$item

  if test "$item" = "UMSCRIPTS" ; then
    if test -d $UM_ROUTDIR/$blddir/bin ; then
      chmod 755 $UM_ROUTDIR/$blddir/bin/* 1>/dev/null 2>&1
      cp -f $UM_ROUTDIR/$blddir/bin/*  $UM_RDATADIR/bin/ 1>/dev/null 2>&1
    fi
  else
    if test "$item" = "UMRECON" ; then
      exepath=$DATAW/bin
      exename=qxreconf

    elif test "$item" = "UMATMOS" ; then
      exepath=$DATAW/bin
      exename=$RUNID.exe

    else
      exepath=$UM_RDATADIR/bin
      if test $item = "CICE" ; then
        exename=CICE.exe
      else
        exename=
      fi
    fi

    eval compval=\$COMP_${item}
    if test $compval = "true" ; then
      mkdir -p $exepath
      if test -x $UM_ROUTDIR/$blddir/bin/$exename ; then
        cp -f $UM_ROUTDIR/$blddir/bin/$exename $exepath/ 1>/dev/null 2>&1
      fi
    fi
  fi
 
done

