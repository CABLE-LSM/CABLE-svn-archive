<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<font color=#447700>!<a name='2'></font>
<font color=#447700>!soil_snow.f90<a name='3'></font>
<font color=#447700>!<a name='4'></font>
<font color=#447700>! Soil and snow routines source file for CABLE, CSIRO land surface model<a name='5'></font>
<font color=#447700>!<a name='6'></font>
<font color=#447700>! Science development by Eva Kowalczyk, CSIRO Marine and Atmospheric Research<a name='7'></font>
<font color=#447700>! <a name='8'></font>
<font color=#447700>! Fortran-95 coding by Harvey Davies, Gab Abramowitz, Martin Dix and Bernard Pak<a name='9'></font>
<font color=#447700>! Please report bugs to bernard.pak@csiro.au<a name='10'></font>
<font color=#447700>!<a name='11'></font>
<font color=#447700>! Major rewrite to modular format in Nov 2007 by Eva Kowalczyk<a name='12'></font>
<font color=#447700>!<a name='13'></font>
<font color=#447700>! This file contains the soil_snow_module only<a name='14'></font>
<font color=#447700>! which has the following subroutines:<a name='15'></font>
<font color=#447700>!   trimb,<a name='16'></font>
<font color=#447700>!   smoisturev,<a name='17'></font>
<font color=#447700>!   snowdensity,<a name='18'></font>
<font color=#447700>!   snow_melting,<a name='19'></font>
<font color=#447700>!   snow_accum,<a name='20'></font>
<font color=#447700>!   surfbv,<a name='21'></font>
<font color=#447700>!   snow_albedo,<a name='22'></font>
<font color=#447700>!   stempv,<a name='23'></font>
<font color=#447700>!   stempvsn,<a name='24'></font>
<font color=#447700>!   snowcheck,<a name='25'></font>
<font color=#447700>!   snowl_adjust,<a name='26'></font>
<font color=#447700>!   soilfreeze,<a name='27'></font>
<font color=#447700>!   remove_trans, and<a name='28'></font>
<font color=#447700>!   soil_snow<a name='29'></font>
<font color=#447700>!<a name='30'></font>
<A NAME='SOIL_SNOW_MODULE'><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='31'>
<font color=#993300>MODULE </font><font color=#cc0000>soil_snow_module</font> <A href='../../call_to/SOIL_SNOW_MODULE.html' TARGET='index'>1</A><a name='32'>
  USE <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_soilsnow.F90.html#cable_soilsnow.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_16"> <font color=#447700>! from cable_variables.f90<a name='33'></font>
  USE <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_soilsnow.F90.html#cable_soilsnow.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_16">       <font color=#447700>! from cable_variables.f90<a name='34'></font>
  USE <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_soilsnow.F90.html#cable_soilsnow.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_28"><a name='35'>
  IMPLICIT NONE<a name='36'>
  PRIVATE<a name='37'>
  REAL(r_1), PARAMETER :: cgsnow = 2090.0 <font color=#447700>! specific heat capacity for snow<a name='38'></font>
  REAL(r_1), PARAMETER :: csice = 2.100e3 <font color=#447700>! specific heat capacity for ice<a name='39'></font>
  REAL(r_1), PARAMETER :: cswat = 4.218e3 <font color=#447700>! specific heat capacity for water<a name='40'></font>
  <font color=#447700>!REAL(r_1), PARAMETER :: hl = 2.5104e6   ! latent heat of evaporation<a name='41'></font>
  <font color=#447700>!REAL(r_1), PARAMETER :: hlf = 0.335e6   ! latent heat of fusion<a name='42'></font>
  REAL(r_1), PARAMETER :: cp = 1004.64    <font color=#447700>! specific heat capacity for air<a name='43'></font>
  REAL(r_1), PARAMETER :: rhowat = 1000.0 <font color=#447700>! density of water<a name='44'></font>
<font color=#447700>!  REAL(r_1), PARAMETER :: snmin = 0.11    ! for 3-layer;<a name='45'></font>
<font color=#447700>!  REAL(r_1), PARAMETER :: snmin =  100000.0 ! for 1-layer;<a name='46'></font>
<font color=#447700>!  REAL(r_1), PARAMETER :: snmin =  20.0 ! for 3-layer in land-ice areas;<a name='47'></font>
  REAL(r_1), PARAMETER :: snmin =  1.0 <font color=#447700>! for 3-layer in land-ice areas;<a name='48'></font>
<a name='49'>
  <font color=#447700>! This module contains the following subroutines:<a name='50'></font>
  PUBLIC soil_snow <font color=#447700>! must be available outside this module<a name='51'></font>
  PRIVATE trimb, smoisturev, snow_accum, stempv, stempvsn <a name='52'>
  PRIVATE snowdensity, snow_melting, snowcheck, snowl_adjust <a name='53'>
<font color=#447700>!  PRIVATE soilfreeze, remove_trans, snow_albedo<a name='54'></font>
   PRIVATE soilfreeze, remove_trans<a name='55'>
<font color=#447700>!  INTEGER(i_d), PARAMETER, PRIVATE  :: idjd = 9985<a name='56'></font>
<font color=#447700>!  INTEGER(i_d), PARAMETER, PRIVATE  :: idjd = 6488<a name='57'></font>
<font color=#447700>!  INTEGER(i_d), PARAMETER, PRIVATE  :: idjd = 10280 <a name='58'></font>
  INTEGER(i_d), PARAMETER, PRIVATE  :: idjd = 2654 <a name='59'>
<a name='60'>
CONTAINS<a name='61'>
<a name='62'>
  <font color=#447700>!----------------------------------------------------------------------<a name='63'></font>
  <font color=#447700>! SUBROUTINE trimb<a name='64'></font>
  <font color=#447700>!<a name='65'></font>
  <font color=#447700>!      this routine solves the system<a name='66'></font>
  <font color=#447700>!	   a(k)*u(k-1)+b(k)*u(k)+c(k)*u(k+1)=rhs(k)    for k=2,kmax-1<a name='67'></font>
  <font color=#447700>!	   with  b(k)*u(k)+c(k)*u(k+1)=rhs(k)	       for k=1<a name='68'></font>
  <font color=#447700>!	   and	 a(k)*u(k-1)+b(k)*u(k)=rhs(k)	       for k=kmax<a name='69'></font>
  <font color=#447700>!<a name='70'></font>
  <font color=#447700>!	 the Thomas algorithm is used for solving sets of linear equation<a name='71'></font>
  <font color=#447700>!	 rhs initially contains rhs; leaves with answer (jlm)<a name='72'></font>
  <font color=#447700>!	 n.b. this one does not assume b = 1-a-c<a name='73'></font>
  <font color=#447700>!<a name='74'></font>
<A NAME='TRIMB'><A href='../../html_code/science/cable_soilsnow.F90.html#TRIMB' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='75'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>trimb</font> (a, b, c, rhs, kmax) <A href='../../call_to/TRIMB.html' TARGET='index'>3</A><a name='76'>
    REAL(r_2), DIMENSION(:,:), INTENT(IN)     :: a <font color=#447700>! coef "A" in finite diff eq<a name='77'></font>
    REAL(r_2), DIMENSION(:,:), INTENT(IN)     :: b <font color=#447700>! coef "B" in finite diff eq<a name='78'></font>
    REAL(r_2), DIMENSION(:,:), INTENT(IN)     :: c <font color=#447700>! coef "C" in finite diff eq<a name='79'></font>
    REAL(r_2), DIMENSION(:,:), INTENT(INOUT)  :: rhs <font color=#447700>! right hand side of eq<a name='80'></font>
    INTEGER(i_d), INTENT(IN)                  :: kmax <font color=#447700>! no. of discrete layers<a name='81'></font>
    INTEGER(i_d)                              :: k <font color=#447700>! do lloop counter<a name='82'></font>
    REAL(r_2), DIMENSION(SIZE(a,1),SIZE(a,2)) :: e <a name='83'>
    REAL(r_2), DIMENSION(SIZE(a,1),SIZE(a,2)) :: g <a name='84'>
    REAL(r_2), DIMENSION(SIZE(a,1),SIZE(a,2)) :: temp <a name='85'>
<a name='86'>
    e(:,1) = c(:,1) / b(:,1)<a name='87'>
    DO k = 2, kmax - 1<a name='88'>
      temp(:,k) = 1. / (b(:,k) - a(:,k) * e(:,k-1) )<a name='89'>
      e(:,k) = c(:,k) * temp(:,k)<a name='90'>
    END DO<a name='91'>
    g(:,1) = rhs(:,1) / b(:,1)<a name='92'>
    DO k = 2, kmax - 1<a name='93'>
      g(:,k) = (rhs(:,k) - a(:,k) * g(:,k-1) ) * temp(:,k)<a name='94'>
    END DO<a name='95'>
<a name='96'>
    <font color=#447700>! do back substitution to give answer now<a name='97'></font>
    rhs(:,kmax) = (rhs(:,kmax) - &amp;<a name='98'>
       &amp; a(:,kmax) * g(:,kmax-1)) / (b(:,kmax) - a(:,kmax) * e(:,kmax-1))<a name='99'>
    DO k = kmax - 1, 1, - 1<a name='100'>
      rhs(:,k) = g(:,k) - e(:,k) * rhs(:,k + 1)<a name='101'>
    END DO<a name='102'>
  END SUBROUTINE trimb<a name='103'>
<a name='104'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='105'></font>
  <font color=#447700>! SUBROUTINE smoisturev (fwtop,dels,ktau,ssoil,soil)<a name='106'></font>
  <font color=#447700>!      Solves implicit soil moisture equation<a name='107'></font>
  <font color=#447700>!      Science development by Eva Kowalczyk and John McGregor, CMAR<a name='108'></font>
  <font color=#447700>!<a name='109'></font>
<A NAME='SMOISTUREV'><A href='../../html_code/science/cable_soilsnow.F90.html#SMOISTUREV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='110'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>smoisturev</font> (dels,ktau,ssoil,soil) <A href='../../call_to/SMOISTUREV.html' TARGET='index'>1</A>,<A href='../../call_from/SMOISTUREV.html' TARGET='index'>1</A><a name='111'>
    REAL(r_1), INTENT(IN)                     :: dels    <font color=#447700>! time step size (s)<a name='112'></font>
    INTEGER(i_d), INTENT(IN)                  :: ktau  <font color=#447700>! integration step number<a name='113'></font>
    TYPE (soil_snow_type), INTENT(INOUT)      :: ssoil <font color=#447700>! soil and snow variables<a name='114'></font>
    TYPE (soil_parameter_type), INTENT(INOUT) :: soil  <font color=#447700>! soil parameters<a name='115'></font>
    INTEGER(i_d), PARAMETER                   :: ntest = 0 <font color=#447700>! 2 for funny pre-set<a name='116'></font>
                                                           <font color=#447700>! for idjd<a name='117'></font>
    <font color=#447700>! nmeth selects the solution method<a name='118'></font>
    INTEGER(i_d), PARAMETER                   :: nmeth = - 1 <font color=#447700>! preferred method<a name='119'></font>
    <font color=#447700>!                                  Values as follows:<a name='120'></font>
    <font color=#447700>!                                   -1 for simple implicit D<a name='121'></font>
    <font color=#447700>!                                    1 for fully implicit solution<a name='122'></font>
    <font color=#447700>!                                    2 for simpler implicit<a name='123'></font>
    <font color=#447700>!                                    3 for simple implicit D, explicit K <a name='124'></font>
    <font color=#447700>!                                    4 for simple implicit D, implicit K<a name='125'></font>
    <font color=#447700>!                                    0 for simple implicit D, new jlm TVD K<a name='126'></font>
    REAL(r_2), DIMENSION(mp,3*ms) :: at     <font color=#447700>! coef "A" in finite diff eq<a name='127'></font>
    REAL(r_2), DIMENSION(mp,3*ms) :: bt     <font color=#447700>! coef "B" in finite diff eq<a name='128'></font>
    REAL(r_2), DIMENSION(mp,3*ms) :: ct     <font color=#447700>! coef "C" in finite diff eq<a name='129'></font>
    REAL(r_2), DIMENSION(mp)      :: fact<a name='130'>
    REAL(r_2), DIMENSION(mp)      :: fact2<a name='131'>
    REAL(r_2), DIMENSION(mp)      :: fluxhi<a name='132'>
    REAL(r_2), DIMENSION(mp)      :: fluxlo<a name='133'>
    REAL(r_2), DIMENSION(mp)      :: hydss  <font color=#447700>! hydraulic conductivity<a name='134'></font>
                                            <font color=#447700>! adjusted for ice<a name='135'></font>
    INTEGER(i_d)                  :: k<a name='136'>
    REAL(r_2), DIMENSION(mp)      :: phi<a name='137'>
    REAL(r_2), DIMENSION(mp)      :: pwb<a name='138'>
<font color=#447700>!    REAL(r_2), DIMENSION(:), ALLOCATABLE, SAVE :: pwb_min<a name='139'></font>
    REAL(r_2), DIMENSION(mp)      :: rat<a name='140'>
    REAL(r_2), DIMENSION(mp)      :: speed_k<a name='141'>
    REAL(r_2), DIMENSION(mp)      :: ssatcurr_k<a name='142'>
    REAL(r_1), DIMENSION(mp)      :: wblfmn<a name='143'>
    REAL(r_1), DIMENSION(mp)      :: wblfmx<a name='144'>
    REAL(r_2), DIMENSION(mp,ms+1) :: wbh<a name='145'>
    REAL(r_2), DIMENSION(mp,ms+1) :: z1<a name='146'>
    REAL(r_2), DIMENSION(mp,ms+1) :: z2<a name='147'>
    REAL(r_2), DIMENSION(mp,ms+1) :: z3<a name='148'>
    REAL(r_1), DIMENSION(mp,ms+1) :: z1mult<a name='149'>
    REAL(r_2), DIMENSION(mp,0:ms) :: fluxh<a name='150'>
    REAL(r_2), DIMENSION(mp,0:ms) :: delt<a name='151'>
    REAL(r_2), DIMENSION(mp,0:ms) :: dtt<a name='152'>
    REAL(r_2), DIMENSION(mp)      :: pwb_wbh<a name='153'>
    REAL(r_2), DIMENSION(mp,ms)   :: ssatcurr<a name='154'>
    REAL(r_1), DIMENSION(mp)      :: totwba <font color=#447700>! diagnostic<a name='155'></font>
    REAL(r_1), DIMENSION(mp)      :: totwbb<a name='156'>
    REAL(r_1), DIMENSION(mp)      :: totwbc<a name='157'>
    REAL(r_1), DIMENSION(mp)      :: totwblb<a name='158'>
    REAL(r_1), DIMENSION(mp)      :: totwblc<a name='159'>
    REAL(r_1), DIMENSION(mp)      :: wbficemx<a name='160'>
    REAL(r_2), DIMENSION(mp)      :: wbh_k<a name='161'>
    REAL(r_2), DIMENSION(mp)      :: wbl_k<a name='162'>
    REAL(r_2), DIMENSION(mp)      :: wbl_kp<a name='163'>
    REAL(r_2), DIMENSION(mp)      :: wh<a name='164'>
    REAL(r_2), DIMENSION(mp)      :: z3_k<a name='165'>
    LOGICAL :: is_open     <font color=#447700>! Is file open?<a name='166'></font>
    INTEGER :: u           <font color=#447700>! I/O unit<a name='167'></font>
    <font color=#447700>!<a name='168'></font>
<font color=#447700>!    IF (ktau == 1) THEN<a name='169'></font>
<font color=#447700>!      ! For some sorts of nested models, this might have been allocated on<a name='170'></font>
<font color=#447700>!      ! another nest<a name='171'></font>
<font color=#447700>!      IF ( ALLOCATED(pwb_min) ) DEALLOCATE(pwb_min)<a name='172'></font>
<font color=#447700>!      ALLOCATE(pwb_min(mp))<a name='173'></font>
<font color=#447700>!      ! Set working variable:<a name='174'></font>
<font color=#447700>!      pwb_min = (soil%swilt / soil%ssat ) **soil%ibp2<a name='175'></font>
<font color=#447700>!    END IF<a name='176'></font>
    <font color=#447700>! Block below for testing purposes only: - - - - - - - - - - - -<a name='177'></font>
<font color=#447700>!        print *, 'wb   smoist1',(ssoil%wb(idjd,k) , k = 1, ms)<a name='178'></font>
<font color=#447700>!        print *, 'wblf smoist1',(ssoil%wblf(idjd,k),k = 1, ms)<a name='179'></font>
    IF (ntest &gt; 0) THEN<a name='180'>
      PRINT * , 'entering smoisturev fwtop1,i2bp3,swilt,sfc,ssat: ', &amp;<a name='181'>
        &amp; ssoil%fwtop1(idjd), soil%i2bp3(idjd), soil%swilt(idjd), &amp;<a name='182'>
        &amp; soil%sfc(idjd), soil%ssat(idjd)<a name='183'>
      u = 97<a name='184'>
      inquire (u, opened=is_open)<a name='185'>
      IF (.NOT. is_open) THEN<a name='186'>
        open (u, file='f97.txt', status='replace')<a name='187'>
        write (u, *) 'ktau', ' fwtop', ' i2bp3', ' swilt', ' sfc', ' ssat'<a name='188'>
      END IF<a name='189'>
      write (u, *) ktau,ssoil%fwtop1,soil%i2bp3,soil%swilt,soil%sfc,soil%ssat<a name='190'>
<font color=#447700>!      IF (ntest == 2) THEN ! just to test conservation<a name='191'></font>
<font color=#447700>!        IF (ktau == 1) ssoil%wb(:,ms) = soil%swilt<a name='192'></font>
<font color=#447700>!        ssoil%fwtop1 = 0.0<a name='193'></font>
<font color=#447700>!        ssoil%fwtop2 = 0.0<a name='194'></font>
<font color=#447700>!        ssoil%fwtop3 = 0.0<a name='195'></font>
<font color=#447700>!      END IF<a name='196'></font>
      WRITE (6, " ('wb   ', 6f8.3) ")    (ssoil%wb(idjd,k) , k = 1, ms)<a name='197'>
      WRITE (6, " ('wbice', 6f8.3) ") (ssoil%wbice(idjd,k) , k = 1, ms)<a name='198'>
      totwba = 0.0<a name='199'>
      DO k = 1, ms<a name='200'>
        totwba = totwba + soil%zse(k) * REAL(ssoil%wb(:,k),r_1)<a name='201'>
      END DO<a name='202'>
    END IF<a name='203'>
    <font color=#447700>! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - <a name='204'></font>
    <font color=#447700>! preset to allow for non-land &amp; snow points in trimb<a name='205'></font>
    at = 0.0<a name='206'>
    bt = 1.0<a name='207'>
    ct = 0.0<a name='208'>
    z1mult(:,1) = 0.0       <font color=#447700>! corresponds to 2b+3<a name='209'></font>
    z1mult(:,ms+1) = 0.0    <font color=#447700>! corresponds to 2b+3<a name='210'></font>
    z1(:,1) = 0.0           <font color=#447700>! i.e. K(.5),    value at surface<a name='211'></font>
    z1(:,ms+1) = 0.0        <font color=#447700>! i.e. K(ms+.5), value at bottom<a name='212'></font>
    <font color=#447700>! nmeth: equation solution technique<a name='213'></font>
    IF (nmeth &lt;= 0) THEN<a name='214'>
      <font color=#447700>! jlm split TVD version<a name='215'></font>
      <font color=#447700>! all land points<a name='216'></font>
      delt(:,0) = 0.0<a name='217'>
      fluxh(:,0) = 0.0<a name='218'>
      fluxh(:,ms) = 0.0<a name='219'>
      DO k = 1, ms-1<a name='220'>
        <font color=#447700>! Calculate amount of liquid soil water:<a name='221'></font>
        wbl_k = MAX(  0.01_r_2, ssoil%wb(:,k)   - ssoil%wbice(:,k)   )<a name='222'>
        wbl_kp = MAX( 0.01_r_2, ssoil%wb(:,k+1) - ssoil%wbice(:,k+1) )<a name='223'>
        <font color=#447700>! Calculate difference in liq soil water b/w consecutive layers:<a name='224'></font>
        delt(:,k) = wbl_kp - wbl_k<a name='225'>
        <font color=#447700>! especially to allow for isolated frozen layers, use min speed<a name='226'></font>
        wh = MIN(wbl_k, wbl_kp)<a name='227'>
        where(ssoil%wbice(:,k).gt.0.05.or.ssoil%wbice(:,k+1).gt.0.01) &amp;<a name='228'>
           wh = 0.9*wbl_k + 0.1*wbl_kp<a name='229'>
        <font color=#447700>! with 50% wbice, reduce hyds by 1.e-5<a name='230'></font>
        <font color=#447700>! Calculate hyd conductivity adjusted for ice:<a name='231'></font>
        hydss = soil%hyds <a name='232'>
<font color=#447700>!        hydss = soil%hyds * (1.0 - MIN(2.0_r_2 * ssoil%wbice(:,k) &amp;<a name='233'></font>
<font color=#447700>!              &amp; / MAX(0.01_r_2,  ssoil%wb(:,k) ), 0.99999_r_2) )<a name='234'></font>
        speed_k = hydss * (wh / soil%ssat ) ** (soil%i2bp3 - 1)<a name='235'>
        <font color=#447700>! update wb by TVD method<a name='236'></font>
        rat = delt(:,k - 1) / (delt(:,k)+SIGN(REAL(1.0e-20,r_2), delt(:,k)))<a name='237'>
        phi = MAX(0.0, MIN(1.0, 2.0 * rat), MIN(2., rat) ) <font color=#447700>! 0 for -ve rat<a name='238'></font>
<font color=#447700>!        phi = MAX(0._r_2, MIN(1._r_2, 2._r_2 * rat), &amp;<a name='239'></font>
<font color=#447700>!            &amp; MIN(2._r_2, rat) ) ! 0 for -ve rat<a name='240'></font>
        fluxhi = wh<a name='241'>
        fluxlo = wbl_k<a name='242'>
        <font color=#447700>! Block below for testing purposes only:<a name='243'></font>
        IF (ntest &gt; 0) THEN<a name='244'>
          PRINT * , 'in TVD for k= ', k<a name='245'>
          PRINT * , 'wbl,wh,hydss ', wbl_k(idjd), wh(idjd), hydss(idjd)<a name='246'>
          PRINT * , 'speeda,speedb,fluxhi,fluxlo,delt,rat,phi ', &amp;<a name='247'>
             &amp; speed_k(idjd), 0.5*soil%zse(k)/dels, fluxhi(idjd), &amp;<a name='248'>
             &amp; fluxlo(idjd), delt(idjd,k), rat(idjd), phi(idjd)<a name='249'>
        END IF<a name='250'>
        <font color=#447700>! scale speed to grid lengths per dt &amp; limit speed for stability<a name='251'></font>
        <font color=#447700>! 1. OK too for stability<a name='252'></font>
        speed_k = MIN(speed_k, 0.5 * soil%zse(k) / dels)<a name='253'>
        fluxh(:,k) = speed_k * (fluxlo + phi * (fluxhi - fluxlo) )<a name='254'>
      END DO<a name='255'>
      <font color=#447700>! calculate drainage (this code replaces the code in the surfb)<a name='256'></font>
      k = ms <a name='257'>
<font color=#447700>!      WHERE( ssoil%wb(:,ms) &gt; soil%sfc(:))<a name='258'></font>
<font color=#447700>!      WHERE( soil%albsoil(:) .lt. 0.25 )<a name='259'></font>
<font color=#447700>!      WHERE( soil%albsoil(:) .lt. 0.30 )<a name='260'></font>
<font color=#447700>!      WHERE( ssoil%wb(:,ms) &gt; soil%sfc(:))<a name='261'></font>
<font color=#447700>!      WHERE( ssoil%wb(:,ms) &gt; max(soil%sfc(:),0.14) )<a name='262'></font>
      WHERE( ssoil%wb(:,ms) &gt; soil%sfc(:) )<a name='263'>
<font color=#447700>!      WHERE( ssoil%wb(:,ms) &gt; 0.5*(soil%sfc(:)+soil%ssat(:)) )<a name='264'></font>
        wbl_k = MAX(0.001_r_2, ssoil%wb(:,ms) - ssoil%wbice(:,ms) )<a name='265'>
        wbl_kp = MAX(0.001_r_2, soil%ssat(:) - ssoil%wbice(:,ms) )<a name='266'>
        <font color=#447700>!wh = 0.9*wbl_k + 0.1*wbl_kp<a name='267'></font>
        wh = MIN(wbl_k, wbl_kp)<a name='268'>
        where(ssoil%wbice(:,ms).gt. 0.05) wh = 0.9*wbl_k + 0.1*wbl_kp<a name='269'>
        <font color=#447700>! Calculate hyd conductivity adjusted for ice:<a name='270'></font>
        hydss = soil%hyds <a name='271'>
<font color=#447700>!        hydss = soil%hyds * ( 1. - MIN( 2.0_r_2 * ssoil%wbice(:,ms) &amp;<a name='272'></font>
<font color=#447700>!              &amp; / MAX(0.01_r_2, ssoil%wb(:,ms)), 0.99999_r_2 ) )<a name='273'></font>
        speed_k = hydss * (wh / soil%ssat ) ** (soil%i2bp3 - 1)<a name='274'>
        speed_k =  0.5*speed_k / (1. - min(0.5,10.*ssoil%wbice(:,ms)))<a name='275'>
        fluxlo = wbl_k<a name='276'>
        <font color=#447700>! scale speed to grid lengths per dt &amp; limit speed for stability<a name='277'></font>
        speed_k = MIN(speed_k, 0.5 * soil%zse(ms) / dels)<a name='278'>
        fluxh(:,ms) = MAX(0.0,speed_k * fluxlo )<a name='279'>
       END WHERE<a name='280'>
<font color=#447700>!      ELSEWHERE<a name='281'></font>
<font color=#447700>!       WHERE( ssoil%wb(:,ms) &gt; soil%sfc(:))<a name='282'></font>
<font color=#447700>!        wbl_k = MAX(0.01_r_2, ssoil%wb(:,ms) - ssoil%wbice(:,ms) )<a name='283'></font>
<font color=#447700>!        wbl_kp = MAX(0.01_r_2, soil%ssat(:) - ssoil%wbice(:,ms) )<a name='284'></font>
<font color=#447700>!        wh = 0.9*wbl_k + 0.1*wbl_kp<a name='285'></font>
<font color=#447700>!        ! Calculate hyd conductivity adjusted for ice:<a name='286'></font>
<font color=#447700>!        hydss = soil%hyds * ( 1. - MIN( 2.0_r_2 * ssoil%wbice(:,ms) &amp;<a name='287'></font>
<font color=#447700>!              &amp; / MAX(0.01_r_2, ssoil%wb(:,ms)), 0.99999_r_2 ) )<a name='288'></font>
<font color=#447700>!        speed_k = hydss * (wh / soil%ssat ) ** (soil%i2bp3 - 1)<a name='289'></font>
<font color=#447700>!        fluxlo = wbl_k<a name='290'></font>
<font color=#447700>!        ! scale speed to grid lengths per dt &amp; limit speed for stability<a name='291'></font>
<font color=#447700>!!        speed_k = MIN(speed_k, 0.5 * soil%zse(ms) / dels)<a name='292'></font>
<font color=#447700>!        speed_k = MIN(0.5*speed_k, 0.5 * soil%zse(ms) / dels)<a name='293'></font>
<font color=#447700>!        fluxh(:,ms) = MAX(0.0,speed_k * fluxlo )<a name='294'></font>
<font color=#447700>!       END WHERE<a name='295'></font>
<font color=#447700>!      END WHERE<a name='296'></font>
<a name='297'>
      <font color=#447700>! update wb by TVD method<a name='298'></font>
      DO k = ms, 1, -1<a name='299'>
        IF (nmeth == -1) THEN <font color=#447700>! each new wb constrained by ssat<a name='300'></font>
          fluxh(:,k-1) = MIN(fluxh (:,k-1), (soil%ssat &amp;<a name='301'>
                 - ssoil%wb(:,k) ) * soil%zse(k) / dels + fluxh(:,k) )<a name='302'>
        END IF<a name='303'>
        <font color=#447700>! fluxh (:,ms) is drainage<a name='304'></font>
        ssoil%wb(:,k) = ssoil%wb(:,k) + dels * (fluxh(:,k-1) - fluxh(:,k)) &amp;<a name='305'>
                                         &amp; / soil%zse(k)<a name='306'>
        <font color=#447700>! re-calculate wblf<a name='307'></font>
        ssatcurr_k = soil%ssat - ssoil%wbice(:,k)<a name='308'>
        dtt(:,k) = dels / (soil%zse(k) * ssatcurr_k)<a name='309'>
        <font color=#447700>! this defn of wblf has different meaning from previous one in surfbv<a name='310'></font>
        <font color=#447700>! N.B. are imposing wbice&lt;wb, so wblf &lt;1<a name='311'></font>
        ssoil%wblf(:,k) = (ssoil%wb(:,k) - ssoil%wbice(:,k) ) / ssatcurr_k<a name='312'>
      END DO<a name='313'>
      ssoil%rnof2 = dels * REAL(fluxh(:,ms),r_1) * 1000.0<a name='314'>
<a name='315'>
      <font color=#447700>! wbh_k represents wblf(k-.5)<a name='316'></font>
      DO k = 2, ms<a name='317'>
        ssatcurr_k = REAL(soil%ssat,r_2) - ssoil%wbice(:,k)<a name='318'>
        wbh_k = ( soil%zse(k) * ssoil%wblf(:,k-1) + soil%zse(k-1) &amp;<a name='319'>
              &amp; * ssoil%wblf(:,k) ) / ( soil%zse(k) + soil%zse(k-1) )<a name='320'>
        <font color=#447700>! i.e. wbh**(bch+1)<a name='321'></font>
<a name='322'>
        fact = wbh_k** (soil%ibp2 - 1)<a name='323'>
        <font color=#447700>! with 50% wbice, reduce hbsh by 1.e-5<a name='324'></font>
<font color=#447700>!        pwb_wbh = (soil%hsbh * (1. - MIN(2. * MIN(0.99_r_2, MAX( &amp;<a name='325'></font>
<font color=#447700>!        pwb_wbh = (soil%hsbh * (1. - MIN(2. * MIN(0.2_r_2, MAX( &amp;<a name='326'></font>
<font color=#447700>!        pwb_wbh = (soil%hsbh * (1. - MIN(2. * MIN(0.1_r_2, MAX( &amp;<a name='327'></font>
        pwb_wbh = (soil%hsbh * (1. - MIN(2. * MIN(0.1_r_2, MAX( &amp;<a name='328'>
                &amp; ssoil%wbice(:,k-1) / MAX(0.01_r_2, ssoil%wb(:,k-1)), &amp;<a name='329'>
                &amp; ssoil%wbice(:,k)   / MAX(0.01_r_2, ssoil%wb(:,k)  ) )) &amp;<a name='330'>
                &amp; , 0.1_r_2) )) &amp;<a name='331'>
                &amp; * MAX(soil%pwb_min, wbh_k * fact)<a name='332'>
<font color=#447700>!                &amp; , 0.2_r_2) )) &amp;<a name='333'></font>
<font color=#447700>!                &amp; , 0.99999_r_2) )) &amp;<a name='334'></font>
        <font color=#447700>! moisture diffusivity (D) is  wbh*pwb; hsbh includes b<a name='335'></font>
        <font color=#447700>! i.e. D(k-.5)/soil%zshh(k)<a name='336'></font>
        z3_k = pwb_wbh / soil%zshh (k)<a name='337'>
        <font color=#447700>! PRINT * , 'z3_k ', z3_k<a name='338'></font>
        <font color=#447700>! where dtt=dels/(soil%zse(k)*ssatcurr_k)<a name='339'></font>
        at (:,k) = - dtt(:,k) * z3_k<a name='340'>
        ct (:,k-1) = - dtt(:,k-1) * z3_k<a name='341'>
      END DO<a name='342'>
      bt = 1. - at - ct<a name='343'>
      <font color=#447700>! Block below for testing purposes only:<a name='344'></font>
<font color=#447700>!        print *, 'wb   smoist2',(ssoil%wb(idjd,k) , k = 1, ms)<a name='345'></font>
<font color=#447700>!        print *, 'wblf smoist2',(ssoil%wblf(idjd,k) , k = 1, ms)<a name='346'></font>
      IF (ntest &gt; 0) THEN<a name='347'>
<font color=#447700>!        PRINT * , 'midway through nmeth&lt;=0'<a name='348'></font>
<font color=#447700>!        PRINT * , 'fluxh ', (fluxh(idjd,k) , k = 1, ms)<a name='349'></font>
        WRITE (6, " ('wb   ', 6f8.3) ")  (ssoil%wb(idjd,k) , k = 1, ms)<a name='350'>
        WRITE (6, " ('wblf ', 6f8.3) ") (ssoil%wblf(idjd,k) , k = 1, ms)<a name='351'>
        totwbb = 0.<a name='352'>
        totwblb = 0.<a name='353'>
        DO k = 1, ms<a name='354'>
          totwbb = totwbb + soil%zse(k) * REAL(ssoil%wb(:,k),r_1) <font color=#447700>! diagnostic<a name='355'></font>
          totwblb=totwblb + soil%zse(k) * REAL(ssoil%wblf(:,k),r_1) <font color=#447700>! diagnostic<a name='356'></font>
        END DO<a name='357'>
<font color=#447700>!        PRINT * , 'nmeth, b+2, 2b+3: ',nmeth, soil%ibp2(idjd), soil%i2bp3(idjd)<a name='358'></font>
        WRITE (6, " ('wb   ', 6f8.3) ")  (ssoil%wb(idjd,k) , k = 1, ms)<a name='359'>
        WRITE (6, " ('wbice', 6f8.3) ") (ssoil%wbice(idjd,k) , k = 1, ms)<a name='360'>
        WRITE (6, " ('wblf ', 6f8.3) ") (ssoil%wblf(idjd,k) , k = 1, ms)<a name='361'>
<font color=#447700>!        PRINT * , 'zse ', soil%zse<a name='362'></font>
<font color=#447700>!        PRINT * , 'zshh ', soil%zshh<a name='363'></font>
<font color=#447700>!        PRINT * , 'dtt ', (dtt(idjd,k) , k = 1, ms)<a name='364'></font>
<font color=#447700>!        PRINT * , 'at ', (at(idjd,k) , k = 1, ms)<a name='365'></font>
<font color=#447700>!        PRINT * , 'bt ', (bt(idjd,k) , k = 1, ms)<a name='366'></font>
<font color=#447700>!        PRINT * , 'ct ', (ct(idjd,k) , k = 1, ms)<a name='367'></font>
      END IF<a name='368'>
      ssoil%wblf(:,1) = ssoil%wblf(:,1) + dtt(:,1) * ssoil%fwtop1 / rhowat<a name='369'>
      ssoil%wblf(:,2) = ssoil%wblf(:,2) + dtt(:,2) * ssoil%fwtop2 / rhowat<a name='370'>
      ssoil%wblf(:,3) = ssoil%wblf(:,3) + dtt(:,3) * ssoil%fwtop3 / rhowat<a name='371'>
    END IF<a name='372'>
<a name='373'>
    IF (nmeth &gt; 0) THEN<a name='374'>
      wbficemx = 0.0<a name='375'>
      DO k = 1, ms<a name='376'>
        ssatcurr(:,k) = REAL(soil%ssat,r_2) - ssoil%wbice(:,k)<a name='377'>
        <font color=#447700>! this defn of wblf has different meaning from previous one in surfbv<a name='378'></font>
        <font color=#447700>! N.B. are imposing wbice&lt;wb, so wblf &lt;1<a name='379'></font>
        ssoil%wblf(:,k) = (ssoil%wb(:,k) - ssoil%wbice(:,k) ) / ssatcurr(:,k)<a name='380'>
        ssoil%wbfice(:,k) = REAL(ssoil%wbice(:,k),r_1) / soil%ssat<a name='381'>
        wbficemx = MAX(wbficemx, ssoil%wbfice(:,k) )<a name='382'>
        dtt(:,k) = dels / (soil%zse(k) * ssatcurr(:,k) )<a name='383'>
      END DO<a name='384'>
      IF (nmeth == 1) THEN <font color=#447700>! full implicit method<a name='385'></font>
        DO k = 2, ms<a name='386'>
          <font color=#447700>! wbh(k)=MIN(1.,ww(k)*wblf(:,k-1)+(1.-ww(k))*wblf(:,k))<a name='387'></font>
          <font color=#447700>! jlm: this is same as:<a name='388'></font>
          wbh(:,k) = (soil%zse(k) * ssoil%wblf(:,k-1) + soil%zse(k-1) &amp;<a name='389'>
                   &amp; * ssoil%wblf(:,k) ) / (soil%zse(k) + soil%zse(k-1) )<a name='390'>
          fact = wbh(:,k) ** (soil%ibp2 - 1) <font color=#447700>! i.e. wbh**(bch+1)<a name='391'></font>
          fact2 = fact * fact<a name='392'>
          pwb = soil%hsbh * fact<a name='393'>
          <font color=#447700>! moisture diffusivity (D) is  wbh*pwb<a name='394'></font>
          <font color=#447700>! other term (K) is wbh*soil%hyds*fact2<a name='395'></font>
          z1(:,k) = wbh(:,k) * ( (soil%i2bp3 - 1) * soil%hyds * fact2 - &amp;<a name='396'>
                  &amp; soil%ibp2 * pwb * (ssoil%wblf(:,k) - ssoil%wblf(:,k-1) ) &amp;<a name='397'>
                  &amp; / soil%zshh (k) )<a name='398'>
          z2(:,k) = - soil%i2bp3 * soil%hyds * fact2 + soil%ibp2 * pwb &amp;<a name='399'>
                  &amp; * (ssoil%wblf(:,k) - ssoil%wblf(:,k-1) ) / soil%zshh (k)<a name='400'>
          z3(:,k) = pwb * wbh(:,k) / soil%zshh (k)<a name='401'>
          at(:,k) = dtt(:,k) * (z2(:,k) * 0.5 * soil%zse(k) / soil%zshh (k) &amp;<a name='402'>
                  &amp; - z3(:,k) )<a name='403'>
        END DO<a name='404'>
        DO k = 1, ms - 1<a name='405'>
          ct(:,k) = dtt(:,k) * ( - z2(:,k+1) * 0.5 * soil%zse(k) &amp;<a name='406'>
                  &amp; / soil%zshh (k+1) - z3(:,k+1) )<a name='407'>
          bt(:,k) = 1.0 + dtt(:,k) * ( - z2(:,k+1) * 0.5 * soil%zse(k+1) &amp;<a name='408'>
                  &amp; / soil%zshh (k+1) + z2(:,k) * 0.5 * soil%zse(MAX(k-1,1)) &amp;<a name='409'>
                  &amp; / soil%zshh (k) + z3(:,k+1) + z3(:,k) )<a name='410'>
        END DO<a name='411'>
        bt(:,ms) = 1.0 + dtt(:,ms) * (z2(:,ms) * 0.5 * soil%zse(ms) &amp;<a name='412'>
                  &amp; / soil%zshh (ms) + z3(:,ms) )<a name='413'>
        DO k = 1, ms<a name='414'>
          ssoil%wblf(:,k) = ssoil%wblf(:,k) + dtt(:,k) * (z1(:,k+1) - z1(:,k) )<a name='415'>
        END DO<a name='416'>
      END IF<a name='417'>
      IF (nmeth &gt;= 2) THEN <font color=#447700>! part implicit method<a name='418'></font>
        DO k = 2, ms<a name='419'>
          z1mult(:,k) = soil%i2bp3 <font color=#447700>! corresponds to 2b+3<a name='420'></font>
        END DO<a name='421'>
        DO k = 2, ms <font color=#447700>! wbh(k) represents wblf(k-.5)<a name='422'></font>
          wbh(:,k) = (soil%zse(k) * ssoil%wblf(:,k-1) + soil%zse(k-1) &amp;<a name='423'>
                   &amp; * ssoil%wblf(:,k) ) / (soil%zse(k) + soil%zse(k-1) )<a name='424'>
          fact = wbh(:,k) ** (soil%ibp2 - 1) <font color=#447700>! i.e. wbh**(bch+1)<a name='425'></font>
          IF (nmeth == 2) pwb_wbh = soil%hsbh * wbh(:,k) * fact<a name='426'>
          IF (nmeth &gt;= 3) pwb_wbh = soil%hsbh * MAX(soil%pwb_min,wbh(:,k)*fact)<a name='427'>
          fact2 = fact * fact<a name='428'>
          <font color=#447700>! moisture diffusivity (D) is  wbh*pwb<a name='429'></font>
          <font color=#447700>! other term (K) is wbh*soil%hyds*fact2<a name='430'></font>
          z1(:,k) = soil%hyds * fact2 <font color=#447700>!  i.e. K(k-.5)/wbh(:,k)<a name='431'></font>
          z3(:,k) = pwb_wbh / soil%zshh(k) <font color=#447700>!  i.e. D(k-.5)/soil%zshh(k)<a name='432'></font>
          at(:,k) = - dtt(:,k) * z3(:,k)<a name='433'>
          ct(:,k-1) = - dtt(:,k-1) * z3(:,k)<a name='434'>
        END DO<a name='435'>
        bt = 1. - at - ct<a name='436'>
        IF (nmeth == 4) THEN <font color=#447700>! for simple implicit D, implicit K<a name='437'></font>
          bt(:,1) = bt(:,1) + dtt(:,1) * z1mult(:,1+1) * z1(:,1+1) &amp;<a name='438'>
                  &amp; * soil%zse(1+1) / (soil%zse(1) + soil%zse(1+1) )<a name='439'>
          DO k = 2, ms<a name='440'>
            at(:,k)   = at(:,k) - dtt(:,k) * z1mult(:,k) * z1(:,k) &amp;<a name='441'>
                      &amp; * soil%zse(k) / (soil%zse(k) + soil%zse(k-1) )<a name='442'>
            ct(:,k-1) = ct(:,k-1) + dtt(:,k-1) * z1mult(:,k) * z1(:,k) &amp;<a name='443'>
                      &amp; * soil%zse(k-1) / (soil%zse(k) + soil%zse(k-1) )<a name='444'>
            bt(:,k) = bt(:,k) - dtt(:,k) * z1mult(:,k) * z1(:,k) &amp;<a name='445'>
                      &amp; * soil%zse(k-1) / (soil%zse(k) + soil%zse(k-1) ) &amp;<a name='446'>
                      &amp; + dtt(:,k) * z1mult(:,k+1) * z1(:,k+1) &amp;<a name='447'>
                      &amp; * soil%zse(k+1) / (soil%zse(k) + soil%zse(k+1) )<a name='448'>
          END DO<a name='449'>
        <font color=#447700>! (nmeth == 4)<a name='450'></font>
        END IF<a name='451'>
        DO k = 2, ms<a name='452'>
          <font color=#447700>! i.e. now K(k-.5)<a name='453'></font>
          z1(:,k) = wbh(:,k) * z1(:,k)<a name='454'>
        END DO<a name='455'>
<a name='456'>
        <font color=#447700>! the following top &amp; bottom b.c.'s will preserve a uniform column<a name='457'></font>
        <font color=#447700>!     z1(1) =z1(2)   ! simple dk/dz=0<a name='458'></font>
        <font color=#447700>!     z1(ms+1)=z1(ms) ! simple dk/dz=0<a name='459'></font>
        <font color=#447700>! N.B. z1 are here +ve<a name='460'></font>
        z1(:,1) = MIN(z1(:,2), z1(:,ms) )<a name='461'>
        z1(:,ms + 1) = z1(:,1)<a name='462'>
        <font color=#447700>! no gravit. term if too much ice 11/12/00<a name='463'></font>
        DO k = 1, ms<a name='464'>
          IF (nmeth == 4) THEN<a name='465'>
            WHERE (wbficemx &lt; 0.75)<a name='466'>
              ssoil%wblf(:,k) = ssoil%wblf(:,k) + dtt(:,k) &amp;<a name='467'>
                              &amp; * ( (z1mult(:,k+1) - 1.0) * z1(:,k+1) &amp;<a name='468'>
                              &amp; - (z1mult(:,k) - 1.0) * z1(:,k) )<a name='469'>
            END WHERE<a name='470'>
          ELSE<a name='471'>
            WHERE (wbficemx &lt; 0.75)<a name='472'>
              ssoil%wblf(:,k) = ssoil%wblf(:,k) + dtt(:,k) &amp;<a name='473'>
                              &amp; * (z1(:,k) - z1(:,k+1) )<a name='474'>
            END WHERE<a name='475'>
          END IF<a name='476'>
        END DO<a name='477'>
      END IF<a name='478'>
      IF (ntest &gt; 0) THEN<a name='479'>
        wblfmx = MAXVAL(REAL(ssoil%wblf,r_1), 2)<a name='480'>
        wblfmn = MINVAL(REAL(ssoil%wblf,r_1), 2)<a name='481'>
      END IF<a name='482'>
      <font color=#447700>! Block below for testing purposes only:<a name='483'></font>
      IF (ntest &gt; 0) THEN<a name='484'>
        totwbb = 0.0<a name='485'>
        totwblb = 0.0<a name='486'>
        DO k = 1, ms<a name='487'>
          <font color=#447700>! diagnostic<a name='488'></font>
          totwbb = totwbb + soil%zse(k) * REAL(ssoil%wb(:,k),r_1)<a name='489'>
          <font color=#447700>! diagnostic<a name='490'></font>
          totwblb = totwblb + soil%zse(k) * REAL(ssoil%wblf(:,k),r_1)<a name='491'>
        END DO<a name='492'>
<font color=#447700>!        PRINT * , 'nmeth, b+2, 2b+3: ',nmeth, soil%ibp2(idjd), soil%i2bp3(idjd)<a name='493'></font>
        WRITE (6, " ('wb   ', 6f8.3) ")  (ssoil%wb(idjd,k), k = 1, ms)<a name='494'>
        WRITE (6, " ('wbice', 6f8.3) ") (ssoil%wbice(idjd,k), k = 1, ms)<a name='495'>
        WRITE (6, " ('wblf ', 6f8.3) ") (ssoil%wblf(idjd,k), k = 1, ms)<a name='496'>
        WRITE (6, " ('wbh  ', 7f8.3) ") wbh(idjd,:)<a name='497'>
        WRITE (6, " ('ssatcurr', 6f8.3) ") ssatcurr(idjd,:)<a name='498'>
<font color=#447700>!        PRINT * , 'pwb_wbh,soil%pwb_min* for ms ', pwb_wbh(idjd), &amp;<a name='499'></font>
<font color=#447700>!                                 &amp; soil%hsbh(idjd) * soil%pwb_min(idjd)<a name='500'></font>
<font color=#447700>!        PRINT * , 'wblfmx,wblfmn', wblfmx(idjd), wblfmn(idjd)<a name='501'></font>
<font color=#447700>!        PRINT * , 'zse ', soil%zse<a name='502'></font>
<font color=#447700>!        PRINT * , 'zshh ', soil%zshh<a name='503'></font>
<font color=#447700>!        PRINT * , 'at ', (at(idjd,k), k = 1, ms)<a name='504'></font>
<font color=#447700>!        PRINT * , 'bt ', (bt(idjd,k), k = 1, ms)<a name='505'></font>
<font color=#447700>!        PRINT * , 'ct ', (ct(idjd,k), k = 1, ms)<a name='506'></font>
      END IF<a name='507'>
      IF (nmeth == 3) THEN<a name='508'>
        <font color=#447700>! artificial fix applied here for safety (explicit nmeth only)<a name='509'></font>
        DO k = 1, ms<a name='510'>
          ssoil%wblf(:,k) = MAX(0.0_r_2, MIN(ssoil%wblf(:,k), 1.0_r_2) )<a name='511'>
        END DO<a name='512'>
        <font color=#447700>! (nmeth == 3)<a name='513'></font>
      END IF<a name='514'>
      ssoil%wblf(:,1) = ssoil%wblf(:,1) + dtt(:,1) * ssoil%fwtop1 / rhowat<a name='515'>
      ssoil%wblf(:,2) = ssoil%wblf(:,2) + dtt(:,2) * ssoil%fwtop2 / rhowat<a name='516'>
      ssoil%wblf(:,3) = ssoil%wblf(:,3) + dtt(:,3) * ssoil%fwtop3 / rhowat<a name='517'>
    END IF  <font color=#447700>! IF (nmeth &gt; 0)<a name='518'></font>
<a name='519'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#TRIMB'>trimb</A><A href='../../html_code/science/cable_soilsnow.F90.html#SMOISTUREV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIMB_1">(at, bt, ct, ssoil%wblf, ms)<a name='520'>
    DO k = 1, ms<a name='521'>
      ssatcurr(:,k) = soil%ssat - ssoil%wbice(:,k)<a name='522'>
      ssoil%wb(:,k) = ssoil%wblf(:,k) * ssatcurr(:,k) + ssoil%wbice(:,k)<a name='523'>
      ssoil%wbice(:,k) = MIN(ssoil%wbice(:,k), 0.85 * ssoil%wb(:,k) )<a name='524'>
    END DO<a name='525'>
    <font color=#447700>! Block below for testing purposes only:<a name='526'></font>
<font color=#447700>!      print *, 'wb   3', (ssoil%wb(idjd,k), k = 1, ms)<a name='527'></font>
<font color=#447700>!      print *, 'wbice3', (ssoil%wbice(idjd,k), k = 1, ms)<a name='528'></font>
<font color=#447700>!      print *, 'wblf 3', (ssoil%wblf(idjd,k), k = 1, ms)<a name='529'></font>
    IF (ntest &gt; 0) THEN<a name='530'>
<font color=#447700>!      PRINT * , 'at end of smoisturev,fwtop ', ssoil%fwtop(idjd)<a name='531'></font>
<font color=#447700>!      PRINT * , 'tgg ', (ssoil%tgg(idjd,k), k = 1, ms)<a name='532'></font>
      WRITE (6, " ('wb   ', 6f8.3) ")  (ssoil%wb(idjd,k), k = 1, ms)<a name='533'>
      WRITE (6, " ('wbice', 6f8.3) ") (ssoil%wbice(idjd,k), k = 1, ms)<a name='534'>
      WRITE (6, " ('wblf ', 6f8.3) ") (ssoil%wblf(idjd,k), k = 1, ms)<a name='535'>
      totwbc = 0.<a name='536'>
      totwblc = 0.<a name='537'>
      DO k = 1, ms<a name='538'>
        totwbc = totwbc + soil%zse(k) * REAL(ssoil%wb(:,k),r_1)<a name='539'>
        totwblc = totwblc + soil%zse(k) * REAL(ssoil%wblf(:,k),r_1)<a name='540'>
      END DO<a name='541'>
<font color=#447700>!      PRINT * , 'totwba,totwbb,totwbc ', totwba(idjd), totwbb(idjd),totwbc(idjd)<a name='542'></font>
<font color=#447700>!      PRINT * , 'totwblb,totwblc ', totwblb(idjd), totwblc(idjd)<a name='543'></font>
    END IF<a name='544'>
  END SUBROUTINE smoisturev<a name='545'>
<a name='546'>
<a name='547'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='548'></font>
<A NAME='SNOWDENSITY'><A href='../../html_code/science/cable_soilsnow.F90.html#SNOWDENSITY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='549'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>snowdensity</font> (dels, ssoil, soil) <A href='../../call_to/SNOWDENSITY.html' TARGET='index'>1</A><a name='550'>
    REAL(r_1), INTENT(IN)   :: dels   <font color=#447700>! integration time step (s)<a name='551'></font>
    TYPE(soil_snow_type),      INTENT(INOUT) :: ssoil  <font color=#447700>! soil+snow variables<a name='552'></font>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='553'>
<a name='554'>
    WHERE (ssoil%snowd &gt; 0.1 .and. ssoil%isflag == 0)<a name='555'>
      ssoil%ssdn(:,1) = MIN(750.0,MAX(120.0, ssoil%ssdn(:,1) + dels &amp;<a name='556'>
          &amp; * ssoil%ssdn(:,1) * 3.1e-6 * EXP( -0.03 &amp;<a name='557'>
          &amp; * (tfrz - MIN(tfrz, ssoil%tgg(:,1) )) &amp;<a name='558'>
          &amp; - merge(0.046, 0.0, ssoil%ssdn(:,1) &gt;= 150.0) &amp;<a name='559'>
          &amp; * (ssoil%ssdn(:,1) - 150.0) ) ))<a name='560'>
      ssoil%ssdn(:,1) = MIN(750.0,ssoil%ssdn(:,1) + dels * 9.806 &amp;<a name='561'>
          &amp; * ssoil%ssdn(:,1) * 0.75 * ssoil%snowd &amp;<a name='562'>
          &amp; / (3.0e7 * EXP(0.021 * ssoil%ssdn(:,1) + 0.081 &amp;<a name='563'>
          &amp; * (tfrz - MIN(tfrz, ssoil%tgg(:,1))))))<a name='564'>
      WHERE (soil%isoilm /= 9) ssoil%ssdn(:,1) = MIN(450.0,ssoil%ssdn(:,1))<a name='565'>
      ssoil%sconds(:,1) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,1) ** 2 &amp;<a name='566'>
                                                        &amp; + 0.074, 2.51) )<a name='567'>
<font color=#447700>!                                                        &amp; + 0.074, 1.0) )<a name='568'></font>
      ssoil%sconds(:,2) = ssoil%sconds(:,1) <a name='569'>
      ssoil%sconds(:,3) = ssoil%sconds(:,1) <a name='570'>
      ssoil%ssdnn = ssoil%ssdn(:,1)<a name='571'>
      ssoil%ssdn(:,2) = ssoil%ssdn(:,1)<a name='572'>
      ssoil%ssdn(:,3) = ssoil%ssdn(:,1)<a name='573'>
    END WHERE<a name='574'>
    WHERE (ssoil%isflag == 1)<a name='575'>
      ssoil%ssdn(:,1) = ssoil%ssdn(:,1) + dels * ssoil%ssdn(:,1) * 3.1e-6 &amp;<a name='576'>
          &amp; * EXP( -0.03 * (tfrz - MIN(tfrz, ssoil%tggsn(:,1))) &amp;<a name='577'>
          &amp; - merge(0.046, 0.0, ssoil%ssdn(:,1) &gt;= 150.0) &amp;<a name='578'>
          &amp; * (ssoil%ssdn(:,1) - 150.0) )<a name='579'>
      ssoil%ssdn(:,2) = ssoil%ssdn(:,2) + dels * ssoil%ssdn(:,2) * 3.1e-6 &amp;<a name='580'>
          &amp; * EXP( -0.03 * (tfrz - MIN(tfrz, ssoil%tggsn(:,2))) &amp;<a name='581'>
          &amp; - merge(0.046, 0.0, ssoil%ssdn(:,2) &gt;= 150.0) &amp;<a name='582'>
          &amp; * (ssoil%ssdn(:,2) - 150.0) )<a name='583'>
      ssoil%ssdn(:,3) = ssoil%ssdn(:,3) + dels * ssoil%ssdn(:,3) * 3.1e-6 &amp;<a name='584'>
          &amp; * EXP( -0.03 * (tfrz - MIN(tfrz, ssoil%tggsn(:,3))) &amp;<a name='585'>
          &amp; - merge(0.046, 0.0, ssoil%ssdn(:,3) &gt;= 150.0) &amp;<a name='586'>
          &amp; * (ssoil%ssdn(:,3) - 150.0) )<a name='587'>
      ssoil%ssdn(:,1) = min( ssoil%ssdn(:,1) + dels * 9.806 * ssoil%ssdn(:,1) &amp;<a name='588'>
          &amp; * ssoil%t_snwlr(:)*ssoil%ssdn(:,1) &amp;<a name='589'>
<font color=#447700>!          &amp; * 0.05*ssoil%ssdn(:,1) &amp;<a name='590'></font>
          &amp; / (3.0e7 * EXP(.021 * ssoil%ssdn(:,1) + 0.081 &amp;<a name='591'>
          &amp; * (tfrz - MIN(tfrz, ssoil%tggsn(:,1))))) , 750.)<a name='592'>
      ssoil%ssdn(:,2) = min( ssoil%ssdn(:,2) + dels * 9.806 * ssoil%ssdn(:,2) &amp;<a name='593'>
<font color=#447700>!          &amp; * (0.05 * ssoil%ssdn(:,1) + 0.5 * ssoil%smass(:,2) ) &amp;<a name='594'></font>
          &amp; * (ssoil%t_snwlr * ssoil%ssdn(:,1) + 0.5 * ssoil%smass(:,2) ) &amp;<a name='595'>
          &amp; / (3.0e7 * EXP(.021 * ssoil%ssdn(:,2) + 0.081 &amp;<a name='596'>
          &amp; * (tfrz - MIN(tfrz, ssoil%tggsn(:,2))))) , 750.)<a name='597'>
      ssoil%ssdn(:,3) = min( ssoil%ssdn(:,3) + dels * 9.806 * ssoil%ssdn(:,3) &amp;<a name='598'>
<font color=#447700>!          &amp; * (0.05*ssoil%ssdn(:,1) + ssoil%smass(:,2) + 0.5*ssoil%smass(:,3)) &amp;<a name='599'></font>
          &amp; * (ssoil%t_snwlr*ssoil%ssdn(:,1) + ssoil%smass(:,2) + 0.5*ssoil%smass(:,3)) &amp;<a name='600'>
          &amp; / (3.0e7 * EXP(.021 * ssoil%ssdn(:,3) + 0.081 &amp;<a name='601'>
          &amp; * (tfrz - MIN(tfrz, ssoil%tggsn(:,3))))) , 750.)<a name='602'>
      WHERE (soil%isoilm /= 9) ssoil%ssdn(:,1) = MIN(450.0,ssoil%ssdn(:,1))<a name='603'>
      WHERE (soil%isoilm /= 9) ssoil%ssdn(:,2) = MIN(450.0,ssoil%ssdn(:,2))<a name='604'>
      WHERE (soil%isoilm /= 9) ssoil%ssdn(:,3) = MIN(450.0,ssoil%ssdn(:,3))<a name='605'>
      ssoil%sdepth(:,1) =  ssoil%smass(:,1) / ssoil%ssdn(:,1) <a name='606'>
      ssoil%sdepth(:,2) =  ssoil%smass(:,2) / ssoil%ssdn(:,2) <a name='607'>
      ssoil%sdepth(:,3) =  ssoil%smass(:,3) / ssoil%ssdn(:,3) <a name='608'>
      ssoil%ssdnn = (ssoil%ssdn(:,1) * ssoil%smass(:,1) + ssoil%ssdn(:,2) &amp;<a name='609'>
             &amp; * ssoil%smass(:,2) + ssoil%ssdn(:,3) * ssoil%smass(:,3) ) &amp;<a name='610'>
             &amp; / ssoil%snowd<a name='611'>
      ssoil%sconds(:,1) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,1) ** 2 &amp;<a name='612'>
                                                        &amp; + 0.074, 2.51) )<a name='613'>
      ssoil%sconds(:,2) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,2) ** 2 &amp;<a name='614'>
                                                        &amp; + 0.074, 2.51) )<a name='615'>
      ssoil%sconds(:,3) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,3) ** 2 &amp;<a name='616'>
                                                        &amp; + 0.074, 2.51) )<a name='617'>
    END WHERE<a name='618'>
<font color=#447700>!    print *,'ssdn &amp; scnd',ssoil%ssdn<a name='619'></font>
<font color=#447700>!    print *,'ssdn &amp; scnda',ssoil%ssdnn<a name='620'></font>
<font color=#447700>!    print *,'ssdn &amp; scnd1',ssoil%snowd<a name='621'></font>
<font color=#447700>!    print *,'ssdn &amp; scnd2',ssoil%sconds<a name='622'></font>
<font color=#447700>!    print *,'ssdn &amp; scnd3',ssoil%ssdn,ssoil%ssdnn,ssoil%snowd,ssoil%sconds<a name='623'></font>
<font color=#447700>!    print *,'ssdn &amp; scnd',mp<a name='624'></font>
<font color=#447700>!    print *,'snowdensity',ssoil%ssdnn<a name='625'></font>
  END SUBROUTINE snowdensity<a name='626'>
<a name='627'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='628'></font>
<A NAME='SNOW_MELTING'><A href='../../html_code/science/cable_soilsnow.F90.html#SNOW_MELTING' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='629'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>snow_melting</font> (dels, snowmlt, ktau, ssoil, soil ) <A href='../../call_to/SNOW_MELTING.html' TARGET='index'>2</A><a name='630'>
    REAL(r_1), INTENT(IN)                 :: dels   <font color=#447700>! integration time step (s)<a name='631'></font>
    REAL(r_1), DIMENSION(mp), INTENT(OUT) :: snowmlt <font color=#447700>! snow melt   <a name='632'></font>
    INTEGER(i_d), INTENT(IN)              :: ktau <font color=#447700>! integration step number<a name='633'></font>
    TYPE(soil_snow_type), INTENT(INOUT)   :: ssoil  <font color=#447700>! soil+snow variables<a name='634'></font>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='635'>
<a name='636'>
    INTEGER(i_d), PARAMETER      :: ntest = 0 <font color=#447700>! for snow diag prints<a name='637'></font>
    INTEGER(i_d)                 :: k<a name='638'>
    REAL(r_1), DIMENSION(mp)     :: osm<a name='639'>
    REAL(r_1), DIMENSION(mp)     :: sgamm<a name='640'>
    REAL(r_1), DIMENSION(mp,0:3) :: smelt1<a name='641'>
    REAL(r_1), DIMENSION(mp)     :: snowflx<a name='642'>
   <a name='643'>
    snowmlt= 0.0<a name='644'>
    smelt1 = 0.0<a name='645'>
<a name='646'>
<font color=#447700>!    ssoil%dtmlt = 0.0<a name='647'></font>
    WHERE (ssoil%snowd &gt; 0.0 .and. ssoil%isflag == 0 &amp;<a name='648'>
                       &amp; .and. ssoil%tgg(:,1) &gt;= tfrz )<a name='649'>
      <font color=#447700>! snow covered land<a name='650'></font>
      <font color=#447700>! following done in sflux  via  ga= ... +cls*egg + ...<a name='651'></font>
      <font color=#447700>! ** land,snow,melting<a name='652'></font>
      snowflx = (ssoil%tgg(:,1) - tfrz) * ssoil%gammzz(:,1)<a name='653'>
<font color=#447700>!      ssoil%dtmlt(:,1) =ssoil%dtmlt(:,1) + max(0.,ssoil%tgg(:,1) - tfrz)<a name='654'></font>
      <font color=#447700>! prevent snow depth going negative<a name='655'></font>
      snowmlt = MIN(snowflx / hlf, ssoil%snowd )<a name='656'>
      ssoil%dtmlt(:,1) = ssoil%dtmlt(:,1) + snowmlt * hlf / ssoil%gammzz(:,1)<a name='657'>
<font color=#447700>!      ssoil%qfsrf = ssoil%qfsrf + snowmlt*hlf/dels<a name='658'></font>
      ssoil%snowd = ssoil%snowd - snowmlt<a name='659'>
      ssoil%tgg(:,1) = ssoil%tgg(:,1) - snowmlt * hlf / ssoil%gammzz(:,1)<a name='660'>
    END WHERE<a name='661'>
<a name='662'>
    smelt1(:,0) = 0.0<a name='663'>
    DO k = 1, 3<a name='664'>
      WHERE (ssoil%snowd &gt; 0.0 .and. ssoil%isflag &gt; 0)<a name='665'>
        sgamm = ssoil%ssdn(:,k) * cgsnow * ssoil%sdepth(:,k)<a name='666'>
        <font color=#447700>! snow melt refreezing<a name='667'></font>
<font color=#447700>!        snowflx = smelt1(:,k-1) * hlf / dels<a name='668'></font>
<font color=#447700>!!        ssoil%tggsn(:,k) = ssoil%tggsn(:,k) + snowflx * dels / sgamm<a name='669'></font>
<font color=#447700>!        ssoil%tggsn(:,k) = ssoil%tggsn(:,k) + ( snowflx * dels +  &amp;<a name='670'></font>
<font color=#447700>!                         &amp; smelt1(:,k-1)*cswat*(tfrz-ssoil%tggsn(:,k)) ) / &amp;<a name='671'></font>
<font color=#447700>!                         &amp; ( sgamm + cswat*smelt1(:,k-1) )<a name='672'></font>
<font color=#447700>!        ! increase density due to snowmelt<a name='673'></font>
<font color=#447700>!        osm = ssoil%smass(:,k)<a name='674'></font>
<font color=#447700>!        ssoil%smass(:,k) = ssoil%smass(:,k) + smelt1(:,k-1)<a name='675'></font>
<font color=#447700>!        ssoil%ssdn(:,k) = MAX(120.0,MIN(ssoil%ssdn(:,k) * osm/ssoil%smass(:,k) &amp;<a name='676'></font>
<font color=#447700>!                        &amp; + rhowat*(1.0-osm/ssoil%smass(:,k)), 750.0))<a name='677'></font>
<font color=#447700>!        WHERE (soil%isoilm /= 9) ssoil%ssdn(:,k) = MIN(450.0,ssoil%ssdn(:,k))<a name='678'></font>
<font color=#447700>!        ssoil%sdepth(:,k) = ssoil%smass(:,k) / ssoil%ssdn(:,k)<a name='679'></font>
<font color=#447700>!        sgamm = ssoil%smass(:,k) * cgsnow<a name='680'></font>
<font color=#447700>!        smelt1(:,k-1) = 0.0<a name='681'></font>
        smelt1(:,k) = 0.0<a name='682'>
<font color=#447700>!        ! snow melting<a name='683'></font>
<font color=#447700>!        ssoil%dtmlt(:,k) = 0.0<a name='684'></font>
        WHERE (ssoil%tggsn(:,k) &gt; tfrz)<a name='685'>
          snowflx = (ssoil%tggsn(:,k) - tfrz) * sgamm<a name='686'>
<font color=#447700>!          ssoil%dtmlt(:,k) = ssoil%dtmlt(:,k)+ max(0.,ssoil%tggsn(:,k) - tfrz)<a name='687'></font>
          smelt1(:,k) = MIN(snowflx / hlf, 0.6 * ssoil%smass(:,k) )<a name='688'>
          ssoil%dtmlt(:,k) = ssoil%dtmlt(:,k) + smelt1(:,k) * hlf / sgamm<a name='689'>
          osm = ssoil%smass(:,k)<a name='690'>
          ssoil%smass(:,k) = ssoil%smass(:,k) - smelt1(:,k)<a name='691'>
          ssoil%tggsn(:,k) = ssoil%tggsn(:,k) - smelt1(:,k) * hlf / sgamm<a name='692'>
<font color=#447700>!          ssoil%tggsn(:,k) = MIN(ssoil%tggsn(:,k) - smelt1(:,k) * hlf / sgamm, &amp;<a name='693'></font>
<font color=#447700>!                               &amp; tfrz)<a name='694'></font>
          ssoil%sdepth(:,k) = ssoil%smass(:,k) / ssoil%ssdn(:,k)<a name='695'>
        END WHERE<a name='696'>
      END WHERE<a name='697'>
    END DO<a name='698'>
    WHERE (ssoil%snowd &gt; 0.0 .and. ssoil%isflag &gt; 0)<a name='699'>
      snowmlt = smelt1(:,1) + smelt1(:,2) + smelt1(:,3)<a name='700'>
<font color=#447700>!      ssoil%qfsrf = ssoil%qfsrf + snowmlt*hlf/dels<a name='701'></font>
      ssoil%snowd = ssoil%snowd - snowmlt<a name='702'>
    END WHERE<a name='703'>
<font color=#447700>!    print *,'snowmelt routine',ssoil%snowd,snowmlt,smelt1(1,:)<a name='704'></font>
<font color=#447700>!    print *,'snowmelt routine',ssoil%tggsn(1,:)<a name='705'></font>
  END SUBROUTINE snow_melting<a name='706'>
<a name='707'>
<a name='708'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='709'></font>
<A NAME='SNOW_ACCUM'><A href='../../html_code/science/cable_soilsnow.F90.html#SNOW_ACCUM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='710'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>snow_accum</font> (dels,  ktau, canopy, met, ssoil, soil) <A href='../../call_to/SNOW_ACCUM.html' TARGET='index'>1</A><a name='711'>
    REAL(r_1), INTENT(IN)                    :: dels   <font color=#447700>! integration time step (s)<a name='712'></font>
    INTEGER(i_d), INTENT(IN)                 :: ktau <font color=#447700>! integration step number<a name='713'></font>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy <font color=#447700>! vegetation variables<a name='714'></font>
    TYPE(met_type), INTENT(INOUT)            :: met   <font color=#447700>! all met forcing<a name='715'></font>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil <font color=#447700>! soil+snow variables<a name='716'></font>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil <font color=#447700>! soil parameters<a name='717'></font>
    INTEGER(i_d), PARAMETER  :: ntest = 0 <font color=#447700>! for snow diag prints<a name='718'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp) :: evapsn   ! now put in soil_snow_type EAK aug08<a name='719'></font>
    INTEGER(i_d)             :: k<a name='720'>
    REAL(r_1), DIMENSION(mp) :: osm<a name='721'>
    REAL(r_1), DIMENSION(mp) :: sgamm<a name='722'>
<font color=#447700>!    REAL(r_1), DIMENSION(mp) :: snowmlt<a name='723'></font>
    REAL(r_1), DIMENSION(mp) :: xxx<a name='724'>
    <font color=#447700>!<a name='725'></font>
    IF (ntest &gt; 0) THEN<a name='726'>
      PRINT * , 'surfb1'<a name='727'>
      PRINT * , 'entering snow_accum', canopy%precis(idjd)<a name='728'>
      PRINT * , 'osnowd,snowd,isflag', ssoil%osnowd(idjd), &amp;<a name='729'>
                  &amp; ssoil%snowd(idjd), ssoil%isflag(idjd)<a name='730'>
      PRINT * , 'tggsn ', (ssoil%tggsn(idjd,k), k = 1, 3)<a name='731'>
      PRINT * , 'tgg ', (ssoil%tgg(idjd,k), k = 1, ms)<a name='732'>
      PRINT * , 'wb ', (ssoil%wb(idjd,k), k = 1, ms)<a name='733'>
      PRINT * , 'wbice ', (ssoil%wbice(idjd,k), k = 1, ms)<a name='734'>
      PRINT * , 'gammzz ', (ssoil%gammzz(idjd,k), k = 1, ms)<a name='735'>
      PRINT * , 'albnew ', (ssoil%albsoilsn(idjd,k), k = 1, 2)<a name='736'>
    END IF<a name='737'>
<a name='738'>
<font color=#447700>!    snowmlt =0.0<a name='739'></font>
<a name='740'>
<font color=#447700>!    WHERE (canopy%precis &gt; 0.)  ! precis is both liquid and snow<a name='741'></font>
    WHERE (canopy%precis &gt; 0.0 .and. ssoil%isflag == 0)<a name='742'>
      ssoil%snowd = MAX(ssoil%snowd + met%precip_sn, 0.0) <font color=#447700>! accumulate solid part<a name='743'></font>
      canopy%precis = canopy%precis - met%precip_sn<a name='744'>
      ssoil%ssdn(:,1) = MAX(120.0, ssoil%ssdn(:,1) &amp;<a name='745'>
                      &amp; * ssoil%osnowd / MAX(0.01, ssoil%snowd) &amp;<a name='746'>
                      &amp; + 120.0 * met%precip_sn / MAX(0.01, ssoil%snowd))<a name='747'>
      ssoil%ssdnn = ssoil%ssdn(:,1)<a name='748'>
<font color=#447700>!      WHERE (canopy%precis &gt; 0.0 .and. ssoil%tgg(:,1) &lt; tfrz)<a name='749'></font>
<font color=#447700>!        ssoil%snowd = MAX(ssoil%snowd + canopy%precis, 0.0)<a name='750'></font>
<font color=#447700>!!        ssoil%tgg(:,1) = ssoil%tgg(:,1) + canopy%precis * hlf &amp;<a name='751'></font>
<font color=#447700>!!                       &amp; / REAL(ssoil%gammzz(:,1),r_1) + &amp;<a name='752'></font>
<font color=#447700>!        ssoil%tgg(:,1) = ssoil%tgg(:,1) + canopy%precis *  &amp;<a name='753'></font>
<font color=#447700>!              &amp; ( hlf + cswat*(tfrz-ssoil%tgg(:,1)) ) /  &amp;<a name='754'></font>
<font color=#447700>!              &amp; ( REAL(ssoil%gammzz(:,1),r_1) + cswat*canopy%precis )  <a name='755'></font>
<font color=#447700>!        ! change density due to water being added <a name='756'></font>
<font color=#447700>!        ssoil%ssdn(:,1) = MIN(750.0, MAX(120.0, ssoil%ssdn(:,1) &amp;<a name='757'></font>
<font color=#447700>!                        &amp; * ssoil%osnowd / MAX(0.01, ssoil%snowd) &amp;<a name='758'></font>
<font color=#447700>!                        &amp; + rhowat * canopy%precis / MAX(0.01, ssoil%snowd)))<a name='759'></font>
<font color=#447700>!        WHERE (soil%isoilm /= 9) ssoil%ssdn(:,1) = MIN(450.0,ssoil%ssdn(:,1))<a name='760'></font>
<font color=#447700>!!        ssoil%tgg(:,1) = ssoil%tgg(:,1) + canopy%precis * hlf  &amp;<a name='761'></font>
<font color=#447700>!!                         / (ssoil%gammzz(:,1) + cswat * canopy%precis)<a name='762'></font>
<font color=#447700>!!        ssoil%qasrf = ssoil%qasrf + canopy%precis * hlf/ dels<a name='763'></font>
<font color=#447700>!        canopy%precis = 0.0<a name='764'></font>
<font color=#447700>!        ssoil%ssdnn = ssoil%ssdn(:,1)<a name='765'></font>
<font color=#447700>!      END WHERE<a name='766'></font>
    END WHERE <font color=#447700>! (canopy%precis &gt; 0. .and. ssoil%isflag == 0) <a name='767'></font>
<font color=#447700>!    PRINT * , 'surfb2',ssoil%snowd,ssoil%osnowd<a name='768'></font>
    WHERE (canopy%precis &gt; 0.0 .and.  ssoil%isflag &gt; 0)<a name='769'>
      <font color=#447700>! add solid precip<a name='770'></font>
<font color=#447700>!      ssoil%qasrf = ssoil%qasrf + canopy%precis * hlf/dels<a name='771'></font>
      ssoil%snowd = MAX(ssoil%snowd + met%precip_sn, 0.0)<a name='772'>
      canopy%precis = canopy%precis - met%precip_sn  <font color=#447700>! remaining liquid precip<a name='773'></font>
      <font color=#447700>! update top snow layer with fresh snow<a name='774'></font>
      osm = ssoil%smass(:,1)<a name='775'>
      ssoil%smass(:,1) = ssoil%smass(:,1) + met%precip_sn<a name='776'>
      ssoil%ssdn(:,1) = MAX(120.0,ssoil%ssdn(:,1)*osm/ssoil%smass(:,1) &amp;<a name='777'>
                      &amp; + 120.0 * met%precip_sn/ssoil%smass(:,1))<a name='778'>
      ssoil%sdepth(:,1) = MAX(0.02,ssoil%smass(:,1) / ssoil%ssdn(:,1))<a name='779'>
      <font color=#447700>! add liquid precip<a name='780'></font>
      <font color=#447700>!WHERE (canopy%precis &gt; 0.0)<a name='781'></font>
      <font color=#447700>!  ssoil%snowd = MAX(ssoil%snowd + canopy%precis, 0.0)<a name='782'></font>
      <font color=#447700>!  sgamm = ssoil%ssdn(:,1) * cgsnow * ssoil%sdepth(:,1)<a name='783'></font>
      <font color=#447700>!  osm = ssoil%smass(:,1)<a name='784'></font>
<font color=#447700>!     !   ssoil%tggsn(:,1) = ssoil%tggsn(:,1) + canopy%precis * hlf &amp;<a name='785'></font>
<font color=#447700>!     !                    &amp; * osm / (sgamm * ssoil%osnowd )<a name='786'></font>
<font color=#447700>!!    !                    * ssoil%smass(:,1) / (sgamm * ssoil%osnowd )<a name='787'></font>
      <font color=#447700>!  ssoil%tggsn(:,1) = ssoil%tggsn(:,1) + canopy%precis *  &amp;<a name='788'></font>
      <font color=#447700>!                   &amp; ( hlf + cswat*(tfrz-ssoil%tggsn(:,1)) )* osm/ssoil%osnowd  &amp;<a name='789'></font>
      <font color=#447700>!                   &amp; / (sgamm + cswat*canopy%precis*osm/ssoil%osnowd)<a name='790'></font>
      <font color=#447700>!  ssoil%smass(:,1) = ssoil%smass(:,1) + canopy%precis &amp;<a name='791'></font>
      <font color=#447700>!                   &amp; * osm/ssoil%osnowd<a name='792'></font>
<font color=#447700>!     !                   * ssoil%smass(:,1)/ssoil%osnowd<a name='793'></font>
      <font color=#447700>!  ssoil%ssdn(:,1) = MAX(120.0,MIN(ssoil%ssdn(:,1) * osm/ssoil%smass(:,1) &amp;<a name='794'></font>
      <font color=#447700>!                  &amp; +  rhowat*(1.0-osm/ssoil%smass(:,1)), 750.0))<a name='795'></font>
      <font color=#447700>!  WHERE (soil%isoilm /= 9) ssoil%ssdn(:,1) = MIN(450.0,ssoil%ssdn(:,1))<a name='796'></font>
      <font color=#447700>!  ssoil%sdepth(:,1) = ssoil%smass(:,1)/ssoil%ssdn(:,1)<a name='797'></font>
<font color=#447700>!<a name='798'></font>
<font color=#447700>!        sgamm = ssoil%ssdn(:,2) * cgsnow * ssoil%sdepth(:,2)<a name='799'></font>
<font color=#447700>!        osm = ssoil%smass(:,2)<a name='800'></font>
<font color=#447700>!!        ssoil%tggsn(:,2) = ssoil%tggsn(:,2) + canopy%precis * hlf &amp;<a name='801'></font>
<font color=#447700>!!                         &amp; * osm / (sgamm * ssoil%osnowd )<a name='802'></font>
<font color=#447700>!!!                        * ssoil%smass(:,2) / (sgamm * ssoil%osnowd )<a name='803'></font>
<font color=#447700>!        ssoil%tggsn(:,2) = ssoil%tggsn(:,2) + canopy%precis * &amp;<a name='804'></font>
<font color=#447700>!                         &amp; ( hlf + cswat*(tfrz-ssoil%tggsn(:,2)) )* osm/ssoil%osnowd  &amp;<a name='805'></font>
<font color=#447700>!                         &amp; / (sgamm + cswat*canopy%precis*osm/ssoil%osnowd)<a name='806'></font>
<font color=#447700>!        ssoil%smass(:,2) = ssoil%smass(:,2) + canopy%precis &amp;<a name='807'></font>
<font color=#447700>!                         &amp; * osm/ssoil%osnowd<a name='808'></font>
<font color=#447700>!!                        ssoil%smass(:,2)/ssoil%osnowd<a name='809'></font>
<font color=#447700>!        ssoil%ssdn(:,2) = MAX(120.0,MIN(ssoil%ssdn(:,2) * osm/ssoil%smass(:,2) &amp;<a name='810'></font>
<font color=#447700>!                        &amp; + rhowat*(1.0-osm/ssoil%smass(:,2)), 750.0))<a name='811'></font>
<font color=#447700>!        WHERE (soil%isoilm /= 9) ssoil%ssdn(:,2) = MIN(450.0,ssoil%ssdn(:,2))<a name='812'></font>
<font color=#447700>!        ssoil%sdepth(:,2) = ssoil%smass(:,2) / ssoil%ssdn(:,2)<a name='813'></font>
<font color=#447700>!<a name='814'></font>
<font color=#447700>!        sgamm = ssoil%ssdn(:,3) * cgsnow * ssoil%sdepth(:,3)<a name='815'></font>
<font color=#447700>!        osm = ssoil%smass(:,3)<a name='816'></font>
<font color=#447700>!!        ssoil%tggsn(:,3) = ssoil%tggsn(:,3) + canopy%precis * hlf &amp;<a name='817'></font>
<font color=#447700>!!                         &amp; * osm / (sgamm * ssoil%osnowd )<a name='818'></font>
<font color=#447700>!        ssoil%tggsn(:,3) = ssoil%tggsn(:,3) + canopy%precis *  &amp;<a name='819'></font>
<font color=#447700>!                        &amp; ( hlf + cswat*(tfrz-ssoil%tggsn(:,3)) ) * osm/ssoil%osnowd  &amp;<a name='820'></font>
<font color=#447700>!                        &amp; / (sgamm + cswat*canopy%precis*osm/ssoil%osnowd)<a name='821'></font>
<font color=#447700>!        ssoil%smass(:,3) = ssoil%smass(:,3) + canopy%precis &amp;<a name='822'></font>
<font color=#447700>!                         &amp; * osm/ssoil%osnowd<a name='823'></font>
<font color=#447700>!!                        * ssoil%smass(:,3)/ssoil%osnowd<a name='824'></font>
<font color=#447700>!        ssoil%ssdn(:,3) = MAX(120.0,MIN(ssoil%ssdn(:,3) * osm/ssoil%smass(:,3) &amp;<a name='825'></font>
<font color=#447700>!                        &amp; + rhowat*(1.0-osm/ssoil%smass(:,3)), 750.0))<a name='826'></font>
<font color=#447700>!        WHERE (soil%isoilm /= 9)  ssoil%ssdn(:,3) = MIN(450.0,ssoil%ssdn(:,3))<a name='827'></font>
<font color=#447700>!        ssoil%sdepth(:,3) = ssoil%smass(:,3)/ssoil%ssdn(:,3)<a name='828'></font>
<font color=#447700>!<a name='829'></font>
<font color=#447700>!        canopy%precis = 0.0<a name='830'></font>
<font color=#447700>!<a name='831'></font>
<font color=#447700>!      END WHERE<a name='832'></font>
    END WHERE<a name='833'>
<a name='834'>
<font color=#447700>!    WHERE (ssoil%snowd &lt; 0.1 .and. canopy%fess .gt. 0.0)<a name='835'></font>
<font color=#447700>!      canopy%fess = MIN(canopy%fess, &amp;<a name='836'></font>
<font color=#447700>!                 &amp; MAX(0.0,REAL(ssoil%wb(:,1),r_1)-soil%swilt/3.0)* soil%zse(1) &amp; ! allow the top soil<a name='837'></font>
<font color=#447700>!                 &amp; * 1000.0 * hl / dels)                                        ! moisture below wilting<a name='838'></font>
<font color=#447700>!      canopy%fess = MIN(canopy%fess, &amp;<a name='839'></font>
<font color=#447700>!                 &amp; REAL((ssoil%wb(:,1)-ssoil%wbice(:,1)),r_1) * soil%zse(1) &amp;<a name='840'></font>
<font color=#447700>!                 &amp; * 1000.0 * hl / dels)<a name='841'></font>
<font color=#447700>!    END WHERE<a name='842'></font>
    <font color=#447700>! Calculate snow evaporation total in mm (from W/m2):<a name='843'></font>
    <font color=#447700>! EAK 'fess' is for soil evap and 'fes' is for soil evap plus soil puddle evap<a name='844'></font>
    canopy%segg = canopy%fess / hl<a name='845'>
    WHERE (ssoil%snowd &gt; 0.1) canopy%segg = canopy%fess / (hl + hlf) <font color=#447700>! EAK aug08<a name='846'></font>
    <font color=#447700>! Initialise snow evaporation:<a name='847'></font>
    ssoil%evapsn = 0<a name='848'>
<font color=#447700>!    ssoil%qssrf = 0.0<a name='849'></font>
    WHERE (ssoil%snowd &gt; 0.1 ) ssoil%evapsn = dels * canopy%fess / ( hl + hlf )<a name='850'>
    <font color=#447700>! Snow evaporation from 1 snow layer<a name='851'></font>
    WHERE (ssoil%snowd &gt; 0.1 .and. ssoil%isflag == 0 .and. canopy%fess &gt; 0.0)<a name='852'>
      ssoil%evapsn = MIN(ssoil%snowd, ssoil%evapsn ) <a name='853'>
      ssoil%snowd = ssoil%snowd - ssoil%evapsn<a name='854'>
      canopy%segg = 0.0<a name='855'>
    END WHERE<a name='856'>
    <font color=#447700>! dew on snow<a name='857'></font>
    WHERE (ssoil%snowd &gt; 0.1 .and. ssoil%isflag == 0 .and. canopy%fess &lt; 0.0)<a name='858'>
      ssoil%snowd = ssoil%snowd - ssoil%evapsn<a name='859'>
      canopy%segg = 0.0<a name='860'>
      <font color=#447700>!canopy%fess = ssoil%evapsn * (hl + hlf) / dels ! return for hyd. balance<a name='861'></font>
    END WHERE<a name='862'>
    <font color=#447700>! Snow evaporation from 3 snow layers<a name='863'></font>
    WHERE (ssoil%snowd &gt; 0.1 .and. ssoil%isflag &gt; 0 .and. canopy%fess &gt; 0.0)<a name='864'>
      ssoil%evapsn = MIN(0.9*ssoil%smass(:,1), ssoil%evapsn )<a name='865'>
      ssoil%snowd = ssoil%snowd - ssoil%evapsn<a name='866'>
      ssoil%smass(:,1) = ssoil%smass(:,1)  - ssoil%evapsn<a name='867'>
      ssoil%sdepth(:,1) = MAX(0.02,ssoil%smass(:,1) / ssoil%ssdn(:,1))<a name='868'>
      canopy%segg = 0.0<a name='869'>
    END WHERE<a name='870'>
    <font color=#447700>! dew on snow<a name='871'></font>
    WHERE (ssoil%snowd &gt; 0.1 .and. ssoil%isflag &gt; 0 .and. canopy%fess &lt; 0.0)<a name='872'>
      ssoil%snowd = ssoil%snowd - ssoil%evapsn<a name='873'>
      ssoil%smass(:,1) = ssoil%smass(:,1)  - ssoil%evapsn<a name='874'>
      ssoil%sdepth(:,1) = MAX(0.02,ssoil%smass(:,1) / ssoil%ssdn(:,1))<a name='875'>
      canopy%segg = 0.0<a name='876'>
    END WHERE<a name='877'>
<a name='878'>
<a name='879'>
  END SUBROUTINE snow_accum <a name='880'>
<a name='881'>
<a name='882'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='883'></font>
<A NAME='SURFBV'><A href='../../html_code/science/cable_soilsnow.F90.html#SURFBV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='884'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>surfbv</font> (dels, ktau, met, ssoil, soil, veg, canopy ) <A href='../../call_to/SURFBV.html' TARGET='index'>1</A>,<A href='../../call_from/SURFBV.html' TARGET='index'>1</A><a name='885'>
    REAL(r_1), INTENT(IN)                    :: dels   <font color=#447700>! integration time step (s)<a name='886'></font>
    INTEGER(i_d), INTENT(IN)                 :: ktau <font color=#447700>! integration step number<a name='887'></font>
    TYPE(met_type), INTENT(INOUT)            :: met    <font color=#447700>! all met forcing<a name='888'></font>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil  <font color=#447700>! soil+snow variables<a name='889'></font>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil <font color=#447700>! soil parameters<a name='890'></font>
    TYPE (veg_parameter_type), INTENT(IN)    :: veg<a name='891'>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy<a name='892'>
    INTEGER(i_d), PARAMETER      :: ntest = 0 <font color=#447700>! for snow diag prints<a name='893'></font>
<font color=#447700>!    INTEGER(i_d), PARAMETER      :: nglacier = 0 ! 0 original, 1 off, 2 new Eva<a name='894'></font>
    INTEGER(i_d), PARAMETER      :: nglacier = 2 <font color=#447700>! 0 original, 1 off, 2 new Eva<a name='895'></font>
    INTEGER(i_d)                 :: k<a name='896'>
    REAL(r_1), DIMENSION(mp)     :: rnof5<a name='897'>
    REAL(r_1), DIMENSION(mp)     :: sfact<a name='898'>
    REAL(r_1), DIMENSION(mp)     :: sgamm<a name='899'>
    REAL(r_1), DIMENSION(mp)     :: smasstot<a name='900'>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: snr<a name='901'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: snrat<a name='902'></font>
    REAL(r_1), DIMENSION(mp,0:3) :: smelt1<a name='903'>
    REAL(r_1), DIMENSION(mp)     :: talb <font color=#447700>! snow albedo<a name='904'></font>
    REAL(r_1), DIMENSION(mp)     :: tmp <font color=#447700>! temporary value<a name='905'></font>
    REAL(r_1), DIMENSION(mp)     :: xxx<a name='906'>
<a name='907'>
<a name='908'>
<a name='909'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SMOISTUREV'>smoisturev</A><A href='../../html_code/science/cable_soilsnow.F90.html#SURFBV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SMOISTUREV_1"> ( dels, ktau, ssoil, soil)<a name='910'>
<a name='911'>
    <font color=#447700>! Diagnostic block below:<a name='912'></font>
    IF (ntest &gt; 0) THEN<a name='913'>
      PRINT * , 'in surfbv after smoisturev '<a name='914'>
      PRINT * , 'osnowd,snowd,isflag,ssat,runoff', ssoil%osnowd(idjd), &amp;<a name='915'>
       &amp; ssoil%snowd(idjd),ssoil%isflag(idjd),soil%ssat(idjd),ssoil%runoff(idjd)<a name='916'>
      PRINT * , 'tggsn_d ', (ssoil%tggsn(idjd,k), k = 1, 3)<a name='917'>
    END IF<a name='918'>
    DO k = 1, ms<a name='919'>
      xxx = REAL(soil%ssat,r_2)<a name='920'>
      ssoil%rnof1 = ssoil%rnof1 + REAL((MAX(ssoil%wb(:,k) - xxx, 0.0_r_2) &amp;<a name='921'>
                                &amp; * 1000.0),r_1) * soil%zse(k)<a name='922'>
      ssoil%wb(:,k) = MIN( ssoil%wb(:,k), xxx )<a name='923'>
<font color=#447700>!      ssoil%wb(:,k) = MIN( ssoil%wb(:,k), soil%ssat )<a name='924'></font>
    END DO<a name='925'>
    <font color=#447700>!  for deep runoff use wb-sfc, but this value not to exceed .99*wb-wbice<a name='926'></font>
    <font color=#447700>!  account for soil/ice cracking<a name='927'></font>
<font color=#447700>!    fracm = MIN(0.2, 1. - MIN(1., ssoil%wb(:,ms) / soil%sfc ) )<a name='928'></font>
<font color=#447700>!    ssoil%wb(:,ms) = ssoil%wb(:,ms) + fracm*ssoil%rnof1/(1000.0*soil%zse(ms))<a name='929'></font>
<font color=#447700>!    ssoil%rnof1 = (1. - fracm) * ssoil%rnof1 <a name='930'></font>
<font color=#447700>!    the code below is replaced, see subroutine smoistv <a name='931'></font>
<font color=#447700>!    tmp = MAX(MIN(ssoil%wb(:,ms) - soil%sfc, .99 * ssoil%wb(:,ms) &amp;<a name='932'></font>
<font color=#447700>!         - ssoil%wbice(:,ms) ) * soil%c3 / 86400., 0.)<a name='933'></font>
<font color=#447700>!    ssoil%rnof2 = soil%zse(ms) * 1000. * tmp * dels<a name='934'></font>
<font color=#447700>!    ssoil%wb(:,ms) = ssoil%wb(:,ms) - tmp * dels<a name='935'></font>
<font color=#447700>!   Scaling  runoff to kg/m^2/s to match rest of the model   <a name='936'></font>
<a name='937'>
<font color=#447700>! correct for water imbalance in the lakes<a name='938'></font>
    ssoil%sinfil = 0.0<a name='939'>
    where  ( veg%iveg == 16 )<a name='940'>
      ssoil%sinfil = min( ssoil%rnof1, ssoil%wb_lake + max(0.,canopy%segg)) <a name='941'>
      ssoil%rnof1 = max( 0.0, ssoil%rnof1 - ssoil%sinfil ) <a name='942'>
      ssoil%wb_lake = ssoil%wb_lake - ssoil%sinfil<a name='943'>
      ssoil%rnof2 = max( 0.0, ssoil%rnof2 - ssoil%wb_lake )<a name='944'>
    endwhere        <a name='945'>
<font color=#447700>!<a name='946'></font>
    ssoil%wbtot = 0.0<a name='947'>
    DO k = 1, ms<a name='948'>
      ssoil%wbtot = ssoil%wbtot + REAL(ssoil%wb(:,k),r_1) * 1000.0 * soil%zse(k)<a name='949'>
    END DO<a name='950'>
    <font color=#447700>!<a name='951'></font>
    <font color=#447700>!---  glacier formation<a name='952'></font>
    rnof5 = 0.0<a name='953'>
    IF (nglacier == 2) THEN<a name='954'>
      smelt1 = 0.0<a name='955'>
      WHERE (ssoil%snowd &gt; 1100.0)<a name='956'>
       rnof5 = ssoil%snowd - 1100.0<a name='957'>
<font color=#447700>!      rnof5 = min(0.1,ssoil%snowd - 1100.0)<a name='958'></font>
<font color=#447700>!        ssoil%runoff = ssoil%runoff + rnof5<a name='959'></font>
        <font color=#447700>!---- change local tg to account for energy - clearly not best method<a name='960'></font>
        WHERE (ssoil%isflag == 0)<a name='961'>
          smasstot = 0.0<a name='962'>
<font color=#447700>!          Ignore local energy correction<a name='963'></font>
<font color=#447700>!          ssoil%tgg(:,1) = ssoil%tgg(:,1) - rnof5 * hlf &amp;<a name='964'></font>
<font color=#447700>!                         &amp; / REAL(ssoil%gammzz(:,1),r_1)<a name='965'></font>
          ssoil%snowd = ssoil%snowd - rnof5<a name='966'>
        ELSEWHERE<a name='967'>
          smasstot = ssoil%smass(:,1) + ssoil%smass(:,2) + ssoil%smass(:,3)<a name='968'>
        END WHERE<a name='969'>
      END WHERE<a name='970'>
      DO k = 1, 3<a name='971'>
        WHERE (ssoil%snowd &gt; 1100.0  .and.  ssoil%isflag &gt; 0)<a name='972'>
          sgamm = ssoil%ssdn(:,k) * cgsnow * ssoil%sdepth(:,k)<a name='973'>
          smelt1(:,k) = MIN(rnof5 * ssoil%smass(:,k) / smasstot, &amp;<a name='974'>
                          &amp; 0.2 * ssoil%smass(:,k) )<a name='975'>
          ssoil%smass(:,k) = ssoil%smass(:,k) - smelt1(:,k)<a name='976'>
          ssoil%snowd = ssoil%snowd - smelt1(:,k)<a name='977'>
<font color=#447700>!          Ignore local energy correction<a name='978'></font>
<font color=#447700>!          ssoil%tggsn(:,k) = ssoil%tggsn(:,k) - smelt1(:,k) * hlf / sgamm<a name='979'></font>
        END WHERE<a name='980'>
      END DO<a name='981'>
      WHERE (ssoil%isflag &gt; 0 ) rnof5 = smelt1(:,1)+smelt1(:,2)+smelt1(:,3)<a name='982'>
    END IF<a name='983'>
<a name='984'>
    ssoil%rnof1 = ssoil%rnof1 / dels + rnof5/dels<a name='985'>
    ssoil%rnof2 = ssoil%rnof2 / dels<a name='986'>
    ssoil%runoff = ssoil%rnof1 + ssoil%rnof2 <a name='987'>
<a name='988'>
    <font color=#447700>! Diagnostic block below:<a name='989'></font>
    IF (ntest &gt; 0) THEN<a name='990'>
      PRINT * , 'end surfbv  rnof1,runoff ',ssoil%rnof1(idjd),ssoil%runoff(idjd)<a name='991'>
      sgamm = ssoil%ssdn(:,1) * cgsnow * ssoil%sdepth(:,1)<a name='992'>
      PRINT * , 'snowd,isflag,sgamm ', ssoil%snowd(idjd), ssoil%isflag(idjd), &amp;<a name='993'>
                                     &amp; sgamm(idjd)<a name='994'>
      PRINT * , 'tggsn_d ', (ssoil%tggsn(idjd,k), k = 1, 3)<a name='995'>
      PRINT * , 'tgg ', (ssoil%tgg(idjd,k), k = 1, ms)<a name='996'>
      PRINT * , 'wb ', (ssoil%wb(idjd,k), k = 1, ms)<a name='997'>
    END IF<a name='998'>
  END SUBROUTINE surfbv<a name='999'>
<a name='1000'>
<a name='1001'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='1002'></font>
<font color=#447700>!  SUBROUTINE snow_albedo (dels, ktau, met, ssoil, soil )<a name='1003'></font>
<font color=#447700>!    REAL(r_1), INTENT(IN)                    :: dels   ! integration time step (s)<a name='1004'></font>
<font color=#447700>!    INTEGER(i_d), INTENT(IN)                 :: ktau ! integration step number<a name='1005'></font>
<font color=#447700>!    TYPE(met_type), INTENT(INOUT)            :: met    ! all met forcing<a name='1006'></font>
<font color=#447700>!    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil  ! soil+snow variables<a name='1007'></font>
<font color=#447700>!    TYPE(soil_parameter_type), INTENT(INOUT) :: soil ! soil parameters<a name='1008'></font>
<font color=#447700>!    INTEGER(i_d), PARAMETER      :: ntest = 0 ! for snow diag prints<a name='1009'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: alv ! Snow albedo for visible<a name='1010'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: alir ! Snow albedo for near infra-red (NIR)<a name='1011'></font>
<font color=#447700>!    REAL(r_1), PARAMETER         :: alvo  = 0.95 ! albedo for vis. on new snow<a name='1012'></font>
<font color=#447700>!    REAL(r_1), PARAMETER         :: aliro = 0.65 ! albedo for NIR on new snow<a name='1013'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: ar1 ! crystal growth  (-ve)<a name='1014'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: ar2 ! freezing of melt water<a name='1015'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: ar3<a name='1016'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: dnsnow ! new snow albedo<a name='1017'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: dtau<a name='1018'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: fage !age factor<a name='1019'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: fzenm<a name='1020'></font>
<font color=#447700>!    INTEGER(i_d)                 :: k<a name='1021'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: sfact<a name='1022'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: sgamm<a name='1023'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: smasstot<a name='1024'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: snr<a name='1025'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: snrat<a name='1026'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp,0:3) :: smelt1<a name='1027'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: talb ! snow albedo<a name='1028'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: tmp ! temporary value<a name='1029'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp)     :: xxx<a name='1030'></font>
<a name='1031'>
<font color=#447700>!    !	 calculate soil/snow albedo<a name='1032'></font>
<font color=#447700>!    !	  cuvrf(i,1) = albsav(iq) ! use surface albedo from indata<a name='1033'></font>
<font color=#447700>!    sfact = 0.68<a name='1034'></font>
<font color=#447700>!    WHERE (soil%albsoil &lt;= 0.14)<a name='1035'></font>
<font color=#447700>!      sfact = 0.5<a name='1036'></font>
<font color=#447700>!    ELSEWHERE (soil%albsoil &gt; 0.14 .and. soil%albsoil &lt;= 0.20)<a name='1037'></font>
<font color=#447700>!      sfact = 0.62<a name='1038'></font>
<font color=#447700>!    END WHERE<a name='1039'></font>
<font color=#447700>!    ssoil%albsoilsn(:,2) = 2. * soil%albsoil / (1.0 + sfact)<a name='1040'></font>
<font color=#447700>!    ssoil%albsoilsn(:,1) = sfact * ssoil%albsoilsn(:,2)<a name='1041'></font>
<font color=#447700>!    ! new snow albedo (needs osnowd from the previous dels)<a name='1042'></font>
<font color=#447700>!    dnsnow = MIN( 1.0, 0.1 * MAX(0.0,ssoil%snowd-ssoil%osnowd) ) ! new snow (cm)<a name='1043'></font>
<font color=#447700>!    ! Snow age depends on snow crystal growth, freezing of melt water,<a name='1044'></font>
<font color=#447700>!    ! accumulation of dirt and amount of new snow.<a name='1045'></font>
<font color=#447700>!    tmp = ssoil%isflag * ssoil%tggsn(:,1) + (1 - ssoil%isflag ) * ssoil%tgg(:,1)<a name='1046'></font>
<font color=#447700>!    tmp = MIN(tmp, 273.15)<a name='1047'></font>
<font color=#447700>!    ar1 = 5000.0 * (1.0 / 273.15 - 1.0 / tmp) ! crystal growth  (-ve)<a name='1048'></font>
<font color=#447700>!    ar2 = 10.0 * ar1 ! freezing of melt water<a name='1049'></font>
<font color=#447700>!    snr = ssoil%snowd / MAX(ssoil%ssdnn, 100.0)<a name='1050'></font>
<font color=#447700>!    ! fixes for Arctic &amp; Antarctic<a name='1051'></font>
<font color=#447700>!    WHERE (soil%isoilm == 9)<a name='1052'></font>
<font color=#447700>!      ar3 = 0.0005<a name='1053'></font>
<font color=#447700>!      dnsnow = MAX(dnsnow, 0.002) !increase refreshing of snow in Antarctic<a name='1054'></font>
<font color=#447700>!      snrat = MIN(1.0, snr / (snr + 0.001) )<a name='1055'></font>
<font color=#447700>!    ELSEWHERE<a name='1056'></font>
<font color=#447700>!      ! accumulation of dirt<a name='1057'></font>
<font color=#447700>!      ar3 = 0.1<a name='1058'></font>
<font color=#447700>!      snrat = MIN(1.0, snr / (snr + 0.01) )<a name='1059'></font>
<font color=#447700>!    END WHERE<a name='1060'></font>
<font color=#447700>!    dtau = 1.0e-6 * (EXP(ar1) + EXP(ar2) + ar3) * dels<a name='1061'></font>
<font color=#447700>!    WHERE (ssoil%snowd &lt;= 1.0)<a name='1062'></font>
<font color=#447700>!      ssoil%snage = 0.0<a name='1063'></font>
<font color=#447700>!    ELSEWHERE<a name='1064'></font>
<font color=#447700>!      ssoil%snage = MAX(0.0, (ssoil%snage + dtau) * (1.0 - dnsnow) )<a name='1065'></font>
<font color=#447700>!    END WHERE<a name='1066'></font>
<font color=#447700>!    fage = 1.0 - 1.0 / (1.0 + ssoil%snage ) !age factor<a name='1067'></font>
<font color=#447700>!    !<a name='1068'></font>
<font color=#447700>!    ! Snow albedo is dependent on zenith angle and  snow age.<a name='1069'></font>
<font color=#447700>!    ! albedo zenith dependence<a name='1070'></font>
<font color=#447700>!    ! alvd = alvo * (1.0-cs*fage); alird = aliro * (1.-cn*fage)<a name='1071'></font>
<font color=#447700>!    ! where cs = 0.2, cn = 0.5, b = 2.0<a name='1072'></font>
<font color=#447700>!    tmp = MAX(0.17365, met%coszen )<a name='1073'></font>
<font color=#447700>!    tmp = MAX(0.01, met%coszen )<a name='1074'></font>
<font color=#447700>!    fzenm = MAX(merge(0.0, (1.0+0.5)/(1.0+4.0*tmp)-0.5, tmp &gt; 0.5), 0.0)<a name='1075'></font>
<font color=#447700>!    tmp = alvo * (1.0 - 0.2 * fage)<a name='1076'></font>
<font color=#447700>!    alv = 0.4 * fzenm * (1.0 - tmp) + tmp<a name='1077'></font>
<font color=#447700>!    tmp = aliro * (1.0 - 0.5 * fage)<a name='1078'></font>
<font color=#447700>!   alir = 0.4 * fzenm * (1.0 - tmp) + tmp<a name='1079'></font>
<font color=#447700>!    talb = 0.5 * (alv + alir) ! snow albedo<a name='1080'></font>
<font color=#447700>!    alss = (1. - snrat) * soil%albsoil + snrat * talb ! canopy free surf albedo<a name='1081'></font>
<font color=#447700>!    ssoil%albsoilsn(:,2) = (1.0 - snrat) * ssoil%albsoilsn(:,2) + snrat * alir<a name='1082'></font>
<font color=#447700>!    ssoil%albsoilsn(:,1) = (1.0 - snrat) * ssoil%albsoilsn(:,1) + snrat * alv<a name='1083'></font>
<a name='1084'>
<font color=#447700>!  END SUBROUTINE snow_albedo <a name='1085'></font>
<a name='1086'>
<a name='1087'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='1088'></font>
  <font color=#447700>! SUBROUTINE stempv<a name='1089'></font>
  <font color=#447700>!	 calculates temperatures of the soil<a name='1090'></font>
  <font color=#447700>!	 tgg - new soil/snow temperature<a name='1091'></font>
  <font color=#447700>!	 ga - heat flux from the atmosphere (ground heat flux)<a name='1092'></font>
  <font color=#447700>!	 ccnsw - soil thermal conductivity, including water/ice<a name='1093'></font>
  <font color=#447700>!<a name='1094'></font>
<A NAME='STEMPV'><A href='../../html_code/science/cable_soilsnow.F90.html#STEMPV' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1095'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>stempv</font>(dels, canopy, ssoil, soil) <A href='../../call_to/STEMPV.html' TARGET='index'>1</A>,<A href='../../call_from/STEMPV.html' TARGET='index'>1</A><a name='1096'>
    REAL(r_1), INTENT(IN)                    :: dels <font color=#447700>! integration time step (s)<a name='1097'></font>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy<a name='1098'>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil<a name='1099'>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='1100'>
    INTEGER(i_d), PARAMETER          :: ntest = 0<a name='1101'>
    REAL(r_2), DIMENSION(mp, -2:ms)  :: at<a name='1102'>
    REAL(r_2), DIMENSION(mp, -2:ms)  :: bt<a name='1103'>
    REAL(r_2), DIMENSION(mp, -2:ms)  :: ct<a name='1104'>
    REAL(r_2), DIMENSION(mp,ms)      :: ccnsw  <font color=#447700>! soil thermal conductivity<a name='1105'></font>
                                               <font color=#447700>! (incl water/ice)<a name='1106'></font>
    REAL(r_1), DIMENSION(mp)         :: coefa<a name='1107'>
    REAL(r_1), DIMENSION(mp)         :: coefb<a name='1108'>
    REAL(r_2), DIMENSION(mp)         :: dtg<a name='1109'>
    REAL(r_2), DIMENSION(mp)         :: ew<a name='1110'>
    REAL(r_2), DIMENSION(mp,-2:ms+1) :: coeff<a name='1111'>
    INTEGER(i_d)                     :: k<a name='1112'>
    REAL(r_1), DIMENSION(mp,-2:ms)   :: rhs<a name='1113'>
<font color=#447700>!    REAL(r_2), DIMENSION(mp,3)       :: sconds<a name='1114'></font>
    REAL(r_1), DIMENSION(mp)         :: sgamm<a name='1115'>
    REAL(r_2), DIMENSION(mp,ms+3)    :: tmp_mat <font color=#447700>! temp. matrix for tggsn &amp; tgg<a name='1116'></font>
    REAL(r_2), DIMENSION(mp)         :: xx<a name='1117'>
    REAL(r_2), DIMENSION(mp)         :: wblfsp <a name='1118'>
    <font color=#447700>!<a name='1119'></font>
    at = 0.0<a name='1120'>
    bt = 1.0<a name='1121'>
    ct = 0.0<a name='1122'>
    coeff = 0.0<a name='1123'>
    DO k = 1, ms<a name='1124'>
      WHERE (soil%isoilm == 9)<a name='1125'>
<font color=#447700>!        ccnsw(:,k) = 1.5<a name='1126'></font>
        ccnsw(:,k) = 2.0<a name='1127'>
      ELSEWHERE<a name='1128'>
        ew = ssoil%wblf(:,k) * soil%ssat<a name='1129'>
        ccnsw(:,k) = MIN(soil%cnsd * EXP( ew * LOG(60.0) + ssoil%wbfice(:,k) &amp;<a name='1130'>
                   &amp; * soil%ssat * LOG(250.0) ), 1.5_r_2) &amp;<a name='1131'>
                   &amp; * MAX(1.0_r_2, SQRT( MIN( 2.0_r_2, 0.5 * soil%ssat &amp;<a name='1132'>
                   &amp; / MIN(ew, 0.5_r_2 * soil%ssat )) ) )<a name='1133'>
      END WHERE<a name='1134'>
    END DO<a name='1135'>
    WHERE (ssoil%isflag == 0)<a name='1136'>
      xx = MAX(0., ssoil%snowd / ssoil%ssdnn )<a name='1137'>
      ccnsw(:,1) = (ccnsw(:,1) - 0.2) * (soil%zse(1) / (soil%zse(1) + xx)) + 0.2<a name='1138'>
    END WHERE<a name='1139'>
    DO k = 3, ms<a name='1140'>
      WHERE (ssoil%isflag == 0)<a name='1141'>
        coeff(:,k) = 2.0 / ( soil%zse(k-1)/ccnsw(:,k-1)+soil%zse(k)/ccnsw(:,k) )<a name='1142'>
      END WHERE<a name='1143'>
    END DO<a name='1144'>
    k = 1<a name='1145'>
    WHERE (ssoil%isflag == 0)<a name='1146'>
      coeff(:,2) = 2.0 / ( (soil%zse(1)+xx)/ccnsw(:,1)+soil%zse(2)/ccnsw(:,2) )<a name='1147'>
      coefa = 0.0<a name='1148'>
      coefb = REAL(coeff(:,2),r_1)<a name='1149'>
      wblfsp = ssoil%wblf(:,k)<a name='1150'>
      xx=soil%css * soil%rhosoil<a name='1151'>
      ssoil%gammzz(:,k) = MAX( (1.0 - soil%ssat) * soil%css * soil%rhosoil &amp;<a name='1152'>
           &amp; + soil%ssat * (wblfsp * cswat * rhowat + ssoil%wbfice(:,k) &amp;<a name='1153'>
           &amp; * csice * rhowat * 0.9), xx ) * soil%zse(k)<a name='1154'>
      ssoil%gammzz(:,k) = ssoil%gammzz(:,k) + cgsnow * ssoil%snowd<a name='1155'>
      dtg = dels / ssoil%gammzz(:,k)<a name='1156'>
      at(:,k) = - dtg * coeff(:,k)<a name='1157'>
      ct(:,k) = - dtg * coeff(:,k+1) <font color=#447700>! c3(ms)=0 &amp; not really used<a name='1158'></font>
      bt(:,k) = 1.0 - at(:,k) - ct(:,k)<a name='1159'>
    END WHERE<a name='1160'>
    DO k = 2, ms<a name='1161'>
      WHERE (ssoil%isflag == 0)<a name='1162'>
        wblfsp = ssoil%wblf(:,k)<a name='1163'>
        xx=soil%css * soil%rhosoil<a name='1164'>
        ssoil%gammzz(:,k) = MAX( (1.0 - soil%ssat ) * soil%css * soil%rhosoil &amp;<a name='1165'>
             &amp; + soil%ssat * (wblfsp * cswat * rhowat + ssoil%wbfice(:,k) &amp;<a name='1166'>
             &amp; * csice * rhowat * 0.9), xx ) * soil%zse(k)<a name='1167'>
        dtg = dels / ssoil%gammzz(:,k)<a name='1168'>
        at(:,k) = - dtg * coeff(:,k)<a name='1169'>
        ct(:,k) = - dtg * coeff(:,k+1) <font color=#447700>! c3(ms)=0 &amp; not really used<a name='1170'></font>
        bt(:,k) = 1.0 - at(:,k) - ct(:,k)<a name='1171'>
      END WHERE<a name='1172'>
    END DO<a name='1173'>
    WHERE (ssoil%isflag == 0)<a name='1174'>
      bt(:,1) = bt(:,1) - canopy%dgdtg * dels / ssoil%gammzz(:,1)<a name='1175'>
      ssoil%tgg(:,1) = ssoil%tgg(:,1) + (canopy%ga - ssoil%tgg(:,1) &amp;<a name='1176'>
          &amp; * REAL(canopy%dgdtg,r_1)) * dels / REAL(ssoil%gammzz(:,1),r_1)<a name='1177'>
    END WHERE<a name='1178'>
    IF (ntest &gt; 0) THEN<a name='1179'>
      PRINT * ,'stempvtgg1,ga,gammzz',ssoil%isflag(idjd),ssoil%tgg(idjd,:),canopy%ga(idjd), &amp;<a name='1180'>
              &amp; ssoil%gammzz(idjd,:)<a name='1181'>
      PRINT * , 'dgdtg', canopy%dgdtg(idjd),ccnsw(idjd,:)<a name='1182'>
      PRINT * , 'ssat,css,rhos,cswat,rhowat,csice ', soil%ssat(idjd), &amp;<a name='1183'>
              &amp; soil%css(idjd), soil%rhosoil(idjd), cswat, rhowat, csice<a name='1184'>
      PRINT * , 'wblf1,wbfice1,zse1,cgsnow ', ssoil%wblf(idjd,1), &amp;<a name='1185'>
              &amp; ssoil%wbfice(idjd,1), soil%zse(:), cgsnow<a name='1186'>
<font color=#447700>!      PRINT * , 'at ', (at(idjd,k) , k = 1, ms)<a name='1187'></font>
<font color=#447700>!      PRINT * , 'bt ', (bt(idjd,k) , k = 1, ms)<a name='1188'></font>
<font color=#447700>!      PRINT * , 'ct ', (ct(idjd,k) , k = 1, ms)<a name='1189'></font>
      PRINT * , 'rhs ', (ssoil%tgg(idjd,k) , k = 1, ms)<a name='1190'>
    END IF<a name='1191'>
    coeff(:,1-3) = 0.0<a name='1192'>
    <font color=#447700>! 3-layer snow points done here<a name='1193'></font>
    WHERE (ssoil%isflag /= 0)<a name='1194'>
      ssoil%sconds(:,1) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,1)**2 &amp;<a name='1195'>
                        &amp; + 0.074, 2.51) )<a name='1196'>
      ssoil%sconds(:,2) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,2)**2 &amp;<a name='1197'>
                        &amp; + 0.074, 2.51) )<a name='1198'>
      ssoil%sconds(:,3) = MAX(0.2, MIN(2.876e-6 * ssoil%ssdn(:,3)**2 &amp;<a name='1199'>
                        &amp; + 0.074, 2.51) )<a name='1200'>
      coeff(:,-1) = 2.0 / (ssoil%sdepth(:,1) / ssoil%sconds(:,1) &amp;<a name='1201'>
                       &amp; + ssoil%sdepth(:,2) / ssoil%sconds(:,2) )<a name='1202'>
      coeff(:,0) = 2.0 / (ssoil%sdepth(:,2) / ssoil%sconds(:,2) &amp;<a name='1203'>
                      &amp; + ssoil%sdepth(:,3) / ssoil%sconds(:,3) )<a name='1204'>
      coeff(:,1) = 2.0 / (ssoil%sdepth(:,3) / ssoil%sconds(:,3) &amp;<a name='1205'>
                      &amp; + soil%zse(1) / ccnsw (:,1) )<a name='1206'>
    END WHERE<a name='1207'>
    DO k = 2, ms<a name='1208'>
      WHERE (ssoil%isflag /= 0)<a name='1209'>
        coeff(:,k) = 2.0 / (soil%zse(k-1)/ccnsw(:,k-1) + soil%zse(k)/ccnsw(:,k))<a name='1210'>
      END WHERE<a name='1211'>
    END DO<a name='1212'>
    WHERE (ssoil%isflag /= 0)<a name='1213'>
      coefa = REAL(coeff (:,-1),r_1)<a name='1214'>
      coefb = REAL(coeff (:,1),r_1)<a name='1215'>
    END WHERE<a name='1216'>
<font color=#447700>!    print *,'stempv coeff isfl=1',coeff(idjd,:),ssoil%sconds(idjd,:)<a name='1217'></font>
<font color=#447700>!    print *,'stempv coeff 2 ', dels,ssoil%sdepth(idjd,:),ssoil%ssdn(idjd,:)<a name='1218'></font>
    DO k = 1, 3<a name='1219'>
      WHERE (ssoil%isflag /= 0)<a name='1220'>
        sgamm = ssoil%ssdn(:,k) * cgsnow * ssoil%sdepth(:,k)<a name='1221'>
        dtg = dels / sgamm<a name='1222'>
        <font color=#447700>! rhs(k-3) = ssoil%tggsn(:,k)  ! A<a name='1223'></font>
        at(:,k-3) = - dtg * coeff(:,k-3)<a name='1224'>
        ct(:,k-3) = - dtg * coeff(:,k-2)<a name='1225'>
        bt(:,k-3) = 1.0 - at(:,k-3) - ct(:,k-3)<a name='1226'>
      END WHERE<a name='1227'>
    END DO<a name='1228'>
    DO k = 1, ms<a name='1229'>
      WHERE (ssoil%isflag /= 0)<a name='1230'>
        wblfsp = ssoil%wblf(:,k)<a name='1231'>
        xx=soil%css * soil%rhosoil<a name='1232'>
        ssoil%gammzz(:,k) = MAX( (1.0 - soil%ssat ) * soil%css * soil%rhosoil &amp;<a name='1233'>
             &amp; + soil%ssat * (wblfsp * cswat * rhowat + ssoil%wbfice(:,k) &amp;<a name='1234'>
             &amp; * csice * rhowat * 0.9), xx ) * soil%zse(k)<a name='1235'>
        dtg = dels / ssoil%gammzz(:,k)<a name='1236'>
        at(:,k) = - dtg * coeff(:,k)<a name='1237'>
        ct(:,k) = - dtg * coeff(:,k + 1) <font color=#447700>! c3(ms)=0 &amp; not really used<a name='1238'></font>
        bt(:,k) = 1.0 - at(:,k) - ct(:,k)<a name='1239'>
      END WHERE<a name='1240'>
    END DO<a name='1241'>
<font color=#447700>!    print *,'stempv  at,bt,ct',ssoil%gammzz(idjd,:),at(idjd,:),canopy%dgdtg(idjd)<a name='1242'></font>
    WHERE (ssoil%isflag /= 0)<a name='1243'>
      sgamm = ssoil%ssdn(:,1) * cgsnow * ssoil%sdepth(:,1)<a name='1244'>
      <font color=#447700>! rhs(1-3) = rhs(1-3)+canopy%ga*dels/sgamm<a name='1245'></font>
      <font color=#447700>! new code<a name='1246'></font>
      bt(:,-2) = bt(:,-2) - canopy%dgdtg * dels / sgamm<a name='1247'>
      ssoil%tggsn(:,1) = ssoil%tggsn(:,1) + (canopy%ga - ssoil%tggsn(:,1) &amp;<a name='1248'>
           &amp; * REAL(canopy%dgdtg,r_1) ) * dels / sgamm<a name='1249'>
      rhs(:,1-3) = ssoil%tggsn(:,1)<a name='1250'>
    END WHERE<a name='1251'>
    IF (ntest &gt; 0) THEN<a name='1252'>
       IF (ssoil%isflag(idjd) /= 0) THEN<a name='1253'>
          PRINT * , 'in stempv 3-layer snow code '<a name='1254'>
          PRINT * , 'ccnsw ', (ccnsw(idjd,k), k = 1, ms)<a name='1255'>
          PRINT * , 'sdepth d ', (ssoil%sdepth(idjd,k), k = 1, 3)<a name='1256'>
          PRINT * , 'sconds ', ssoil%sconds(idjd,:)<a name='1257'>
          <font color=#447700>!      PRINT * , 'coeff ', coeff<a name='1258'></font>
          PRINT * , 'at ', (at(idjd,k), k = - 2, ms)<a name='1259'>
          PRINT * , 'bt ', (bt(idjd,k), k = - 2, ms)<a name='1260'>
          PRINT * , 'ct ', (ct(idjd,k), k = - 2, ms)<a name='1261'>
          PRINT * , 'rhs(tggsn,tgg) ', (ssoil%tggsn(idjd,k), k = 1,3), &amp;<a name='1262'>
               &amp; (ssoil%tgg(idjd,k), k = 1,ms)<a name='1263'>
          PRINT * , 'tggsn,ga,sgamm ', ssoil%tggsn(idjd,1), canopy%ga(idjd), &amp;<a name='1264'>
               &amp; sgamm(idjd)<a name='1265'>
          PRINT * , 'dgdtg ', canopy%dgdtg(idjd)<a name='1266'>
       END IF<a name='1267'>
    END IF<a name='1268'>
    <font color=#447700>!<a name='1269'></font>
    <font color=#447700>!     note in the following that tgg and tggsn are processed together<a name='1270'></font>
    tmp_mat(:,:3) = REAL(ssoil%tggsn,r_2)<a name='1271'>
    tmp_mat(:,4:) = REAL(ssoil%tgg,r_2)<a name='1272'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#TRIMB'>trimb</A><A href='../../html_code/science/cable_soilsnow.F90.html#STEMPV' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIMB_2"> (at, bt, ct, tmp_mat, ms + 3)<a name='1273'>
    ssoil%tggsn = REAL(tmp_mat(:,:3),r_1)<a name='1274'>
    ssoil%tgg   = REAL(tmp_mat(:,4:),r_1)<a name='1275'>
<a name='1276'>
    IF (ntest &gt; 0) THEN<a name='1277'>
       IF (ssoil%isflag(idjd) /= 0) THEN<a name='1278'>
          PRINT * , 'afrhs(tggsn,tgg) ', (ssoil%tggsn(idjd,k), k = 1,3), &amp;<a name='1279'>
              &amp; (ssoil%tgg(idjd,k), k = 1,ms)<a name='1280'>
          PRINT * , 'aftggsn,ga,sgamm ', ssoil%tggsn(idjd,1), canopy%ga(idjd), &amp;<a name='1281'>
              &amp; sgamm(idjd)<a name='1282'>
       END IF<a name='1283'>
    END IF<a name='1284'>
 <a name='1285'>
    canopy%sghflux = coefa * (ssoil%tggsn(:,1) - ssoil%tggsn(:,2) )<a name='1286'>
<font color=#447700>!    canopy%sghflux = coefb * (ssoil%tggsn(:,3) - ssoil%tgg(:,1) )<a name='1287'></font>
    canopy%ghflux = coefb * (ssoil%tgg(:,1) - ssoil%tgg(:,2) ) <font color=#447700>! +ve downwards<a name='1288'></font>
  END SUBROUTINE stempv<a name='1289'>
<a name='1290'>
<a name='1291'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='1292'></font>
  <font color=#447700>! SUBROUTINE stempvsn<a name='1293'></font>
  <font color=#447700>!	 calculates temperatures of the three layer snowpack<a name='1294'></font>
  <font color=#447700>!	 tgg - new soil/snow temperature<a name='1295'></font>
  <font color=#447700>!	 ga - heat flux from the atmosphere <a name='1296'></font>
  <font color=#447700>!	 ccnsw - soil thermal conductivity, including water/ice<a name='1297'></font>
  <font color=#447700>!<a name='1298'></font>
<A NAME='STEMPVSN'><A href='../../html_code/science/cable_soilsnow.F90.html#STEMPVSN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1299'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>stempvsn</font>(dels,soilcond, soilhcp, canopy, ssoil, soil),<A href='../../call_from/STEMPVSN.html' TARGET='index'>1</A><a name='1300'>
    REAL(r_1), INTENT(IN)                    :: dels <font color=#447700>! integration time step (s)<a name='1301'></font>
    REAL(r_1), DIMENSION(mp), INTENT(IN)     :: soilcond   <a name='1302'>
    REAL(r_1), DIMENSION(mp), INTENT(IN)     :: soilhcp   <a name='1303'>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy<a name='1304'>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil<a name='1305'>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='1306'>
    INTEGER(i_d), PARAMETER            :: mssn = 1<a name='1307'>
    INTEGER(i_d), PARAMETER            :: ntest = 0<a name='1308'>
    REAL(r_2), DIMENSION(mp, -2:mssn)  :: at<a name='1309'>
    REAL(r_2), DIMENSION(mp, -2:mssn)  :: bt<a name='1310'>
    REAL(r_2), DIMENSION(mp, -2:mssn)  :: ct<a name='1311'>
    REAL(r_2), DIMENSION(mp,mssn)      :: ccnsw  <font color=#447700>! soil thermal conductivity<a name='1312'></font>
                                                 <font color=#447700>! (incl water/ice)<a name='1313'></font>
    REAL(r_1), DIMENSION(mp)           :: coefa<a name='1314'>
    REAL(r_1), DIMENSION(mp)           :: coefb<a name='1315'>
    REAL(r_2), DIMENSION(mp)           :: dtg<a name='1316'>
    REAL(r_2), DIMENSION(mp)           :: ew<a name='1317'>
    REAL(r_2), DIMENSION(mp,-2:mssn+1) :: coeff<a name='1318'>
    INTEGER(i_d)                       :: k<a name='1319'>
    REAL(r_1), DIMENSION(mp,-2:mssn)   :: rhs<a name='1320'>
<font color=#447700>!    REAL(r_2), DIMENSION(mp,3)         :: sconds<a name='1321'></font>
    REAL(r_1), DIMENSION(mp)           :: sgamm<a name='1322'>
    REAL(r_2), DIMENSION(mp,mssn+3)    :: tmp_mat <font color=#447700>! temp. matrix for tggsn &amp; tgg<a name='1323'></font>
    REAL(r_2), DIMENSION(mp)           :: xx<a name='1324'>
    REAL(r_2), DIMENSION(mp)           :: wblfsp <a name='1325'>
    <font color=#447700>!<a name='1326'></font>
    at = 0.0<a name='1327'>
    bt = 1.0<a name='1328'>
    ct = 0.0<a name='1329'>
    coeff = 0.0<a name='1330'>
    canopy%dgdtg =0.0<a name='1331'>
    ccnsw(:,1) = soilcond  <font color=#447700>! from Jules<a name='1332'></font>
    coeff (:,1-3) = 0.0<a name='1333'>
    <font color=#447700>! 3-layer snow points done here<a name='1334'></font>
    WHERE (ssoil%isflag /= 0)<a name='1335'>
      coeff(:,-1) = 2.0 / (ssoil%sdepth(:,1) / ssoil%sconds(:,1) &amp;<a name='1336'>
                       &amp; + ssoil%sdepth(:,2) / ssoil%sconds(:,2) )<a name='1337'>
      coeff(:,0) = 2.0 / (ssoil%sdepth(:,2) / ssoil%sconds(:,2) &amp;<a name='1338'>
                      &amp; + ssoil%sdepth(:,3) / ssoil%sconds(:,3) )<a name='1339'>
      coeff(:,1) = 2.0 / (ssoil%sdepth(:,3) / ssoil%sconds(:,3) &amp;<a name='1340'>
                      &amp; + 0.1 / ccnsw(:,1) )<a name='1341'>
    END WHERE<a name='1342'>
    WHERE (ssoil%isflag /= 0)<a name='1343'>
      coefa = REAL(coeff(:,-1),r_1)<a name='1344'>
      coefb = REAL(coeff(:,1),r_1)<a name='1345'>
    END WHERE<a name='1346'>
    DO k = 1, 3<a name='1347'>
      WHERE (ssoil%isflag /= 0)<a name='1348'>
        sgamm = ssoil%ssdn(:,k) * cgsnow * ssoil%sdepth(:,k)<a name='1349'>
        dtg = dels / sgamm<a name='1350'>
        <font color=#447700>! rhs(k-3) = ssoil%tggsn(:,k)	  ! A<a name='1351'></font>
        at(:,k-3) = - dtg * coeff(:,k-3)<a name='1352'>
        ct(:,k-3) = - dtg * coeff(:,k-2)<a name='1353'>
        bt(:,k-3) = 1.0 - at(:,k-3) - ct(:,k-3)<a name='1354'>
      END WHERE<a name='1355'>
    END DO<a name='1356'>
    DO k = 1, mssn<a name='1357'>
      WHERE (ssoil%isflag /= 0)<a name='1358'>
        dtg = dels / soilhcp<a name='1359'>
        at(:,k) = - dtg * coeff(:,k)<a name='1360'>
        ct(:,k) = - dtg * coeff(:,k + 1) <font color=#447700>! c3(mssn)=0 &amp; not really used<a name='1361'></font>
        bt(:,k) = 1.0 - at(:,k) - ct(:,k)<a name='1362'>
      END WHERE<a name='1363'>
    END DO<a name='1364'>
    WHERE (ssoil%isflag /= 0)<a name='1365'>
      sgamm = ssoil%ssdn(:,1) * cgsnow * ssoil%sdepth(:,1)<a name='1366'>
      <font color=#447700>! rhs(1-3) = rhs(1-3)+canopy%ga*dels/sgamm<a name='1367'></font>
      <font color=#447700>! new code<a name='1368'></font>
      bt(:,-2) = bt(:,-2) - canopy%dgdtg * dels / sgamm<a name='1369'>
      ssoil%tggsn(:,1) = ssoil%tggsn(:,1) + (canopy%ga - ssoil%tggsn(:,1) &amp;<a name='1370'>
           &amp; * REAL(canopy%dgdtg,r_1) ) * dels / sgamm<a name='1371'>
      rhs(:,1-3) = ssoil%tggsn(:,1)<a name='1372'>
    END WHERE<a name='1373'>
    IF (ntest &gt; 0) THEN<a name='1374'>
       IF (ssoil%isflag(idjd) /= 0) THEN<a name='1375'>
          PRINT * , 'in stempv 3-layer snow code '<a name='1376'>
          PRINT * , 'ccnsw ', (ccnsw(idjd,k), k = 1, mssn)<a name='1377'>
          PRINT * , 'sdepth d ', (ssoil%sdepth(idjd,k), k = 1, 3)<a name='1378'>
          PRINT * , 'sconds ', ssoil%sconds<a name='1379'>
          PRINT * , 'coeff ', coeff<a name='1380'>
          PRINT * , 'at ', (at(idjd,k) , k = - 2, mssn)<a name='1381'>
          PRINT * , 'bt ', (bt(idjd,k) , k = - 2, mssn)<a name='1382'>
          PRINT * , 'ct ', (ct(idjd,k) , k = - 2, mssn)<a name='1383'>
          PRINT * , 'rhs(tggsn,tgg)',(ssoil%tggsn(idjd,k),k = 1,4)<a name='1384'>
          PRINT * , 'tggsn,ga,sgamm ', ssoil%tggsn (idjd,1) , canopy%ga(idjd) , &amp;<a name='1385'>
               &amp; sgamm(idjd)<a name='1386'>
       END IF<a name='1387'>
    END IF<a name='1388'>
    <font color=#447700>!<a name='1389'></font>
    <font color=#447700>!     note in the following that tgg and tggsn are processed together<a name='1390'></font>
    tmp_mat(:,:3) = REAL(ssoil%tggsn,r_2)<a name='1391'>
    tmp_mat(:,4:) = REAL(ssoil%tgg,r_2)<a name='1392'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#TRIMB'>trimb</A><A href='../../html_code/science/cable_soilsnow.F90.html#STEMPVSN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="TRIMB_3"> (at, bt, ct, tmp_mat, mssn + 3)<a name='1393'>
    ssoil%tggsn = REAL(tmp_mat(:,:3),r_1)<a name='1394'>
<font color=#447700>!    canopy%sghflux = coefb * (ssoil%tggsn(:,3) - ssoil%tgg(:,1) )<a name='1395'></font>
<font color=#447700>!    WHERE ( ssoil%isflag == 1 ) canopy%ga = canopy%sghflux<a name='1396'></font>
<font color=#447700>!    print *,'stempvsn ga',canopy%ga<a name='1397'></font>
  END SUBROUTINE stempvsn<a name='1398'>
<a name='1399'>
<a name='1400'>
  <font color=#447700>!-------------------------------------------------------------------------<a name='1401'></font>
<A NAME='SNOWCHECK'><A href='../../html_code/science/cable_soilsnow.F90.html#SNOWCHECK' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1402'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>snowcheck</font>(dels, ktau, ssoil, soil, met, ktau_gl ) <A href='../../call_to/SNOWCHECK.html' TARGET='index'>1</A><a name='1403'>
<font color=#447700>!  SUBROUTINE snowcheck(dels, ktau_gl, ssoil, soil, met )<a name='1404'></font>
    REAL(r_1), INTENT(IN)               :: dels <font color=#447700>! integration time step (s)<a name='1405'></font>
    INTEGER(i_d), INTENT(IN)            :: ktau <font color=#447700>! integration step number<a name='1406'></font>
    INTEGER(i_d), INTENT(IN)            :: ktau_gl <a name='1407'>
    TYPE(soil_snow_type), INTENT(INOUT) :: ssoil<a name='1408'>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil  <font color=#447700>! soil parameters<a name='1409'></font>
    TYPE(met_type), INTENT(INOUT)            :: met <font color=#447700>! all met forcing<a name='1410'></font>
    INTEGER(i_d), PARAMETER :: ntest = 0 <font color=#447700>!  for prints<a name='1411'></font>
    INTEGER(i_d)            :: k<a name='1412'>
<a name='1413'>
    <font color=#447700>! Diagnostic block:<a name='1414'></font>
    IF (ntest &gt; 0) THEN<a name='1415'>
      PRINT *, 'in snowcheck ktau= ', ktau, ssoil%isflag(idjd), idjd<a name='1416'>
      PRINT *, 'dels,ssdn ', dels, (ssoil%ssdn(idjd,k),k=1,3)<a name='1417'>
      PRINT *, 'osnowd,snowd', ssoil%osnowd(idjd), ssoil%snowd(idjd)<a name='1418'>
      PRINT *, 'tgg ', (ssoil%tgg(idjd,k),k=1,ms)<a name='1419'>
      PRINT *, 'tggsn ', (ssoil%tggsn(idjd,k),k=1,3)<a name='1420'>
    END IF<a name='1421'>
<a name='1422'>
<font color=#447700>!!$    IF (ktau &lt;= 1) THEN<a name='1423'></font>
<font color=#447700>!!$      ssoil%ssdn = 120.0<a name='1424'></font>
<font color=#447700>!!$      ssoil%ssdnn = 120.0<a name='1425'></font>
<font color=#447700>!!$      ssoil%tggsn = tfrz<a name='1426'></font>
<font color=#447700>!!$      ssoil%isflag = 0<a name='1427'></font>
<font color=#447700>!!$      ssoil%sdepth(:,1) = ssoil%snowd / ssoil%ssdn(:,1)<a name='1428'></font>
<font color=#447700>!!$      ssoil%sdepth(:,2) = 0.<a name='1429'></font>
<font color=#447700>!!$      ssoil%sdepth(:,3) = 0.<a name='1430'></font>
<font color=#447700>!!$      ssoil%smass(:,1) = ssoil%snowd<a name='1431'></font>
<font color=#447700>!!$      ssoil%smass(:,2) = 0.0     <a name='1432'></font>
<font color=#447700>!!$      ssoil%smass(:,3) = 0.0    <a name='1433'></font>
<font color=#447700>!!$      WHERE( soil%isoilm == 9 )<a name='1434'></font>
<font color=#447700>!!$        ssoil%ssdn(:,1)  = 200.0<a name='1435'></font>
<font color=#447700>!!$        ssoil%ssdn(:,2)  = 300.0<a name='1436'></font>
<font color=#447700>!!$        ssoil%ssdn(:,3)  = 380.0<a name='1437'></font>
<font color=#447700>!!$        ssoil%ssdnn      = 350.0<a name='1438'></font>
<font color=#447700>!!$      ENDWHERE<a name='1439'></font>
<font color=#447700>!!$<a name='1440'></font>
<font color=#447700>!!$    END IF<a name='1441'></font>
<a name='1442'>
    WHERE (ssoil%snowd &lt;= 0.0)<a name='1443'>
      ssoil%isflag = 0<a name='1444'>
      ssoil%ssdn(:,1) = 120.0<a name='1445'>
      ssoil%ssdn(:,2) = 120.0<a name='1446'>
      ssoil%ssdn(:,3) = 120.0<a name='1447'>
      ssoil%ssdnn = 120.0<a name='1448'>
      ssoil%tggsn(:,1) = tfrz<a name='1449'>
      ssoil%tggsn(:,2) = tfrz<a name='1450'>
      ssoil%tggsn(:,3) = tfrz<a name='1451'>
      ssoil%sdepth(:,1) = ssoil%snowd / ssoil%ssdn(:,1)<a name='1452'>
      ssoil%sdepth(:,2) = 0.<a name='1453'>
      ssoil%sdepth(:,3) = 0.<a name='1454'>
      ssoil%smass(:,1) = ssoil%snowd<a name='1455'>
      ssoil%smass(:,2) = 0.0     <font color=#447700>! EK to fix -ve sdepth 21Dec2007<a name='1456'></font>
      ssoil%smass(:,3) = 0.0     <font color=#447700>! EK to fix -ve sdepth 21Dec2007<a name='1457'></font>
    ELSEWHERE (ssoil%snowd &lt; snmin * ssoil%ssdnn) <font color=#447700>! original version for CABLE<a name='1458'></font>
<a name='1459'>
<font color=#447700>!    assume land ice points in UM have been initialised with 50,000 cm of snow<a name='1460'></font>
<font color=#447700>!    and 3 layer snow pack can be open only outside land ice points<a name='1461'></font>
<font color=#447700>!    ELSEWHERE ((ssoil%snowd &lt; snmin*ssoil%ssdnn).or.(ssoil%snowd &gt; 40000.0))<a name='1462'></font>
<a name='1463'>
      WHERE (ssoil%isflag == 1)<a name='1464'>
        ssoil%ssdn(:,1) = ssoil%ssdnn<a name='1465'>
        ssoil%tgg(:,1) = ssoil%tggsn(:,1)<a name='1466'>
      END WHERE<a name='1467'>
<font color=#447700>!      ssoil%ssdnn = MIN( 400.0, MAX(120.0, ssoil%ssdn(:,1)) )<a name='1468'></font>
      ssoil%ssdnn = MAX(120.0, ssoil%ssdn(:,1)) <a name='1469'>
      ssoil%ssdn(:,1) = ssoil%ssdnn<a name='1470'>
      ssoil%ssdn(:,2) = ssoil%ssdnn<a name='1471'>
      ssoil%ssdn(:,3) = ssoil%ssdnn<a name='1472'>
      ssoil%isflag = 0<a name='1473'>
      ssoil%tggsn(:,1) = min(tfrz,ssoil%tgg(:,1))<a name='1474'>
      ssoil%tggsn(:,2) = min(tfrz,ssoil%tgg(:,1))<a name='1475'>
      ssoil%tggsn(:,3) = min(tfrz,ssoil%tgg(:,1))<a name='1476'>
      ssoil%sdepth(:,1) = ssoil%snowd / ssoil%ssdn(:,1)<a name='1477'>
      ssoil%sdepth(:,2) = 0.0     <a name='1478'>
      ssoil%sdepth(:,3) = 0.0     <a name='1479'>
      ssoil%smass(:,1) = ssoil%snowd     <a name='1480'>
      ssoil%smass(:,2) = 0.0     <a name='1481'>
      ssoil%smass(:,3) = 0.0     <a name='1482'>
<font color=#447700>!!$      where( soil%isoilm == 9 .and. ktau_gl &lt;= 2 )<a name='1483'></font>
<font color=#447700>!!$      ssoil%ssdnn = 700.0<a name='1484'></font>
<font color=#447700>!!$      endwhere<a name='1485'></font>
<a name='1486'>
    ELSEWHERE <font color=#447700>! sufficient snow now for 3 layer snowpack<a name='1487'></font>
<a name='1488'>
      WHERE (ssoil%isflag == 0)<a name='1489'>
        ssoil%tggsn(:,1) = min(tfrz,ssoil%tgg(:,1))<a name='1490'>
        ssoil%tggsn(:,2) = min(tfrz,ssoil%tgg(:,1))<a name='1491'>
        ssoil%tggsn(:,3) = min(tfrz,ssoil%tgg(:,1))<a name='1492'>
        ssoil%ssdn(:,2) = ssoil%ssdn(:,1)<a name='1493'>
        ssoil%ssdn(:,3) = ssoil%ssdn(:,1)<a name='1494'>
<font color=#447700>!!$        WHERE( soil%isoilm == 9 .and. ktau_gl &lt;= 2 )<a name='1495'></font>
<font color=#447700>!!$          ssoil%ssdn(:,1)  = 450.0<a name='1496'></font>
<font color=#447700>!!$          ssoil%ssdn(:,2)  = 580.0<a name='1497'></font>
<font color=#447700>!!$          ssoil%ssdn(:,3)  = 600.0<a name='1498'></font>
<font color=#447700>!!$!          ssoil%tggsn(:,3) = min(210.0,ssoil%tggav)<a name='1499'></font>
<font color=#447700>!!$!          ssoil%tggsn(:,2) = min(213.0,0.5*(ssoil%tggsn(:,3) + met%tk))<a name='1500'></font>
<font color=#447700>!!$!          ssoil%tggsn(:,1) = min(ssoil%tggsn(:,2),met%tk)<a name='1501'></font>
<font color=#447700>!!$        ENDWHERE<a name='1502'></font>
<font color=#447700>!        ssoil%sdepth(:,1) = 0.05<a name='1503'></font>
        ssoil%sdepth(:,1) = ssoil%t_snwlr<a name='1504'>
        <font color=#447700>! next 5 lines replaced to fix -ve sdepth (EK 21Dec2007)<a name='1505'></font>
<font color=#447700>!        ssoil%smass(:,1)  = 0.05 * ssoil%ssdn(:,1)<a name='1506'></font>
        ssoil%smass(:,1)  =  ssoil%t_snwlr * ssoil%ssdn(:,1)<a name='1507'>
        ssoil%smass(:,2)  = (ssoil%snowd - ssoil%smass(:,1)) * 0.4<a name='1508'>
        ssoil%sdepth(:,2) = ssoil%smass(:,2)/ssoil%ssdn(:,2)<a name='1509'>
        ssoil%smass(:,3)  = (ssoil%snowd - ssoil%smass(:,1)) * 0.6<a name='1510'>
        ssoil%sdepth(:,3) = ssoil%smass(:,3)/ssoil%ssdn(:,3)<a name='1511'>
        ssoil%ssdnn = (ssoil%ssdn(:,1) * ssoil%smass(:,1) + ssoil%ssdn(:,2) &amp;<a name='1512'>
             &amp; * ssoil%smass(:,2) + ssoil%ssdn(:,3) * ssoil%smass(:,3) ) &amp;<a name='1513'>
             &amp; / ssoil%snowd<a name='1514'>
<a name='1515'>
<font color=#447700>!        ssoil%sdepth(:,2) =  (ssoil%snowd / ssoil%ssdn(:,1) - 0.05) &amp;<a name='1516'></font>
<font color=#447700>!             &amp; * merge(0.4, 0.4, ssoil%snowd &gt; 20.0)<a name='1517'></font>
<font color=#447700>!        ssoil%sdepth(:,3) = (ssoil%snowd / ssoil%ssdn(:,1) - 0.05) &amp;<a name='1518'></font>
<font color=#447700>!             &amp; * merge(0.6, 0.6, ssoil%snowd &gt; 20.0)<a name='1519'></font>
<font color=#447700>!        ssoil%smass(:,1) = 0.05 * ssoil%ssdn(:,1)<a name='1520'></font>
<font color=#447700>!        ssoil%smass(:,2) = ssoil%sdepth(:,2) * ssoil%ssdn(:,2)<a name='1521'></font>
<font color=#447700>!        ssoil%smass(:,3) = ssoil%sdepth(:,3) * ssoil%ssdn(:,3)<a name='1522'></font>
<a name='1523'>
      END WHERE<a name='1524'>
      ssoil%isflag = 1<a name='1525'>
    END WHERE<a name='1526'>
<a name='1527'>
  END SUBROUTINE snowcheck <a name='1528'>
<a name='1529'>
<a name='1530'>
  <font color=#447700>!******************************************************************<a name='1531'></font>
<A NAME='SNOWL_ADJUST'><A href='../../html_code/science/cable_soilsnow.F90.html#SNOWL_ADJUST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1532'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>snowl_adjust</font>(dels, ktau,  ssoil, canopy ) <A href='../../call_to/SNOWL_ADJUST.html' TARGET='index'>1</A><a name='1533'>
    REAL(r_1), INTENT(IN)               :: dels <font color=#447700>! integration time step (s)<a name='1534'></font>
    INTEGER(i_d), INTENT(IN)            :: ktau <font color=#447700>! integration step number<a name='1535'></font>
    TYPE(soil_snow_type), INTENT(INOUT) :: ssoil<a name='1536'>
    TYPE(canopy_type), INTENT(INOUT)    :: canopy<a name='1537'>
    INTEGER(i_d), PARAMETER  :: ntest = 0 <font color=#447700>!  for prints<a name='1538'></font>
    INTEGER(i_d)             :: k<a name='1539'>
    REAL(r_2), DIMENSION(mp) :: excd<a name='1540'>
    REAL(r_2), DIMENSION(mp) :: excm<a name='1541'>
    REAL(r_2), DIMENSION(mp) :: frac <a name='1542'>
    REAL(r_2), DIMENSION(mp) :: xfrac <a name='1543'>
    REAL(r_1), DIMENSION(mp) :: osm<a name='1544'>
   <font color=#447700>!						~.11 to turn on 3-layer snow<a name='1545'></font>
    <font color=#447700>! Diagnostic block:<a name='1546'></font>
    IF (ntest &gt; 0) THEN<a name='1547'>
       PRINT *, 'in soilsnowv before stempv,  ktau= ', ktau,ssoil%isflag(idjd)<a name='1548'>
       PRINT *, 'soilsnowv ', canopy%dgdtg(idjd), canopy%fevc(idjd), &amp;<a name='1549'>
              &amp; canopy%fess(idjd), canopy%precis(idjd)<a name='1550'>
       PRINT *, 'ga,dels,ssdn ', canopy%ga(idjd), dels, (ssoil%ssdn(idjd,k),k=1,3)<a name='1551'>
       PRINT *, 'osnowd,snowd,isflag', ssoil%osnowd(idjd), ssoil%snowd(idjd), &amp;<a name='1552'>
              &amp; ssoil%isflag(idjd)<a name='1553'>
       PRINT *, 'tgg ', (ssoil%tgg(idjd,k),k=1,ms)<a name='1554'>
       PRINT *, 'tggsn ', (ssoil%tggsn(idjd,k),k=1,3)<a name='1555'>
       PRINT *, 'wb ', (ssoil%wb(idjd,k),k=1,ms)<a name='1556'>
       PRINT *, 'wbice ', (ssoil%wbice(idjd,k),k=1,ms)<a name='1557'>
    END IF<a name='1558'>
<a name='1559'>
    <font color=#447700>! adjust levels in the snowpack due to snow accumulation/melting,<a name='1560'></font>
    <font color=#447700>! snow aging etc...<a name='1561'></font>
    WHERE (ssoil%isflag &gt; 0)<a name='1562'>
<font color=#447700>!      WHERE ( ssoil%sdepth(:,1) .gt. 0.05 )<a name='1563'></font>
      WHERE ( ssoil%sdepth(:,1) .gt.  ssoil%t_snwlr )<a name='1564'>
<font color=#447700>!        excd = ssoil%sdepth(:,1) - 0.05<a name='1565'></font>
        excd = ssoil%sdepth(:,1) - ssoil%t_snwlr<a name='1566'>
        excm = excd * ssoil%ssdn(:,1)<a name='1567'>
        ssoil%sdepth(:,1) = ssoil%sdepth(:,1) - excd<a name='1568'>
<font color=#447700>!        ssoil%sdepth(:,1) = 0.05<a name='1569'></font>
        osm = ssoil%smass(:,1)<a name='1570'>
        ssoil%smass(:,1) = ssoil%smass(:,1) - excm<a name='1571'>
<a name='1572'>
        osm = ssoil%smass(:,2)<a name='1573'>
        ssoil%smass(:,2) = MAX(0.01_r_2, ssoil%smass(:,2) + excm)<a name='1574'>
        ssoil%ssdn(:,2) = MAX(120.0_r_2, MIN(750.0_r_2, ssoil%ssdn(:,2)* &amp;<a name='1575'>
          &amp; osm/ssoil%smass(:,2) + ssoil%ssdn(:,1) * excm / ssoil%smass(:,2)) )<a name='1576'>
        ssoil%sdepth(:,2) =  ssoil%smass(:,2) / ssoil%ssdn(:,2) <a name='1577'>
        ssoil%tggsn(:,2) = ssoil%tggsn(:,2) * osm / ssoil%smass(:,2) + &amp;<a name='1578'>
                         &amp; ssoil%tggsn(:,1) * excm/ ssoil%smass(:,2)<a name='1579'>
        <font color=#447700>! following line changed to fix -ve sdepth (EK 21Dec2007)<a name='1580'></font>
        ssoil%smass(:,3) = MAX(0.01_r_2, &amp;<a name='1581'>
                          &amp; ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2))<a name='1582'>
<font color=#447700>!        ssoil%smass(:,3) = ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2)<a name='1583'></font>
<font color=#447700>!      ELSEWHERE ! ssoil%sdepth(:,1) &lt; 0.05<a name='1584'></font>
      ELSEWHERE <font color=#447700>! ssoil%sdepth(:,1) &lt;  ssoil%t_snwlr<a name='1585'></font>
        <font color=#447700>! 1st layer<a name='1586'></font>
<font color=#447700>!        excd = 0.05 - ssoil%sdepth(:,1)<a name='1587'></font>
        excd =  ssoil%t_snwlr - ssoil%sdepth(:,1)<a name='1588'>
        excm = excd * ssoil%ssdn(:,2)<a name='1589'>
        osm = ssoil%smass(:,1)<a name='1590'>
        ssoil%smass(:,1) = ssoil%smass(:,1) + excm<a name='1591'>
<font color=#447700>!        ssoil%sdepth(:,1) = 0.05<a name='1592'></font>
        ssoil%sdepth(:,1) =  ssoil%t_snwlr<a name='1593'>
        ssoil%ssdn(:,1) = MAX(120.0_r_2, MIN(750.0_r_2, ssoil%ssdn(:,1)* &amp;<a name='1594'>
        &amp; osm/ssoil%smass(:,1) + ssoil%ssdn(:,2) * excm / ssoil%smass(:,1)) )<a name='1595'>
        ssoil%tggsn(:,1) = ssoil%tggsn(:,1) * osm / ssoil%smass(:,1) +  &amp;<a name='1596'>
                         &amp; ssoil%tggsn(:,2) * excm/ ssoil%smass(:,1)<a name='1597'>
        <font color=#447700>! 2nd layer<a name='1598'></font>
        ssoil%smass(:,2) = MAX(0.01_r_2, ssoil%smass(:,2) - excm)<a name='1599'>
        ssoil%sdepth(:,2) = ssoil%smass(:,2)/ssoil%ssdn(:,2)<a name='1600'>
        ssoil%smass(:,3) = MAX(0.01_r_2, &amp;<a name='1601'>
                          &amp; ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2))<a name='1602'>
<font color=#447700>!        ssoil%smass(:,3) = ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2)<a name='1603'></font>
      END WHERE<a name='1604'>
    END WHERE<a name='1605'>
<font color=#447700>!!$    write(0,*) "MRD SSOIL ISFLAG", ssoil%isflag<a name='1606'></font>
<font color=#447700>!!$    write(0,*) "MRD SMASS 2 ", ssoil%smass(:,2)<a name='1607'></font>
<font color=#447700>!!$    write(0,*) "MRD SMASS 3 ", ssoil%smass(:,3)<a name='1608'></font>
    xfrac = 0. <font color=#447700>! Work around NaN initialisation problem<a name='1609'></font>
    WHERE (ssoil%isflag &gt; 0)<a name='1610'>
      frac = ssoil%smass(:,2) / MAX(0.02, ssoil%smass(:,3))<a name='1611'>
      <font color=#447700>! if frac &gt; 0.6 or frac &lt; 0.74 do nothing HOW TO translate this to xfrac<a name='1612'></font>
      xfrac = 2.0/3.0/ frac<a name='1613'>
      WHERE ( xfrac &gt; 1.0 )<a name='1614'>
        excm = (xfrac - 1.0) * ssoil%smass(:,2)<a name='1615'>
        osm = ssoil%smass(:,2)<a name='1616'>
        <font color=#447700>! changed 0.02 to 0.01 to fix -ve sdepth (EK 21Dec2007)<a name='1617'></font>
        ssoil%smass(:,2) = MAX(0.01_r_2, ssoil%smass(:,2) + excm)<a name='1618'>
        ssoil%tggsn(:,2) = ssoil%tggsn(:,2) * osm / ssoil%smass(:,2) +  &amp;<a name='1619'>
                         &amp; ssoil%tggsn(:,3) * excm/ ssoil%smass(:,2)<a name='1620'>
        ssoil%ssdn(:,2) = MAX(120.0_r_2, MIN(750.0_r_2, ssoil%ssdn(:,2)* &amp;<a name='1621'>
           &amp; osm/ssoil%smass(:,2) + ssoil%ssdn(:,3) * excm / ssoil%smass(:,2)) )<a name='1622'>
        <font color=#447700>! following line added MAX function to fix -ve sdepth (EK 21Dec2007)<a name='1623'></font>
        ssoil%smass(:,3) = MAX(0.01_r_2, &amp;<a name='1624'>
                         &amp; ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2))<a name='1625'>
        ssoil%sdepth(:,3) = MAX(0.02, ssoil%smass(:,3) / ssoil%ssdn(:,3) )<a name='1626'>
      ELSEWHERE <font color=#447700>! xfrac &lt; 1<a name='1627'></font>
        excm = (1 - xfrac) * ssoil%smass(:,2)<a name='1628'>
        ssoil%smass(:,2) = MAX(0.01_r_2, ssoil%smass(:,2) - excm)<a name='1629'>
        ssoil%sdepth(:,2) = MAX(0.02, ssoil%smass(:,2) / ssoil%ssdn(:,2) )<a name='1630'>
<a name='1631'>
        osm = ssoil%smass(:,3)<a name='1632'>
        <font color=#447700>! following line added MAX function to fix -ve sdepth (EK 21Dec2007)<a name='1633'></font>
        ssoil%smass(:,3) = MAX(0.01_r_2, &amp;<a name='1634'>
                         &amp; ssoil%snowd - ssoil%smass(:,1) - ssoil%smass(:,2))<a name='1635'>
        ssoil%tggsn(:,3) = ssoil%tggsn(:,3) * osm / ssoil%smass(:,3) +  &amp;<a name='1636'>
                         &amp; ssoil%tggsn(:,2) * excm/ ssoil%smass(:,3)<a name='1637'>
        ssoil%ssdn(:,3) = MAX(120.0_r_2, MIN(750.0_r_2, ssoil%ssdn(:,3)* &amp;<a name='1638'>
          &amp; osm/ssoil%smass(:,3) + ssoil%ssdn(:,2) * excm / ssoil%smass(:,3)) )<a name='1639'>
        ssoil%sdepth(:,3) = ssoil%smass(:,3) /  ssoil%ssdn(:,3)<a name='1640'>
      END WHERE<a name='1641'>
      ssoil%isflag = 1<a name='1642'>
      ssoil%ssdnn = (ssoil%ssdn(:,1) * ssoil%sdepth(:,1) + ssoil%ssdn(:,2) &amp;<a name='1643'>
             &amp; * ssoil%sdepth(:,2) + ssoil%ssdn(:,3) * ssoil%sdepth(:,3) ) &amp;<a name='1644'>
             &amp; / (ssoil%sdepth(:,1) + ssoil%sdepth(:,2) + ssoil%sdepth(:,3))<a name='1645'>
    END WHERE<a name='1646'>
<a name='1647'>
    <font color=#447700>! Diagnostic block:<a name='1648'></font>
    IF (ntest &gt; 0) THEN<a name='1649'>
      PRINT *, 'in soilsnowv before stempv,  ktau= ',ktau<a name='1650'>
      PRINT *, 'ga,dels,ssdn ', canopy%ga(idjd), dels, (ssoil%ssdn(idjd,k),k=1,3)<a name='1651'>
      PRINT *, 'osnowd,snowd,isflag', ssoil%osnowd(idjd), ssoil%snowd(idjd), &amp;<a name='1652'>
             &amp; ssoil%isflag(idjd)<a name='1653'>
      PRINT *, 'tgg ', (ssoil%tgg(idjd,k),k=1,ms)<a name='1654'>
      PRINT *, 'tggsn ', (ssoil%tggsn(idjd,k),k=1,3)<a name='1655'>
      PRINT *, 'wb ', (ssoil%wb(idjd,k),k=1,ms)<a name='1656'>
      PRINT *, 'wbice ', (ssoil%wbice(idjd,k),k=1,ms)<a name='1657'>
      PRINT *, 'wblf ', (ssoil%wblf(idjd,k),k=1,ms)<a name='1658'>
      PRINT *, 'wbfice ', (ssoil%wbfice(idjd,k),k=1,ms)<a name='1659'>
    END IF<a name='1660'>
    IF (ntest == 1) THEN<a name='1661'>
      PRINT *, 'in soilsnow printing wbfice_max'<a name='1662'>
      PRINT *, 'sdepth c2 ', (ssoil%sdepth(idjd,k),k=1,3)<a name='1663'>
    END IF<a name='1664'>
<a name='1665'>
  END SUBROUTINE snowl_adjust<a name='1666'>
<a name='1667'>
<a name='1668'>
  <font color=#447700>!******************************************************************<a name='1669'></font>
<A NAME='SOILFREEZE'><A href='../../html_code/science/cable_soilsnow.F90.html#SOILFREEZE' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1670'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>soilfreeze</font>(dels, soil, ssoil) <A href='../../call_to/SOILFREEZE.html' TARGET='index'>1</A><a name='1671'>
    REAL(r_1), INTENT(IN)                    :: dels <font color=#447700>! integration time step (s)<a name='1672'></font>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil<a name='1673'>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='1674'>
    REAL(r_1), DIMENSION(mp)           :: sicefreeze<a name='1675'>
    REAL(r_1), DIMENSION(mp)           :: sicemelt<a name='1676'>
    REAL(r_1), DIMENSION(mp)           :: xx<a name='1677'>
    INTEGER(i_d) k<a name='1678'>
    <font color=#447700>! allow for some water (&lt; 5%) to remain unfrozen<a name='1679'></font>
    DO k = 1, ms<a name='1680'>
      WHERE (ssoil%tgg(:,k) &lt; tfrz &amp;<a name='1681'>
          &amp; .and. 0.80 * ssoil%wb(:,k) - ssoil%wbice(:,k) &gt; .001)<a name='1682'>
        sicefreeze = MIN( MAX(0.0_r_2,(0.80*ssoil%wb(:,k)-ssoil%wbice(:,k))) &amp;<a name='1683'>
                        &amp; * soil%zse(k) * 1000.0, &amp;<a name='1684'>
                        &amp; (tfrz - ssoil%tgg(:,k) ) * ssoil%gammzz(:,k) / hlf )<a name='1685'>
        ssoil%wbice(:,k) = MIN( ssoil%wbice(:,k) + sicefreeze / (soil%zse(k) &amp;<a name='1686'>
                         &amp; * 1000.0), 0.80 * ssoil%wb(:,k) )<a name='1687'>
        xx=soil%css * soil%rhosoil<a name='1688'>
        ssoil%gammzz(:,k) = MAX( (1.0 - soil%ssat) * soil%css * soil%rhosoil &amp;<a name='1689'>
             &amp; + (ssoil%wb(:,k) - ssoil%wbice(:,k)) * cswat * rhowat &amp;<a name='1690'>
             &amp; + ssoil%wbice(:,k) * csice * rhowat * 0.9, xx) &amp;<a name='1691'>
             &amp; * soil%zse(k)<a name='1692'>
        WHERE (k == 1 .and. ssoil%isflag == 0)<a name='1693'>
          ssoil%gammzz(:,k) = ssoil%gammzz(:,k) + cgsnow * ssoil%snowd<a name='1694'>
        END WHERE<a name='1695'>
        ssoil%tgg(:,k) = ssoil%tgg(:,k) + REAL(sicefreeze,r_1) &amp;<a name='1696'>
                       &amp; * hlf / REAL(ssoil%gammzz(:,k),r_1)<a name='1697'>
      ELSEWHERE (ssoil%tgg(:,k) &gt; tfrz .and. ssoil%wbice(:,k) &gt; 0.)<a name='1698'>
        sicemelt = MIN(ssoil%wbice(:,k) * soil%zse(k) * 1000.0, &amp;<a name='1699'>
               (ssoil%tgg(:,k) - tfrz) * ssoil%gammzz(:,k) / hlf)<a name='1700'>
        ssoil%wbice(:,k) = MAX(0.0_r_2, ssoil%wbice(:,k) - sicemelt &amp;<a name='1701'>
                         &amp; / (soil%zse(k) * 1000.0) )<a name='1702'>
        xx = soil%css * soil%rhosoil<a name='1703'>
        ssoil%gammzz(:,k) = MAX( (1.0-soil%ssat) * soil%css * soil%rhosoil &amp;<a name='1704'>
             &amp; + (ssoil%wb(:,k) - ssoil%wbice(:,k)) * cswat * rhowat &amp;<a name='1705'>
             &amp; + ssoil%wbice(:,k) * csice * rhowat * 0.9, xx ) * soil%zse(k)<a name='1706'>
        WHERE (k == 1 .and. ssoil%isflag == 0)<a name='1707'>
          ssoil%gammzz(:,k) = ssoil%gammzz(:,k) + cgsnow * ssoil%snowd<a name='1708'>
        END WHERE<a name='1709'>
        ssoil%tgg(:,k) = ssoil%tgg(:,k) - REAL(sicemelt,r_1) &amp;<a name='1710'>
                       &amp; * hlf / REAL(ssoil%gammzz(:,k),r_1)<a name='1711'>
      END WHERE<a name='1712'>
    END DO<a name='1713'>
  END SUBROUTINE soilfreeze<a name='1714'>
<a name='1715'>
<a name='1716'>
  <font color=#447700>!******************************************************************<a name='1717'></font>
<font color=#447700>!  SUBROUTINE remove_trans(dels, soil, ssoil, canopy, veg)<a name='1718'></font>
<A NAME='REMOVE_TRANS'><A href='../../html_code/science/cable_soilsnow.F90.html#REMOVE_TRANS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1719'>
    <font color=#993300>SUBROUTINE </font><font color=#cc0000>remove_trans</font>(dels, soil, ssoil, canopy, veg) <A href='../../call_to/REMOVE_TRANS.html' TARGET='index'>1</A><a name='1720'>
    REAL(r_1), INTENT(IN)                    :: dels <font color=#447700>! integration time step (s)<a name='1721'></font>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy<a name='1722'>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil<a name='1723'>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='1724'>
    TYPE (veg_parameter_type), INTENT(IN)    :: veg<a name='1725'>
<font color=#447700>!    TYPE(veg_parameter_type), INTENT(INOUT)  :: veg<a name='1726'></font>
    REAL(r_1), DIMENSION(mp,ms)   :: evapfbl<a name='1727'>
    REAL(r_1), DIMENSION(mp,0:ms) :: diff <a name='1728'>
    REAL(r_1), DIMENSION(mp)      :: xx<a name='1729'>
    INTEGER(i_d) k<a name='1730'>
<a name='1731'>
    diff(:,:) = 0.0  <a name='1732'>
<font color=#447700>!    diff(:,0) = 0.0<a name='1733'></font>
    evapfbl(:,:) = 0.0<a name='1734'>
<a name='1735'>
<font color=#447700>!    print *,'remove_trans1',canopy%fevc(352),soil%swilt(352)<a name='1736'></font>
<font color=#447700>!    print *,'remove_trans1a',ssoil%wb(352,:)<a name='1737'></font>
    DO k = 1,ms<a name='1738'>
      <font color=#447700>! Removing transpiration from soil:<a name='1739'></font>
      WHERE (canopy%fevc &gt; 0.0)     <font color=#447700>! convert to mm/dels<a name='1740'></font>
        <font color=#447700>! Calculate the amount (perhaps moisture/ice limited)<a name='1741'></font>
        <font color=#447700>! which can be removed:<a name='1742'></font>
        xx = canopy%fevc * dels / hl * veg%froot(:,k) + diff(:,k-1)   <font color=#447700>! kg/m2<a name='1743'></font>
        diff(:,k) = ( MAX( 0.0, ssoil%wb(:,k) - soil%swilt) &amp;      <font color=#447700>! m3/m3<a name='1744'></font>
                  &amp; * soil%zse(k) * 1000.0 - xx) / (soil%zse(k) * 1000.0)<a name='1745'>
<font color=#447700>!        diff(:,k) = (MAX( 0.0, MIN( ssoil%wb(:,k) - soil%swilt, &amp;      ! m3/m3<a name='1746'></font>
<font color=#447700>!                  &amp; ssoil%wb(:,k) - ssoil%wbice(:,k) ) ) &amp;<a name='1747'></font>
<font color=#447700>!                  &amp; * soil%zse(k) * 1000.0 - xx) / (soil%zse(k) * 1000.0)<a name='1748'></font>
        WHERE ( diff(:,k) .gt. 0.0 )<a name='1749'>
          ssoil%wb(:,k) = ssoil%wb(:,k) - xx / (soil%zse(k) * 1000.0)<a name='1750'>
          diff(:,k) = 0.0<a name='1751'>
          evapfbl(:,k) = xx <a name='1752'>
        ELSEWHERE<a name='1753'>
          diff(:,k) = xx<a name='1754'>
        ENDWHERE<a name='1755'>
      END WHERE<a name='1756'>
    END DO<a name='1757'>
<a name='1758'>
    <font color=#447700>! Adjust fevc<a name='1759'></font>
<font color=#447700>!    WHERE (canopy%fevc &gt; 0.)  <a name='1760'></font>
<font color=#447700>!      canopy%fevc = (evapfbl(:,1)+evapfbl(:,2)+evapfbl(:,3)+evapfbl(:,4))*hl/dels<a name='1761'></font>
<font color=#447700>!!        &amp; + evapfbl(:,5)+evapfbl(:,6))*hl/dels<a name='1762'></font>
<font color=#447700>!    END WHERE<a name='1763'></font>
<a name='1764'>
<font color=#447700>!    print *,'remove_trans2',canopy%fevc(352),soil%swilt(352)<a name='1765'></font>
<font color=#447700>!    print *,'remove_trans2a',ssoil%wb(352,:)<a name='1766'></font>
<font color=#447700>!    print *,'remove_trans3a',ssoil%wb(352,:)<a name='1767'></font>
<a name='1768'>
  END SUBROUTINE remove_trans <a name='1769'>
<a name='1770'>
  <font color=#447700>!----------------------------------------------------------------------------<a name='1771'></font>
  <font color=#447700>! SUBROUTINE soil_snow<a name='1772'></font>
  <font color=#447700>!<a name='1773'></font>
  <font color=#447700>! Replaces following<a name='1774'></font>
  <font color=#447700>! SUBROUTINE soilsnow (dt_in, ktau_in, ga, dgdtg, condxpr, scondxpr, fev, fes, t, coszen)<a name='1775'></font>
  <font color=#447700>!	    for snow diag prints set ntest to 1 throughout<a name='1776'></font>
  <font color=#447700>!	    or, usefully can edit 'ntest &gt; 0' to 'ktau &gt; nnn'<a name='1777'></font>
  <font color=#447700>!----------------------------------------------------------------------<a name='1778'></font>
  <font color=#447700>! Inputs:<a name='1779'></font>
  <font color=#447700>!	 dt_in - time step in sec<a name='1780'></font>
  <font color=#447700>!	 ktau_in - time step no.<a name='1781'></font>
  <font color=#447700>!	 ga	 - ground heat flux W/m^2<a name='1782'></font>
  <font color=#447700>!	 dgdtg	 -<a name='1783'></font>
  <font color=#447700>!	 condxpr - total precip reaching the ground (liquid and solid)<a name='1784'></font>
  <font color=#447700>!	 scondxpr - precip (solid only)<a name='1785'></font>
  <font color=#447700>!	 fev   - transpiration (W/m2)<a name='1786'></font>
  <font color=#447700>!	 fess   - soil evaporation (W/m2)<a name='1787'></font>
  <font color=#447700>!	 isoil - soil type<a name='1788'></font>
  <font color=#447700>!	 ivegt - vegetation type<a name='1789'></font>
  <font color=#447700>! Output<a name='1790'></font>
  <font color=#447700>!	 ssoil<a name='1791'></font>
<font color=#447700>! SUBROUTINE soil_snow(dels, ktau, soil, ssoil, veg,canopy, met, bal)<a name='1792'></font>
<A NAME='SOIL_SNOW'><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1793'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>soil_snow</font>(dels, soil, ssoil, canopy, met, bal, veg) <A href='../../call_to/SOIL_SNOW.html' TARGET='index'>2</A>,<A href='../../call_from/SOIL_SNOW.html' TARGET='index'>13</A><a name='1794'>
   use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_18"><a name='1795'>
   use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_8">, only : cable_stat<a name='1796'>
<a name='1797'>
   implicit none<a name='1798'>
    REAL(r_1), INTENT(IN)                    :: dels <font color=#447700>! integration time step (s)<a name='1799'></font>
    TYPE(soil_parameter_type), INTENT(INOUT) :: soil<a name='1800'>
    TYPE(soil_snow_type), INTENT(INOUT)      :: ssoil<a name='1801'>
    TYPE(canopy_type), INTENT(INOUT)         :: canopy<a name='1802'>
<font color=#447700>!    TYPE(veg_parameter_type), INTENT(INOUT)  :: veg<a name='1803'></font>
    TYPE(met_type), INTENT(INOUT)            :: met <font color=#447700>! all met forcing<a name='1804'></font>
    TYPE (balances_type), INTENT(INOUT)      :: bal<a name='1805'>
    TYPE (veg_parameter_type), INTENT(IN)    :: veg<a name='1806'>
    INTEGER(i_d), PARAMETER  :: ntest = 0 <font color=#447700>!  for prints<a name='1807'></font>
    INTEGER(i_d)             :: k<a name='1808'>
<font color=#447700>!    REAL(r_2), DIMENSION(mp):: sicefreeze<a name='1809'></font>
<font color=#447700>!    REAL(r_2), DIMENSION(mp):: sicemelt<a name='1810'></font>
    REAL(r_1), DIMENSION(mp) :: snowmlt<a name='1811'>
    REAL(r_1), DIMENSION(mp) :: totwet<a name='1812'>
    REAL(r_1), DIMENSION(mp) :: weting<a name='1813'>
    REAL(r_1), DIMENSION(mp) :: xxx<a name='1814'>
    REAL(r_2), DIMENSION(mp) :: sinfil1,sinfil2,sinfil3<a name='1815'>
    REAL(r_2), DIMENSION(mp) :: xx,deltat<a name='1816'>
<font color=#447700>!    REAL(r_2), DIMENSION(mp) :: oldpudsto,newpudsto<a name='1817'></font>
    REAL(r_1)                :: zsetot<a name='1818'>
    REAL(r_1), DIMENSION(mp) :: tgg_old,tggsn_old <a name='1819'>
    INTEGER(i_d) :: idjd1,idjd2,idjd3<a name='1820'>
   integer, save :: ktau =1<a name='1821'>
<a name='1822'>
      if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='1823'>
         call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_8">('soil_snow')<a name='1824'>
    idjd1 = 351<a name='1825'>
    idjd2 = 8285<a name='1826'>
    idjd3 = 9985<a name='1827'>
<a name='1828'>
<a name='1829'>
    <font color=#447700>! Diagnostic block:<a name='1830'></font>
    IF(ntest&gt;0) THEN<a name='1831'>
<font color=#447700>!    IF(mp &gt; 10300) THEN<a name='1832'></font>
      print *,'idjd',idjd<a name='1833'>
      PRINT 10, ktau,mp, ssoil%isflag(idjd),ssoil%osnowd(idjd),ssoil%snowd(idjd), &amp;<a name='1834'>
                      met%tk(idjd),met%tc(idjd),met%qv(idjd),met%ua(idjd), &amp;<a name='1835'>
                      met%fsd(idjd,3),met%fld(idjd), met%precip(idjd),canopy%precis(idjd)<a name='1836'>
10    format(x,'soilsnowv befstempv,ktau=',2i6,2x,i2,2f8.2,f5.0,f5.1,f7.4,f5.1,x,2f6.0,2f6.3)<a name='1837'>
      PRINT 11, ktau,canopy%dgdtg(idjd),canopy%fevc(idjd),canopy%fevw(idjd), &amp;<a name='1838'>
                canopy%fess(idjd),canopy%fe(idjd),canopy%fhs(idjd),canopy%fhv(idjd), &amp;<a name='1839'>
                canopy%fh(idjd),canopy%fnv(idjd),canopy%fns(idjd),canopy%precis(idjd)<a name='1840'>
11    format(x,'bsoilsnow',i6,10f7.2,2x,f6.3)<a name='1841'>
      PRINT 12, ktau,canopy%ga(idjd),(ssoil%ssdn(idjd,k),k=1,3), &amp;<a name='1842'>
                (ssoil%sdepth(idjd,k),k=1,3),(ssoil%smass(idjd,k),k=1,3)<a name='1843'>
12    format(x,'bga,ssdn,sdepth smass',i6,f7.1,3f6.1,2x,3f8.3,2x,3f8.1)<a name='1844'>
      PRINT 13, ktau,(ssoil%tgg(idjd,k),k=1,ms),(ssoil%tggsn(idjd,k),k=1,3)<a name='1845'>
13    format(x,'btgg tggsn ',i6,6f7.2,2x,3f7.2)<a name='1846'>
      PRINT 14, ktau,(ssoil%wb(idjd,k),k=1,ms),(ssoil%wbice(idjd,k),k=1,ms),veg%froot(idjd,:)<a name='1847'>
14    format(x,'bwb wbice',i6,6f6.3,2x,6f6.3,6f6.3)<a name='1848'>
    ENDIF<a name='1849'>
<a name='1850'>
    zsetot = sum(soil%zse) <a name='1851'>
    ssoil%tggav = 0.<a name='1852'>
    DO k = 1, ms<a name='1853'>
     ssoil%tggav = ssoil%tggav  + soil%zse(k)*ssoil%tgg(:,k)/zsetot<a name='1854'>
    END DO<a name='1855'>
    ssoil%fwtop1 = 0.0<a name='1856'>
    ssoil%fwtop2 = 0.0<a name='1857'>
    ssoil%fwtop3 = 0.0<a name='1858'>
    ssoil%runoff = 0.0<a name='1859'>
    ssoil%rnof1 = 0.0<a name='1860'>
    ssoil%rnof2 = 0.0<a name='1861'>
    ssoil%smelt = 0.0 <font color=#447700>! initialise snowmelt<a name='1862'></font>
    ssoil%osnowd = ssoil%snowd<a name='1863'>
    ssoil%dtmlt = 0.0<a name='1864'>
<font color=#447700>!    ssoil%qasrf =  0.0<a name='1865'></font>
<font color=#447700>!    ssoil%qfsrf =  0.0<a name='1866'></font>
<font color=#447700>!    ssoil%qssrf =  0.0<a name='1867'></font>
<a name='1868'>
    IF (ktau_gl .eq. 1) THEN<a name='1869'>
<font color=#447700>!      canopy%ga = 0.0<a name='1870'></font>
      canopy%dgdtg = 0.0<a name='1871'>
      <font color=#447700>! N.B. snmin should exceed sum of layer depths, i.e. .11 m<a name='1872'></font>
      <font color=#447700>!     IF (ntest == 3) snmin = .11 ! to force 3-layer snow for testing<a name='1873'></font>
      ssoil%wbtot = 0.0<a name='1874'>
      DO k = 1, ms<a name='1875'>
<font color=#447700>!!$        ssoil%wb(:,k)  = min( soil%ssat,max ( ssoil%wb(:,k), soil%swilt ))<a name='1876'></font>
        ssoil%wbtot = ssoil%wbtot + ssoil%wb(:,k) * 1000.0 * soil%zse(k)<a name='1877'>
      END DO<a name='1878'>
<font color=#447700>!!$      ssoil%wb(:,ms-2)  = min( soil%ssat,max ( ssoil%wb(:,ms-2), 0.5*(soil%sfc+soil%swilt) ))<a name='1879'></font>
<font color=#447700>!!$      ssoil%wb(:,ms-1)  = min( soil%ssat,max ( ssoil%wb(:,ms-1), 0.8*soil%sfc ))<a name='1880'></font>
<font color=#447700>!!$      ssoil%wb(:,ms)    = min( soil%ssat,max ( ssoil%wb(:,ms),   soil%sfc) )<a name='1881'></font>
<font color=#447700>!!$!      ssoil%tgg(:,ms-1)  = ssoil%tgg(:,ms-1) - 1.<a name='1882'></font>
<font color=#447700>!!$!      ssoil%tgg(:,ms)    = ssoil%tgg(:,ms) - 2.<a name='1883'></font>
<font color=#447700>!!$      WHERE (soil%isoilm == 9)<a name='1884'></font>
<font color=#447700>!!$        ssoil%snowd = 1100.00 <a name='1885'></font>
<font color=#447700>!!$        ssoil%osnowd = 1100.00 <a name='1886'></font>
<font color=#447700>!!$        ssoil%tgg(:,1) = ssoil%tgg(:,1) - 1.0<a name='1887'></font>
<font color=#447700>!!$!        ssoil%tgg(:,2) = ssoil%tgg(:,2) - 1.0<a name='1888'></font>
<font color=#447700>!!$!        ssoil%tgg(:,3) = ssoil%tgg(:,3) - 0.0<a name='1889'></font>
<font color=#447700>!!$      END WHERE<a name='1890'></font>
<font color=#447700>!!$!<a name='1891'></font>
<font color=#447700>!!$      DO k = 1, ms<a name='1892'></font>
<font color=#447700>!!$        WHERE (ssoil%tgg(:,k) &lt;= tfrz .and. ssoil%wbice(:,k) &lt;= 0.01)<a name='1893'></font>
<font color=#447700>!!$          ssoil%wbice(:,k) = 0.5 * ssoil%wb(:,k)<a name='1894'></font>
<font color=#447700>!!$        END WHERE<a name='1895'></font>
<font color=#447700>!!$        WHERE (ssoil%tgg(:,k) &lt; tfrz)<a name='1896'></font>
<font color=#447700>!!$          ssoil%wbice(:,k) = 0.98 * ssoil%wb(:,k)<a name='1897'></font>
<font color=#447700>!!$        END WHERE<a name='1898'></font>
<font color=#447700>!!$      END DO<a name='1899'></font>
      xx=soil%css * soil%rhosoil<a name='1900'>
      ssoil%gammzz(:,1) = MAX( (1.0 - soil%ssat) * soil%css * soil%rhosoil &amp;<a name='1901'>
           &amp; + (ssoil%wb(:,1) - ssoil%wbice(:,1) ) * cswat * rhowat &amp;<a name='1902'>
           &amp; + ssoil%wbice(:,1) * csice * rhowat * .9, xx ) * soil%zse(1)<a name='1903'>
    END IF<a name='1904'>
    xx=soil%css * soil%rhosoil<a name='1905'>
    IF (ktau &lt;= 1) ssoil%gammzz(:,1) = MAX( (1.0 - soil%ssat) * soil%css * soil%rhosoil &amp;<a name='1906'>
           &amp; + (ssoil%wb(:,1) - ssoil%wbice(:,1) ) * cswat * rhowat &amp;<a name='1907'>
           &amp; + ssoil%wbice(:,1) * csice * rhowat * .9, xx ) * soil%zse(1)<a name='1908'>
<a name='1909'>
<font color=#447700>!   PRINT *, 'aft init',ktau,canopy%ga(idjd),ssoil%gammzz(idjd,1)<a name='1910'></font>
    DO k = 1, ms <font color=#447700>! for stempv<a name='1911'></font>
      ssoil%wblf(:,k) = MAX( 0.01_r_2, (ssoil%wb(:,k) - ssoil%wbice(:,k)) ) &amp;<a name='1912'>
                      &amp; / soil%ssat<a name='1913'>
      ssoil%wbfice(:,k) = REAL(ssoil%wbice(:,k),r_1) / soil%ssat<a name='1914'>
    END DO<a name='1915'>
<a name='1916'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOWCHECK'>snowcheck</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWCHECK_1"> (dels, ktau, ssoil, soil, met , ktau_gl)<a name='1917'>
<font color=#447700>!    CALL snowcheck (dels, ktau_gl, ssoil, soil, met )<a name='1918'></font>
<a name='1919'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOWDENSITY'>snowdensity</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWDENSITY_1"> (dels, ssoil, soil)<a name='1920'>
<a name='1921'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOW_ACCUM'>snow_accum</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_ACCUM_1"> (dels, ktau, canopy, met, ssoil, soil )<a name='1922'>
<a name='1923'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOW_MELTING'>snow_melting</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_MELTING_1"> (dels, snowmlt, ktau, ssoil, soil )<a name='1924'>
    ssoil%smelt = snowmlt<a name='1925'>
<a name='1926'>
    <font color=#447700>! adjust levels in the snowpack due to snow accumulation/melting,<a name='1927'></font>
    <font color=#447700>! snow aging etc...<a name='1928'></font>
<a name='1929'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOWL_ADJUST'>snowl_adjust</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOWL_ADJUST_1">(dels, ktau, ssoil, canopy )<a name='1930'>
<a name='1931'>
    <font color=#447700>! Diagnostic block:<a name='1932'></font>
    IF (ntest &gt; 0) THEN<a name='1933'>
      PRINT *, 'in soilsnowv before stempv,  ktau= ',ktau<a name='1934'>
      PRINT *, 'ga,dels,ssdn ', canopy%ga(idjd), dels, (ssoil%ssdn(idjd,k),k=1,3)<a name='1935'>
      PRINT *, 'osnowd,snowd,isflag', ssoil%osnowd(idjd), ssoil%snowd(idjd), &amp;<a name='1936'>
             &amp; ssoil%isflag(idjd)<a name='1937'>
      PRINT *, 'tgg ', (ssoil%tgg(idjd,k),k=1,ms)<a name='1938'>
      PRINT *, 'tggsn ', (ssoil%tggsn(idjd,k),k=1,3)<a name='1939'>
      PRINT *, 'wb ', (ssoil%wb(idjd,k),k=1,ms)<a name='1940'>
      PRINT *, 'wbice ', (ssoil%wbice(idjd,k),k=1,ms)<a name='1941'>
      PRINT *, 'wblf ', (ssoil%wblf(idjd,k),k=1,ms)<a name='1942'>
      PRINT *, 'wbfice ', (ssoil%wbfice(idjd,k),k=1,ms)<a name='1943'>
    END IF<a name='1944'>
<a name='1945'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#STEMPV'>stempv</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="STEMPV_1">(dels, canopy, ssoil, soil)<a name='1946'>
    ssoil%tss =  (1-ssoil%isflag)*ssoil%tgg(:,1) + ssoil%isflag*ssoil%tggsn(:,1)<a name='1947'>
<font color=#447700>!    deltat = ssoil%tss - ssoil%otss<a name='1948'></font>
<font color=#447700>!    where( veg%vlaiw .lt. 0.01) canopy%fhs = canopy%fhs + deltat*ssoil%dfh_dtg<a name='1949'></font>
<font color=#447700>!    where( veg%vlaiw .lt. 0.01) canopy%fes = canopy%fes + deltat* &amp;<a name='1950'></font>
<font color=#447700>!                                           (ssoil%cls*ssoil%dfe_ddq * ssoil%ddq_dtg)<a name='1951'></font>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SNOW_MELTING'>snow_melting</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SNOW_MELTING_2"> (dels, snowmlt, ktau, ssoil, soil )<a name='1952'>
    ssoil%smelt = ssoil%smelt + snowmlt<a name='1953'>
<a name='1954'>
    where(  ssoil%dtmlt(:,1) &gt; 0.0001) canopy%fhs = canopy%fhs+ssoil%dtmlt(:,1)*ssoil%dfh_dtg<a name='1955'>
    where( ssoil%dtmlt(:,1) &gt; 0.0001) canopy%fes = canopy%fes+ssoil%dtmlt(:,1)* &amp;<a name='1956'>
                                        (ssoil%cls*ssoil%dfe_ddq * ssoil%ddq_dtg)<a name='1957'>
<a name='1958'>
<font color=#447700>!    canopy%fhs = canopy%fhs+ssoil%smelt*hlf/dels<a name='1959'></font>
<a name='1960'>
<font color=#447700>!    where( veg%vlaiw .lt. 0.01 .and. ssoil%smelt &gt; 0.001) canopy%fhs = canopy%fhs+ssoil%smelt*hlf/dels<a name='1961'></font>
<font color=#447700>!    where( veg%vlaiw .lt. 0.01 .and. ssoil%dtmlt(:,1) &gt; 0.001) canopy%fes = canopy%fes+ssoil%dtmlt(:,1)* &amp;<a name='1962'></font>
<font color=#447700>!                                           (ssoil%cls*ssoil%dfe_ddq * ssoil%ddq_dtg)<a name='1963'></font>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#REMOVE_TRANS'>remove_trans</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="REMOVE_TRANS_1">(dels, soil, ssoil, canopy, veg)<a name='1964'>
<a name='1965'>
<font color=#447700>!    CALL hydraulic_redistribution(dels,ktau,soil,ssoil,canopy,veg, met)<a name='1966'></font>
<a name='1967'>
    CALL  <A href='../../html_code/science/cable_soilsnow.F90.html#SOILFREEZE'>soilfreeze</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILFREEZE_1">(dels, soil, ssoil)<a name='1968'>
<a name='1969'>
    totwet = canopy%precis + ssoil%smelt<a name='1970'>
    weting = totwet + max(0.,ssoil%pudsto - canopy%fesp/hl*dels) <font color=#447700>! total available liquid including puddle<a name='1971'></font>
    xxx=soil%ssat - ssoil%wb(:,1)<a name='1972'>
    sinfil1 = MIN( 0.95*xxx*soil%zse(1)*rhowat,weting) <font color=#447700>!soil capacity<a name='1973'></font>
    xxx=soil%ssat - ssoil%wb(:,2)<a name='1974'>
    sinfil2 = MIN( 0.95*xxx*soil%zse(2)*rhowat,weting-sinfil1) <font color=#447700>!soil capacity<a name='1975'></font>
    xxx=soil%ssat - ssoil%wb(:,3)<a name='1976'>
    sinfil3 = MIN( 0.95*xxx*soil%zse(3)*rhowat,weting-sinfil1-sinfil2) <font color=#447700>!soil capacity<a name='1977'></font>
    ssoil%fwtop1 = sinfil1/ dels - canopy%segg<a name='1978'>
    ssoil%fwtop2 = sinfil2/ dels<a name='1979'>
    ssoil%fwtop3 = sinfil3/ dels<a name='1980'>
<a name='1981'>
<font color=#447700>!    ssoil%fwtop = sinfil / dels - canopy%segg          ! net water flux to the soil<a name='1982'></font>
<font color=#447700>!   Puddle for the next time step<a name='1983'></font>
    ssoil%pudsto = max( 0., weting - sinfil1 - sinfil2 - sinfil3 )<a name='1984'>
    ssoil%rnof1 = max(0.,ssoil%pudsto - ssoil%pudsmx)<a name='1985'>
    ssoil%pudsto = ssoil%pudsto - ssoil%rnof1<a name='1986'>
<a name='1987'>
<font color=#447700>!    print 25,ktau,totwet(idjd1),weting(idjd1),canopy%segg(idjd1)*dels,ssoil%rnof1(idjd1), &amp;<a name='1988'></font>
<font color=#447700>!     ssoil%pudsto(idjd1), sinfil(idjd1),ssoil%fwtop(idjd1)*1800.,   &amp;<a name='1989'></font>
<font color=#447700>!     canopy%fes(idjd1),canopy%fess(idjd1),canopy%fesp(idjd1), &amp;<a name='1990'></font>
<font color=#447700>!     canopy%fesp(idjd1)/hl*dels,canopy%precis(idjd1),ssoil%wb(idjd1,1),met%tk(idjd1), &amp;<a name='1991'></font>
<font color=#447700>!     canopy%cansto(idjd1),canopy%oldcansto(idjd1),xxx(idjd1)*soil%zse(1)*rhowat<a name='1992'></font>
<font color=#447700>!25  format('Puddle2',i4,2f8.3,2x,2f8.5,2x,f7.3,x,f8.4,f10.6,2x,3f7.2,3f8.3,f6.1,2f6.3,f7.3)<a name='1993'></font>
                <font color=#447700>!<a name='1994'></font>
<font color=#447700>!    CALL  soilfreeze(dels, soil, ssoil)<a name='1995'></font>
<a name='1996'>
<font color=#447700>!    CALL remove_trans(dels, soil, ssoil, canopy)<a name='1997'></font>
<a name='1998'>
    CALL <A href='../../html_code/science/cable_soilsnow.F90.html#SURFBV'>surfbv</A><A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFBV_1">(dels, ktau,  met, ssoil, soil, veg, canopy )<a name='1999'>
<a name='2000'>
<font color=#447700>!    CALL hydraulic_redistribution(dels,ktau,soil,ssoil,canopy,veg, met)<a name='2001'></font>
<font color=#447700>!as per Eva, no more call to hydraulic_redistribution.<a name='2002'></font>
<font color=#447700>!<a name='2003'></font>
<a name='2004'>
<font color=#447700>!!    CALL snow_albedo(dels, ktau, met, ssoil, soil )<a name='2005'></font>
<a name='2006'>
    <font color=#447700>! Diagnostic block:<a name='2007'></font>
    IF (ntest &gt; 0) THEN<a name='2008'>
<font color=#447700>!    IF (mp &gt; 10000) THEN<a name='2009'></font>
      PRINT 15, ktau, ssoil%isflag(idjd),ssoil%osnowd(idjd),ssoil%snowd(idjd), &amp;<a name='2010'>
                      ssoil%rnof1(idjd),ssoil%rnof2(idjd)<a name='2011'>
15    format(x,'after soilsnowv ktau=',i6,2x,i2,2f8.2,2x,2f6.3)<a name='2012'>
      PRINT 16, ktau,canopy%dgdtg(idjd),canopy%fevc(idjd),canopy%fevw(idjd), &amp;<a name='2013'>
                canopy%fess(idjd),canopy%fe(idjd),canopy%fhs(idjd),canopy%fhv(idjd), &amp;<a name='2014'>
                canopy%fh(idjd),canopy%fnv(idjd),canopy%fns(idjd),canopy%precis(idjd)<a name='2015'>
16    format(x,'absoilsnow',i6,10f7.2,2x,f6.3)<a name='2016'>
      PRINT 17, ktau,canopy%ga(idjd),(ssoil%ssdn(idjd,k),k=1,3), &amp;<a name='2017'>
                (ssoil%sdepth(idjd,k),k=1,3),(ssoil%smass(idjd,k),k=1,3)<a name='2018'>
17    format(x,'aft ga,ssdn,sdepth smass',i6,f7.1,3f6.1,2x,3f8.3,2x,3f8.1)<a name='2019'>
      PRINT 18, ktau,(ssoil%tgg(idjd,k),k=1,ms),(ssoil%tggsn(idjd,k),k=1,3)<a name='2020'>
18    format(x,'aftgg tggsn ',i6,6f7.2,2x,3f7.2)<a name='2021'>
      PRINT 19, ktau,(ssoil%wb(idjd,k),k=1,ms),(ssoil%wbice(idjd,k),k=1,ms), &amp;<a name='2022'>
                (ssoil%wblf(idjd,k),k=1,ms),(ssoil%wbfice(idjd,k),k=1,ms)<a name='2023'>
19    format(x,'awb wbice',i6,6f6.3,x,6f6.3,x,6f6.3,x,6f6.3)<a name='2024'>
    END IF<a name='2025'>
    <font color=#447700>! Set weighted soil/snow surface temperature:<a name='2026'></font>
<a name='2027'>
    ssoil%tss=(1-ssoil%isflag)*ssoil%tgg(:,1) + ssoil%isflag*ssoil%tggsn(:,1)<a name='2028'>
    ssoil%smelt = ssoil%smelt/dels<a name='2029'>
  <a name='2030'>
    ssoil%wbtot = 0.0<a name='2031'>
    DO k = 1, ms<a name='2032'>
       ssoil%wbtot = ssoil%wbtot + ssoil%wb(:,k) * 1000.0 * soil%zse(k)<a name='2033'>
    END DO<a name='2034'>
<a name='2035'>
   ktau=ktau+1<a name='2036'>
<a name='2037'>
  END SUBROUTINE soil_snow<a name='2038'>
<a name='2039'>
  <font color=#447700>!+++++++++++++++++++  Hydraulic Redistribution Section  ++++++++++++++++++++++<a name='2040'></font>
  <font color=#447700>! Sciences from Ryel et al. Oecologia, 2002; Lee et al., 2005, PNAS<a name='2041'></font>
  <font color=#447700>! Code by LiLH 16 Feb, 2011<a name='2042'></font>
  <font color=#447700>! Fixed problem of negative wb in global run by BP Mar 2011<a name='2043'></font>
<A NAME='HYDRAULIC_REDISTRIBUTION'><A href='../../html_code/science/cable_soilsnow.F90.html#HYDRAULIC_REDISTRIBUTION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='2044'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>hydraulic_redistribution</font>(dels, ktau, soil, ssoil, canopy, veg, met)<a name='2045'>
    REAL(r_1),                 INTENT(IN) :: dels <font color=#447700>! integration time step (s)<a name='2046'></font>
    INTEGER(i_d),              INTENT(IN) :: ktau  <font color=#447700>! integration step number<a name='2047'></font>
    TYPE(soil_parameter_type), INTENT(IN) :: soil<a name='2048'>
    TYPE(soil_snow_type),   INTENT(INOUT) :: ssoil<a name='2049'>
    TYPE(canopy_type),         INTENT(IN) :: canopy<a name='2050'>
    TYPE(veg_parameter_type),  INTENT(IN) :: veg<a name='2051'>
    TYPE(met_type), INTENT(INOUT)         :: met <font color=#447700>! all met forcing<a name='2052'></font>
    INTEGER(i_d) k<a name='2053'>
    INTEGER(i_d) j<a name='2054'>
    INTEGER(i_d) ii<a name='2055'>
    REAL(r_1), DIMENSION(mp,ms)    :: S_VG                <font color=#447700>! --<a name='2056'></font>
    REAL(r_1), DIMENSION(mp,ms)    :: wpsy                <font color=#447700>! MPa<a name='2057'></font>
    REAL(r_1), DIMENSION(mp)       :: frootX              <font color=#447700>! --<a name='2058'></font>
    REAL(r_1), DIMENSION(mp,ms)    :: C_hr                <font color=#447700>! --<a name='2059'></font>
<font color=#447700>!    REAL(r_1), DIMENSION(mp,ms)    :: hr                  ! cm/hour<a name='2060'></font>
    REAL(r_1), DIMENSION(mp,ms,ms) :: hr_term             <font color=#447700>! cm/hour<a name='2061'></font>
    REAL(r_1), DIMENSION(mp)       :: Dtran               <font color=#447700>! Swith for hr<a name='2062'></font>
<a name='2063'>
    REAL(r_1), PARAMETER :: thetas=0.45  <font color=#447700>! from Belk et al., 2007, WRR<a name='2064'></font>
    REAL(r_1), PARAMETER :: thetar=0.20  <font color=#447700>! from Belk et al., 2007, WRR<a name='2065'></font>
    <font color=#447700>! REAL(r_1), PARAMETER :: alpha_VG = 0.00045  ! from Belk et al., 2007, WRR,<a name='2066'></font>
                                                  <font color=#447700>! cm^{-1} 1cmH2O=100Pa<a name='2067'></font>
    <font color=#447700>! REAL(r_1), PARAMETER :: n_VG = 1.40         ! from Belk et al., 2007, WRR<a name='2068'></font>
    REAL(r_1), PARAMETER :: n_VG = 2.06           <font color=#447700>! -- 2.06<a name='2069'></font>
    REAL(r_1), PARAMETER :: m_VG = 1.0-1.0/n_VG   <font color=#447700>! --<a name='2070'></font>
    REAL(r_1), PARAMETER :: alpha_VG = 0.00423    <font color=#447700>! cm^{-1} Note: 1cmH2O=100Pa<a name='2071'></font>
    REAL(r_1), PARAMETER :: n_hr = 3.22           <font color=#447700>! --<a name='2072'></font>
    REAL(r_1), PARAMETER :: wpsy50 = -1.0         <font color=#447700>! MPa<a name='2073'></font>
    REAL(r_1), PARAMETER :: CRT = 125.0           <font color=#447700>! cm MPa^-1 h^-1, default value (0.097) from Ryel et al., 2002<a name='2074'></font>
    REAL(r_1), PARAMETER :: wiltParam = 0.5   <a name='2075'>
    REAL(r_1), PARAMETER :: satuParam = 0.8   <a name='2076'>
    <font color=#447700>! 125.0  for Tumbarumbar <a name='2077'></font>
    <font color=#447700>! 125.0  for Dinghushan<a name='2078'></font>
    <font color=#447700>! 125.0  for Howard Springs<a name='2079'></font>
    <font color=#447700>! 125.0  for KM83 <a name='2080'></font>
    REAL(r_1), DIMENSION(mp,ms,ms) :: hr_perTime<a name='2081'>
    REAL(r_1), DIMENSION(mp)       :: temp<a name='2082'>
    REAL(r_1), DIMENSION(mp)       :: available<a name='2083'>
    REAL(r_1), DIMENSION(mp)       :: accommodate<a name='2084'>
    REAL(r_1), DIMENSION(mp)       :: totalmoist,totalice<a name='2085'>
    REAL(r_1), DIMENSION(mp)       :: total2,zsetot<a name='2086'>
<font color=#447700>!    REAL(r_1), PARAMETER :: wiltParam = 0.5<a name='2087'></font>
<font color=#447700>!    REAL(r_1), PARAMETER :: satuParam = 0.8<a name='2088'></font>
    INTEGER(i_d) :: idjd1<a name='2089'>
<a name='2090'>
    <font color=#447700>! Find initial moisture total for checking purpose<a name='2091'></font>
    idjd1 = 351  <font color=#447700>! Amazon<a name='2092'></font>
<a name='2093'>
    zsetot = sum(soil%zse)<a name='2094'>
    totalmoist(:) = 0.0<a name='2095'>
    totalice(:) = 0.0<a name='2096'>
    DO k=1, ms<a name='2097'>
      totalmoist(:) = totalmoist(:) + ssoil%wb(:,k)*soil%zse(k)/zsetot<a name='2098'>
      totalice(:) = totalice(:) + ssoil%wbice(:,k)*soil%zse(k)/zsetot<a name='2099'>
    ENDDO<a name='2100'>
<a name='2101'>
    WHERE ( canopy%fevc &gt; 10.0 )  <font color=#447700>! restrict to nighttime and cloudy day<a name='2102'></font>
      Dtran=0.0<a name='2103'>
    ELSEWHERE<a name='2104'>
      Dtran=1.0<a name='2105'>
    ENDWHERE<a name='2106'>
    where ( totalice  &gt; 1.e-2 ) Dtran=0.<a name='2107'>
    <a name='2108'>
    DO k=1, ms<a name='2109'>
      S_VG(:,k) = MIN( 1.0, MAX(1.0E-4, ssoil%wb(:,k) - soil%swilt) &amp;<a name='2110'>
                             / (soil%ssat - soil%swilt) )<a name='2111'>
      wpsy(:,k) = -1.0/alpha_VG*(S_VG(:,k)**(-1.0/m_VG)-1.0)**(1/n_VG) &amp;<a name='2112'>
                   *100*1.0E-6     <font color=#447700>! VG model, convert from cm to Pa by (*100),<a name='2113'></font>
                                   <font color=#447700>!                           to MPa (*1.0E-6)<a name='2114'></font>
      C_hr(:,k) = 1./(1+(wpsy(:,k)/wpsy50)**n_hr)<a name='2115'>
    ENDDO<a name='2116'>
<font color=#447700>!    print *,'zse',soil%zse,ms,mp,soil%swilt(idjd1),soil%ssat(idjd1),soil%sfc(idjd1), &amp;<a name='2117'></font>
<font color=#447700>!                  met%tk(idjd1),met%precip(idjd1)<a name='2118'></font>
<font color=#447700>!    print 14,(ssoil%wb(idjd1,k),k=1,4),totalmoist(idjd1),(wpsy(idjd1,k),k=1,4), &amp;<a name='2119'></font>
<font color=#447700>!                       (C_hr(idjd1,k),k=1,4),canopy%fevc(idjd1),Dtran(idjd1)<a name='2120'></font>
<font color=#447700>!14  format(1x,'hydrre0',4f8.5,2x,f8.5,2(4f8.3),2x,f8.3,f4.1)<a name='2121'></font>
<a name='2122'>
<font color=#447700>!    hr(:,:) = 0.0<a name='2123'></font>
    temp(:)        = 0.0<a name='2124'>
    hr_term(:,:,:) = 0.0    <font color=#447700>! unit: cm h^{-1}<a name='2125'></font>
    hr_perTime(:,:,:) = 0.0<a name='2126'>
    <font color=#447700>! setting hr_term=0 for top layer, follows Lee et al., 2005, PNAS<a name='2127'></font>
    DO k = ms, 3, -1<a name='2128'>
      DO j = k-1, 2, -1<a name='2129'>
        temp(:)        = 0.0<a name='2130'>
        available(:)   = 0.0<a name='2131'>
        accommodate(:) = 0.0<a name='2132'>
        WHERE ( veg%froot(:,k) &gt; veg%froot(:,j) )<a name='2133'>
          frootX=veg%froot(:,k)<a name='2134'>
        ELSEWHERE<a name='2135'>
          frootX=veg%froot(:,j)<a name='2136'>
        ENDWHERE<a name='2137'>
        hr_term(:,k,j) = CRT*(wpsy(:,j)-wpsy(:,k))*MAX(C_hr(:,k),C_hr(:,j)) &amp;<a name='2138'>
                       *(veg%froot(:,k)*veg%froot(:,j))/(1-frootX) * Dtran<a name='2139'>
        hr_perTime(:,k,j) = hr_term(:,k,j)*1.0E-2/3600.0*dels <font color=#447700>! m per timestep<a name='2140'></font>
        hr_perTime(:,j,k) = -1.0 * hr_perTime(:,k,j)<a name='2141'>
        hr_perTime(:,k,j) = hr_perTime(:,k,j)/soil%zse(k)<a name='2142'>
        hr_perTime(:,j,k) = hr_perTime(:,j,k)/soil%zse(j)<a name='2143'>
        <font color=#447700>! Restricting changes to all broadleaf forests, and<a name='2144'></font>
        <font color=#447700>! other forests and woody savannas in the tropics<a name='2145'></font>
        <font color=#447700>! Note that veg types here are based on IGBP classification (BP mar2011)<a name='2146'></font>
<font color=#447700>!        WHERE (.NOT.(veg%iveg==2.OR.veg%iveg==7.OR.veg%iveg==8.OR.veg%iveg==9))<a name='2147'></font>
        WHERE (.NOT.veg%iveg==2)<a name='2148'>
<font color=#447700>!        WHERE (.NOT.(veg%iveg == 2 .OR. veg%iveg == 2 ))<a name='2149'></font>
<font color=#447700>!                     .OR.((veg%iveg &lt;=5 .OR. veg%iveg ==8) )))<a name='2150'></font>
<font color=#447700>!                     .OR.((veg%iveg &lt;=5 .OR. veg%iveg ==8) &amp;<a name='2151'></font>
<font color=#447700>!                          .AND. patch(:)%latitude &gt; -24.0 &amp;<a name='2152'></font>
<font color=#447700>!                          .AND. patch(:)%latitude &lt;  24.0)  ))<a name='2153'></font>
          hr_perTime(:,k,j) = 0.0<a name='2154'>
          hr_perTime(:,j,k) = 0.0<a name='2155'>
        ENDWHERE<a name='2156'>
        WHERE (hr_perTime(:,k,j) &lt; 0.0)<a name='2157'>
<font color=#447700>!          available(:)   = MAX(0.0, ssoil%wb(:,k)-soil%swilt(:))<a name='2158'></font>
          available(:)   = MAX(0.0, ssoil%wb(:,k)-  &amp;<a name='2159'>
                          ( soil%swilt(:) + (soil%sfc(:)-soil%swilt(:))/3.) )<a name='2160'>
          accommodate(:) = MAX(0.0, soil%ssat(:)-ssoil%wb(:,j))<a name='2161'>
          temp(:) = MAX(hr_perTime(:,k,j), &amp;<a name='2162'>
                        -1.0*wiltParam*available(:), &amp;<a name='2163'>
                        -1.0*satuParam*accommodate(:)*soil%zse(j)/soil%zse(k)) <a name='2164'>
          hr_perTime(:,k,j) = temp(:)<a name='2165'>
          hr_perTime(:,j,k) = -1.0 * temp(:) * soil%zse(k) / soil%zse(j)<a name='2166'>
        ELSEWHERE (hr_perTime(:,j,k) &lt; 0.0)<a name='2167'>
<font color=#447700>!          available(:)   = MAX(0.0, ssoil%wb(:,j)-soil%swilt(:))<a name='2168'></font>
          available(:)   = MAX(0.0, ssoil%wb(:,j)-  &amp;<a name='2169'>
                           ( soil%swilt(:) + (soil%sfc(:)-soil%swilt(:))/3.) )<a name='2170'>
          accommodate(:) = MAX(0.0, soil%ssat(:)-ssoil%wb(:,k))<a name='2171'>
          temp(:) = MAX(hr_perTime(:,j,k), &amp;<a name='2172'>
                        -1.0*wiltParam*available(:), &amp;<a name='2173'>
                        -1.0*satuParam*accommodate(:)*soil%zse(k)/soil%zse(j))<a name='2174'>
          hr_perTime(:,j,k) = temp(:)<a name='2175'>
          hr_perTime(:,k,j) = -1.0 * temp(:) * soil%zse(j) / soil%zse(k)<a name='2176'>
        ENDWHERE<a name='2177'>
        ssoil%wb(:,k) = ssoil%wb(:,k) + hr_perTime(:,k,j)<a name='2178'>
        ssoil%wb(:,j) = ssoil%wb(:,j) + hr_perTime(:,j,k)<a name='2179'>
<font color=#447700>!      print 18,k,j,veg%iveg(idjd1),available(idjd1),accommodate(idjd1),hr_perTime(idjd1,j,k)<a name='2180'></font>
<font color=#447700>!18  format(1x,'hydrre1',3i3,3f8.4)<a name='2181'></font>
      ENDDO <a name='2182'>
    ENDDO<a name='2183'>
<a name='2184'>
    <font color=#447700>! Redistribution should not change the total. Check if it is true.<a name='2185'></font>
<font color=#447700>!    total2(:) = 0.0<a name='2186'></font>
<font color=#447700>!    DO k=1, ms<a name='2187'></font>
<font color=#447700>!      total2(:) = total2(:) + ssoil%wb(:,k)*soil%zse(k)/zsetot<a name='2188'></font>
<font color=#447700>!    ENDDO<a name='2189'></font>
<font color=#447700>!    print 20,(ssoil%wb(idjd1,k),k=1,4),totalmoist(idjd1),total2(idjd1)<a name='2190'></font>
<font color=#447700>!20  format(1x,'hydrre2',4f8.5,2x,2f8.5)<a name='2191'></font>
<a name='2192'>
<a name='2193'>
<font color=#447700>!    IF (MINVAL(totalmoist(:) - total2(:)) &lt; -1.0e-6 .OR. &amp;<a name='2194'></font>
<font color=#447700>!        MAXVAL(totalmoist(:) - total2(:)) &gt;  1.0e-6) THEN<a name='2195'></font>
<font color=#447700>!      PRINT *, 'Problem with hydraulic_redistribution at timestep ', ktau<a name='2196'></font>
<font color=#447700>!      PRINT *, 'Maximum of ', MAXVAL(totalmoist(:) - total2(:)), ' at ', &amp;<a name='2197'></font>
<font color=#447700>!                MAXLOC(totalmoist(:) - total2(:))<a name='2198'></font>
<font color=#447700>!      PRINT *, 'Minimum of ', MINVAL(totalmoist(:) - total2(:)), ' at ', &amp;<a name='2199'></font>
<font color=#447700>!                MINLOC(totalmoist(:) - total2(:))<a name='2200'></font>
<font color=#447700>!      STOP<a name='2201'></font>
<font color=#447700>!    ENDIF<a name='2202'></font>
<a name='2203'>
  END SUBROUTINE hydraulic_redistribution<a name='2204'>
  <font color=#447700>!+++++++++++++++++++  Hydraulic Redistribution Section  ++++++++++++++++++++++<a name='2205'></font>
<a name='2206'>
<a name='2207'>
END MODULE soil_snow_module<a name='2208'>
</pre></body></html>