<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<a name='2'>
<A NAME='ALBEDO_MODULE'><A href='../../html_code/science/cable_albedo.F90.html#ALBEDO_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>albedo_module</font> <A href='../../call_to/ALBEDO_MODULE.html' TARGET='index'>1</A><a name='4'>
   IMPLICIT NONE<a name='5'>
   private<a name='6'>
   PUBLIC surface_albedo<a name='7'>
   CONTAINS<a name='8'>
<a name='9'>
<A NAME='SURFACE_ALBEDO'><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='10'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>surface_albedo</font>(ssoil, veg, met, rad, soil, canopy) <A href='../../call_to/SURFACE_ALBEDO.html' TARGET='index'>2</A>,<A href='../../call_from/SURFACE_ALBEDO.html' TARGET='index'>8</A><a name='11'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_6"><a name='12'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_2"><a name='13'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_10"><a name='14'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_1">, only : LAI_THRESH, RAD_THRESH <a name='15'>
      use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_2">, only : cable_stat<a name='16'>
      implicit none<a name='17'>
      TYPE (soil_snow_type),INTENT(INOUT) :: ssoil<a name='18'>
      TYPE (veg_parameter_type),INTENT(INout):: veg<a name='19'>
      TYPE (canopy_type),INTENT(IN)          :: canopy<a name='20'>
      TYPE (met_type),INTENT(INOUT)       :: met<a name='21'>
      TYPE (radiation_type),INTENT(INOUT) :: rad<a name='22'>
      TYPE(soil_parameter_type), INTENT(INOUT) :: soil   <a name='23'>
<a name='24'>
      INTEGER(i_d)            :: b    <font color=#447700>!rad. band 1=visible, 2=near-infrared, 3=long-wave<a name='25'></font>
      LOGICAL, DIMENSION(mp)  :: mask <font color=#447700>! select points for calculation<a name='26'></font>
      real, dimension(:,:), allocatable, save :: c1, rhoch<a name='27'>
<a name='28'>
      if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='29'>
         call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_2">('surface_albedo')<a name='30'>
      <a name='31'>
      if (.not. allocated(c1)) &amp;<a name='32'>
         allocate( c1(mp,nrb), rhoch(mp,nrb) )<a name='33'>
<a name='34'>
      if(cable_runtime%um) &amp;<a name='35'>
         call <A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDOSN'>surface_albedosn</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_ALBEDOSN_1">(ssoil, veg, met, soil)<a name='36'>
<a name='37'>
      <font color=#447700>!jhan:Eva has added this<a name='38'></font>
      WHERE (soil%isoilm == 9)          <font color=#447700>! use dry snow albedo<a name='39'></font>
       ssoil%albsoilsn(:,2) = 0.82<a name='40'>
        ssoil%albsoilsn(:,1) = 0.82<a name='41'>
      END WHERE<a name='42'>
      <a name='43'>
      rad%cexpkbm = 0.0<a name='44'>
      rad%extkbm  = 0.0<a name='45'>
      rad%rhocbm      = 0.0<a name='46'>
 <a name='47'>
      <font color=#447700>! Initialise effective conopy beam reflectance:<a name='48'></font>
      rad%reffbm = ssoil%albsoilsn<a name='49'>
      rad%reffdf = ssoil%albsoilsn<a name='50'>
      rad%albedo = ssoil%albsoilsn<a name='51'>
 <a name='52'>
      <font color=#447700>! Define vegetation mask:<a name='53'></font>
      mask = canopy%vlaiw &gt; LAI_THRESH .AND. ( met%fsd(:,1) + met%fsd(:,2) ) &gt; RAD_THRESH     <a name='54'>
<a name='55'>
      call <A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH'>calc_rhoch</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RHOCH_1">( veg, c1, rhoch )<a name='56'>
<a name='57'>
      <font color=#447700>! Update extinction coefficients and fractional transmittance for <a name='58'></font>
      <font color=#447700>! leaf transmittance and reflection (ie. NOT black leaves):<a name='59'></font>
      <font color=#447700>!---1 = visible, 2 = nir radiaition<a name='60'></font>
      DO b = 1, 2        <a name='61'>
         <a name='62'>
         rad%extkdm(:,b) = rad%extkd * c1(:,b)<a name='63'>
         <font color=#447700>!--Define canopy diffuse transmittance (fraction):<a name='64'></font>
         rad%cexpkdm(:,b) = EXP(-rad%extkdm(:,b) * canopy%vlaiw)<a name='65'>
 <a name='66'>
         <font color=#447700>!---Calculate effective diffuse reflectance (fraction):<a name='67'></font>
         where( canopy%vlaiw &gt; 1e-2 ) <a name='68'>
            rad%reffdf(:,b) = rad%rhocdf(:,b) + (ssoil%albsoilsn(:,b) &amp;<a name='69'>
                  - rad%rhocdf(:,b)) * rad%cexpkdm(:,b)**2<a name='70'>
         END WHERE<a name='71'>
         <a name='72'>
         <font color=#447700>!---where vegetated and sunlit <a name='73'></font>
         WHERE (mask)                <a name='74'>
            rad%extkbm(:,b) = rad%extkb * c1(:,b)<a name='75'>
            <font color=#447700>! Canopy reflection (6.21) beam:<a name='76'></font>
            <font color=#447700>!jhan:BP uses local var rhocbm here not rad%<a name='77'></font>
            rad%rhocbm(:,b) = 2.*rad%extkb/(rad%extkb+rad%extkd)*rhoch(:,b)<a name='78'>
            <font color=#447700>! Canopy beam transmittance (fraction):<a name='79'></font>
            rad%cexpkbm(:,b) = EXP(-rad%extkbm(:,b)*canopy%vlaiw)<a name='80'>
            <font color=#447700>! Calculate effective beam reflectance (fraction):<a name='81'></font>
            rad%reffbm(:,b) = rad%rhocbm(:,b) + (ssoil%albsoilsn(:,b) &amp;<a name='82'>
                  - rad%rhocbm(:,b))*rad%cexpkbm(:,b)**2<a name='83'>
         END WHERE<a name='84'>
 <a name='85'>
         <font color=#447700>! Define albedo:<a name='86'></font>
         where( canopy%vlaiw&gt; LAI_THRESH ) <a name='87'>
            rad%albedo(:,b) = (1.-rad%fbeam(:,b))*rad%reffdf(:,b) + &amp;<a name='88'>
                  rad%fbeam(:,b)*rad%reffbm(:,b)<a name='89'>
         END WHERE<a name='90'>
          <a name='91'>
      END DO<a name='92'>
<a name='93'>
      return<a name='94'>
   END SUBROUTINE surface_albedo <a name='95'>
<a name='96'>
   <font color=#447700>!jhan:subr was reintroduced here to temporarily resolve issue when <a name='97'></font>
   <font color=#447700>!creating libcable.a <a name='98'></font>
<A NAME='CALC_RHOCH'><A href='../../html_code/science/cable_albedo.F90.html#CALC_RHOCH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='99'>
   <font color=#993300>subroutine </font><font color=#cc0000>calc_rhoch</font>(veg,c1,rhoch)  <A href='../../call_to/CALC_RHOCH.html' TARGET='index'>2</A>,<A href='../../call_from/CALC_RHOCH.html' TARGET='index'>5</A><a name='100'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_3"><a name='101'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_2"><a name='102'>
      implicit none<a name='103'>
      type (veg_parameter_type), intent(inout) :: veg<a name='104'>
      real, intent(inout), dimension(:,:) :: c1, rhoch<a name='105'>
<a name='106'>
<font color=#447700>!jhan:UM uses rad%extkn instead of veg%extkn, which should be read from par. file anyway<a name='107'></font>
<font color=#447700>!jhan:cahnge Mk3l to read veg%taul like UM <a name='108'></font>
<font color=#447700>!#ifndef ONLINE_UM<a name='109'></font>
<font color=#447700>!         veg%taul(:,1) = taul(1)<a name='110'></font>
<font color=#447700>!         veg%taul(:,2) = taul(2)<a name='111'></font>
<font color=#447700>!         veg%refl(:,1) = refl(1) <a name='112'></font>
<font color=#447700>!         veg%refl(:,2) = refl(2) <a name='113'></font>
<font color=#447700>!#endif                  <a name='114'></font>
         c1(:,1) = SQRT(1. - veg%taul(:,1) - veg%refl(:,1))<a name='115'>
         c1(:,2) = SQRT(1. - veg%taul(:,2) - veg%refl(:,2))<a name='116'>
         c1(:,3) = 1.<a name='117'>
          <a name='118'>
         <font color=#447700>! Canopy reflection black horiz leaves (eq. 6.19 in Goudriaan and van Laar, 1994):<a name='119'></font>
         rhoch = (1.0 - c1) / (1.0 + c1)<a name='120'>
      return<a name='121'>
   end subroutine calc_rhoch <a name='122'>
<a name='123'>
<A NAME='SURFACE_ALBEDOSN'><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDOSN' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='124'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>surface_albedosn</font>(ssoil, veg, met, soil) <A href='../../call_to/SURFACE_ALBEDOSN.html' TARGET='index'>1</A>,<A href='../../call_from/SURFACE_ALBEDOSN.html' TARGET='index'>3</A><a name='125'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDOSN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_4"><a name='126'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDOSN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_11"><a name='127'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDOSN' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_7"><a name='128'>
      implicit none<a name='129'>
      TYPE (soil_snow_type),INTENT(INOUT) :: ssoil<a name='130'>
      TYPE (veg_parameter_type),INTENT(INout):: veg<a name='131'>
      TYPE (met_type),INTENT(INOUT)       :: met<a name='132'>
      TYPE(soil_parameter_type), INTENT(INOUT) :: soil   <a name='133'>
      REAL(r_1), DIMENSION(mp)    :: alv <font color=#447700>! Snow albedo for visible<a name='134'></font>
      REAL(r_1), DIMENSION(mp)    :: alir <font color=#447700>! Snow albedo for near infra-red<a name='135'></font>
      REAL(r_1), PARAMETER        :: alvo  = 0.95 <font color=#447700>! albedo for vis. on a new snow<a name='136'></font>
      REAL(r_1), PARAMETER        :: aliro = 0.70 <font color=#447700>! albedo for near-infr. on a new snow<a name='137'></font>
      REAL(r_1), DIMENSION(mp)    :: ar1 <font color=#447700>! crystal growth  (-ve)<a name='138'></font>
      REAL(r_1), DIMENSION(mp)    :: ar2 <font color=#447700>! freezing of melt water<a name='139'></font>
      REAL(r_1), DIMENSION(mp)    :: ar3<a name='140'>
      REAL(r_1), DIMENSION(mp)    :: dnsnow <font color=#447700>! new snow albedo<a name='141'></font>
      REAL(r_1), DIMENSION(mp)    :: dtau<a name='142'>
      REAL(r_1), DIMENSION(mp)    :: fage <font color=#447700>!age factor<a name='143'></font>
      REAL(r_1), DIMENSION(mp)    :: fzenm<a name='144'>
      REAL(r_1), DIMENSION(mp)    :: sfact<a name='145'>
      REAL(r_1), DIMENSION(mp)    :: snr<a name='146'>
      REAL(r_1), DIMENSION(mp)    :: snrat<a name='147'>
      REAL(r_1), DIMENSION(mp)    :: talb <font color=#447700>! snow albedo<a name='148'></font>
      REAL(r_1), DIMENSION(mp)    :: tmp <font color=#447700>! temporary value<a name='149'></font>
      INTEGER(i_d)            :: k,i,j,l,l1,l2<a name='150'>
<a name='151'>
<font color=#447700>!jhan:incurrent code in coupled model soil%albsoil(mp)    <a name='152'></font>
    soil%albsoilf = soil%albsoil(:,1)<a name='153'>
    where( veg%iveg == 16 )<a name='154'>
      soil%albsoilf = -0.022*( min(275., max(260.,met%tk) ) - 260.) + 0.45<a name='155'>
    end where<a name='156'>
<font color=#447700>!jhan:Eva has added this<a name='157'></font>
    where(ssoil%snowd &gt; 1. .and. veg%iveg == 16 ) soil%albsoilf = 0.85<a name='158'>
    sfact = 0.68<a name='159'>
    WHERE (soil%albsoilf &lt;= 0.14)<a name='160'>
       sfact = 0.5<a name='161'>
    ELSEWHERE (soil%albsoilf &gt; 0.14 .and. soil%albsoilf &lt;= 0.20)<a name='162'>
       sfact = 0.62<a name='163'>
    END WHERE<a name='164'>
    ssoil%albsoilsn(:,2) = 2. * soil%albsoilf / (1. + sfact)<a name='165'>
    ssoil%albsoilsn(:,1) = sfact * ssoil%albsoilsn(:,2)<a name='166'>
    snrat=0.<a name='167'>
<font color=#447700>!jhan:Eva has added this<a name='168'></font>
<font color=#447700>!.6 and .9 -&gt; 0.<a name='169'></font>
    alir =0.<a name='170'>
    alv  =0.<a name='171'>
<font color=#447700>!jhan:Eva has added this 0 -&gt;1<a name='172'></font>
    WHERE (ssoil%snowd &gt; 1. .and. .NOT. cable_runtime%um_radiation) <a name='173'>
       dnsnow = min (1., .1 * max (0., ssoil%snowd - ssoil%osnowd ) ) <font color=#447700>! new snow (cm H2O)<a name='174'></font>
       <font color=#447700>!         Snow age depends on snow crystal growth, freezing of melt water,<a name='175'></font>
       <font color=#447700>!         accumulation of dirt and amount of new snow.<a name='176'></font>
       tmp = ssoil%isflag * ssoil%tggsn(:,1) + (1 - ssoil%isflag ) * ssoil%tgg(:,1)<a name='177'>
       tmp = min (tmp, 273.15)<a name='178'>
       ar1 = 5000. * (1. / 273.15 - 1. / tmp) <font color=#447700>! crystal growth  (-ve)<a name='179'></font>
       ar2 = 10. * ar1 <font color=#447700>! freezing of melt water<a name='180'></font>
<font color=#447700>!jhan:Eva has added this 300 -&gt; 200<a name='181'></font>
       snr = ssoil%snowd / max (ssoil%ssdnn, 200.)<a name='182'>
       WHERE (soil%isoilm == 9)<a name='183'>
          ar3 = .0000001<a name='184'>
          dnsnow = max (dnsnow, .5) <font color=#447700>!increase refreshing of snow in Antarctic<a name='185'></font>
  <font color=#447700>!jhan:Eva has added this<a name='186'></font>
            dnsnow = 1.0<a name='187'>
          snrat = 1.<a name='188'>
       ELSEWHERE<a name='189'>
          <font color=#447700>! accumulation of dirt<a name='190'></font>
  <font color=#447700>!jhan:Eva has added this<a name='191'></font>
          <font color=#447700>!ar3 = .2<a name='192'></font>
          ar3 = .1<a name='193'>
          snrat = min (1., snr / (snr + .1) )    <font color=#447700>! snow covered fraction of the grid<a name='194'></font>
       END WHERE<a name='195'>
       dtau = 1.e-6 * (exp(ar1) + exp(ar2) + ar3) * kwidth_gl <a name='196'>
       WHERE (ssoil%snowd &lt;= 1.0)<a name='197'>
          ssoil%snage = 0.<a name='198'>
       ELSEWHERE<a name='199'>
          ssoil%snage = max (0.,(ssoil%snage+dtau)*(1.-dnsnow))<a name='200'>
       END WHERE<a name='201'>
       fage = 1. - 1. / (1. + ssoil%snage ) <font color=#447700>!age factor<a name='202'></font>
<a name='203'>
       tmp = max (.17365, met%coszen )<a name='204'>
       fzenm = max(merge(0.0, (1. + 1./2.)/(1. + 2.*2.*tmp) - 1./2., tmp &gt; 0.5), 0.)<a name='205'>
       tmp = alvo * (1.0 - 0.2 * fage)<a name='206'>
       alv = .4 * fzenm * (1. - tmp) + tmp<a name='207'>
       tmp = aliro * (1. - .5 * fage)<a name='208'>
       WHERE (soil%isoilm == 9)             <font color=#447700>! use dry snow albedo for pernament land ice<a name='209'></font>
  <font color=#447700>!jhan:Eva has channged this - needs to be sym link<a name='210'></font>
         tmp = 0.95 * (1.0 - 0.2 * fage)<a name='211'>
         alv = .4 * fzenm * (1. - tmp) + tmp<a name='212'>
  <font color=#447700>!jhan:Eva has channged this - needs to be sym link<a name='213'></font>
         tmp = 0.75 * (1. - .5 * fage)<a name='214'>
       END WHERE<a name='215'>
       alir = .4 * fzenm * (1.0 - tmp) + tmp<a name='216'>
       talb = .5 * (alv + alir) <font color=#447700>! snow albedo<a name='217'></font>
    ENDWHERE        <font color=#447700>! snowd &gt; 0<a name='218'></font>
   <font color=#447700>!   wnhen it is called from  cable_RADum no need to recalculate snage <a name='219'></font>
  <font color=#447700>!jhan:Eva has channged this - needs to be sym link<a name='220'></font>
    WHERE (ssoil%snowd &gt; 1 .and. cable_runtime%um_radiation )<a name='221'>
       snr = ssoil%snowd / max (ssoil%ssdnn, 200.)<a name='222'>
       WHERE (soil%isoilm == 9)<a name='223'>
          snrat = 1.<a name='224'>
       ELSEWHERE<a name='225'>
          snrat = min (1., snr / (snr + .1) )<a name='226'>
       END WHERE<a name='227'>
       fage = 1. - 1. / (1. + ssoil%snage ) <font color=#447700>!age factor<a name='228'></font>
       tmp = max (.17365, met%coszen )<a name='229'>
       fzenm = max(merge(0.0, (1. + 1./2.)/(1. + 2.*2.*tmp) - 1./2., tmp &gt; 0.5), 0.)<a name='230'>
       tmp = alvo * (1.0 - 0.2 * fage)<a name='231'>
       alv = .4 * fzenm * (1. - tmp) + tmp<a name='232'>
       tmp = aliro * (1. - .5 * fage)<a name='233'>
       WHERE (soil%isoilm == 9)          <font color=#447700>! use dry snow albedo<a name='234'></font>
  <font color=#447700>!jhan:Eva has channged this - needs to be sym link<a name='235'></font>
         tmp = 0.95 * (1.0 - 0.2 * fage)<a name='236'>
         alv = .4 * fzenm * (1. - tmp) + tmp<a name='237'>
  <font color=#447700>!jhan:Eva has channged this - needs to be sym link<a name='238'></font>
         tmp = 0.75 * (1. - .5 * fage)<a name='239'>
       END WHERE<a name='240'>
       alir = .4 * fzenm * (1.0 - tmp) + tmp<a name='241'>
       talb = .5 * (alv + alir) <font color=#447700>! snow albedo<a name='242'></font>
    ENDWHERE        <font color=#447700>! snowd &gt; 0<a name='243'></font>
    ssoil%albsoilsn(:,2) = min(aliro,(1. - snrat) * ssoil%albsoilsn(:,2) + snrat * alir)<a name='244'>
    ssoil%albsoilsn(:,1) = min(alvo,(1. - snrat) * ssoil%albsoilsn(:,1) + snrat * alv)<a name='245'>
<a name='246'>
   end subroutine surface_albedosn<a name='247'>
<a name='248'>
END MODULE albedo_module<a name='249'>
</pre></body></html>