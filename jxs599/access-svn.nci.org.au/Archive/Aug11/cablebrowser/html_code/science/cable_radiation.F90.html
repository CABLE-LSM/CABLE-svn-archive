<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<a name='2'>
<A NAME='RADIATION_MODULE'><A href='../../html_code/science/cable_radiation.F90.html#RADIATION_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>radiation_module</font> <A href='../../call_to/RADIATION_MODULE.html' TARGET='index'>2</A><a name='4'>
  <font color=#447700>!jhan: check scope here <a name='5'></font>
  USE <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_radiation.F90.html#cable_radiation.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_8"><a name='6'>
  USE <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_radiation.F90.html#cable_radiation.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_11"><a name='7'>
  USE <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_radiation.F90.html#cable_radiation.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_13"><a name='8'>
  USE <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_radiation.F90.html#cable_radiation.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_26"><a name='9'>
  USE <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_radiation.F90.html#cable_radiation.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_14"><a name='10'>
  <font color=#447700>!jhan: rm this<a name='11'></font>
<font color=#447700>!  USE cable_variables<a name='12'></font>
  IMPLICIT NONE<a name='13'>
<a name='14'>
  PRIVATE<a name='15'>
  PUBLIC init_radiation, radiation, sinbet <a name='16'>
<a name='17'>
CONTAINS<a name='18'>
<a name='19'>
<A NAME='INIT_RADIATION'><A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='20'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>init_radiation</font>(met,rad,veg,canopy) <A href='../../call_to/INIT_RADIATION.html' TARGET='index'>1</A>,<A href='../../call_from/INIT_RADIATION.html' TARGET='index'>4</A><a name='21'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_14"><a name='22'>
      implicit none<a name='23'>
      TYPE (veg_parameter_type), INTENT(INout) :: veg<a name='24'>
      TYPE (radiation_type), INTENT(INOUT) :: rad<a name='25'>
      TYPE (met_type),INTENT(INOUT)        :: met<a name='26'>
      TYPE (canopy_type),INTENT(IN)                :: canopy<a name='27'>
      REAL(r_1), DIMENSION(nrb)     :: cos3  <font color=#447700>! cos(15 45 75 degrees)<a name='28'></font>
      REAL(r_1), DIMENSION(mp,nrb)  :: xvlai2 <font color=#447700>! 2D vlai<a name='29'></font>
      REAL(r_1), DIMENSION(mp,nrb)  :: xk    <font color=#447700>! extinct. coef.for beam rad. and black leaves<a name='30'></font>
      REAL(r_1), DIMENSION(mp)    :: xphi1 <font color=#447700>! leaf angle parmameter 1<a name='31'></font>
      REAL(r_1), DIMENSION(mp)    :: xphi2 <font color=#447700>! leaf angle parmameter 2<a name='32'></font>
      INTEGER(i_d) :: ictr<a name='33'>
      LOGICAL, DIMENSION(mp)    :: mask   <font color=#447700>! select points for calculation<a name='34'></font>
      real, dimension(:,:), pointer,save :: c1, rhoch<a name='35'>
<a name='36'>
         cos3 = COS(pi180 * (/ 15.0, 45.0, 75.0 /))<a name='37'>
<a name='38'>
         <font color=#447700>! See Sellers 1985, eq.13 (leaf angle parameters):<a name='39'></font>
         WHERE (canopy%vlaiw &gt; LAI_THRESH)<a name='40'>
            xphi1 = 0.5 - veg%xfang * (0.633 + 0.33 * veg%xfang)<a name='41'>
            xphi2 = 0.877 * (1.0 - 2.0 * xphi1)<a name='42'>
         END WHERE<a name='43'>
         <font color=#447700>! 2 dimensional LAI<a name='44'></font>
         xvlai2 = SPREAD(canopy%vlaiw, 2, 3)<a name='45'>
<a name='46'>
         <font color=#447700>! Extinction coefficient for beam radiation and black leaves;<a name='47'></font>
         <font color=#447700>! eq. B6, Wang and Leuning, 1998<a name='48'></font>
         WHERE (xvlai2 &gt; LAI_THRESH) <font color=#447700>! vegetated<a name='49'></font>
            xk = SPREAD(xphi1, 2, 3) / SPREAD(cos3, 1, mp) + SPREAD(xphi2, 2, 3)<a name='50'>
         ELSEWHERE <font color=#447700>! i.e. bare soil<a name='51'></font>
            xk = 0.0          <a name='52'>
         END WHERE<a name='53'>
     <a name='54'>
         WHERE (canopy%vlaiw &gt; LAI_THRESH ) <font color=#447700>! vegetated<a name='55'></font>
            <font color=#447700>! Extinction coefficient for diffuse radiation for black leaves:<a name='56'></font>
            rad%extkd = -LOG(SUM(SPREAD(gauss_w, 1, mp) * EXP(-xk * xvlai2), 2)) / canopy%vlaiw<a name='57'>
         ELSEWHERE <font color=#447700>! i.e. bare soil<a name='58'></font>
            rad%extkd = 0.7<a name='59'>
         END WHERE<a name='60'>
<a name='61'>
         mask = canopy%vlaiw &gt; LAI_THRESH  .AND.                                 &amp;<a name='62'>
               ( met%fsd(:,1) + met%fsd(:,2) ) &gt; RAD_THRESH<a name='63'>
<a name='64'>
         call <A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH'>calc_rhoch</A><A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CALC_RHOCH_2">( veg, c1, rhoch )<a name='65'>
<a name='66'>
         <font color=#447700>! Canopy reflection of diffuse radiation for black leaves:<a name='67'></font>
         do ictr=1,nrb<a name='68'>
           rad%rhocdf(:,ictr) = rhoch(:,ictr) * ( gauss_w(1)*xk(:,1)/( xk(:,1) + rad%extkd(:) ) +  &amp;<a name='69'>
                                            gauss_w(2)*xk(:,2)/( xk(:,2) + rad%extkd(:) ) +  &amp;<a name='70'>
                                            gauss_w(3)*xk(:,3)/( xk(:,3) + rad%extkd(:) )  )<a name='71'>
         enddo<a name='72'>
         <a name='73'>
         if( .NOT. cable_runtime%um) then<a name='74'>
            <font color=#447700>! Define beam fraction, fbeam:<a name='75'></font>
            rad%fbeam(:,1) = <A href='../../html_code/science/cable_radiation.F90.html#SPITTER'>spitter</A><A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPITTER_1">(met%doy, met%coszen, met%fsd(:,1))<a name='76'>
            rad%fbeam(:,2) = <A href='../../html_code/science/cable_radiation.F90.html#SPITTER'>spitter</A><A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SPITTER_2">(met%doy, met%coszen, met%fsd(:,2))<a name='77'>
            <font color=#447700>! coszen is set during met data read in.<a name='78'></font>
            WHERE (met%coszen &lt;1.0e-2)<a name='79'>
               rad%fbeam(:,1) = 0.0<a name='80'>
               rad%fbeam(:,2) = 0.0<a name='81'>
            END WHERE<a name='82'>
         endif<a name='83'>
<a name='84'>
   WHERE (canopy%vlaiw &gt; LAI_THRESH)    <font color=#447700>! In gridcells where vegetation exists....<a name='85'></font>
      <font color=#447700>! SW beam extinction coefficient ("black" leaves, extinction neglects<a name='86'></font>
      <font color=#447700>! leaf SW transmittance and reflectance):<a name='87'></font>
      rad%extkb = xphi1 / met%coszen + xphi2<a name='88'>
   ELSEWHERE <font color=#447700>! i.e. bare soil<a name='89'></font>
      rad%extkb = 0.5<a name='90'>
   END WHERE<a name='91'>
   <a name='92'>
   WHERE ( abs(rad%extkb - rad%extkd)  &lt; 0.001 )<a name='93'>
      rad%extkb = rad%extkd + 0.001<a name='94'>
   END WHERE<a name='95'>
   <a name='96'>
   WHERE(rad%fbeam(:,1) &lt; RAD_THRESH )<a name='97'>
      rad%extkb=30.0         <font color=#447700>! keep cexpkbm within real*4 range (BP jul2010)<a name='98'></font>
   END WHERE<a name='99'>
   <a name='100'>
      return<a name='101'>
   END SUBROUTINE init_radiation<a name='102'>
<a name='103'>
<a name='104'>
<a name='105'>
<A NAME='RADIATION'><A href='../../html_code/science/cable_radiation.F90.html#RADIATION' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='106'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>radiation</font>(bal, soil, ssoil, veg, air, met, rad, canopy) <A href='../../call_to/RADIATION.html' TARGET='index'>1</A>,<A href='../../call_from/RADIATION.html' TARGET='index'>3</A><a name='107'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_radiation.F90.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_15">, only : cable_runtime, cable_user<a name='108'>
      use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_radiation.F90.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_6">, only : cable_stat<a name='109'>
      implicit none<a name='110'>
      TYPE (soil_parameter_type),INTENT(IN)               :: soil<a name='111'>
      TYPE (soil_snow_type),INTENT(INOUT) :: ssoil<a name='112'>
      TYPE (veg_parameter_type),INTENT(IN)                :: veg<a name='113'>
      TYPE (canopy_type),INTENT(IN)                :: canopy<a name='114'>
      TYPE (air_type),INTENT(IN)          :: air<a name='115'>
      TYPE (met_type),INTENT(INOUT)       :: met<a name='116'>
      TYPE (radiation_type),INTENT(INOUT) :: rad<a name='117'>
      TYPE (balances_type),INTENT(INOUT)  :: bal<a name='118'>
  <a name='119'>
      REAL(r_1), DIMENSION(mp)  :: cf1    <font color=#447700>! (1.0 - rad%transb * cexpkdm) / (extkb + extkdm(:,b))<a name='120'></font>
      REAL(r_1), DIMENSION(mp)  :: cf3    <font color=#447700>! (1.0 - rad%transb * cexpkbm) / (extkb + extkbm(:,b))<a name='121'></font>
      REAL(r_1), DIMENSION(mp)  :: cf2n   <font color=#447700>! exp(-extkn * vlai) (nitrogen)<a name='122'></font>
      REAL(r_1), DIMENSION(mp)  :: emair  <font color=#447700>! air emissivity<a name='123'></font>
      REAL(r_1), DIMENSION(mp)  :: flpwb  <font color=#447700>! black-body long-wave radiation<a name='124'></font>
      REAL(r_1), DIMENSION(mp)  :: flwv   <font color=#447700>! vegetation long-wave radiation (isothermal)<a name='125'></font>
      INTEGER(i_d)              :: b <font color=#447700>! rad. band 1=visible, 2=near-infrared, 3=long-wave<a name='126'></font>
      LOGICAL, DIMENSION(mp)    :: mask   <font color=#447700>! select points for calculation<a name='127'></font>
      integer, save :: call_number =0<a name='128'>
<a name='129'>
      call_number = call_number + 1<a name='130'>
  <a name='131'>
      if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='132'>
         call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_radiation.F90.html#RADIATION' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_6">('radiation')<a name='133'>
    <font color=#447700>! Define vegetation mask:<a name='134'></font>
    mask = canopy%vlaiw &gt; LAI_THRESH .AND. ( met%fsd(:,1)+met%fsd(:,2) ) &gt; RAD_THRESH <a name='135'>
    <font color=#447700>! Relative leaf nitrogen concentration within canopy:<a name='136'></font>
    <font color=#447700>! rad%extkn renamed veg%extkn<a name='137'></font>
<font color=#447700>!jhan:Evaa made this change Aug-Jan after agreed to mv to veg%<a name='138'></font>
<font color=#447700>!jh        where( veg%iveg == 2 ) rad%extkn = 0.01<a name='139'></font>
<a name='140'>
    cf2n = EXP(-veg%extkn * canopy%vlaiw)<a name='141'>
   <a name='142'>
         rad%transd = 1.0<a name='143'>
         WHERE (canopy%vlaiw &gt; LAI_THRESH )    <font color=#447700>! In gridcells where vegetation exists....<a name='144'></font>
            <font color=#447700>! Diffuse SW transmission fraction ("black" leaves, extinction neglects<a name='145'></font>
            <font color=#447700>! leaf SW transmittance and reflectance);<a name='146'></font>
            <font color=#447700>! from Monsi &amp; Saeki 1953, quoted in eq. 18 of Sellers 1985:<a name='147'></font>
            rad%transd = EXP(-rad%extkd * canopy%vlaiw)<a name='148'>
         END WHERE<a name='149'>
<a name='150'>
    <font color=#447700>! Define fraction of SW beam tranmitted through canopy:<a name='151'></font>
    rad%transb = EXP(-rad%extkb * canopy%vlaiw)<a name='152'>
<a name='153'>
    <font color=#447700>! Define longwave from vegetation:<a name='154'></font>
    <font color=#447700>!jhan: should we use tk or tvrad here    <a name='155'></font>
   <font color=#447700>!jhanflpwb = sboltz * (met%tvrad) ** 4   ! YP Nov2009 (fix cold bias problem)<a name='156'></font>
    flpwb = sboltz * (met%tk) ** 4<a name='157'>
    flwv = emleaf * flpwb<a name='158'>
<a name='159'>
    <font color=#447700>! Combined soil/snow temperature:<a name='160'></font>
    ssoil%tss=(1-ssoil%isflag)*ssoil%tgg(:,1) + ssoil%isflag*ssoil%tggsn(:,1)<a name='161'>
    <font color=#447700>! Define longwave from soil/snow surface:<a name='162'></font>
    rad%flws = sboltz*emsoil* ssoil%tss **4<a name='163'>
    <font color=#447700>! Define air emissivity:<a name='164'></font>
    emair = met%fld / flpwb<a name='165'>
    <a name='166'>
    rad%gradis = 0.0 <font color=#447700>! initialise radiative conductance<a name='167'></font>
    rad%qcan = 0.0   <font color=#447700>! initialise radiation absorbed by canopy<a name='168'></font>
    <a name='169'>
    <a name='170'>
    <a name='171'>
   <a name='172'>
    <a name='173'>
    <a name='174'>
    <a name='175'>
    <a name='176'>
    <a name='177'>
    <a name='178'>
    WHERE (canopy%vlaiw &gt; LAI_THRESH )<a name='179'>
       <font color=#447700>! Define radiative conductance (Leuning et al, 1995), eq. D7:<a name='180'></font>
       rad%gradis(:,1) = (4.0 * emleaf / (capp * air%rho)) * flpwb &amp;<a name='181'>
            &amp; / (met%tk) * rad%extkd &amp;<a name='182'>
            &amp; * ((1.0 - rad%transb * rad%transd) / (rad%extkb + rad%extkd) &amp;<a name='183'>
            &amp; + (rad%transd - rad%transb) / (rad%extkb - rad%extkd))<a name='184'>
       rad%gradis(:,2) = (8.0*emleaf/(capp*air%rho)) * flpwb / (met%tk) &amp;<a name='185'>
            &amp; * rad%extkd * (1.0 - rad%transd) / rad%extkd - rad%gradis(:,1)<a name='186'>
       <font color=#447700>! Longwave radiation absorbed by sunlit canopy fraction:<a name='187'></font>
       rad%qcan(:,1,3) = (rad%flws-flwv) *rad%extkd * (rad%transd - rad%transb) &amp;<a name='188'>
            &amp; / (rad%extkb - rad%extkd) &amp;<a name='189'>
            &amp; + (emair-emleaf) * rad%extkd * flpwb * (1.0-rad%transd*rad%transb) &amp;<a name='190'>
            &amp; / ( rad%extkb + rad%extkd) <a name='191'>
       <font color=#447700>! Longwave radiation absorbed by shaded canopy fraction:<a name='192'></font>
       rad%qcan(:,2,3) = (1.0 - rad%transd) * &amp;<a name='193'>
            &amp; (rad%flws + met%fld - 2.0 * flwv) - rad%qcan(:,1,3)<a name='194'>
    END WHERE<a name='195'>
    <font color=#447700>! Convert radiative conductance from m/s to mol/m2/s:<a name='196'></font>
    rad%gradis=SPREAD(air%cmolar, 2, mf)*rad%gradis<a name='197'>
    rad%gradis = MAX(1.0e-3_r_2,rad%gradis)<a name='198'>
<a name='199'>
         <font color=#447700>! Update extinction coefficients and fractional transmittance for <a name='200'></font>
         <font color=#447700>! leaf transmittance and reflection (ie. NOT black leaves):<a name='201'></font>
         <font color=#447700>! Define qcan for short wave (par, nir) for sunlit leaf:<a name='202'></font>
         <font color=#447700>!jhan:prev. offline//Mk3l used met%fsd(:), hence assumed 1/2 met%fsd in each "b" calc here.<a name='203'></font>
         <font color=#447700>!UM recieves met%fsd(:,b) forcing. assumed for offline that USED met%fsd(:,b) = 1/2* INPUT met%fsd<a name='204'></font>
         DO b = 1, 2 <font color=#447700>! 1 = visible, 2 = nir radiaition<a name='205'></font>
            WHERE (mask) <font color=#447700>! i.e. vegetation and sunlight are present<a name='206'></font>
               cf1 = (1.0 - rad%transb * rad%cexpkdm(:,b)) / (rad%extkb + rad%extkdm(:,b))<a name='207'>
               cf3 = (1.0 - rad%transb * rad%cexpkbm(:,b)) / (rad%extkb + rad%extkbm(:,b))<a name='208'>
               rad%qcan(:,1,b) = met%fsd(:,b) * ( &amp;          <font color=#447700>! scale to real sunlit flux<a name='209'></font>
                     (1.0-rad%fbeam(:,b))*(1.0-rad%reffdf(:,b))*rad%extkdm(:,b)*cf1 &amp;<a name='210'>
                     + rad%fbeam(:,b)*(1.0-rad%reffbm(:,b))*rad%extkbm(:,b)*cf3 &amp;<a name='211'>
                     + rad%fbeam(:,b)*(1.0-veg%taul(:,b)-veg%refl(:,b))*rad%extkb &amp;<a name='212'>
                     * ((1-rad%transb)/rad%extkb - (1-rad%transb**2)/(rad%extkb+rad%extkb)))<a name='213'>
               <font color=#447700>! Define qcan for short wave (par, nir) for shaded leaf:<a name='214'></font>
               rad%qcan(:,2,b) = met%fsd(:,b) * ( &amp;          <font color=#447700>! scale to real shaded flux<a name='215'></font>
                     (1.0-rad%fbeam(:,b))*(1.0-rad%reffdf(:,b))*rad%extkdm(:,b)* &amp;<a name='216'>
                     ((1.0 - rad%cexpkdm(:,b)) / rad%extkdm(:,b) - cf1) &amp;<a name='217'>
                     + rad%fbeam(:,b)*(1.-rad%reffbm(:,b))*rad%extkbm(:,b) &amp;<a name='218'>
                     * ((1.0 - rad%cexpkbm(:,b)) / rad%extkbm(:,b) - cf3) &amp;<a name='219'>
                     - rad%fbeam(:,b)*(1.0-veg%taul(:,b)-veg%refl(:,b))*rad%extkb &amp;<a name='220'>
                     * ((1-rad%transb)/rad%extkb - (1-rad%transb**2)/(rad%extkb+rad%extkb)))<a name='221'>
       END WHERE<a name='222'>
    END DO<a name='223'>
    <a name='224'>
    rad%qssabs = 0.<a name='225'>
    <a name='226'>
         WHERE (mask) <font color=#447700>! i.e. vegetation and sunlight are present<a name='227'></font>
            <font color=#447700>! Calculate shortwave radiation absorbed by soil:<a name='228'></font>
            <font color=#447700>! (av. of transmitted NIR and PAR through canopy)*SWdown<a name='229'></font>
            rad%qssabs = met%fsd(:,1) * (                                                 &amp;<a name='230'>
               rad%fbeam(:,1)*(1.-rad%reffbm(:,1))*EXP(-rad%extkbm(:,1)*canopy%vlaiw) +      &amp;<a name='231'>
               (1.-rad%fbeam(:,1))*(1.-rad%reffdf(:,1))*EXP(-rad%extkdm(:,1)*canopy%vlaiw) ) &amp;<a name='232'>
              + met%fsd(:,2)*(                                                              &amp;<a name='233'>
                rad%fbeam(:,2)*(1.-rad%reffbm(:,2))*rad%cexpkbm(:,2) +                    &amp;<a name='234'>
                (1.-rad%fbeam(:,2))*(1.-rad%reffdf(:,2))*rad%cexpkdm(:,2) )<a name='235'>
     <a name='236'>
            <font color=#447700>! Scaling from single leaf to canopy, see Wang &amp; Leuning 1998 appendix C:<a name='237'></font>
            rad%scalex(:,1) = (1.0 - rad%transb * cf2n) / (rad%extkb + veg%extkn)<a name='238'>
            <font color=#447700>! Leaf area index of big leaf, sunlit, shaded, respectively:<a name='239'></font>
            rad%fvlai(:,1) = (1.0 - rad%transb) / rad%extkb<a name='240'>
            rad%fvlai(:,2) = canopy%vlaiw - rad%fvlai(:,1)<a name='241'>
         ELSEWHERE <font color=#447700>! i.e. either vegetation or sunlight are NOT present<a name='242'></font>
            <font color=#447700>! Shortwave absorbed by soil/snow surface:<a name='243'></font>
            rad%qssabs = (1.0 - ssoil%albsoilsn(:,1))*met%fsd(:,1)+                         &amp;<a name='244'>
                         (1.0 - ssoil%albsoilsn(:,2))*met%fsd(:,2)<a name='245'>
            rad%scalex(:,1) = 0.0<a name='246'>
            rad%fvlai(:,1) = 0.0<a name='247'>
            rad%fvlai(:,2) = canopy%vlaiw<a name='248'>
         END WHERE<a name='249'>
<a name='250'>
    rad%scalex(:,2) = (1.0 - cf2n) / veg%extkn - rad%scalex(:,1)<a name='251'>
    <font color=#447700>! Total energy absorbed by canopy:<a name='252'></font>
    rad%rniso = SUM(rad%qcan, 3)<a name='253'>
    <a name='254'>
  END SUBROUTINE radiation<a name='255'>
<a name='256'>
<A NAME='CALC_RHOCH'><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='257'>
   <font color=#993300>subroutine </font><font color=#cc0000>calc_rhoch</font>(veg,c1,rhoch)  <A href='../../call_to/CALC_RHOCH.html' TARGET='index'>2</A>,<A href='../../call_from/CALC_RHOCH.html' TARGET='index'>5</A><a name='258'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_14"><a name='259'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_12"><a name='260'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_radiation.F90.html#CALC_RHOCH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_16">, only : cable_runtime   <a name='261'>
      implicit none<a name='262'>
      type (veg_parameter_type), intent(inout) :: veg<a name='263'>
      real, intent(inout), dimension(:,:), pointer:: c1, rhoch<a name='264'>
<a name='265'>
      allocate( c1(mp,nrb), rhoch(mp,nrb) )<a name='266'>
<a name='267'>
<font color=#447700>!jhan:UM uses rad%extkn instead of veg%extkn, which should be read from par. file anyway<a name='268'></font>
<font color=#447700>!jhan:cahnge Mk3l to read veg%taul like UM <a name='269'></font>
         if( .NOT. cable_runtime%um) then<a name='270'>
            veg%taul(:,1) = taul(1)<a name='271'>
            veg%taul(:,2) = taul(2)<a name='272'>
            veg%refl(:,1) = refl(1) <a name='273'>
            veg%refl(:,2) = refl(2) <a name='274'>
         endif                  <a name='275'>
         c1(:,1) = SQRT(1. - veg%taul(:,1) - veg%refl(:,1))<a name='276'>
         c1(:,2) = SQRT(1. - veg%taul(:,2) - veg%refl(:,2))<a name='277'>
         c1(:,3) = 1.<a name='278'>
          <a name='279'>
         <font color=#447700>! Canopy reflection black horiz leaves (eq. 6.19 in Goudriaan and van Laar, 1994):<a name='280'></font>
         rhoch = (1.0 - c1) / (1.0 + c1)<a name='281'>
      return<a name='282'>
   end subroutine calc_rhoch <a name='283'>
<a name='284'>
<a name='285'>
<a name='286'>
<a name='287'>
<a name='288'>
<a name='289'>
<a name='290'>
  <font color=#447700>!-----------------------------------------------------------------<a name='291'></font>
<A NAME='SINBET'><A href='../../html_code/science/cable_radiation.F90.html#SINBET' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='292'>
  ELEMENTAL <font color=#993300>FUNCTION </font><font color=#cc0000>sinbet</font>(doy,xslat,hod) RESULT(z)<a name='293'>
    <font color=#447700>! calculate sin(bet), bet = elevation angle of sun<a name='294'></font>
    <font color=#447700>! calculations according to goudriaan &amp; van laar 1994 p30<a name='295'></font>
    REAL(r_1), INTENT(IN) :: doy    <font color=#447700>! day of year<a name='296'></font>
    REAL(r_1), INTENT(IN) :: xslat  <font color=#447700>! latitude (degrees north)<a name='297'></font>
    REAL(r_1), INTENT(IN) :: hod    <font color=#447700>! hour of day<a name='298'></font>
    REAL(r_1)             :: sindec <font color=#447700>! sine of maximum declination<a name='299'></font>
    REAL(r_1)             :: z      <font color=#447700>! result<a name='300'></font>
    sindec = -SIN(23.45 * pi180) * COS(two_pi * (doy + 10.0) / 365.0)<a name='301'>
    z = MAX( SIN(pi180 * xslat) * sindec &amp;<a name='302'>
      &amp; + COS(pi180 * xslat) * SQRT(1. - sindec * sindec) &amp;<a name='303'>
      &amp; * COS(pi_c * (hod - 12.0) / 12.0), 1e-8 )<a name='304'>
  END FUNCTION sinbet<a name='305'>
  <font color=#447700>!-------------------------------------------------------------------<a name='306'></font>
<A NAME='SPITTER'><A href='../../html_code/science/cable_radiation.F90.html#SPITTER' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='307'>
   <font color=#993300>FUNCTION </font><font color=#cc0000>spitter</font>(doy, coszen, fsd) RESULT(fbeam) <A href='../../call_to/SPITTER.html' TARGET='index'>2</A><a name='308'>
    <font color=#447700>! Calculate beam fraction<a name='309'></font>
    <font color=#447700>! See spitters et al. 1986, agric. for meteorol., 38:217-229<a name='310'></font>
    REAL(r_1), DIMENSION(mp), INTENT(IN) :: doy <font color=#447700>! day of year<a name='311'></font>
    REAL(r_1), DIMENSION(mp), INTENT(IN) :: coszen <font color=#447700>! cos(zenith angle of sun)<a name='312'></font>
    REAL(r_1), DIMENSION(mp), INTENT(IN) :: fsd <font color=#447700>! short wave down (positive) w/m^2<a name='313'></font>
    REAL(r_1), DIMENSION(mp) :: fbeam   <font color=#447700>! beam fraction (result)<a name='314'></font>
    REAL(r_1), PARAMETER :: solcon = 1370.0<a name='315'>
    REAL(r_1), DIMENSION(mp) :: tmpr <font color=#447700>!                                      <a name='316'></font>
    REAL(r_1), DIMENSION(mp) :: tmpk <font color=#447700>!                                <a name='317'></font>
    REAL(r_1), DIMENSION(mp) :: tmprat <font color=#447700>!                               <a name='318'></font>
    fbeam = 0.0<a name='319'>
    tmpr = 0.847 + coszen * (1.04 * coszen - 1.61)<a name='320'>
    tmpk = (1.47 - tmpr) / 1.66<a name='321'>
    WHERE (coszen &gt; 1.0e-10 .AND. fsd &gt; 10.0)<a name='322'>
       tmprat = fsd / (solcon * (1.0 + 0.033 * COS(two_pi * (doy-10.0) / 365.0)) * coszen)<a name='323'>
    ELSEWHERE<a name='324'>
      tmprat = 0.0<a name='325'>
    END WHERE<a name='326'>
    WHERE (tmprat &gt; 0.22) fbeam = 6.4 * (tmprat - 0.22) ** 2<a name='327'>
    WHERE (tmprat &gt; 0.35) fbeam = MIN(1.66 * tmprat - 0.4728, 1.0)<a name='328'>
    WHERE (tmprat &gt; tmpk) fbeam = MAX(1.0 - tmpr, 0.0)<a name='329'>
  END FUNCTION spitter<a name='330'>
END MODULE radiation_module<a name='331'>
</pre></body></html>