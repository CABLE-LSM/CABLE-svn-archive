<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<A NAME='ROUGHNESS_MODULE'><A href='../../html_code/science/cable_roughness.F90.html#ROUGHNESS_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='2'>
<font color=#993300>MODULE </font><font color=#cc0000>roughness_module</font> <A href='../../call_to/ROUGHNESS_MODULE.html' TARGET='index'>1</A><a name='3'>
  USE <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_roughness.F90.html#cable_roughness.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_15"><a name='4'>
  USE <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_roughness.F90.html#cable_roughness.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_15"><a name='5'>
  USE <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_roughness.F90.html#cable_roughness.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_27"><a name='6'>
  IMPLICIT NONE<a name='7'>
  PRIVATE<a name='8'>
  PUBLIC ruff_resist<a name='9'>
CONTAINS<a name='10'>
  <font color=#447700>!-------------------------------------------------------------------<a name='11'></font>
<A NAME='RUFF_RESIST'><A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='12'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>ruff_resist</font>(veg, rough, ssoil, soil, met, canopy) <A href='../../call_to/RUFF_RESIST.html' TARGET='index'>2</A>,<A href='../../call_from/RUFF_RESIST.html' TARGET='index'>3</A><a name='13'>
    <font color=#447700>! m.r. raupach, 24-oct-92<a name='14'></font>
    <font color=#447700>! see: Raupach, 1992, BLM 60 375-395<a name='15'></font>
    <font color=#447700>!      MRR notes "Simplified wind model for canopy", 23-oct-92<a name='16'></font>
    <font color=#447700>!      MRR draft paper "Simplified expressions...", dec-92<a name='17'></font>
    <font color=#447700>! modified to include resistance calculations by Ray leuning 19 Jun 1998  <a name='18'></font>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_17">, only : cable_runtime, cable_user<a name='19'>
      use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_7">, only : cable_stat<a name='20'>
    implicit none<a name='21'>
    TYPE (veg_parameter_type), INTENT(INOUT)       :: veg<a name='22'>
    TYPE (soil_snow_type), INTENT(IN)      :: ssoil<a name='23'>
    TYPE (soil_parameter_type), INTENT(IN) :: soil  <font color=#447700>! soil parameters<a name='24'></font>
    TYPE (roughness_type), INTENT(INOUT) :: rough<a name='25'>
    TYPE (met_type), INTENT(INOUT)      :: met<a name='26'>
    TYPE (canopy_type), INTENT(INOUT)   :: canopy<a name='27'>
    REAL(r_1), DIMENSION(mp) :: xx <font color=#447700>! =ccd*LAI; working variable <a name='28'></font>
    REAL(r_1), DIMENSION(mp) :: dh <font color=#447700>! d/h where d is zero-plane displacement<a name='29'></font>
    REAL(r_1), DIMENSION(mp) :: hmax <font color=#447700>! maximum height of canopy from<a name='30'></font>
                                     <font color=#447700>! tiles belonging to the same grid<a name='31'></font>
 <a name='32'>
      if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='33'>
         call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_7">('ruff_resist')<a name='34'>
<a name='35'>
    <font color=#447700>! Set canopy height above snow level:<a name='36'></font>
<font color=#447700>!jhan:Eva has changed 0.01 to 0.001<a name='37'></font>
    rough%hruff = MAX(0.01,veg%hc-1.2*ssoil%snowd/MAX(ssoil%ssdnn,100.)) <a name='38'>
    <font color=#447700>! maximum height of canopy from tiles belonging to the same grid<a name='39'></font>
    hmax = rough%hruff_grmx<a name='40'>
    <font color=#447700>! LAI decreases due to snow and vegetation fraction:<a name='41'></font>
    <font color=#447700>!jh:use this in UM<a name='42'></font>
<font color=#447700>!jhan:Eva still using veg%<a name='43'></font>
    canopy%vlaiw = veg%vlai * rough%hruff/MAX(0.01,veg%hc)<a name='44'>
    canopy%rghlai = canopy%vlaiw<a name='45'>
    where(ssoil%snowd.lt.0.001.and. &amp;<a name='46'>
            (veg%iveg.ne.1.and.veg%iveg.ne.6.and.veg%iveg.ne.9)) &amp;<a name='47'>
        canopy%rghlai = min( 3.,canopy%vlaiw)<a name='48'>
<a name='49'>
    <font color=#447700>! Roughness length of bare soil (m):<a name='50'></font>
    rough%z0soil = 1.e-6<a name='51'>
    <font color=#447700>!rough%z0soil = MIN(0.001,MAX(0.0011*exp(-canopy%vlaiw),1.e-6))<a name='52'></font>
    <font color=#447700>!rough%z0soilsn = MAX(MIN(-7.5e-6*(0.01*MIN(ssoil%snowd,20.))+ &amp;<a name='53'></font>
    rough%z0soilsn = max(rough%z0soil-0.5e-7*min(ssoil%snowd,20.),0.1e-7)<a name='54'>
<a name='55'>
<font color=#447700>!jhan:Eva adds this cond.<a name='56'></font>
    <font color=#447700>!jh:WHERE( soil%isoilm == 9 ) rough%z0soilsn = 1.e-5<a name='57'></font>
    <a name='58'>
    WHERE (canopy%vlaiw.LT.0.01 .OR. rough%hruff.LT. rough%z0soilsn) <font color=#447700>! BARE SOIL SURFACE<a name='59'></font>
       rough%z0m = rough%z0soilsn<a name='60'>
       rough%hruff = 0.0<a name='61'>
       rough%rt0us = 0.0  <a name='62'>
       rough%disp = 0.0<a name='63'>
    <font color=#447700>! Reference height zref is height above the displacement height<a name='64'></font>
       rough%zref_uv = max(3.5,rough%za_uv - rough%disp + hmax -  &amp;<a name='65'>
                                             min(1.,ssoil%snowd/max(ssoil%ssdnn,100.)))<a name='66'>
       rough%zref_tq = max(3.5,rough%za_tq - rough%disp + hmax - &amp;<a name='67'>
                                             min(1.,ssoil%snowd/max(ssoil%ssdnn,100.)))<a name='68'>
<font color=#447700>!       rough%zref_uv = max(3.5,rough%za_uv + rough%hruff)<a name='69'></font>
       rough%zruffs = 0.0<a name='70'>
       rough%rt1usa = 0.0 <a name='71'>
       rough%rt1usb = 0.0<a name='72'>
       <font color=#447700>! Friction velocity/windspeed at canopy height<a name='73'></font>
       <font color=#447700>! eq. 7 Raupach 1994, BLM, vol 71, p211-216<a name='74'></font>
       <font color=#447700>! (usuhm set in physical_constants module):<a name='75'></font>
       rough%usuh = MIN(SQRT(csd+crd*(canopy%vlaiw*0.5)), usuhm)<a name='76'>
       <font color=#447700>! xx is ccd (see physical_constants) by LAI<a name='77'></font>
       xx = SQRT(ccd*MAX((canopy%vlaiw*0.5),0.0005))<a name='78'>
       <font color=#447700>! Displacement height/canopy height:<a name='79'></font>
       <font color=#447700>! eq.8 Raupach 1994, BLM, vol 71, p211-216<a name='80'></font>
       dh = 1.0 - (1.0 - EXP(-xx))/xx<a name='81'>
       <font color=#447700>! Extinction coefficient for wind profile in canopy:<a name='82'></font>
       <font color=#447700>! eq. 3.14, SCAM manual (CSIRO tech report 132)<a name='83'></font>
       rough%coexp = rough%usuh / (vonk*ccw_c*(1.0 - dh))<a name='84'>
    ELSEWHERE <font color=#447700>! VEGETATED SURFACE<a name='85'></font>
       <font color=#447700>! Friction velocity/windspeed at canopy height<a name='86'></font>
       <font color=#447700>! eq. 7 Raupach 1994, BLM, vol 71, p211-216<a name='87'></font>
       <font color=#447700>! (usuhm set in physical_constants module):<a name='88'></font>
<font color=#447700>!jhan:Eva uses         <a name='89'></font>
        <font color=#447700>!rough%usuh = MIN(SQRT(csd+crd*(canopy%vlaiw*0.5)), usuhm)<a name='90'></font>
        rough%usuh = MIN(SQRT(csd+crd*(canopy%rghlai*0.5)), usuhm)<a name='91'>
       <font color=#447700>! xx is ccd (see physical_constants) by LAI:<a name='92'></font>
<font color=#447700>!jhan:Eva uses         <a name='93'></font>
       <font color=#447700>!xx = SQRT(ccd*MAX((canopy%vlaiw*0.5),0.0005))<a name='94'></font>
       xx = SQRT(ccd*MAX((canopy%rghlai*0.5),0.0005))<a name='95'>
       <font color=#447700>! eq.8 Raupach 1994, BLM, vol 71, p211-216:<a name='96'></font>
       dh = 1.0 - (1.0 - EXP(-xx))/xx<a name='97'>
       <font color=#447700>! Calculate zero-plane displacement:<a name='98'></font>
       rough%disp = dh*rough%hruff<a name='99'>
    <font color=#447700>! Reference height zref is height above the displacement height<a name='100'></font>
       rough%zref_uv = max(3.5,rough%za_uv -  &amp; <a name='101'>
                       max(rough%disp,min(1.,ssoil%snowd/max(ssoil%ssdnn,100.))) + hmax)<a name='102'>
       rough%zref_tq = max(3.5,rough%za_tq -  &amp;<a name='103'>
                       max(rough%disp,min(1.,ssoil%snowd/max(ssoil%ssdnn,100.))) + hmax)<a name='104'>
<font color=#447700>!       rough%zref_uv = max(3.5,rough%za_uv + rough%hruff)<a name='105'></font>
<font color=#447700>!       rough%zref_tq = max(3.5,rough%za_tq + rough%hruff)<a name='106'></font>
       <font color=#447700>! Calcualte roughness length:<a name='107'></font>
       rough%z0m = ( (1.0 - dh) * EXP( LOG(ccw_c) - 1. + 1./ccw_c &amp;<a name='108'>
            &amp; - vonk/rough%usuh ) ) * rough%hruff<a name='109'>
       <font color=#447700>! find coexp: see notes "simplified wind model ..." eq 34a<a name='110'></font>
       <font color=#447700>! Extinction coefficient for wind profile in canopy:<a name='111'></font>
       <font color=#447700>! eq. 3.14, SCAM manual (CSIRO tech report 132)<a name='112'></font>
       rough%coexp = rough%usuh / (vonk*ccw_c*(1.0 - dh))<a name='113'>
<font color=#447700>!jhan:Eva uses         <a name='114'></font>
       <font color=#447700>!jh rough%term2  = EXP(2*csw*min(veg%vlaiw,3.)*(1-rough%disp/rough%hruff))<a name='115'></font>
       <font color=#447700>!jh rough%term3  = a33**2*ctl*2*csw*min(veg%vlaiw,3.)<a name='116'></font>
<a name='117'>
       rough%term2  = EXP(2*csw*canopy%rghlai*(1-rough%disp/rough%hruff))<a name='118'>
       rough%term3  = a33**2*ctl*2*csw*canopy%rghlai<a name='119'>
       rough%term5  = MAX((2./3.)*rough%hruff/rough%disp, 1.0)<a name='120'>
       rough%term6 =  exp(3.*rough%coexp*(rough%disp/rough%hruff -1.))<a name='121'>
       <font color=#447700>! eq. 3.54, SCAM manual (CSIRO tech report 132)<a name='122'></font>
       rough%rt0us  = rough%term5*(zdlin*LOG(zdlin*rough%disp/rough%z0soilsn) &amp;<a name='123'>
<font color=#447700>!jhan:Eva uses         <a name='124'></font>
            <font color=#447700>!jh + (1-zdlin))*(EXP(2*csw*min(veg%vlaiw,3.)) - rough%term2)/rough%term3  ! &amp;<a name='125'></font>
            + (1-zdlin))*(EXP(2*csw*canopy%rghlai) - rough%term2)/rough%term3  <font color=#447700>! &amp;<a name='126'></font>
<font color=#447700>!              / rough%term6<a name='127'></font>
       <font color=#447700>!        rt1 = turbulent resistance from canopy (z1 = disp) to<a name='128'></font>
       <font color=#447700>!        reference level zref (from disp as origin). Normalisation:<a name='129'></font>
       <font color=#447700>!        rt1us = us*rt1 = rt1usa + rt1usb + rt1usc<a name='130'></font>
       <font color=#447700>!        with term a = resistance from disp to hruf<a name='131'></font>
       <font color=#447700>!        term b = resistance from hruf to zruffs (or zref if zref&lt;zruffs)<a name='132'></font>
       <font color=#447700>!        term c = resistance from zruffs to zref (= 0 if zref&lt;zruffs)<a name='133'></font>
       <font color=#447700>!        where zruffs = SCALAR roughness sublayer depth (ground=origin)<a name='134'></font>
       <font color=#447700>!        xzrufs = xdisp + xhruf*a33**2*ctl/vonk<a name='135'></font>
       <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.49:<a name='136'></font>
       rough%zruffs = rough%disp + rough%hruff*a33**2*ctl/vonk/rough%term5<a name='137'>
       <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.51:<a name='138'></font>
       rough%rt1usa = rough%term5*(rough%term2 - 1.0)/rough%term3<a name='139'>
       rough%rt1usb = rough%term5*(MIN(rough%zref_tq+rough%disp,rough%zruffs) - rough%hruff)/ &amp;<a name='140'>
            (a33**2*ctl*rough%hruff)<a name='141'>
       rough%rt1usb = MAX(rough%rt1usb,0.0)       <font color=#447700>! in case zrufs &lt; rough%hruff<a name='142'></font>
    END WHERE<a name='143'>
  END SUBROUTINE ruff_resist<a name='144'>
END MODULE roughness_module<a name='145'>
</pre></body></html>