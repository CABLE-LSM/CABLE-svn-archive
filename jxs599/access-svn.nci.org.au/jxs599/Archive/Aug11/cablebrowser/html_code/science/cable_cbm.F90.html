<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<a name='2'>
<A NAME='CBM_MODULE'><A href='../../html_code/science/cable_cbm.F90.html#CBM_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>MODULE </font><font color=#cc0000>cbm_module</font><a name='4'>
  USE <A href='../../html_code/science/cable_canopy.F90.html#CANOPY_MODULE'>canopy_module</A><A href='../../html_code/science/cable_cbm.F90.html#cable_cbm.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CANOPY_MODULE_1"><a name='5'>
  USE <A href='../../html_code/science/cable_albedo.F90.html#ALBEDO_MODULE'>albedo_module</A><A href='../../html_code/science/cable_cbm.F90.html#cable_cbm.F90' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ALBEDO_MODULE_1"><a name='6'>
  IMPLICIT NONE<a name='7'>
  PRIVATE<a name='8'>
  PUBLIC cbm <a name='9'>
CONTAINS<a name='10'>
<A NAME='CBM'><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>cbm</font>( dels, air, bgc, canopy, met, bal, &amp;,<A href='../../call_from/CBM.html' TARGET='index'>23</A><a name='12'>
             rad, rough, soil, ssoil, sum_flux, veg )<a name='13'>
   use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_25"><a name='14'>
    USE <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_13"><a name='15'>
    USE <A href='../../html_code/science/cable_carbon.F90.html#CARBON_MODULE'>carbon_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CARBON_MODULE_1"><a name='16'>
    USE <A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW_MODULE'>soil_snow_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_SNOW_MODULE_1"><a name='17'>
    USE <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_12"><a name='18'>
    USE <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_13"><a name='19'>
    USE <A href='../../html_code/science/cable_roughness.F90.html#ROUGHNESS_MODULE'>roughness_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="ROUGHNESS_MODULE_1"><a name='20'>
    USE <A href='../../html_code/science/cable_radiation.F90.html#RADIATION_MODULE'>radiation_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_MODULE_2"><a name='21'>
    USE <A href='../../html_code/science/cable_air.F90.html#AIR_MODULE'>air_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AIR_MODULE_2"><a name='22'>
      use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_5">, only : cable_stat<a name='23'>
      implicit none<a name='24'>
    INTEGER(i_d) :: k,kk,j  <a name='25'>
    INTEGER(i_d) :: idjd,idjd1,idjd2,idjd3  <a name='26'>
    REAL(r_1), INTENT(IN)               :: dels <font color=#447700>! time setp size (s)<a name='27'></font>
    TYPE (air_type), INTENT(INOUT)      :: air<a name='28'>
    TYPE (bgc_pool_type), INTENT(INOUT) :: bgc<a name='29'>
    TYPE (canopy_type), INTENT(INOUT)   :: canopy<a name='30'>
    TYPE (met_type), INTENT(INOUT)      :: met<a name='31'>
    TYPE (balances_type), INTENT(INOUT)         :: bal<a name='32'>
    TYPE (radiation_type), INTENT(INOUT)        :: rad<a name='33'>
    TYPE (roughness_type), INTENT(INOUT)        :: rough<a name='34'>
    TYPE (soil_parameter_type), INTENT(INOUT)   :: soil <a name='35'>
    TYPE (soil_snow_type), INTENT(INOUT)        :: ssoil<a name='36'>
    TYPE (sum_flux_type), INTENT(INOUT) :: sum_flux<a name='37'>
    TYPE (veg_parameter_type), INTENT(INOUT)    :: veg  <a name='38'>
    INTEGER(i_d), PARAMETER  :: ntest = 0 <font color=#447700>!  for prints<a name='39'></font>
<a name='40'>
      if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='41'>
         call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_5">('cbm')<a name='42'>
<a name='43'>
      <font color=#447700>!jhan:do this in iniotialization   <a name='44'></font>
       <font color=#447700>! Fix in-canopy turbulence scheme globally:<a name='45'></font>
       veg%meth = 1<a name='46'>
<a name='47'>
      if( cable_runtime%um ) then<a name='48'>
         cable_runtime%um_radiation = .false.<a name='49'>
         if( cable_runtime%um_explicit ) then<a name='50'>
            call <A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST'>ruff_resist</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RUFF_RESIST_1">(veg, rough, ssoil, soil, met, canopy)<a name='51'>
            met%tk = met%tk + grav/capp*(rough%zref_tq + 0.9*rough%z0m)<a name='52'>
            <font color=#447700>!jhan:consult group b4 rm<a name='53'></font>
            met%tc = met%tk - tfrz<a name='54'>
         endif<a name='55'>
         CALL <A href='../../html_code/science/cable_air.F90.html#DEFINE_AIR'>define_air</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_AIR_2"> (met, air)<a name='56'>
      else<a name='57'>
         call <A href='../../html_code/science/cable_roughness.F90.html#RUFF_RESIST'>ruff_resist</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RUFF_RESIST_2">(veg, rough, ssoil, soil, met, canopy)<a name='58'>
      endif<a name='59'>
<a name='60'>
<a name='61'>
      CALL <A href='../../html_code/science/cable_radiation.F90.html#INIT_RADIATION'>init_radiation</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="INIT_RADIATION_1">(met,rad,veg, canopy) <font color=#447700>! need to be called at every dt<a name='62'></font>
<a name='63'>
      if( cable_runtime%um ) then<a name='64'>
         if( cable_runtime%um_explicit ) then<a name='65'>
            <font color=#447700>!call surface_albedo(ssoil, veg, met, rad, soil, canopy)<a name='66'></font>
            call <A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO'>surface_albedo</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_ALBEDO_1">(ssoil, veg, met, rad, soil, canopy)<a name='67'>
         endif<a name='68'>
      else<a name='69'>
         call <A href='../../html_code/science/cable_albedo.F90.html#SURFACE_ALBEDO'>surface_albedo</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURFACE_ALBEDO_2">(ssoil, veg, met, rad, soil, canopy)<a name='70'>
      endif<a name='71'>
    <a name='72'>
    <font color=#447700>! Calculate canopy variables:<a name='73'></font>
    CALL <A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY'>define_canopy</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_CANOPY_1">(bal,rad,rough,air,met,dels,ssoil,soil,veg, canopy)<a name='74'>
<a name='75'>
   ssoil%otss = ssoil%tss<a name='76'>
   if( cable_runtime%um ) then<a name='77'>
      if( cable_runtime%um_hydrology ) then<a name='78'>
         ssoil%owetfac = ssoil%wetfac<a name='79'>
         call <A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW'>soil_snow</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_SNOW_1">(dels, soil, ssoil, canopy, met, bal,veg)<a name='80'>
      endif<a name='81'>
    else<a name='82'>
      call <A href='../../html_code/science/cable_soilsnow.F90.html#SOIL_SNOW'>soil_snow</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOIL_SNOW_2">(dels, soil, ssoil, canopy, met, bal,veg)<a name='83'>
    endif<a name='84'>
<a name='85'>
    <font color=#447700>!jhan:Eva addded this<a name='86'></font>
    canopy%fhs = canopy%fhs + (ssoil%tss-ssoil%otss)*ssoil%dfh_dtg<a name='87'>
    canopy%fes = canopy%fes + (ssoil%tss-ssoil%otss)*(ssoil%cls*ssoil%dfe_ddq*ssoil%ddq_dtg)<a name='88'>
<a name='89'>
    canopy%fh = canopy%fhv + canopy%fhs<a name='90'>
<a name='91'>
    <font color=#447700>!   need to adjust fe after soilsnow<a name='92'></font>
    canopy%fev  = canopy%fevc + canopy%fevw<a name='93'>
    <font color=#447700>! Calculate total latent heat flux:<a name='94'></font>
    canopy%fe = canopy%fev + canopy%fes<a name='95'>
    <font color=#447700>! Calculate net radiation absorbed by soil + veg<a name='96'></font>
    canopy%rnet = canopy%fns + canopy%fnv<a name='97'>
<a name='98'>
    <font color=#447700>! Calculate radiative/skin temperature:<a name='99'></font>
    rad%trad = ( (1.-rad%transd)*canopy%tv**4 + &amp;<a name='100'>
          rad%transd * ssoil%tss**4 )**0.25<a name='101'>
<a name='102'>
<font color=#447700>! rml 17/1/11 move all plant resp and soil resp calculations here from canopy<a name='103'></font>
<font color=#447700>! and only call on implicit step<a name='104'></font>
<font color=#447700>! put old and new soil resp calculations into soilcarb subroutine<a name='105'></font>
<font color=#447700>! make new plantcarb subroutine<a name='106'></font>
   if( cable_runtime%um ) then<a name='107'>
     if (.not.cable_runtime%um_explicit) then<a name='108'>
<font color=#447700>!      calculate canopy%frp<a name='109'></font>
       CALL <A href='../../html_code/science/cable_carbon.F90.html#PLANTCARB'>plantcarb</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PLANTCARB_1">(veg,bgc,met,canopy)<a name='110'>
<font color=#447700>!      calculate canopy%frs<a name='111'></font>
       CALL <A href='../../html_code/science/cable_carbon.F90.html#SOILCARB'>soilcarb</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SOILCARB_1">(soil, ssoil, veg, bgc, met, canopy)<a name='112'>
<a name='113'>
<font color=#447700>! rml - why was this here, is it needed??<a name='114'></font>
<font color=#447700>!        rad%flws = sboltz*emsoil* ssoil%tss **4<a name='115'></font>
       CALL <A href='../../html_code/science/cable_carbon.F90.html#CARBON_PL'>carbon_pl</A><A href='../../html_code/science/cable_cbm.F90.html#CBM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CARBON_PL_1">(dels, soil, ssoil, veg, canopy, bgc)<a name='116'>
<a name='117'>
       canopy%fnpp = -1.0* canopy%fpn - canopy%frp<a name='118'>
       canopy%fnee = canopy%fpn + canopy%frs + canopy%frp<a name='119'>
<a name='120'>
     endif<a name='121'>
   endif<a name='122'>
<a name='123'>
  <a name='124'>
END SUBROUTINE cbm<a name='125'>
<a name='126'>
END MODULE cbm_module<a name='127'>
</pre></body></html>