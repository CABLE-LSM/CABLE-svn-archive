#!/bin/ksh

if [[ ! -d tmp ]]; then
   mkdir tmp
fi

COM="../../core/src/common/"
SCI="../../core/src/science/"
DRV="../../UM/src/"
CNP="../../core/pkg/CASA/"

if [[ `uname -s` == "Darwin" ]]; then
   /bin/cp -p $COM/*90 ./tmp
   /bin/cp -p $DRV/*90 ./tmp
   /bin/cp -p $SCI/*90 ./tmp
   /bin/cp -p $CNP/*90 ./tmp
   /bin/cp -p ../../offline/src/cable_abort.F90 ./tmp
   /bin/cp -p Make_CABLE-UM ./tmp
else
   /bin/cp --preserve $COM/*90 ./tmp
   /bin/cp --preserve $DRV/*90 ./tmp
   /bin/cp --preserve $SCI/*90 ./tmp
   /bin/cp --preserve $CNP/*90 ./tmp
   /bin/cp --preserve ../../offline/src/cable_abort.F90 ./tmp
   /bin/cp Make_CABLE-UM --preserve ./tmp
fi

cd tmp/
   make -f Make_CABLE-UM
 
if [[ -d tmp ]]; then
   rm -fr tmp
fi

mkdir tmp
mv *.o *.mod tmp

   ## make library from CABLE object files
   #if (-f tmp/cable_explicit_driver.o) then
   cd tmp/
      #./makelib.csh   
      ar r libcable.a cable_explicit_driver.o cable_implicit_driver.o   \
         cable_rad_driver.o cable_hyd_driver.o cable_common.o    \
         cable_diag.o cable_define_dimensions.o cable_math_constants.o  \
         cable_other_constants.o cable_photosynthetic_constants.o       \
         cable_physical_constants.o cable_define_types.o cable_iovars.o \
         cable_soilsnow.o cable_air.o cable_albedo.o cable_radiation.o  \
         cable_roughness.o cable_carbon.o cable_canopy.o cable_cbm.o    \
         cable_um_tech.o cable_um_init_subrs.o cable_um_init.o          \
         cable_abort.o casa_cnp.o casa_variable.o casa_inout.o          \
         casa_cable.o

      if  [[ -f libcable.a ]]; then
         echo ''
         echo 'library build successful. copying to ~/CABLE-UM'
         echo ''
      else
         echo ''
         echo 'build failed'
         exit
      fi

   cd ../
cd ../

cd lib/
   if [[ -f libcable.a.bu ]]; then
      rm -f libcable.a.bu 
   fi   
   if [[ -f libcable.a ]]; then
      mv libcable.a libcable.a.bu 
   fi   
   
   /bin/cp ../tmp/tmp/libcable.a .

   if [[ -d ~/CABLE-UM ]]; then
      rm -f ~/CABLE-UM/libcable.a
      /bin/cp ../tmp/tmp/libcable.a ~/CABLE-UM
   else
      mkdir ~/CABLE-UM 
      /bin/cp ../tmp/tmp/libcable.a ~/CABLE-UM
   fi
   
   rm -fr ../tmp/tmp/

   if [[ -f ~/CABLE-UM/libcable.a ]]; then
      echo ''
      echo `ls -alt ~/CABLE-UM/libcable.a`
      echo ''
      echo 'DONE'
      rm -fr tmp/
      exit
   else
      echo 'build failed'
      exit
   fi 

