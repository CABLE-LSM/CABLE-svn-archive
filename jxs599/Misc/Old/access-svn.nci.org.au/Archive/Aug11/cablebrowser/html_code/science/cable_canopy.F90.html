<HTML> <BODY BGCOLOR=#ffffcc LINK=#0000aa VLINK=#0000ff ALINK=#ff0000 ><BASE TARGET="bottom_target"><PRE><a name='1'>
<a name='2'>
<A NAME='CANOPY_MODULE'><A href='../../html_code/science/cable_canopy.F90.html#CANOPY_MODULE' TARGET='top_target'><IMG SRC="../../gif/bar_purple.gif" border=0></A><a name='3'>
<font color=#993300>module </font><font color=#cc0000>canopy_module</font> <A href='../../call_to/CANOPY_MODULE.html' TARGET='index'>1</A><a name='4'>
   implicit none<a name='5'>
   private<a name='6'>
   public define_canopy<a name='7'>
<a name='8'>
   contains<a name='9'>
 <a name='10'>
<A NAME='DEFINE_CANOPY'><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='11'>
   <font color=#993300>subroutine </font><font color=#cc0000>define_canopy</font>(bal,rad,rough,air,met,dels,ssoil,soil,veg, canopy) <A href='../../call_to/DEFINE_CANOPY.html' TARGET='index'>1</A>,<A href='../../call_from/DEFINE_CANOPY.html' TARGET='index'>35</A><a name='12'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_5"><a name='13'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_12"><a name='14'>
      use <A href='../../html_code/science/cable_radiation.F90.html#RADIATION_MODULE'>radiation_module</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_MODULE_1"><a name='15'>
      use <A href='../../html_code/science/cable_air.F90.html#AIR_MODULE'>air_module</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="AIR_MODULE_1"><a name='16'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_3"><a name='17'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_3"><a name='18'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_1"><a name='19'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_8">   <a name='20'>
      use <A href='../../html_code/common/cable_diag.F90.html#CABLE_DIAG_MODULE'>cable_diag_module</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_DIAG_MODULE_3">, only : cable_stat<a name='21'>
<a name='22'>
      implicit none<a name='23'>
      type (balances_type),intent(inout)  :: bal<a name='24'>
      type (radiation_type), intent(inout):: rad<a name='25'>
      type (roughness_type), intent(inout):: rough<a name='26'>
      type (air_type), intent(inout)      :: air<a name='27'>
      type (met_type), intent(inout)      :: met<a name='28'>
      type (soil_snow_type), intent(inout):: ssoil<a name='29'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='30'>
      type (veg_parameter_type), intent(inout)    :: veg<a name='31'>
      type (canopy_type), intent(inout)   :: canopy<a name='32'>
      real(r_1), intent(in)               :: dels <font color=#447700>! integration time setp (s)<a name='33'></font>
      <a name='34'>
      <font color=#447700>!jhan: can be alloc/dealloc<a name='35'></font>
      REAL(r_2), DIMENSION(mp)            :: gbvtop <font color=#447700>! bnd layer cond. top leaf<a name='36'></font>
      REAL(r_1), DIMENSION(mp)            :: rt0 <font color=#447700>! turbulent resistance<a name='37'></font>
      REAL(r_1), DIMENSION(mp)            :: ortsoil <font color=#447700>! turb. resist. prev t-step<a name='38'></font>
      REAL(r_1), DIMENSION(mp)            :: rt1usc <font color=#447700>! eq. 3.53, SCAM manual, 1997<a name='39'></font>
      REAL(r_1), DIMENSION(mp) :: tstar <font color=#447700>! <a name='40'></font>
      REAL(r_1), DIMENSION(mp) :: zscrn <font color=#447700>!<a name='41'></font>
      REAL(r_1), DIMENSION(mp) :: qstar <font color=#447700>!<a name='42'></font>
      REAL(r_1), DIMENSION(mp) :: rsts  <font color=#447700>!<a name='43'></font>
      REAL(r_1), DIMENSION(mp) :: qsurf <font color=#447700>!<a name='44'></font>
      REAL(r_1), DIMENSION(mp) :: qtgnet <font color=#447700>!<a name='45'></font>
      REAL(r_1), DIMENSION(mp) :: tss4 <font color=#447700>! soil/snow temperature**4<a name='46'></font>
      REAL(r_1), DIMENSION(mp) :: qstvair <font color=#447700>! sat spec humidity at leaf temperature<a name='47'></font>
      INTEGER(i_d) :: iter <font color=#447700>! iteration #<a name='48'></font>
      INTEGER(i_d) :: iterplus <font color=#447700>!<a name='49'></font>
<a name='50'>
      REAL(r_1), DIMENSION(mp) :: xx <font color=#447700>! delta-type func for sparse canopy limit, p20 SCAM manual<a name='51'></font>
      REAL(r_1), DIMENSION(mp)  :: term1, term2, term3, term5<a name='52'>
      REAL(r_1), DIMENSION(mp)  :: r_sc<a name='53'>
      REAL(r_1), DIMENSION(mp)  :: zscl<a name='54'>
<a name='55'>
      real(r_1), dimension(:), pointer :: cansat <font color=#447700>! max canopy intercept. (mm)<a name='56'></font>
      real(r_1), dimension(:), pointer :: dsx <font color=#447700>! leaf surface vpd<a name='57'></font>
      real(r_1), dimension(:), pointer :: fwsoil <font color=#447700>! soil water modifier of stom. cond<a name='58'></font>
      real(r_1), dimension(:), pointer :: tlfx <font color=#447700>! leaf temp prev. iter (K)<a name='59'></font>
      real(r_1), dimension(:), pointer :: tlfy <font color=#447700>! leaf temp (K)<a name='60'></font>
      real(r_2), dimension(:), pointer :: ecy <font color=#447700>! lat heat fl dry big leaf<a name='61'></font>
      real(r_2), dimension(:), pointer :: hcy <font color=#447700>! veg. sens heat<a name='62'></font>
      real(r_2), dimension(:), pointer :: rny <font color=#447700>! net rad<a name='63'></font>
      real(r_2), dimension(:,:), pointer :: gbhu <font color=#447700>! forcedConvectionBndryLayerCond<a name='64'></font>
      real(r_2), dimension(:,:), pointer :: gbhf <font color=#447700>! freeConvectionBndryLayerCond<a name='65'></font>
      real(r_2), dimension(:,:), pointer :: csx <font color=#447700>! leaf surface CO2 concentration<a name='66'></font>
      real(r_2), dimension(:), pointer :: ghwet  <font color=#447700>! cond for heat for a wet canopy<a name='67'></font>
      REAL(r_1), DIMENSION(mp)            :: pwet<a name='68'>
<a name='69'>
      <font color=#447700>!jhan:local temporary vars<a name='70'></font>
      real(r_1), dimension(mp)  :: ftemp,z_eff,psim_arg, psim_1, psim_2, rlower_limit  <a name='71'>
      real  :: rt_min<a name='72'>
      real(r_1), dimension(mp)  :: sum_rad_gradis <a name='73'>
      <a name='74'>
      <font color=#447700>!  rml temporary arrays to write out air temp when leaf temp goes crazy<a name='75'></font>
      integer, dimension(1) :: temp1, temp2<a name='76'>
      integer :: j<a name='77'>
      integer, save :: call_number =0<a name='78'>
      call_number = call_number + 1<a name='79'>
               <a name='80'>
         if( cable_user%RUN_DIAG_LEVEL == 'BASIC' ) &amp;    <a name='81'>
            call <A href='../../html_code/common/cable_diag.F90.html#CABLE_STAT'>cable_stat</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_STAT_3">('define_canopy')<a name='82'>
      <a name='83'>
         <font color=#447700>!jhan:in UM interface. Mk3l to follow<a name='84'></font>
         if( .NOT. cable_runtime%um) &amp;<a name='85'>
            canopy%oldcansto =  canopy%cansto<a name='86'>
<a name='87'>
         allocate(cansat(mp),gbhu(mp,mf))<a name='88'>
         allocate(dsx(mp), fwsoil(mp), tlfx(mp), tlfy(mp))<a name='89'>
         allocate(ecy(mp), hcy(mp), rny(mp))<a name='90'>
         allocate(gbhf(mp,mf), csx(mp,mf))<a name='91'>
         allocate(ghwet(mp))<a name='92'>
<a name='93'>
         <font color=#447700>!jhan:never used<a name='94'></font>
         <font color=#447700>!phenps = 1.0  <a name='95'></font>
<a name='96'>
         <font color=#447700>! BATS-type canopy saturation proportional to LAI:<a name='97'></font>
         cansat = veg%canst1 * canopy%vlaiw<a name='98'>
<a name='99'>
         <font color=#447700>!---compute surface wetness factor, update cansto, through<a name='100'></font>
         call <A href='../../html_code/science/cable_canopy.F90.html#SURF_WETNESS_FACT'>surf_wetness_fact</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="SURF_WETNESS_FACT_1">( cansat, canopy, ssoil,veg,met, soil, dels )<a name='101'>
<a name='102'>
         <font color=#447700>!jhan:this has no effect <a name='103'></font>
         <font color=#447700>!canopy%fevw_pot = 0.0<a name='104'></font>
         <font color=#447700>! rml 15/2/11 initialised after check my mrd<a name='105'></font>
         canopy%fevw_pot = 0.0<a name='106'>
<a name='107'>
         canopy%gswx = 1e-3     <font color=#447700>! default stomatal conuctance <a name='108'></font>
         gbhf = 1e-3     <font color=#447700>! default free convection boundary layer conductance<a name='109'></font>
         gbhu = 1e-3     <font color=#447700>! default forced convection boundary layer conductance<a name='110'></font>
     <a name='111'>
         <font color=#447700>! Initialise in-canopy temperatures and humidity:<a name='112'></font>
         csx = SPREAD(met%ca, 2, mf) <font color=#447700>! initialise leaf surface CO2 concentration<a name='113'></font>
         met%tvair = met%tk<a name='114'>
         met%qvair = met%qv<a name='115'>
         canopy%tv = met%tvair<a name='116'>
     <a name='117'>
         CALL <A href='../../html_code/science/cable_air.F90.html#DEFINE_AIR'>define_air</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_AIR_1"> (met, air)<a name='118'>
         <a name='119'>
         call <A href='../../html_code/science/cable_canopy.F90.html#QSATFJH'>qsatfjh</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSATFJH_1">(qstvair,met%tvair-tfrz,met%pmb)<a name='120'>
<a name='121'>
         met%dva = (qstvair - met%qvair) *  rmair/rmh2o * met%pmb * 100.0<a name='122'>
         dsx = met%dva     <font color=#447700>! init. leaf surface vpd<a name='123'></font>
         <a name='124'>
         tlfx = met%tk  <font color=#447700>! initialise leaf temp iteration memory variable (K)<a name='125'></font>
         tlfy = met%tk  <font color=#447700>! initialise current leaf temp (K)<a name='126'></font>
         <a name='127'>
         ortsoil = ssoil%rtsoil<a name='128'>
         ssoil%tss =  (1-ssoil%isflag)*ssoil%tgg(:,1) + ssoil%isflag*ssoil%tggsn(:,1)<a name='129'>
         tss4 = ssoil%tss**4<a name='130'>
         canopy%fes = 0.<a name='131'>
         canopy%fess = 0.<a name='132'>
         canopy%fesp = 0.<a name='133'>
         ssoil%potev = 0.<a name='134'>
         canopy%fevw_pot = 0.<a name='135'>
    <a name='136'>
         CALL <A href='../../html_code/science/cable_radiation.F90.html#RADIATION'>radiation</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="RADIATION_1">(bal, soil, ssoil, veg, air, met, rad,canopy)<a name='137'>
    <a name='138'>
     <a name='139'>
         <font color=#447700>!jhan:mk3l to make global as well<a name='140'></font>
         canopy%zetar(:,1) = zeta0 <font color=#447700>! stability correction terms<a name='141'></font>
         canopy%zetar(:,2) = zetpos + 1 <a name='142'>
<a name='143'>
         DO iter = 1, niter<a name='144'>
            <font color=#447700>!jhan:Eva has added<a name='145'></font>
            met%tvair = met%tk<a name='146'>
            met%qvair = met%qv<a name='147'>
            canopy%tv = met%tk<a name='148'>
<a name='149'>
            <font color=#447700>! AERODYNAMIC PROPERTIES: friction velocity us, thence turbulent<a name='150'></font>
            <font color=#447700>! resistances rt0, rt1 (elements of dispersion matrix):<a name='151'></font>
            <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.46:<a name='152'></font>
            <a name='153'>
            call <A href='../../html_code/science/cable_canopy.F90.html#COMP_FRICTION_VEL'>comp_friction_vel</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="COMP_FRICTION_VEL_1">()<a name='154'>
<a name='155'>
            <font color=#447700>! Turbulent aerodynamic resistance from roughness sublayer depth to reference height,<a name='156'></font>
            <font color=#447700>! x=1 if zref+disp&gt;zruffs, 0 otherwise: thus rt1usc = 0 if zref+disp&lt;zruffs<a name='157'></font>
            <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.53:<a name='158'></font>
            xx = 0.5 + sign(0.5,rough%zref_tq+rough%disp-rough%zruffs)<a name='159'>
            <font color=#447700>!              correction  by Ian Harman to the 2nd psis term<a name='160'></font>
            <a name='161'>
            rt1usc = xx * (LOG(rough%zref_tq/MAX(rough%zruffs-rough%disp, rough%z0soilsn)) &amp;<a name='162'>
                  - <A href='../../html_code/science/cable_canopy.F90.html#PSIS'>psis</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS_1">( canopy%zetar(:,iter) ) &amp;<a name='163'>
                  + <A href='../../html_code/science/cable_canopy.F90.html#PSIS'>psis</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS_2">( canopy%zetar(:,iter)*(MAX(rough%zruffs-rough%disp,rough%z0soilsn))/rough%zref_tq ) &amp;<a name='164'>
                  )/vonk<a name='165'>
            <a name='166'>
            rt_min = 5.      <a name='167'>
            rt0 = max(rt_min,rough%rt0us / canopy%us)<a name='168'>
     <a name='169'>
            <font color=#447700>! Aerodynamic resistance (sum 3 height integrals)/us<a name='170'></font>
            <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.50:<a name='171'></font>
            <a name='172'>
            rough%rt1 = max(5.,(rough%rt1usa + rough%rt1usb + rt1usc) / canopy%us)<a name='173'>
    <a name='174'>
            <font color=#447700>!jhan:Eva uses .9 -&gt; 1.<a name='175'></font>
            <font color=#447700>!jhan:in latest vn doesn't use this block at all<a name='176'></font>
            <font color=#447700>!WhHERE (ssoil%snowd &gt; 0.1)<a name='177'></font>
            <font color=#447700>!   ssoil%wetfac = 0.90<a name='178'></font>
            <font color=#447700>!END WHhERE<a name='179'></font>
            <a name='180'>
            do j=1,mp<a name='181'>
               if(canopy%vlaiw(j) &gt; LAI_THRESH) then<a name='182'>
                 ssoil%rtsoil(j) = rt0(j)<a name='183'>
               ELSE<a name='184'>
                 ssoil%rtsoil(j) = rt0(j) + rough%rt1(j)<a name='185'>
               ENDif <a name='186'>
            enddo <a name='187'>
     <a name='188'>
            ssoil%rtsoil = max(rt_min,ssoil%rtsoil)   <a name='189'>
            <a name='190'>
            do j=1,mp<a name='191'>
               if( ssoil%rtsoil(j) &gt; 2.*ortsoil(j) .OR. ssoil%rtsoil(j) &lt; 0.5*ortsoil(j) ) &amp;<a name='192'>
                  ssoil%rtsoil(j) = MAX(rt_min,0.5*(ssoil%rtsoil(j) + ortsoil(j)))<a name='193'>
            enddo <a name='194'>
     <a name='195'>
            <font color=#447700>! Vegetation boundary-layer conductance (mol/m2/s)<a name='196'></font>
            <font color=#447700>! prandt = kinematic viscosity/molecular diffusivity<a name='197'></font>
            <font color=#447700>! See CSIRO SCAM, Raupach et al 1997, eq. 3.12. Top leaf:<a name='198'></font>
            do j=1,mp<a name='199'>
               if(canopy%vlaiw(j) &gt; lai_thresh) then<a name='200'>
                  gbvtop(j) = air%cmolar(j)*apol * air%visc(j) / prandt / veg%dleaf(j) *       &amp;<a name='201'>
                        (canopy%us(j) / MIN(rough%usuh(j), 0.2) * &amp;<a name='202'>
                        veg%dleaf(j) / air%visc(j) )**0.5 * prandt**(1.0/3.0) / veg%shelrb(j)<a name='203'>
                  gbvtop(j) = MAX (0.05,gbvtop(j) )      <font color=#447700>! for testing (BP aug2010)<a name='204'></font>
                  <a name='205'>
                  <font color=#447700>! Forced convection boundary layer conductance (see Wang &amp; Leuning 1998, AFM):<a name='206'></font>
                  gbhu(j,1) = gbvtop(j)*(1.0-EXP(-canopy%vlaiw(j)*(0.5*rough%coexp(j)+rad%extkb(j) ))) / &amp;<a name='207'>
                        (rad%extkb(j)+0.5*rough%coexp(j))<a name='208'>
                  gbhu(j,2) = (2.0/rough%coexp(j))*gbvtop(j)*  &amp;<a name='209'>
                        (1.0-EXP(-0.5*rough%coexp(j)*canopy%vlaiw(j)))-gbhu(j,1)<a name='210'>
               endif <a name='211'>
            enddo <a name='212'>
     <a name='213'>
            rny = SUM(rad%rniso,2) <font color=#447700>! init current estimate net rad<a name='214'></font>
            hcy = 0.0              <font color=#447700>! init current estimate lat heat<a name='215'></font>
            ecy = rny - hcy        <font color=#447700>! init current estimate lat heat<a name='216'></font>
     <a name='217'>
            CALL <A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF'>dryLeaf</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DRYLEAF_1">(dels,rad,rough,air,met,veg,canopy, soil,ssoil, dsx,fwsoil,    &amp;<a name='218'>
                  tlfx,tlfy, ecy,hcy, rny, gbhu, gbhf, csx, iter )<a name='219'>
     <a name='220'>
            CALL <A href='../../html_code/science/cable_canopy.F90.html#WETLEAF'>wetLeaf</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WETLEAF_1">(dels,rad,rough,air,met,veg,canopy,cansat, tlfy, gbhu,gbhf, ghwet )<a name='221'>
<a name='222'>
<font color=#447700>!  rml 8/2/11 check leaf temperature<a name='223'></font>
<font color=#447700>! need an lai check too since Antarctica can get this cold<a name='224'></font>
<font color=#447700>!           if (minval(tlfy).lt.200.or.maxval(tlfy).gt.400) then<a name='225'></font>
<font color=#447700>!             write(6,*) 'rmlcheck tlfy: ',minval(tlfy),maxval(tlfy)<a name='226'></font>
<font color=#447700>!             temp1 = minloc(tlfy); temp2 = maxloc(tlfy)<a name='227'></font>
<font color=#447700>!             write(6,*) 'rmlcheck: min/max loc',minloc(tlfy),maxloc(tlfy)<a name='228'></font>
<font color=#447700>!             write(6,*) 'rmlcheck: met/tvair',met%tvair(temp1(1)), met%tvair(temp2(1))<a name='229'></font>
<font color=#447700>!             write(6,*) 'rmlcheck: veg type',veg%iveg(temp1(1)), veg%iveg(temp2(1))<a name='230'></font>
<font color=#447700>!             write(6,*) 'rmlcheck: lai ',canopy%vlaiw(temp1(1)), canopy%vlaiw(temp2(1))<a name='231'></font>
<font color=#447700>!             stop 'Error in cable_canopy: tlf'<a name='232'></font>
<font color=#447700>!           endif<a name='233'></font>
     <a name='234'>
            <font color=#447700>! Calculate latent heat from vegetation:<a name='235'></font>
            <font color=#447700>! Calculate sensible heat from vegetation:<a name='236'></font>
            <font color=#447700>! Calculate net rad absorbed by canopy:<a name='237'></font>
            canopy%fev = REAL(canopy%fevc + canopy%fevw,r_1)<a name='238'>
            ftemp = (1.0 - canopy%fwet) *  REAL(hcy,r_1) + canopy%fhvw<a name='239'>
            canopy%fhv = real(ftemp,r_1) <a name='240'>
            ftemp= (1.0-canopy%fwet)*REAL(rny,r_1)+canopy%fevw+canopy%fhvw<a name='241'>
            canopy%fnv = real(ftemp,r_1)<a name='242'>
     <a name='243'>
            <font color=#447700>! canopy radiative temperature is calculated based on long-wave radiation balance<a name='244'></font>
            sum_rad_gradis = SUM(rad%gradis,2)<a name='245'>
            do j=1,mp<a name='246'>
               if ( canopy%vlaiw(j) &gt; LAI_THRESH .and. rough%hruff(j) &gt; rough%z0soilsn(j) ) then<a name='247'>
                  rad%lwabv(j) = capp * rmair * (tlfy(j)-met%tk(j))* sum_rad_gradis(j) &amp;<a name='248'>
                            + canopy%fhvw(j)*sum_rad_gradis(j) /max(0.001,ghwet(j))<a name='249'>
<a name='250'>
                  canopy%tv(j) = (rad%lwabv(j) / (2.0*(1.0-rad%transd(j))*sboltz*emleaf)+met%tk(j)**4)**0.25<a name='251'>
               ELSE<font color=#447700>! sparse canopy<a name='252'></font>
                 canopy%tv(j) = met%tk(j)<a name='253'>
               ENDif <a name='254'>
            enddo <a name='255'>
           <a name='256'>
<a name='257'>
            <font color=#447700>! Calculate net rad to soil:<a name='258'></font>
            canopy%fns = rad%qssabs + rad%transd*met%fld + (1.0-rad%transd)*emleaf* &amp;<a name='259'>
                  sboltz*canopy%tv**4 - emsoil*sboltz* tss4<a name='260'>
<a name='261'>
<a name='262'>
            <font color=#447700>!jhan:?? to do here. UM uses ssoil%qstss in calc of met%qvair as well <a name='263'></font>
            <font color=#447700>!jhan:ssoil%qstss include in mk3l?<a name='264'></font>
            <font color=#447700>! Saturation specific humidity at soil/snow surface temperature:<a name='265'></font>
    <a name='266'>
            call <A href='../../html_code/science/cable_canopy.F90.html#QSATFJH'>qsatfjh</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSATFJH_2">(ssoil%qstss,ssoil%tss-tfrz,met%pmb)<a name='267'>
<a name='268'>
            if(cable_runtime%um) then<a name='269'>
               ssoil%potev =  <A href='../../html_code/science/cable_canopy.F90.html#HUMIDITY_DEFICIT_METHOD'>Humidity_deficit_method</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HUMIDITY_DEFICIT_METHOD_1">(ssoil%qstss ) <a name='270'>
            else<a name='271'>
               <font color=#447700>!--- uses %ga from previous timestep    <a name='272'></font>
               ssoil%potev =  <A href='../../html_code/science/cable_canopy.F90.html#PENMAN_MONTEITH'>Penman_Monteith</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_MONTEITH_1">(canopy%ga) <a name='273'>
            endif<a name='274'>
<a name='275'>
            <font color=#447700>! Soil latent heat:<a name='276'></font>
            call <A href='../../html_code/science/cable_canopy.F90.html#LATENT_HEAT_FLUX'>latent_heat_flux</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATENT_HEAT_FLUX_1">()<a name='277'>
  <a name='278'>
            <font color=#447700>! Calculate soil sensible heat:<a name='279'></font>
            canopy%fhs = air%rho*capp*(ssoil%tss - met%tk) /ssoil%rtsoil<a name='280'>
<a name='281'>
            <font color=#447700>!jhan:Eva has removed these calcs<a name='282'></font>
            <font color=#447700>! Calculate ground heat flux:<a name='283'></font>
            <font color=#447700>!canopy%ga = canopy%fns-canopy%fhs-canopy%fes*ssoil%cls<a name='284'></font>
            <font color=#447700>! Calculate total latent heat:<a name='285'></font>
            <font color=#447700>!canopy%fe = canopy%fev + canopy%fes<a name='286'></font>
            <font color=#447700>! Calculate total sensible heat:<a name='287'></font>
            <font color=#447700>!canopy%fh = canopy%fhv + canopy%fhs<a name='288'></font>
<a name='289'>
<a name='290'>
            call <A href='../../html_code/science/cable_canopy.F90.html#WITHIN_CANOPY'>within_canopy</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="WITHIN_CANOPY_1">( gbhu, gbhf )<a name='291'>
<a name='292'>
            <font color=#447700>!jhan:Eva has removed these calcs<a name='293'></font>
            <font color=#447700>! Net radiation absorbed by soil: <a name='294'></font>
            <font color=#447700>!canopy%fns = rad%qssabs + rad%transd*met%fld + (1.0-rad%transd)*emleaf* &amp;<a name='295'></font>
            <font color=#447700>!      sboltz*canopy%tv**4 - emsoil*sboltz* tss4<a name='296'></font>
         <a name='297'>
            if(cable_runtime%um) then<a name='298'>
               ssoil%potev =  <A href='../../html_code/science/cable_canopy.F90.html#HUMIDITY_DEFICIT_METHOD'>Humidity_deficit_method</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="HUMIDITY_DEFICIT_METHOD_2">(ssoil%qstss ) <a name='299'>
            else<a name='300'>
               canopy%ghflux = (1-ssoil%isflag)*canopy%ghflux + ssoil%isflag*canopy%sghflux<a name='301'>
               ssoil%potev =  <A href='../../html_code/science/cable_canopy.F90.html#PENMAN_MONTEITH'>Penman_Monteith</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PENMAN_MONTEITH_2">(canopy%ghflux) <a name='302'>
            endif<a name='303'>
<a name='304'>
         <a name='305'>
            <font color=#447700>! Soil latent heat:<a name='306'></font>
            call <A href='../../html_code/science/cable_canopy.F90.html#LATENT_HEAT_FLUX'>latent_heat_flux</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="LATENT_HEAT_FLUX_2">()<a name='307'>
<a name='308'>
            <font color=#447700>! Soil sensible heat:<a name='309'></font>
            canopy%fhs = air%rho*capp*(ssoil%tss - met%tvair) /ssoil%rtsoil<a name='310'>
            canopy%ga = canopy%fns-canopy%fhs-canopy%fes*ssoil%cls<a name='311'>
            <a name='312'>
            <font color=#447700>! Set total latent heat:<a name='313'></font>
            canopy%fe = canopy%fev + canopy%fes<a name='314'>
            <a name='315'>
            <font color=#447700>! Set total sensible heat:<a name='316'></font>
            canopy%fh = canopy%fhv + canopy%fhs<a name='317'>
            <font color=#447700>!jhan:{ prev. in UM only<a name='318'></font>
            <font color=#447700>!---diagnostic purposes<a name='319'></font>
            do j=1,mp<a name='320'>
               if (ssoil%potev(j) .ge. 0.) then<a name='321'>
                  ssoil%potev(j) = max(0.001,ssoil%potev(j))<a name='322'>
               else<a name='323'>
                  ssoil%potev(j) = min(-0.002,ssoil%potev(j))<a name='324'>
               endif<a name='325'>
               <font color=#447700>!jhan:Eva has added this block<a name='326'></font>
               if (canopy%fevw_pot(j) .ge. 0.) then<a name='327'>
                  canopy%fevw_pot(j) = max(0.001,canopy%fevw_pot(j))<a name='328'>
               else<a name='329'>
                  canopy%fevw_pot(j) = min(-0.002,canopy%fevw_pot(j))<a name='330'>
               endif<a name='331'>
            enddo <a name='332'>
<a name='333'>
<a name='334'>
            canopy%rnet = canopy%fnv + canopy%fns  <a name='335'>
            canopy%epot = ((1.-rad%transd)*canopy%fevw_pot + rad%transd*ssoil%potev) * dels/air%rlam  <a name='336'>
                        <font color=#447700>! convert to mm/day<a name='337'></font>
            rlower_limit = canopy%fevw_pot + ssoil%potev<a name='338'>
            do j=1,mp<a name='339'>
               if( abs(rlower_limit(j) ) &lt; 1.e-30) &amp; <a name='340'>
                  rlower_limit = rlower_limit + 1.e-29 <a name='341'>
            enddo<a name='342'>
            canopy%wetfac_cs = min(1.0,canopy%fe / rlower_limit )<a name='343'>
            <a name='344'>
            do j=1,mp<a name='345'>
               if ( canopy%wetfac_cs(j) .le. 0. )  &amp;<a name='346'>
                  canopy%wetfac_cs(j) = max(0.,min(1., &amp;<a name='347'>
                     max(canopy%fev(j)/canopy%fevw_pot(j),canopy%fes(j)/ssoil%potev(j))))<a name='348'>
            enddo <a name='349'>
<a name='350'>
            call <A href='../../html_code/science/cable_canopy.F90.html#UPDATE_ZETAR'>update_zetar</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="UPDATE_ZETAR_1">()<a name='351'>
<a name='352'>
      END DO           <font color=#447700>! do iter = 1, niter<a name='353'></font>
<a name='354'>
      canopy%cduv = canopy%us * canopy%us / (max(met%ua,umin))**2<a name='355'>
<a name='356'>
      <font color=#447700>!jhan:prev. in UM only<a name='357'></font>
      <font color=#447700>!---diagnostic purposes<a name='358'></font>
      canopy%gswx_T = rad%fvlai(:,1)/max(LAI_THRESH,canopy%vlaiw(:))*canopy%gswx(:,1) &amp;<a name='359'>
             + rad%fvlai(:,2)/max(LAI_THRESH,canopy%vlaiw(:))*canopy%gswx(:,2)<a name='360'>
      <font color=#447700>!jhan:Evachanged<a name='361'></font>
      canopy%gswx_T = max(1.e-05,canopy%gswx_T )<a name='362'>
             <a name='363'>
      canopy%cdtq = canopy%cduv *(LOG(rough%zref_uv / rough%z0m) -          &amp;<a name='364'>
        <A href='../../html_code/science/cable_canopy.F90.html#PSIM'>psim</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIM_1">( canopy%zetar(:,niter) * rough%zref_uv/rough%zref_tq )) /      &amp;<a name='365'>
       (LOG( rough%zref_uv /(0.1*rough%z0m) ) - <A href='../../html_code/science/cable_canopy.F90.html#PSIS'>psis</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS_3">(canopy%zetar(:,niter)) )<a name='366'>
<a name='367'>
      <font color=#447700>! Calculate screen temperature:<a name='368'></font>
      <font color=#447700>! 1) original method from SCAM<a name='369'></font>
<a name='370'>
      <font color=#447700>! screen temp., windspeed and relative humidity at 1.5m<a name='371'></font>
      <font color=#447700>! screen temp., windspeed and relative humidity at 2.0m<a name='372'></font>
       tstar = - canopy%fh / ( air%rho*capp*canopy%us)<a name='373'>
       qstar = - canopy%fe / ( air%rho*air%rlam *canopy%us)<a name='374'>
       zscrn = max(rough%z0m,2.0-rough%disp)<a name='375'>
       ftemp = ( log(rough%zref_tq/zscrn)- <A href='../../html_code/science/cable_canopy.F90.html#PSIS'>psis</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS_4">(canopy%zetar(:,iterplus)) + &amp;<a name='376'>
            <A href='../../html_code/science/cable_canopy.F90.html#PSIS'>psis</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS_5">(canopy%zetar(:,iterplus) * zscrn / rough%zref_tq) ) /vonk<a name='377'>
   <a name='378'>
       <font color=#447700>! Calculate screen temperature:<a name='379'></font>
       canopy%tscrn = met%tk - tfrz - tstar * ftemp<a name='380'>
   <a name='381'>
       <font color=#447700>! Calculate radiative/skin temperature; at this stage old soil temperature is used<a name='382'></font>
       rad%trad = ( (1.-rad%transd)*canopy%tv**4 + rad%transd * ssoil%tss**4 )**0.25<a name='383'>
<a name='384'>
      <font color=#447700>! calculation of screen temepratures for LAI &gt; 0.1 . Method by Ian Harman<a name='385'></font>
      <font color=#447700>!jhan:Eva's mods in r2411_cableum_17 July 2011 reset rghlai<a name='386'></font>
      <font color=#447700>!jhan:in merged version (canopy%)rghlai is init. in _roughness()<a name='387'></font>
      <font color=#447700>!do j=1,mp<a name='388'></font>
      <font color=#447700>!   if(ssoil%snowd(j) .lt. 0.001.and.veg%iveg(j) .ne. 1) &amp;<a name='389'></font>
      <font color=#447700>!      canopy%rghlai(j) = min(3.,canopy%vlaiw(j))<a name='390'></font>
      <font color=#447700>!enddo<a name='391'></font>
       <a name='392'>
      term1=0.<a name='393'>
      term2=0.<a name='394'>
      term5=0.<a name='395'>
      term3 = 0. <font color=#447700>! Work around for Intel compiler problem with nested whres<a name='396'></font>
      r_sc = 0.<a name='397'>
      zscl = max(rough%z0soilsn,2.0)<a name='398'>
 <a name='399'>
      <font color=#447700>!---assume screen temp of bareground if all these conditions are not met<a name='400'></font>
      do j=1,mp<a name='401'>
         if ( canopy%vlaiw(j) &gt; LAI_THRESH .and. rough%hruff(j) &gt; 0.01) then<a name='402'>
            if ( rough%disp(j)  &gt; 0.0 ) then<a name='403'>
               <font color=#447700>!jhan:Eva uses new var<a name='404'></font>
               term1(j) = EXP(2*csw*canopy%rghlai(j)*(1-zscl(j)/rough%hruff(j)))<a name='405'>
               term2(j) = EXP(2*csw*canopy%rghlai(j)*(1-rough%disp(j)/rough%hruff(j)))<a name='406'>
               term5(j) = MAX(2./3.*rough%hruff(j)/rough%disp(j), 1.)<a name='407'>
            endif<a name='408'>
            <font color=#447700>!jhan:Eva uses new var<a name='409'></font>
            term3(j) = a33**2*ctl*2*csw*canopy%rghlai(j)<a name='410'>
 <a name='411'>
            if( zscl(j) &lt; rough%disp(j) ) then<a name='412'>
                r_sc(j) = term5(j) * LOG(zscl(j)/rough%z0soilsn(j)) * &amp;<a name='413'>
                ( exp(2*csw*canopy%rghlai(j)) - term1(j) ) / term3(j)<a name='414'>
<a name='415'>
            elseif ( rough%disp(j) &lt;= zscl(j) .and. zscl(j) &lt; rough%hruff(j) ) then<a name='416'>
                r_sc(j) = rough%rt0us(j) + term5(j) * ( term2(j) - term1(j) ) / term3(j)<a name='417'>
<a name='418'>
            elseif ( rough%hruff(j) &lt;= zscl(j) .and. zscl(j) &lt;  rough%zruffs(j) ) then<a name='419'>
                r_sc(j) = rough%rt0us(j) + rough%rt1usa(j) + term5(j) * &amp;<a name='420'>
                ( zscl(j) - rough%hruff(j) ) /  (a33**2*ctl*rough%hruff(j) )<a name='421'>
<a name='422'>
            elseif (zscl(j) &gt;= rough%zruffs(j) ) then<a name='423'>
                r_sc(j) = rough%rt0us(j) + rough%rt1usa(j) + rough%rt1usb(j) +  &amp;<a name='424'>
                  ( log( (zscl(j) - rough%disp(j))/MAX(rough%zruffs(j)-rough%disp(j), rough%z0soilsn(j)) ) &amp;<a name='425'>
                    - <A href='../../html_code/science/cable_canopy.F90.html#PSIS1'>psis1</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS1_1">( (zscl(j) - rough%disp(j)) / (rough%zref_tq(j)/canopy%zetar(j,iterplus)) )  &amp;<a name='426'>
                    + <A href='../../html_code/science/cable_canopy.F90.html#PSIS1'>psis1</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIS1_2">( (rough%zruffs(j) - rough%disp(j)) / (rough%zref_tq(j)/canopy%zetar(j,iterplus)) )  &amp;<a name='427'>
                  ) / vonk<a name='428'>
            endif<a name='429'>
           <font color=#447700>!jhan:Eva uses <a name='430'></font>
           canopy%tscrn(j) = ssoil%tss(j) + (met%tk(j) - ssoil%tss(j)) * min(1.,r_sc(j) /            &amp;<a name='431'>
                  max(1.,rough%rt0us(j) + rough%rt1usa(j) + rough%rt1usb(j) + rt1usc(j))) - tfrz <a name='432'>
         endif  <a name='433'>
      enddo  <a name='434'>
     <a name='435'>
      call <A href='../../html_code/science/cable_canopy.F90.html#QSATFJH'>qsatfjh</A><A href='../../html_code/science/cable_canopy.F90.html#DEFINE_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSATFJH_3">(rsts,canopy%tscrn,met%pmb)<a name='436'>
        <a name='437'>
      qtgnet = rsts * ssoil%wetfac - met%qv<a name='438'>
      do j=1,mp<a name='439'>
         if (qtgnet(j) .gt. 0. ) then<a name='440'>
            qsurf(j) = rsts(j) * ssoil%wetfac(j)<a name='441'>
         else<a name='442'>
            qsurf(j) = 0.1*rsts(j)*ssoil%wetfac(j) + 0.9*met%qv(j)<a name='443'>
         endif<a name='444'>
         canopy%qscrn(j) = met%qv(j) - qstar(j) * ftemp(j)<a name='445'>
<a name='446'>
         <font color=#447700>!jhan:Eva uses <a name='447'></font>
         if ( canopy%vlaiw(j) &gt;LAI_THRESH .and. rough%hruff(j) &gt; 0.01) &amp;<a name='448'>
            canopy%qscrn(j) =  qsurf(j) + (met%qv(j) - qsurf(j)) * min(1.,r_sc(j) / &amp;<a name='449'>
                            max(1.,rough%rt0us(j) + rough%rt1usa(j) + rough%rt1usb(j) + rt1usc(j)))<a name='450'>
      enddo <a name='451'>
<a name='452'>
<a name='453'>
      <font color=#447700>! Calculate dewfall: from negative lh wet canopy + neg. lh dry canopy:<a name='454'></font>
      canopy%dewmm = - (min(0.0,canopy%fevw) + min(0.0_r_2,canopy%fevc)) * &amp;<a name='455'>
           dels * 1.0e3 / (rhow*air%rlam)<a name='456'>
      <font color=#447700>! Add dewfall to canopy water storage:<a name='457'></font>
      canopy%cansto = canopy%cansto + canopy%dewmm<a name='458'>
      <font color=#447700>! rml 28/2/11 moved from a few lines further down to improve water balance (BP)<a name='459'></font>
      <font color=#447700>! Modify canopy water storage for evaporation:<a name='460'></font>
      canopy%cansto = MAX(canopy%cansto-MAX(0.0,REAL(canopy%fevw,r_1))*dels &amp;<a name='461'>
        *1.0e3/(rhow*air%rlam), 0.0)<a name='462'>
<a name='463'>
      <font color=#447700>! Calculate canopy water storage excess:<a name='464'></font>
      canopy%spill=max(0.0, canopy%cansto-cansat)<a name='465'>
  <a name='466'>
      <font color=#447700>! Move excess canopy water to throughfall:<a name='467'></font>
      canopy%through = canopy%through + canopy%spill<a name='468'>
      <font color=#447700>! Initialise 'throughfall to soil' as 'throughfall from canopy'; snow may absorb<a name='469'></font>
      canopy%precis = max(0.,canopy%through)<a name='470'>
      <font color=#447700>! Update canopy storage term:<a name='471'></font>
      canopy%cansto=canopy%cansto - canopy%spill<a name='472'>
      <font color=#447700>! Modify canopy water storage for evaporation:<a name='473'></font>
      <font color=#447700>!canopy%cansto = max(canopy%cansto-max(0.0,canopy%fevw)*dels*1.0e3/ &amp;<a name='474'></font>
      <font color=#447700>!(rhow*air%rlam), 0.0)<a name='475'></font>
      <font color=#447700>! Calculate the total change in canopy water store (mm/dels):<a name='476'></font>
      canopy%delwc = canopy%cansto-canopy%oldcansto<a name='477'>
      <font color=#447700>! calculate dgdtg, derivative of ghflux<a name='478'></font>
      ssoil%dfn_dtg = (-1.)*4.*emsoil*sboltz*tss4/ssoil%tss  <font color=#447700>! d(canopy%fns)/d(ssoil%tgg)<a name='479'></font>
      ssoil%dfh_dtg = air%rho*capp/ssoil%rtsoil      <font color=#447700>! d(canopy%fhs)/d(ssoil%tgg)<a name='480'></font>
      ssoil%dfe_ddq = ssoil%wetfac*air%rho*air%rlam/ssoil%rtsoil  <font color=#447700>! d(canopy%fes)/d(dq)<a name='481'></font>
      ssoil%ddq_dtg = (rmh2o/rmair)/met%pmb *tetena*tetenb*tetenc &amp;<a name='482'>
           /((tetenc+ssoil%tss-tfrz)**2)*exp(tetenb*(ssoil%tss-tfrz)/(tetenc+ssoil%tss-tfrz))<a name='483'>
      canopy%dgdtg = ssoil%dfn_dtg - ssoil%dfh_dtg - ssoil%cls*ssoil%dfe_ddq * ssoil%ddq_dtg<a name='484'>
  <a name='485'>
      bal%drybal=REAL(ecy+hcy,r_1)-SUM(rad%rniso,2) &amp;<a name='486'>
           +capp*rmair*(tlfy-met%tk)*SUM(rad%gradis,2)  <font color=#447700>! YP nov2009<a name='487'></font>
      bal%wetbal=canopy%fevw+canopy%fhvw-SUM(rad%rniso,2)*canopy%fwet &amp;<a name='488'>
           +capp*rmair*(tlfy-met%tk)*SUM(rad%gradis,2)*canopy%fwet  <font color=#447700>! YP nov2009<a name='489'></font>
  <a name='490'>
      DEALLOCATE(cansat,gbhu)<a name='491'>
      DEALLOCATE(dsx, fwsoil, tlfx, tlfy)<a name='492'>
      DEALLOCATE(ecy, hcy, rny)<a name='493'>
      DEALLOCATE(gbhf, csx)<a name='494'>
      DEALLOCATE(ghwet)<a name='495'>
<a name='496'>
      CONTAINS<a name='497'>
<a name='498'>
<a name='499'>
<A NAME='COMP_FRICTION_VEL'><A href='../../html_code/science/cable_canopy.F90.html#COMP_FRICTION_VEL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='500'>
      <font color=#993300>subroutine </font><font color=#cc0000>comp_friction_vel</font>() <A href='../../call_to/COMP_FRICTION_VEL.html' TARGET='index'>1</A>,<A href='../../call_from/COMP_FRICTION_VEL.html' TARGET='index'>2</A><a name='501'>
      real(r_1), dimension(mp)  :: lower_limit, rescale<a name='502'>
            psim_1 = <A href='../../html_code/science/cable_canopy.F90.html#PSIM'>psim</A><A href='../../html_code/science/cable_canopy.F90.html#COMP_FRICTION_VEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIM_2">(canopy%zetar(:,iter)) <a name='503'>
            <a name='504'>
               rescale = vonk * MAX(met%ua,umin)<a name='505'>
               z_eff = rough%zref_uv / rough%z0m<a name='506'>
            <a name='507'>
            psim_arg = canopy%zetar(:,iter) / z_eff <a name='508'>
            <font color=#447700>!---fix for compiler limitation. bitwise reproducable whilst we  <a name='509'></font>
            <font color=#447700>!---we know it to 11th decimal. psim_arg typically of a few <a name='510'></font>
            <font color=#447700>!psim_arg = nint(psim_arg * 1.e11)*1.e-11<a name='511'></font>
<a name='512'>
            psim_2 = <A href='../../html_code/science/cable_canopy.F90.html#PSIM'>psim</A><A href='../../html_code/science/cable_canopy.F90.html#COMP_FRICTION_VEL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PSIM_3">( psim_arg )<a name='513'>
                   <a name='514'>
            lower_limit = rescale / ( LOG(z_eff) - psim_1 + psim_2 )<a name='515'>
<a name='516'>
            canopy%us = MAX(1.e-6, lower_limit )<a name='517'>
      end subroutine comp_friction_vel<a name='518'>
<a name='519'>
<a name='520'>
<A NAME='PENMAN_MONTEITH'><A href='../../html_code/science/cable_canopy.F90.html#PENMAN_MONTEITH' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='521'>
   <font color=#993300>function </font><font color=#cc0000>Penman_Monteith</font>( ground_H_flux ) result(ssoilpotev) <A href='../../call_to/PENMAN_MONTEITH.html' TARGET='index'>2</A>,<A href='../../call_from/PENMAN_MONTEITH.html' TARGET='index'>1</A><a name='522'>
      implicit none<a name='523'>
      real(r_1), intent(in), dimension(mp)  :: ground_H_flux<a name='524'>
      real(r_1), dimension(mp)  :: ssoilpotev <a name='525'>
      REAL(r_1), DIMENSION(mp) :: sss <font color=#447700>! var for Penman-Monteith soil evap<a name='526'></font>
      REAL(r_1), DIMENSION(mp) :: cc1 <font color=#447700>! var for Penman-Monteith soil evap<a name='527'></font>
      REAL(r_1), DIMENSION(mp) :: cc2 <font color=#447700>! var for Penman-Monteith soil evap<a name='528'></font>
      REAL(r_1), DIMENSION(mp) :: qsatfvar<a name='529'>
      integer :: j<a name='530'>
         <font color=#447700>! Penman-Monteith formula<a name='531'></font>
         sss=air%dsatdk<a name='532'>
         cc1=sss/(sss+air%psyc )<a name='533'>
         cc2=air%psyc /(sss+air%psyc )<a name='534'>
         <a name='535'>
         call <A href='../../html_code/science/cable_canopy.F90.html#QSATFJH'>qsatfjh</A><A href='../../html_code/science/cable_canopy.F90.html#PENMAN_MONTEITH' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSATFJH_4">(qsatfvar,met%tvair-tfrz,met%pmb)<a name='536'>
<a name='537'>
         ssoilpotev = cc1 * (canopy%fns - ground_H_flux) + &amp;<a name='538'>
         cc2 * air%rho * air%rlam*(qsatfvar  - met%qvair)/ssoil%rtsoil<a name='539'>
      return<a name='540'>
   end function Penman_Monteith<a name='541'>
<a name='542'>
<a name='543'>
   <font color=#447700>! method alternative to P-M formula above<a name='544'></font>
<A NAME='HUMIDITY_DEFICIT_METHOD'><A href='../../html_code/science/cable_canopy.F90.html#HUMIDITY_DEFICIT_METHOD' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='545'>
   <font color=#993300>function </font><font color=#cc0000>Humidity_deficit_method</font>(qstss ) result(ssoilpotev) <A href='../../call_to/HUMIDITY_DEFICIT_METHOD.html' TARGET='index'>2</A><a name='546'>
      implicit none<a name='547'>
      real(r_1), dimension(mp)  :: ssoilpotev <a name='548'>
      REAL(r_1), DIMENSION(mp)            :: dq <font color=#447700>! sat spec hum diff.<a name='549'></font>
      REAL(r_1), DIMENSION(mp)            :: qstss <font color=#447700>!dummy var for compilation <a name='550'></font>
      integer :: j<a name='551'>
       <font color=#447700>! Spec hum deficit at soil/snow surface:<a name='552'></font>
       dq = qstss - met%qv<a name='553'>
<a name='554'>
       do j=1,mp<a name='555'>
         if(ssoil%snowd(j) &gt; 1.0) dq(j) = max( -0.1e-3, dq(j))<a name='556'>
       enddo <a name='557'>
      ssoilpotev =air%rho * air%rlam * dq /ssoil%rtsoil<a name='558'>
      return<a name='559'>
   end function Humidity_deficit_method<a name='560'>
<a name='561'>
 <a name='562'>
<A NAME='LATENT_HEAT_FLUX'><A href='../../html_code/science/cable_canopy.F90.html#LATENT_HEAT_FLUX' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='563'>
   <font color=#993300>subroutine </font><font color=#cc0000>latent_heat_flux</font>()  <A href='../../call_to/LATENT_HEAT_FLUX.html' TARGET='index'>2</A>,<A href='../../call_from/LATENT_HEAT_FLUX.html' TARGET='index'>1</A><a name='564'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_canopy.F90.html#LATENT_HEAT_FLUX' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_9"><a name='565'>
      implicit none<a name='566'>
      real(r_1), dimension(mp) ::  swilt_eff, frescale<a name='567'>
      real(r_1) :: flower_limit, fupper_limit<a name='568'>
      integer :: j<a name='569'>
<a name='570'>
         <font color=#447700>! Soil latent heat:<a name='571'></font>
         <font color=#447700>!canopy%fes= ssoil%wetfac * ssoil%potev<a name='572'></font>
         <font color=#447700>!jhan:Eva uses %fess<a name='573'></font>
         canopy%fess= ssoil%wetfac * ssoil%potev<a name='574'>
         <font color=#447700>! Reduce soil evap due to presence of puddle<a name='575'></font>
         pwet = max(0.,min(0.2,ssoil%pudsto/max(1.,ssoil%pudsmx)))<a name='576'>
         canopy%fess = canopy%fess * (1.-pwet)<a name='577'>
<a name='578'>
         <font color=#447700>!jhan: is this necessary anymore       <a name='579'></font>
         <font color=#447700>!--- decrease wilting point in UM <a name='580'></font>
         if( cable_runtime%um) then<a name='581'>
               swilt_eff = soil%swilt/3.0    <a name='582'>
         else<a name='583'>
               swilt_eff = soil%swilt    <a name='584'>
         endif<a name='585'>
         <font color=#447700>!jhan:NB %evapfbl<a name='586'></font>
         frescale = soil%zse(1) * 1000.  - ssoil%evapfbl(:,1) * air%rlam / dels         <a name='587'>
<a name='588'>
         do j=1,mp<a name='589'>
            <font color=#447700>!jhan:Eva uses %fess<a name='590'></font>
            if(ssoil%snowd(j) &lt; 0.1 .and. canopy%fess(j) .gt. 0. ) then<a name='591'>
<a name='592'>
               flower_limit = REAL(ssoil%wb(j,1),r_1)-soil%swilt(j)<a name='593'>
               fupper_limit = max(0._r_2,flower_limit) * frescale(j)<a name='594'>
               canopy%fess(j) = min(canopy%fess(j), fupper_limit )<a name='595'>
               <a name='596'>
               fupper_limit = REAL(ssoil%wb(j,1)-ssoil%wbice(j,1),r_1) * frescale(j)<a name='597'>
               canopy%fess(j) = min(canopy%fess(j), fupper_limit)<a name='598'>
            END if<a name='599'>
   <a name='600'>
            ssoil%cls(j)=1.<a name='601'>
            if (ssoil%snowd(j) &gt;= 0.1) then<a name='602'>
               ssoil%cls(j) = 1.1335<a name='603'>
               canopy%fess(j) = min( (ssoil%wetfac(j)*ssoil%potev(j)),                           &amp;<a name='604'>
                     ssoil%snowd(j)/dels*air%rlam(j)*ssoil%cls(j))<a name='605'>
            ENDif<a name='606'>
<a name='607'>
         enddo <a name='608'>
         <a name='609'>
         <font color=#447700>!jhan:Eva uses %fess<a name='610'></font>
         <font color=#447700>! Evaporation form soil puddle<a name='611'></font>
         canopy%fesp = min(ssoil%pudsto/dels*air%rlam,max(pwet*ssoil%potev,0.))<a name='612'>
         canopy%fes = canopy%fess + canopy%fesp<a name='613'>
<font color=#447700>!ijhan: double check with Eva that this is desired behaviour on 2nd call to latent heat<a name='614'></font>
<a name='615'>
      return<a name='616'>
   end subroutine latent_heat_flux<a name='617'>
<a name='618'>
<A NAME='WITHIN_CANOPY'><A href='../../html_code/science/cable_canopy.F90.html#WITHIN_CANOPY' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='619'>
<font color=#993300>subroutine </font><font color=#cc0000>within_canopy</font>( gbhu, gbhf ) <A href='../../call_to/WITHIN_CANOPY.html' TARGET='index'>1</A>,<A href='../../call_from/WITHIN_CANOPY.html' TARGET='index'>1</A><a name='620'>
  implicit none<a name='621'>
   real(r_2), intent(in), dimension(:,:) :: gbhu <font color=#447700>! forcedConvectionBndryLayerCond<a name='622'></font>
   real(r_2), intent(in), dimension(:,:):: gbhf <font color=#447700>! freeConvectionBndryLayerCond<a name='623'></font>
      REAL(r_1), DIMENSION(mp)            :: rrsw <font color=#447700>! recipr. stomatal resistance for water<a name='624'></font>
      REAL(r_1), DIMENSION(mp)            :: rrbw <font color=#447700>! recipr. leaf boundary layer resistance for water<a name='625'></font>
       REAL(r_1), DIMENSION(mp) :: dmah <font color=#447700>! A_{H} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='626'></font>
      REAL(r_1), DIMENSION(mp) :: dmbh <font color=#447700>! B_{H} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='627'></font>
      REAL(r_1), DIMENSION(mp) :: dmch <font color=#447700>! C_{H} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='628'></font>
      REAL(r_1), DIMENSION(mp) :: dmae <font color=#447700>! A_{E} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='629'></font>
      REAL(r_1), DIMENSION(mp) :: dmbe <font color=#447700>! B_{E} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='630'></font>
      REAL(r_1), DIMENSION(mp) :: dmce <font color=#447700>! C_{E} in eq. 3.41 in SCAM, CSIRO tech report 132<a name='631'></font>
      real(r_1)  :: lower_limit, upper_limit<a name='632'>
      <font color=#447700>!real(r_1), dimension(mp)  :: lower_limit, upper_limit<a name='633'></font>
      integer :: j<a name='634'>
      <a name='635'>
            <font color=#447700>!jhan:mk3l DID typecast again, and rrbw=1/rbw <a name='636'></font>
            rrbw = sum(gbhu+gbhf,2)/air%cmolar  <font color=#447700>! MJT <a name='637'></font>
            <font color=#447700>! leaf stomatal resistance for water<a name='638'></font>
            rrsw = sum(canopy%gswx,2)/air%cmolar <font color=#447700>! MJT<a name='639'></font>
            do j=1,mp<a name='640'>
            if(veg%meth(j) &gt; 0 .and. canopy%vlaiw(j) &gt; LAI_THRESH .and. &amp;<a name='641'>
                      rough%hruff(j) &gt; rough%z0soilsn(j)) then<a name='642'>
               <font color=#447700>!   use the dispersion matrix (DM) to find the air temperature <a name='643'></font>
               <font color=#447700>!   and specific humidity <a name='644'></font>
               <font color=#447700>!   (Raupach, Finkele and Zhang 1997, pp 17)<a name='645'></font>
               <font color=#447700>! leaf boundary layer resistance for water<a name='646'></font>
               <font color=#447700>! A_{H} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='647'></font>
               dmah(j) = (rt0(j)+rough%rt1(j))*((1.+air%epsi(j))*rrsw(j) + rrbw(j)) &amp;<a name='648'>
                    + air%epsi(j) * (rt0(j)*rough%rt1(j))*(rrbw(j)*rrsw(j))<a name='649'>
               <font color=#447700>! B_{H} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='650'></font>
               dmbh(j) = (-air%rlam(j)/capp)*(rt0(j)*rough%rt1(j))*(rrbw(j)*rrsw(j))<a name='651'>
               <font color=#447700>! C_{H} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='652'></font>
               dmch(j) = ((1.+air%epsi(j))*rrsw(j) + rrbw(j))*rt0(j)*rough%rt1(j)* &amp;<a name='653'>
                    (canopy%fhv(j) + canopy%fhs(j))/(air%rho(j)*capp)<a name='654'>
               <font color=#447700>! A_{E} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='655'></font>
               dmae(j) = (-air%epsi(j)*capp/air%rlam(j))*(rt0(j)*rough%rt1(j))*(rrbw(j)*rrsw(j))<a name='656'>
               <font color=#447700>! B_{E} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='657'></font>
               dmbe(j) = (rt0(j)+ssoil%wetfac(j)*rough%rt1(j))* &amp;<a name='658'>
                      ((1.+air%epsi(j))*rrsw(j) + rrbw(j))+(rt0(j)*rough%rt1(j))*(rrbw(j)*rrsw(j))<a name='659'>
               <font color=#447700>! C_{E} in eq. 3.41, SCAM manual, CSIRO tech doc 132<a name='660'></font>
               dmce(j) = ((1.+air%epsi(j))*rrsw(j) + rrbw(j))*rt0(j)*rough%rt1(j)* &amp;<a name='661'>
                      (canopy%fev(j) + canopy%fes(j))/(air%rho(j)*air%rlam(j))<a name='662'>
     <a name='663'>
               <font color=#447700>! Within canopy air temperature:<a name='664'></font>
               met%tvair(j) = met%tk(j) + (dmbe(j)*dmch(j)-dmbh(j)*dmce(j))/(dmah(j)*dmbe(j)-dmae(j)*dmbh(j)+1.0e-12)<a name='665'>
                 <a name='666'>
               <font color=#447700>!---set limits for comparisson<a name='667'></font>
               lower_limit =  min( ssoil%tss(j), met%tk(j)) - 5.0<a name='668'>
               upper_limit =  max( ssoil%tss(j), met%tk(j)) + 5.0<a name='669'>
      <a name='670'>
               <font color=#447700>!--- tvair within these limits<a name='671'></font>
               met%tvair(j) = max(met%tvair(j) , lower_limit)<a name='672'>
               met%tvair(j) = min(met%tvair(j) , upper_limit)<a name='673'>
     <a name='674'>
               <font color=#447700>! recalculate using canopy within temperature<a name='675'></font>
               <font color=#447700>!     whhere (veg%meth .eq. 0 )<a name='676'></font>
               met%qvair(j) = met%qv(j) + (dmah(j)*dmce(j)-dmae(j)*dmch(j))/(dmah(j)*dmbe(j)-dmae(j)*dmbh(j)+1.0e-12)<a name='677'>
               met%qvair(j) = max(0.0,met%qvair(j))<a name='678'>
<font color=#447700>!jhan:output warning t<a name='679'></font>
<font color=#447700>!jhan:ssoil%qstss is UM only<a name='680'></font>
<font color=#447700>!jhan:consult<a name='681'></font>
               if(cable_runtime%um) then<a name='682'>
                  <font color=#447700>!---set limits for comparisson<a name='683'></font>
                  lower_limit =  min( ssoil%qstss(j), met%qv(j))<a name='684'>
                  upper_limit =  max( ssoil%qstss(j), met%qv(j))<a name='685'>
 <a name='686'>
                  <font color=#447700>!--- qvair within these limits<a name='687'></font>
                  met%qvair(j) =  max(met%qvair(j),lower_limit)<a name='688'>
                  met%qvair(j) =  min(met%qvair(j), upper_limit)<a name='689'>
               endif<a name='690'>
<a name='691'>
               <font color=#447700>! Saturated specific humidity in canopy:<a name='692'></font>
               call <A href='../../html_code/science/cable_canopy.F90.html#QSATFJH2'>qsatfjh2</A><A href='../../html_code/science/cable_canopy.F90.html#WITHIN_CANOPY' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="QSATFJH2_1">(qstvair(j),met%tvair(j)-tfrz,met%pmb(j))<a name='693'>
               <font color=#447700>! Saturated vapour pressure deficit in canopy:<a name='694'></font>
               met%dva(j) = (qstvair(j) - met%qvair(j)) *  rmair/rmh2o * met%pmb(j) * 100.<a name='695'>
            END if <a name='696'>
         enddo <a name='697'>
     <a name='698'>
   return<a name='699'>
end subroutine within_canopy<a name='700'>
<a name='701'>
<A NAME='UPDATE_ZETAR'><A href='../../html_code/science/cable_canopy.F90.html#UPDATE_ZETAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='702'>
   <font color=#993300>subroutine </font><font color=#cc0000>update_zetar</font>() <A href='../../call_to/UPDATE_ZETAR.html' TARGET='index'>1</A><a name='703'>
      implicit none<a name='704'>
      integer :: j<a name='705'>
            <font color=#447700>! monin-obukhov stability parameter zetar=zref/l<a name='706'></font>
            <font color=#447700>!        recompute zetar for the next iteration, except on last iteration<a name='707'></font>
            IF (iter &lt; niter) THEN <font color=#447700>! dont compute zetar on the last iter<a name='708'></font>
               iterplus = max(iter+1,2)<a name='709'>
               canopy%zetar(:,iterplus) = -(vonk*grav*rough%zref_tq*(canopy%fh+0.07*canopy%fe))/ &amp;<a name='710'>
                     (air%rho*capp*met%tk*canopy%us**3)<a name='711'>
               <font color=#447700>! case niter=2: final zetar=zetmul*zetar(2) (compute only when iter=1)<a name='712'></font>
               IF (niter == 2) THEN<a name='713'>
                  canopy%zetar(:,2) = zetmul * canopy%zetar(:,2)<a name='714'>
                  do j=1,mp<a name='715'>
                     if ( (met%fsd(j,1)+met%fsd(j,2))  ==  0.0 ) &amp;<a name='716'>
                        canopy%zetar(j,2) = 0.5 * canopy%zetar(j,2)<a name='717'>
                  enddo<a name='718'>
               END IF<a name='719'>
               <font color=#447700>!     constrain zeta to zetpos and zetneg (set in param0)<a name='720'></font>
               canopy%zetar(:,iterplus) = min(zetpos,canopy%zetar(:,iterplus))        <font color=#447700>! zetar too +<a name='721'></font>
               canopy%zetar(:,iterplus) = max(zetneg,canopy%zetar(:,iterplus))        <font color=#447700>! zetar too -<a name='722'></font>
            END IF <font color=#447700>! (iter &lt; niter) <a name='723'></font>
   end subroutine update_zetar<a name='724'>
<a name='725'>
<a name='726'>
<a name='727'>
<font color=#447700>!jhan:these are all NOT contained subrs in mk3l<a name='728'></font>
    <font color=#447700>!--------------------------------------------------------------------------<a name='729'></font>
<A NAME='QSATF'><A href='../../html_code/science/cable_canopy.F90.html#QSATF' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='730'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>qsatf</font>(j,tair,pmb) RESULT(r)<a name='731'>
      <font color=#447700>! MRR, 1987<a name='732'></font>
      <font color=#447700>! AT TEMP tair (DEG C) AND PRESSURE pmb (MB), GET SATURATION SPECIFIC<a name='733'></font>
      <font color=#447700>! HUMIDITY (KG/KG) FROM TETEN FORMULA<a name='734'></font>
      REAL(r_1), INTENT(IN) :: tair <font color=#447700>! air temperature (C)<a name='735'></font>
      REAL(r_1), INTENT(IN) :: pmb  <font color=#447700>! pressure PMB (mb)<a name='736'></font>
      REAL(r_1)           :: r    <font color=#447700>! result; sat sp humidity<a name='737'></font>
      integer, intent(in) :: j <a name='738'>
      r = (rmh2o/rmair) * (tetena*EXP(tetenb*tair/(tetenc+tair))) / pmb<a name='739'>
    END FUNCTION qsatf<a name='740'>
<a name='741'>
    <font color=#447700>!---------------------------------------------------------<a name='742'></font>
<A NAME='QSATFJH'><A href='../../html_code/science/cable_canopy.F90.html#QSATFJH' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='743'>
    <font color=#993300>subroutine </font><font color=#cc0000>qsatfjh</font>(var,tair,pmb)  <A href='../../call_to/QSATFJH.html' TARGET='index'>4</A><a name='744'>
      REAL(r_1), INTENT(IN), dimension(mp) :: tair <font color=#447700>! air temperature (C)<a name='745'></font>
      REAL(r_1), INTENT(IN), dimension(mp) :: pmb  <font color=#447700>! pressure PMB (mb)<a name='746'></font>
      REAL(r_1), intent(out), dimension(mp)           :: var    <font color=#447700>! result; sat sp humidity<a name='747'></font>
      integer :: j<a name='748'>
      <a name='749'>
      do j=1,mp<a name='750'>
         <font color=#447700>!if (knode_gl == 1 ) then<a name='751'></font>
         <font color=#447700>!print *,'jhan: j', j <a name='752'></font>
         <font color=#447700>!print *,'jhan:rmho2/rmair *tetena', rmh2o/rmair *tetena<a name='753'></font>
         <font color=#447700>!print *,'jhan:exp_Arg', tetenb*tair/(tetenc+tair) <a name='754'></font>
         <font color=#447700>!print *,'jhan:exp_Arg', pmb<a name='755'></font>
         <font color=#447700>!print *,''<a name='756'></font>
         <font color=#447700>!endif<a name='757'></font>
   <a name='758'>
         var(j) = (rmh2o/rmair) * (tetena*EXP(tetenb*tair(j)/(tetenc+tair(j)))) / pmb(j)<a name='759'>
      enddo   <a name='760'>
    END subroutine qsatfjh<a name='761'>
<a name='762'>
    <font color=#447700>!---------------------------------------------------------<a name='763'></font>
<a name='764'>
<A NAME='QSATFJH2'><A href='../../html_code/science/cable_canopy.F90.html#QSATFJH2' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='765'>
    <font color=#993300>subroutine </font><font color=#cc0000>qsatfjh2</font>(var,tair,pmb)  <A href='../../call_to/QSATFJH2.html' TARGET='index'>1</A><a name='766'>
      REAL(r_1), INTENT(IN) :: tair <font color=#447700>! air temperature (C)<a name='767'></font>
      REAL(r_1), INTENT(IN) :: pmb  <font color=#447700>! pressure PMB (mb)<a name='768'></font>
      REAL(r_1), intent(out)           :: var    <font color=#447700>! result; sat sp humidity<a name='769'></font>
      <a name='770'>
  <font color=#447700>!       print *,'jhan: j', j <a name='771'></font>
  <font color=#447700>!       print *,'jhan:rmho2/rmair *tetena', rmh2o/rmair *tetena<a name='772'></font>
  <font color=#447700>!       print *,'jhan:exp_Arg', tetenb*tair/(tetenc+tair) <a name='773'></font>
  <font color=#447700>!       print *,'jhan:exp_Arg', pmb<a name='774'></font>
  <font color=#447700>!       print *,''<a name='775'></font>
  <a name='776'>
         var = (rmh2o/rmair) * (tetena*EXP(tetenb*tair/(tetenc+tair))) / pmb<a name='777'>
    END subroutine qsatfjh2<a name='778'>
<a name='779'>
<a name='780'>
<A NAME='PSIM'><A href='../../html_code/science/cable_canopy.F90.html#PSIM' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='781'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>psim</font>(zeta) result(r) <A href='../../call_to/PSIM.html' TARGET='index'>3</A>,<A href='../../call_from/PSIM.html' TARGET='index'>1</A><a name='782'>
      <font color=#447700>! mrr, 16-sep-92 (from function psi: mrr, edinburgh 1977)<a name='783'></font>
      <font color=#447700>! computes integrated stability function psim(z/l) (z/l=zeta)<a name='784'></font>
      <font color=#447700>! for momentum, using the businger-dyer form for unstable cases<a name='785'></font>
      <font color=#447700>! and the webb form for stable cases. see paulson (1970).<a name='786'></font>
      USE <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#PSIM' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_1"><a name='787'>
      REAL(r_1), INTENT(IN), dimension(mp)     :: zeta<a name='788'>
      REAL(r_1), dimension(mp)                  :: r<a name='789'>
      REAL(r_1), dimension(mp)                  :: x,x3<a name='790'>
      REAL(r_1), PARAMETER      :: gu = 16.0<a name='791'>
      REAL(r_1), PARAMETER      :: gs = 5.0<a name='792'>
<a name='793'>
      REAL(r_1), dimension(mp)                  :: z <a name='794'>
      REAL(r_1), dimension(mp)                  :: stable <a name='795'>
      REAL(r_1), dimension(mp)                  :: unstable <a name='796'>
<a name='797'>
      z = 0.5 + sign(0.5,zeta) <font color=#447700>!z=1 in stable, 0 in unstable<a name='798'></font>
      stable = -gs*zeta<a name='799'>
      x      = (1.0 + gu*abs(zeta))**0.25<a name='800'>
      xx = (1.0+x*x)*(1.0+x)**2/8<a name='801'>
      unstable = log(xx) - 2.0*atan(x) + pi_c*0.5<a name='802'>
      <font color=#447700>!unstable = log((1.0+x*x)*(1.0+x)**2/8) - 2.0*atan(x) + pi_c*0.5<a name='803'></font>
      r   = z*stable + (1.0-z)*unstable<a name='804'>
       <a name='805'>
    END FUNCTION psim<a name='806'>
<a name='807'>
    <font color=#447700>!---------------------------------------------------------<a name='808'></font>
<A NAME='PSIS'><A href='../../html_code/science/cable_canopy.F90.html#PSIS' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='809'>
    ELEMENTAL <font color=#993300>FUNCTION </font><font color=#cc0000>psis</font>(zeta) result(r) <A href='../../call_to/PSIS.html' TARGET='index'>5</A><a name='810'>
      <font color=#447700>! mrr, 16-sep-92 (from function psi: mrr, edinburgh 1977)<a name='811'></font>
      <font color=#447700>! computes integrated stability function psis(z/l) (z/l=zeta)<a name='812'></font>
      <font color=#447700>! for scalars, using the businger-dyer form for unstable cases<a name='813'></font>
      <font color=#447700>! and the webb form for stable cases. see paulson (1970).<a name='814'></font>
      REAL(r_1), INTENT(IN)     :: zeta<a name='815'>
      REAL(r_1)                 :: r<a name='816'>
      REAL(r_1), PARAMETER      :: gu = 16.0<a name='817'>
      REAL(r_1), PARAMETER      :: gs = 5.0<a name='818'>
<a name='819'>
      REAL(r_1)                 :: z<a name='820'>
      REAL(r_1)                 :: y<a name='821'>
      REAL(r_1)                 :: stable<a name='822'>
      REAL(r_1)                 :: unstable<a name='823'>
<a name='824'>
      z      = 0.5 + sign(0.5,zeta)    <font color=#447700>! z=1 in stable, 0 in unstable <a name='825'></font>
      stable = -gs*zeta<a name='826'>
      y      = (1.0 + gu*abs(zeta))**0.5<a name='827'>
      unstable = 2.0 * alog((1+y)*0.5)<a name='828'>
      r   = z*stable + (1.0-z)*unstable<a name='829'>
<a name='830'>
    END FUNCTION psis<a name='831'>
<a name='832'>
    <font color=#447700>!---------------------------------------------------------<a name='833'></font>
<A NAME='PSIS1'><A href='../../html_code/science/cable_canopy.F90.html#PSIS1' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='834'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>psis1</font>(zeta) result(r) <A href='../../call_to/PSIS1.html' TARGET='index'>2</A><a name='835'>
      <font color=#447700>! mrr, 16-sep-92 (from function psi: mrr, edinburgh 1977)<a name='836'></font>
      <font color=#447700>! computes integrated stability function psis(z/l) (z/l=zeta)<a name='837'></font>
      <font color=#447700>! for scalars, using the businger-dyer form for unstable cases<a name='838'></font>
      <font color=#447700>! and the webb form for stable cases. see paulson (1970).<a name='839'></font>
      REAL(r_1), INTENT(IN)     :: zeta<a name='840'>
      REAL(r_1)                 :: r<a name='841'>
      REAL(r_1), PARAMETER      :: gu = 16.0<a name='842'>
      REAL(r_1), PARAMETER      :: gs = 5.0<a name='843'>
<a name='844'>
      REAL(r_1)                 :: z<a name='845'>
      REAL(r_1)                 :: y<a name='846'>
      REAL(r_1)                 :: stable<a name='847'>
      REAL(r_1)                 :: unstable<a name='848'>
<a name='849'>
      z      = 0.5 + sign(0.5,zeta)    <font color=#447700>! z=1 in stable, 0 in unstable <a name='850'></font>
      stable = -gs*zeta<a name='851'>
      y      = (1.0 + gu*abs(zeta))**0.5<a name='852'>
      unstable = 2.0 * alog((1+y)*0.5)<a name='853'>
      r   = z*stable + (1.0-z)*unstable<a name='854'>
<a name='855'>
    END FUNCTION psis1<a name='856'>
<a name='857'>
    <font color=#447700>!---------------------------------------------------------<a name='858'></font>
<A NAME='RPLANT'><A href='../../html_code/science/cable_canopy.F90.html#RPLANT' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='859'>
    ELEMENTAL <font color=#993300>FUNCTION </font><font color=#cc0000>rplant</font>(rpconst, rpcoef, tair) result(z)<a name='860'>
      REAL(r_1), INTENT(IN)     :: rpconst<a name='861'>
      REAL(r_1), INTENT(IN)     :: rpcoef<a name='862'>
      REAL(r_1), INTENT(IN)     :: tair<a name='863'>
      REAL(r_1)                 :: z<a name='864'>
      z = rpconst * exp(rpcoef * tair)<a name='865'>
    END FUNCTION rplant<a name='866'>
    <font color=#447700>!---------------------------------------------------------<a name='867'></font>
<a name='868'>
<a name='869'>
<a name='870'>
<a name='871'>
<a name='872'>
<a name='873'>
    <font color=#447700>!---------------------------------------------------------<a name='874'></font>
<A NAME='WETLEAF'><A href='../../html_code/science/cable_canopy.F90.html#WETLEAF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='875'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>wetLeaf</font>(dels,rad,rough,air,met,veg,canopy,cansat, tlfy, gbhu, gbhf,ghwet) <A href='../../call_to/WETLEAF.html' TARGET='index'>1</A><a name='876'>
<a name='877'>
    TYPE (radiation_type), INTENT(INOUT):: rad<a name='878'>
    TYPE (roughness_type), INTENT(INOUT):: rough<a name='879'>
    TYPE (air_type), INTENT(INOUT)      :: air<a name='880'>
    TYPE (met_type), INTENT(INOUT)      :: met<a name='881'>
    TYPE (veg_parameter_type), INTENT(INOUT)    :: veg<a name='882'>
    TYPE (canopy_type), INTENT(INOUT)   :: canopy<a name='883'>
   real(r_1),intent(in), dimension(:) :: tlfy <font color=#447700>! leaf temp (K)<a name='884'></font>
   real(r_2), intent(in), dimension(:,:) :: gbhu <font color=#447700>! forcedConvectionBndryLayerCond<a name='885'></font>
   real(r_2), intent(in), dimension(:,:) :: gbhf <font color=#447700>! freeConvectionBndryLayerCond<a name='886'></font>
      real(r_2), intent(out), dimension(:) :: ghwet  <font color=#447700>! cond for heat for a wet canopy<a name='887'></font>
<a name='888'>
      real(r_1),intent(in), dimension(:) :: cansat <font color=#447700>! max canopy intercept. (mm)<a name='889'></font>
   <font color=#447700>! assuming the temperature of wet leaf is equal that of dry leaf ="tlfy"<a name='890'></font>
    REAL(r_1), INTENT(IN)     :: dels <font color=#447700>! integration time step (s)<a name='891'></font>
    REAL(r_1), DIMENSION(mp)  :: ccfevw <font color=#447700>! limitation term for<a name='892'></font>
                                        <font color=#447700>! wet canopy evaporation rate<a name='893'></font>
    REAL(r_1), DIMENSION(mp)  :: gwwet  <font color=#447700>! cond for water for a wet canopy<a name='894'></font>
    REAL(r_1), DIMENSION(mp)  :: ghrwet <font color=#447700>! wet canopy cond: heat &amp; thermal rad<a name='895'></font>
    REAL(r_1), DIMENSION(mp)  :: sum_gbh, sum_rad_rniso, sum_rad_gradis <a name='896'>
    integer :: j<a name='897'>
<a name='898'>
    ghwet = 1.0e-3<a name='899'>
    gwwet = 1.0e-3<a name='900'>
    ghrwet= 1.0e-3<a name='901'>
    canopy%fevw = 0.0<a name='902'>
    canopy%fhvw = 0.0<a name='903'>
    sum_gbh = SUM((gbhu+gbhf),2)<a name='904'>
    sum_rad_rniso = SUM(rad%rniso,2)<a name='905'>
    sum_rad_gradis = SUM(rad%gradis,2)<a name='906'>
<a name='907'>
    do j=1,mp<a name='908'>
      if(canopy%vlaiw(j) &gt; LAI_THRESH) then<a name='909'>
       <font color=#447700>! VEG SENSIBLE AND LATENT HEAT FLUXES fevw, fhvw (W/m2) for a wet canopy<a name='910'></font>
       <font color=#447700>! calculate total thermal resistance, rthv in s/m<a name='911'></font>
          ghwet(j) = 2.0   * sum_gbh(j) <a name='912'>
          gwwet(j) = 1.075 * sum_gbh(j) <a name='913'>
          ghrwet(j) = sum_rad_gradis(j) + ghwet(j)<a name='914'>
          <font color=#447700>! Calculate fraction of canopy which is wet:<a name='915'></font>
          canopy%fwet(j) = MAX(0.0,MIN(1.0,0.8*canopy%cansto(j)/MAX(cansat(j),0.01)))<a name='916'>
          <font color=#447700>! Calculate lat heat from wet canopy, may be neg. if dew on wet canopy<a name='917'></font>
          <font color=#447700>! to avoid excessive evaporation:<a name='918'></font>
          ccfevw(j) = MIN(canopy%cansto(j) * air%rlam(j) / dels, &amp;<a name='919'>
                       2.0 / (1440.0 / (dels/60.0)) * air%rlam(j) )<a name='920'>
   <a name='921'>
          canopy%fevw(j) = MIN(canopy%fwet(j) * (air%dsatdk(j)*(sum_rad_rniso(j)- &amp;<a name='922'>
                        capp*rmair*(met%tvair(j)-met%tk(j))*sum_rad_gradis(j)) &amp;<a name='923'>
                        + capp*rmair*met%dva(j)*ghrwet(j)) &amp;<a name='924'>
                            / (air%dsatdk(j)+air%psyc(j)*ghrwet(j)/gwwet(j)), ccfevw(j))<a name='925'>
          <font color=#447700>!jhan:prev. in UM only<a name='926'></font>
          canopy%fevw_pot(j) = (air%dsatdk(j)* (sum_rad_rniso(j)- &amp;<a name='927'>
                        capp*rmair*(met%tvair(j)-met%tk(j))*sum_rad_gradis(j)) &amp;<a name='928'>
                        + capp*rmair*met%dva(j)*ghrwet(j)) &amp;<a name='929'>
                            / (air%dsatdk(j)+air%psyc(j)*ghrwet(j)/gwwet(j) )<a name='930'>
          <font color=#447700>! Calculate sens heat from wet canopy:<a name='931'></font>
          <font color=#447700>!canopy%fhvw = (canopy%fwet*(SUM(rad%rniso,2)-capp*rmair *              &amp;<a name='932'></font>
          <font color=#447700>!(met%tvair(:)-met%tk(:))*sum(rad%gradis,2))-canopy%fevw)*ghwet/ghrwet<a name='933'></font>
   <a name='934'>
          canopy%fhvw(j) = canopy%fwet(j)*(sum_rad_rniso(j) -capp*rmair*(tlfy(j)-met%tk(j))* &amp;<a name='935'>
                        sum_rad_gradis(j))  - canopy%fevw(j)<a name='936'>
      ENDif <a name='937'>
    enddo        <a name='938'>
  END SUBROUTINE wetLeaf<a name='939'>
<a name='940'>
  END SUBROUTINE define_canopy<a name='941'>
<a name='942'>
<a name='943'>
<A NAME='SURF_WETNESS_FACT'><A href='../../html_code/science/cable_canopy.F90.html#SURF_WETNESS_FACT' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='944'>
   <font color=#993300>subroutine </font><font color=#cc0000>surf_wetness_fact</font>( cansat, canopy, ssoil,veg, met, soil, dels ) <A href='../../call_to/SURF_WETNESS_FACT.html' TARGET='index'>1</A>,<A href='../../call_from/SURF_WETNESS_FACT.html' TARGET='index'>3</A><a name='945'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#SURF_WETNESS_FACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_13"><a name='946'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#SURF_WETNESS_FACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_6"><a name='947'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#SURF_WETNESS_FACT' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_4">, only : tfrz<a name='948'>
      implicit none<a name='949'>
      type (veg_parameter_type), INTENT(INOUT)    :: veg<a name='950'>
      type (soil_snow_type), intent(inout):: ssoil<a name='951'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='952'>
      type (canopy_type), INTENT(INOUT)   :: canopy<a name='953'>
      type (met_type), INTENT(INOUT)   :: met<a name='954'>
      real(r_1), intent(in)               :: dels <font color=#447700>! integration time setp (s)<a name='955'></font>
      real(r_1),intent(in), dimension(:) :: cansat <font color=#447700>! max canopy intercept. (mm)<a name='956'></font>
      real(r_1), dimension(mp)  :: lower_limit, upper_limit,ftemp<a name='957'>
      integer :: j<a name='958'>
<a name='959'>
         <font color=#447700>! Rainfall variable is limited so canopy interception is limited,<a name='960'></font>
         <font color=#447700>! used to stabilise latent fluxes.<a name='961'></font>
         <font color=#447700>! to avoid excessive direct canopy evaporation (EK nov2007, snow scheme)<a name='962'></font>
         upper_limit = 4.0 * MIN(dels,1800.0) / (60.0 * 1440.0 ) <a name='963'>
         ftemp =MIN(met%precip-met%precip_sn, upper_limit )<a name='964'>
         <font color=#447700>! Calculate canopy intercepted rainfall, equal to zero if temp &lt; 0C:<a name='965'></font>
         lower_limit = cansat - canopy%cansto<a name='966'>
         upper_limit = max(lower_limit, 0.0) <a name='967'>
         canopy%wcint = MERGE( MIN(upper_limit, ftemp), 0.0,     &amp;<a name='968'>
               ftemp &gt; 0.0  .AND. met%tk &gt; tfrz)  <font color=#447700>!EAK, 09/10<a name='969'></font>
<a name='970'>
         <font color=#447700>! Define canopy throughfall (100% of precip if temp &lt; 0C, see above):<a name='971'></font>
         canopy%through = met%precip_sn + MIN( met%precip - met%precip_sn , &amp;<a name='972'>
              MAX(0.0, met%precip - met%precip_sn - canopy%wcint) )  <font color=#447700>! EK nov2007<a name='973'></font>
     <a name='974'>
         <font color=#447700>! Add canopy interception to canopy storage term:<a name='975'></font>
         canopy%cansto = canopy%cansto + canopy%wcint<a name='976'>
     <a name='977'>
         <font color=#447700>! Calculate fraction of canopy which is wet:<a name='978'></font>
         <font color=#447700>!jhan:rm hardwire<a name='979'></font>
         canopy%fwet   = max(0.0,min(1.0,0.8*canopy%cansto/MAX(cansat,0.01)))<a name='980'>
     <a name='981'>
         ssoil%wetfac = MAX(0.0, MIN(1.0, &amp;<a name='982'>
              (REAL(ssoil%wb(:,1),r_1) - soil%swilt) / (soil%sfc - soil%swilt)))<a name='983'>
        <a name='984'>
         <font color=#447700>!jhan:Evahas modified this   <a name='985'></font>
         <font color=#447700>! Temporay fixer for accounting the reduction of soil evap due to freezing<a name='986'></font>
            do j=1,mp<a name='987'>
               if( ssoil%wbice(j,1) &gt; 0. ) &amp;<a name='988'>
                  ssoil%wetfac(j) = ssoil%wetfac(j)*max(0.5,1.-min(0.2,(ssoil%wbice(j,1)/ssoil%wb(j,1))**2))<a name='989'>
               if (ssoil%snowd(j) &gt; 0.1) ssoil%wetfac(j) = 0.9<a name='990'>
               if ( veg%iveg(j) == 14 .and. met%tk(j) &gt;= tfrz + 5.) ssoil%wetfac(j) = 1.0<a name='991'>
               if( veg%iveg(j) == 14 .and. met%tk(j) &lt; tfrz + 5.) ssoil%wetfac(j) = 0.7<a name='992'>
            enddo <a name='993'>
            <a name='994'>
    <a name='995'>
         <font color=#447700>! owetfac introduced to reduce sharp changes in dry regions,<a name='996'></font>
         <font color=#447700>! especially in offline runs in which there may be discrepancies between<a name='997'></font>
         <font color=#447700>! timing of precip and temperature change (EAK apr2009)<a name='998'></font>
         ssoil%wetfac = 0.5*(ssoil%wetfac + ssoil%owetfac)<a name='999'>
         <font color=#447700>!jhan:Eva has modified this<a name='1000'></font>
         <font color=#447700>! Temporay fixer for accounting the reduction of soil evap due to freezing<a name='1001'></font>
         <font color=#447700>!WERE ( ssoil%wbice(:,1) &gt; 0.0 ) ! Prevents divide by zero at glaciated<a name='1002'></font>
         <font color=#447700>!                                ! points whhere wb and wbice=0.<a name='1003'></font>
          <font color=#447700>! ssoil%wetfac = ssoil%wetfac &amp;<a name='1004'></font>
          <font color=#447700>!              * REAL(((1.0-ssoil%wbice(:,1)/ssoil%wb(:,1)))**2,r_1)<a name='1005'></font>
         <font color=#447700>!END WERE<a name='1006'></font>
    <a name='1007'>
      return<a name='1008'>
   end subroutine surf_wetness_fact<a name='1009'>
<a name='1010'>
<a name='1011'>
<A NAME='DRYLEAF'><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1012'>
   <font color=#993300>SUBROUTINE </font><font color=#cc0000>dryLeaf</font>(dels,rad,rough,air,met,veg,canopy, soil,ssoil, dsx,fwsoil, tlfx,  &amp; <A href='../../call_to/DRYLEAF.html' TARGET='index'>1</A>,<A href='../../call_from/DRYLEAF.html' TARGET='index'>18</A><a name='1013'>
         tlfy, ecy, hcy, rny, gbhu, gbhf, csx, iter )<a name='1014'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_14"><a name='1015'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_7"><a name='1016'>
      use <A href='../../html_code/common/cable_common.F90.html#CABLE_COMMON_MODULE'>cable_common_module</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="CABLE_COMMON_MODULE_10"><a name='1017'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_4"><a name='1018'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_2"><a name='1019'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_5"><a name='1020'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_2"><font color=#447700>!, only : gsw03<a name='1021'></font>
      implicit none<a name='1022'>
<a name='1023'>
      TYPE (radiation_type), INTENT(INOUT):: rad<a name='1024'>
      TYPE (roughness_type), INTENT(INOUT):: rough<a name='1025'>
      TYPE (air_type), INTENT(INOUT)      :: air<a name='1026'>
      TYPE (met_type), INTENT(INOUT)      :: met<a name='1027'>
      TYPE (veg_parameter_type), INTENT(INOUT)    :: veg<a name='1028'>
      TYPE (canopy_type), INTENT(INOUT)   :: canopy<a name='1029'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='1030'>
      type (soil_snow_type), intent(inout):: ssoil<a name='1031'>
      real(r_1), intent(inout), dimension(:) :: dsx <font color=#447700>! leaf surface vpd<a name='1032'></font>
      real(r_1), intent(inout), dimension(:):: fwsoil <font color=#447700>! soil water modifier of stom. cond<a name='1033'></font>
      real(r_1),intent(inout), dimension(:) :: tlfx <font color=#447700>! leaf temp prev. iter (K)<a name='1034'></font>
      real(r_1),intent(inout), dimension(:) :: tlfy <font color=#447700>! leaf temp (K)<a name='1035'></font>
      real(r_2),intent(inout), dimension(:) :: ecy <font color=#447700>! lat heat fl dry big leaf<a name='1036'></font>
      real(r_2),intent(inout), dimension(:) :: hcy <font color=#447700>! veg. sens heat<a name='1037'></font>
      real(r_2),intent(inout), dimension(:) :: rny <a name='1038'>
      real(r_2), intent(in), dimension(:,:) :: gbhu <font color=#447700>! forcedConvectionBndryLayerCond<a name='1039'></font>
      real(r_2), intent(inout), dimension(:,:) :: gbhf <font color=#447700>! freeConvectionBndryLayerCond<a name='1040'></font>
      real(r_2), intent(inout), dimension(:,:) :: csx <font color=#447700>! leaf surface CO2 concentration<a name='1041'></font>
      integer,intent(in) :: iter<a name='1042'>
    <a name='1043'>
      REAL(r_1), INTENT(IN)     :: dels <font color=#447700>! integration time step (s)<a name='1044'></font>
      REAL(r_1), PARAMETER  :: co2cp3 = 0.0 <font color=#447700>! CO2 compensation pt C3<a name='1045'></font>
      REAL(r_1), PARAMETER  :: jtomol = 4.6e-6 <font color=#447700>! Convert from J to Mol for light<a name='1046'></font>
      REAL(r_1), DIMENSION(mp)  :: conkct <font color=#447700>! Michaelis Menton const.<a name='1047'></font>
      REAL(r_1), DIMENSION(mp)  :: conkot <font color=#447700>! Michaelis Menton const.<a name='1048'></font>
      REAL(r_1), DIMENSION(mp)  :: cx1  <font color=#447700>! "d_{3}" in Wang and Leuning,<a name='1049'></font>
      REAL(r_1), DIMENSION(mp)  :: cx2  <font color=#447700>!     1998, appendix E<a name='1050'></font>
      REAL(r_1), DIMENSION(mp)  :: tdiff <font color=#447700>! leaf air temp diff.<a name='1051'></font>
      REAL(r_1), DIMENSION(mp)  :: tlfxx <font color=#447700>! leaf temp of current iteration (K)<a name='1052'></font>
      REAL(r_1), DIMENSION(mp)  :: abs_deltlf <font color=#447700>! ABS(deltlf)<a name='1053'></font>
      REAL(r_1), DIMENSION(mp)  :: deltlf <font color=#447700>! deltlfy of prev iter.<a name='1054'></font>
      REAL(r_1), DIMENSION(mp)  :: deltlfy <font color=#447700>! del temp successive iter.<a name='1055'></font>
      REAL(r_1), DIMENSION(mp)  :: gras <font color=#447700>! Grashof coeff<a name='1056'></font>
      REAL(r_1), DIMENSION(mp)  :: evapfb <font color=#447700>!<a name='1057'></font>
      REAL(r_1), DIMENSION(mp)  :: temp<a name='1058'>
      REAL(r_2), DIMENSION(mp)  :: ecx <font color=#447700>! lat. hflux big leaf<a name='1059'></font>
      REAL(r_2), DIMENSION(mp)  :: hcx <font color=#447700>! sens heat fl big leaf prev iteration<a name='1060'></font>
      REAL(r_2), DIMENSION(mp)  :: rnx <font color=#447700>! net rad prev timestep<a name='1061'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: gw  <font color=#447700>! cond for water for a dry canopy<a name='1062'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: gh  <font color=#447700>! cond for heat for a dry canopy<a name='1063'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: ghr <font color=#447700>! dry canopy cond for heat &amp; thermal rad<a name='1064'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: anx <font color=#447700>! net photos. prev iteration<a name='1065'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: an_y <font color=#447700>! net photosynthesis soln<a name='1066'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: rdx <font color=#447700>! daytime leaf resp rate, prev iteration<a name='1067'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: rdy <font color=#447700>! daytime leaf resp rate<a name='1068'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: ejmax2 <font color=#447700>! jmax of big leaf<a name='1069'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: ejmxt3 <font color=#447700>! jmax big leaf C3 plants<a name='1070'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: vcmxt3 <font color=#447700>! vcmax big leaf C3<a name='1071'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: vcmxt4 <font color=#447700>! vcmax big leaf C4<a name='1072'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: vx3 <font color=#447700>! carboxylation C3 plants<a name='1073'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: vx4 <font color=#447700>! carboxylation C4 plants<a name='1074'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: xleuning <font color=#447700>! leuning stomatal coeff<a name='1075'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: psycst <font color=#447700>! modified pych. constant<a name='1076'></font>
      REAL(r_1), DIMENSION(mp,mf)  :: temp2<a name='1077'>
      INTEGER(i_d)   :: k  <font color=#447700>! iteration count<a name='1078'></font>
      INTEGER(i_d)   :: kk  <font color=#447700>! iteration count<a name='1079'></font>
      REAL(r_1), DIMENSION(mp,ms)  :: oldevapfbl<a name='1080'>
<a name='1081'>
      INTEGER(i_d)   :: i,j <font color=#447700>!loop counts - kdcorbin, 09/10<a name='1082'></font>
<a name='1083'>
      <font color=#447700>!jhan:lower_limit = IS this doable outside stability loop<a name='1084'></font>
      real(r_1), dimension(:,:), pointer :: gswmin <font color=#447700>! min stomatal conductance<a name='1085'></font>
      real(r_1), dimension(mp,2)  ::  gsw_term, lower_limit2  <font color=#447700>! local temp var <a name='1086'></font>
      REAL(r_1), DIMENSION(mp,mf) :: frac42 <font color=#447700>! 2D frac4<a name='1087'></font>
<a name='1088'>
<a name='1089'>
      allocate( gswmin(mp,mf ))<a name='1090'>
<a name='1091'>
      <font color=#447700>! Soil water limitation on stomatal conductance:<a name='1092'></font>
      if( iter ==1) then<a name='1093'>
         if(cable_user%FWSOIL_SWITCH == 'standard') then<a name='1094'>
            call <A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_STD'>fwsoil_calc_std</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FWSOIL_CALC_STD_1">( fwsoil, soil, ssoil, veg) <a name='1095'>
         elseif (cable_user%FWSOIL_SWITCH == 'non-linear extrapolation') then<a name='1096'>
            <font color=#447700>!EAK, 09/10 - replace linear approx by polynomial fitting<a name='1097'></font>
            call <A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_NON_LINEAR'>fwsoil_calc_non_linear</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FWSOIL_CALC_NON_LINEAR_1">(fwsoil, soil, ssoil, veg) <a name='1098'>
         elseif(cable_user%FWSOIL_SWITCH == 'Lai and Ktaul 2000') then<a name='1099'>
            call <A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_LAI_KTAUL'>fwsoil_calc_Lai_Ktaul</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="FWSOIL_CALC_LAI_KTAUL_1">(fwsoil, soil, ssoil, veg) <a name='1100'>
         else<a name='1101'>
            STOP 'fwsoil_switch failed.'<a name='1102'>
         endif<a name='1103'>
      endif<a name='1104'>
<a name='1105'>
      <font color=#447700>! weight min stomatal conductance by C3 an C4 plant fractions<a name='1106'></font>
      frac42 = SPREAD(veg%frac4, 2, mf) <font color=#447700>! frac C4 plants<a name='1107'></font>
<a name='1108'>
      gsw_term = gsw03 * (1. - frac42) + gsw04 * frac42<a name='1109'>
      lower_limit2 = rad%scalex * (gsw03 * (1. - frac42) + gsw04 * frac42)<a name='1110'>
      gswmin = max(1.e-6,lower_limit2)<a name='1111'>
            <a name='1112'>
<a name='1113'>
      gw = 1.0e-3 <font color=#447700>! default values of conductance<a name='1114'></font>
      gh = 1.0e-3<a name='1115'>
      ghr= 1.0e-3<a name='1116'>
      rdx = 0.0<a name='1117'>
      anx = 0.0<a name='1118'>
      rnx = SUM(rad%rniso,2)<a name='1119'>
      abs_deltlf = 999.0<a name='1120'>
      <font color=#447700>!jhan:Eva uses<a name='1121'></font>
      <font color=#447700>!jh:canopy%fevc = 0.0<a name='1122'></font>
  <a name='1123'>
  <a name='1124'>
      gras = 1.0e-6<a name='1125'>
      an_y= 0.0<a name='1126'>
      hcx = 0.0              <font color=#447700>! init sens heat iteration memory variable<a name='1127'></font>
      hcy = 0.0<a name='1128'>
      rdy = 0.0<a name='1129'>
      ecx = SUM(rad%rniso,2) <font color=#447700>! init lat heat iteration memory variable<a name='1130'></font>
      tlfxx = tlfx<a name='1131'>
      psycst(:,:) = SPREAD(air%psyc,2,mf)<a name='1132'>
      canopy%fevc = 0.0<a name='1133'>
      ssoil%evapfbl = 0.0<a name='1134'>
  <a name='1135'>
      DO kk=1,mp<a name='1136'>
         IF(canopy%vlaiw(kk) &lt;= LAI_THRESH) THEN<a name='1137'>
            rnx(kk) = 0.0 <font color=#447700>! intialise<a name='1138'></font>
            ecx(kk) = 0.0 <font color=#447700>! intialise<a name='1139'></font>
            ecy(kk) = ecx(kk) <font color=#447700>! store initial values<a name='1140'></font>
            abs_deltlf(kk)=0.0<a name='1141'>
            rny(kk) = rnx(kk) <font color=#447700>! store initial values<a name='1142'></font>
         END IF<a name='1143'>
      ENDDO<a name='1144'>
      deltlfy = abs_deltlf<a name='1145'>
      k = 0<a name='1146'>
<a name='1147'>
      <font color=#447700>!kdcorbin, 08/10 - doing all points all the time<a name='1148'></font>
      DO WHILE (k &lt; maxiter)<a name='1149'>
         k = k + 1<a name='1150'>
<a name='1151'>
         DO i=1,mp<a name='1152'>
            IF (canopy%vlaiw(i) &gt; LAI_THRESH .AND. abs_deltlf(i) &gt; 0.1) Then<a name='1153'>
   <a name='1154'>
               <font color=#447700>! Grashof number (Leuning et al, 1995) eq E4:<a name='1155'></font>
               gras(i) = MAX(1.0e-6, &amp;<a name='1156'>
                   1.595E8*ABS(tlfx(i)-met%tvair(i))*(veg%dleaf(i)**3.0))<a name='1157'>
               <font color=#447700>! See Appendix E in (Leuning et al, 1995):<a name='1158'></font>
               gbhf(i,1) = rad%fvlai(i,1) * air%cmolar(i) * 0.5*dheat &amp;<a name='1159'>
                    *(gras(i)**0.25) / veg%dleaf(i)<a name='1160'>
               gbhf(i,2) = rad%fvlai(i,2) * air%cmolar(i) * 0.5*dheat &amp;<a name='1161'>
                    *(gras(i)**0.25) / veg%dleaf(i)<a name='1162'>
               gbhf(i,:) = max(1.e-6,gbhf(i,:))<a name='1163'>
      <a name='1164'>
               <font color=#447700>! Conductance for heat:<a name='1165'></font>
               gh(i,:) = 2.0 * (gbhu(i,:) + gbhf(i,:))<a name='1166'>
      <a name='1167'>
               <font color=#447700>! Conductance for heat and longwave radiation:<a name='1168'></font>
               ghr(i,:) = rad%gradis(i,:)+gh(i,:)<a name='1169'>
      <a name='1170'>
               <font color=#447700>! Leuning 2002 (P C &amp; E) equation for temperature response<a name='1171'></font>
               <font color=#447700>! used for Vcmax for C3 plants:<a name='1172'></font>
               temp(i) =  <A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3'>xvcmxt3</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XVCMXT3_1">(tlfx(i)) * veg%vcmax(i) * (1.0-veg%frac4(i))<a name='1173'>
                  <font color=#447700>!jhan: here mk3l usess (i,:) {<a name='1174'></font>
               vcmxt3(i,1) = rad%scalex(i,1) * temp(i)<a name='1175'>
               vcmxt3(i,2) = rad%scalex(i,2) * temp(i)<a name='1176'>
    <a name='1177'>
               <font color=#447700>! Temperature response of Vcmax for C4 plants (Collatz et al 1989):<a name='1178'></font>
               temp(i) = <A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4'>xvcmxt4</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XVCMXT4_1">(tlfx(i)-tfrz) * veg%vcmax(i) * veg%frac4(i)<a name='1179'>
               vcmxt4(i,1) = rad%scalex(i,1) * temp(i)<a name='1180'>
               vcmxt4(i,2) = rad%scalex(i,2) * temp(i)<a name='1181'>
    <a name='1182'>
               <font color=#447700>! Leuning 2002 (P C &amp; E) equation for temperature response<a name='1183'></font>
               <font color=#447700>! used for Jmax for C3 plants:<a name='1184'></font>
               temp(i) = <A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3'>xejmxt3</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="XEJMXT3_1">(tlfx(i)) * veg%ejmax(i) * (1.0-veg%frac4(i))<a name='1185'>
               ejmxt3(i,1) = rad%scalex(i,1) * temp(i)<a name='1186'>
               ejmxt3(i,2) = rad%scalex(i,2) * temp(i)<a name='1187'>
               <font color=#447700>!jhan:}  <a name='1188'></font>
               <font color=#447700>! Difference between leaf temperature and reference temperature:<a name='1189'></font>
               tdiff(i) = tlfx(i) - trefk<a name='1190'>
               <font color=#447700>! Michaelis menten constant of Rubisco for CO2:<a name='1191'></font>
               conkct(i) = conkc0 * EXP((ekc/(rgas*trefk)) * (1.0-trefk/tlfx(i)))<a name='1192'>
               <font color=#447700>! Michaelis menten constant of Rubisco for oxygen:<a name='1193'></font>
               conkot(i) = conko0 * EXP((eko/(rgas*trefk)) * (1.0-trefk/tlfx(i)))<a name='1194'>
   <a name='1195'>
               <font color=#447700>! Store leaf temperature<a name='1196'></font>
               tlfxx(i) = tlfx(i)<a name='1197'>
   <a name='1198'>
               <font color=#447700>! "d_{3}" in Wang and Leuning, 1998, appendix E:<a name='1199'></font>
               cx1(i) = conkct(i) * (1.0+0.21/conkot(i))<a name='1200'>
               cx2(i) = 2.0 * gam0 * (1.0 + gam1*tdiff(i) + gam2*tdiff(i)*tdiff(i))<a name='1201'>
    <a name='1202'>
                <font color=#447700>!jhan: here mk3l usess (i,:) {<a name='1203'></font>
               <font color=#447700>! All equations below in appendix E in Wang and Leuning 1998 are<a name='1204'></font>
               <font color=#447700>! for calculating anx, csx and gswx for Rubisco limited,<a name='1205'></font>
               <font color=#447700>! RuBP limited, sink limited<a name='1206'></font>
               temp2(i,1) = rad%qcan(i,1,1) * jtomol * (1.0-veg%frac4(i))<a name='1207'>
               temp2(i,2) = rad%qcan(i,2,1) * jtomol * (1.0-veg%frac4(i))<a name='1208'>
               vx3(i,1)  = <A href='../../html_code/science/cable_canopy.F90.html#EJ3X'>ej3x</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EJ3X_1">(temp2(i,1),ejmxt3(i,1))<a name='1209'>
               vx3(i,2)  = <A href='../../html_code/science/cable_canopy.F90.html#EJ3X'>ej3x</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EJ3X_2">(temp2(i,2),ejmxt3(i,2))<a name='1210'>
    <a name='1211'>
               temp2(i,1) = rad%qcan(i,1,1) * jtomol * veg%frac4(i)<a name='1212'>
               temp2(i,2) = rad%qcan(i,2,1) * jtomol * veg%frac4(i)<a name='1213'>
               vx4(i,1)  = <A href='../../html_code/science/cable_canopy.F90.html#EJ4X'>ej4x</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EJ4X_1">(temp2(i,1),vcmxt4(i,1))<a name='1214'>
               vx4(i,2)  = <A href='../../html_code/science/cable_canopy.F90.html#EJ4X'>ej4x</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="EJ4X_2">(temp2(i,2),vcmxt4(i,2))<a name='1215'>
    <a name='1216'>
               rdx(i,1) = (cfrd3*vcmxt3(i,1) + cfrd4*vcmxt4(i,1))*fwsoil(i)<a name='1217'>
               rdx(i,2) = (cfrd3*vcmxt3(i,2) + cfrd4*vcmxt4(i,2))*fwsoil(i)<a name='1218'>
               <font color=#447700>!jhan:sort out braces here: x/() + y<a name='1219'></font>
               xleuning(i,1) = (fwsoil(i) / (csx(i,1)-co2cp3))  &amp;<a name='1220'>
                         * ((1.0-veg%frac4(i)) * a1c3 / (1.0+dsx(i)/d0c3) &amp;<a name='1221'>
                             + veg%frac4(i)    * a1c4 / (1.0+dsx(i)/d0c4))<a name='1222'>
               xleuning(i,2) = (fwsoil(i) / (csx(i,2)-co2cp3))  &amp;<a name='1223'>
                         * ((1.0-veg%frac4(i)) * a1c3 / (1.0+dsx(i)/d0c3) &amp;<a name='1224'>
                             + veg%frac4(i)    * a1c4 / (1.0+dsx(i)/d0c4))<a name='1225'>
    <a name='1226'>
               <font color=#447700>!jhan:}  <a name='1227'></font>
            ENDIF<a name='1228'>
         ENDDO <font color=#447700>!i=1,mp<a name='1229'></font>
   <a name='1230'>
         call <A href='../../html_code/science/cable_canopy.F90.html#PHOTOSYNTHESIS'>photosynthesis</A><A href='../../html_code/science/cable_canopy.F90.html#DRYLEAF' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHESIS_1">(csx(:,:),SPREAD(cx1(:),2,mf), &amp;<a name='1231'>
                SPREAD(cx2(:),2,mf),gswmin(:,:),rdx(:,:), &amp;<a name='1232'>
                vcmxt3(:,:),vcmxt4(:,:),vx3(:,:),vx4(:,:),xleuning(:,:), &amp;<a name='1233'>
                rad%fvlai(:,:),SPREAD(abs_deltlf,2,mf),anx(:,:))<a name='1234'>
<a name='1235'>
         DO i=1,mp<a name='1236'>
            IF (canopy%vlaiw(i) &gt; LAI_THRESH .AND. abs_deltlf(i) &gt; 0.1) Then<a name='1237'>
               do kk=1,mf<a name='1238'>
                  if(rad%fvlai(i,kk)&gt;LAI_THRESH) then<a name='1239'>
                     csx(i,kk) = met%ca(i) - rgbwc*anx(i,kk) / (gbhu(i,kk) + gbhf(i,kk))<a name='1240'>
                     csx(i,kk) = MAX(1.0e-4,csx(i,kk))<a name='1241'>
<a name='1242'>
                     canopy%gswx(i,kk) = MAX(1.e-3, gswmin(i,kk) +                         &amp;<a name='1243'>
                       MAX(0.0,rgswc*xleuning(i,kk)*anx(i,kk)))<a name='1244'>
<a name='1245'>
                     <font color=#447700>!Recalculate conductance for water:<a name='1246'></font>
                     gw(i,kk) = 1.0/(1.0/canopy%gswx(i,kk)   +  1.0/(1.075*(gbhu(i,kk)+gbhf(i,kk))))<a name='1247'>
                     gw(i,kk) = MAX(gw(i,kk),0.00001)<a name='1248'>
<a name='1249'>
                     <font color=#447700>!Modified psychrometric constant (Monteith and Unsworth, 1990)<a name='1250'></font>
                     psycst(i,kk) = air%psyc(i)*REAL(ghr(i,kk)/gw(i,kk),r_1)<a name='1251'>
                  endif<a name='1252'>
               enddo<a name='1253'>
<a name='1254'>
               ecx(i) = (air%dsatdk(i)*(rad%rniso(i,1) &amp;<a name='1255'>
                     - capp*rmair*(met%tvair(i)-met%tk(i)) &amp;<a name='1256'>
                     * rad%gradis(i,1)) + capp*rmair*met%dva(i)*ghr(i,1)) &amp;<a name='1257'>
                     / (air%dsatdk(i)+psycst(i,1)) &amp;<a name='1258'>
                     + (air%dsatdk(i)*(rad%rniso(i,2) &amp;<a name='1259'>
                     -  capp*rmair*(met%tvair(i)-met%tk(i))*rad%gradis(i,2)) &amp;<a name='1260'>
                     + capp*rmair*met%dva(i)*ghr(i,2)) &amp;<a name='1261'>
                     / (air%dsatdk(i)+psycst(i,2))<a name='1262'>
<a name='1263'>
               IF (ecx(i) &gt; 0.0 .AND. canopy%fwet(i) &lt; 1.0) Then<a name='1264'>
                  evapfb(i) = (1.0-canopy%fwet(i))*REAL(ecx(i),r_1)*dels/air%rlam(i)<a name='1265'>
                  DO kk = 1,ms<a name='1266'>
                     <font color=#447700>!ssoil%evapfbl(i,kk) = MIN(evapfb(i)*veg%froot(i,kk), &amp;<a name='1267'></font>
                     <font color=#447700>!    MAX(0.0,MIN(REAL(ssoil%wb(i,kk),r_1) &amp;<a name='1268'></font>
                     <font color=#447700>!      -soil%swilt(i),REAL(ssoil%wb(i,kk)  &amp;<a name='1269'></font>
                     <font color=#447700>!      -1.05*ssoil%wbice(i,kk),r_1))) &amp;<a name='1270'></font>
                     <font color=#447700>!      * soil%zse(kk)*1000.0)<a name='1271'></font>
                     <font color=#447700>!jhan:Eva uses<a name='1272'></font>
                     ssoil%evapfbl(i,kk) = MIN(evapfb(i)*veg%froot(i,kk), &amp;<a name='1273'>
                         MAX(0.0,REAL(ssoil%wb(i,kk),r_1) - 1.1*soil%swilt(i)) &amp;<a name='1274'>
                           * soil%zse(kk)*1000.0)<a name='1275'>
                  ENDDO<a name='1276'>
<a name='1277'>
                  canopy%fevc(i) = SUM(ssoil%evapfbl(i,:))*air%rlam(i)/dels<a name='1278'>
       <a name='1279'>
                  ecx(i) = canopy%fevc(i) / (1.0-canopy%fwet(i))<a name='1280'>
<a name='1281'>
               ENDIF<a name='1282'>
<a name='1283'>
               <font color=#447700>! Update canopy sensible heat flux:<a name='1284'></font>
               hcx(i) = (SUM(rad%rniso(i,:))-ecx(i) &amp;<a name='1285'>
                  - capp*rmair*(met%tvair(i)-met%tk(i))  &amp;<a name='1286'>
                  * SUM(rad%gradis(i,:)))    &amp;<a name='1287'>
                  * SUM(gh(i,:))/ SUM(ghr(i,:))<a name='1288'>
  <a name='1289'>
               <font color=#447700>! Update leaf temperature:<a name='1290'></font>
               tlfx(i)=met%tvair(i)+REAL(hcx(i),r_1)/(capp*rmair*SUM(gh(i,:)))<a name='1291'>
         <a name='1292'>
               <font color=#447700>! Update net radiation for canopy:<a name='1293'></font>
               rnx(i) = SUM(rad%rniso(i,:)) - &amp;<a name='1294'>
                        capp*rmair*(tlfx(i)-met%tk(i))*  &amp;<a name='1295'>
                        SUM(rad%gradis(i,:))<a name='1296'>
  <a name='1297'>
               <font color=#447700>! Update leaf surface vapour pressure deficit:<a name='1298'></font>
               dsx(i) = met%dva(i) + air%dsatdk(i) * (tlfx(i)-met%tvair(i))<a name='1299'>
  <a name='1300'>
               <font color=#447700>! Store change in leaf temperature between successive iterations:<a name='1301'></font>
               deltlf(i) = tlfxx(i)-tlfx(i)<a name='1302'>
               abs_deltlf(i) = ABS(deltlf(i))<a name='1303'>
  <a name='1304'>
            ENDIF <font color=#447700>!lai/abs_deltlf<a name='1305'></font>
         ENDDO <font color=#447700>!i=1,mp<a name='1306'></font>
<a name='1307'>
         <font color=#447700>! Whhere leaf temp change b/w iterations is significant, and<a name='1308'></font>
         <font color=#447700>! difference is smaller than the previous iteration, store results:<a name='1309'></font>
         <font color=#447700>!jhan:Eva uses instead<a name='1310'></font>
         DO i=1,mp<a name='1311'>
            if (abs_deltlf(i) &lt; ABS(deltlfy(i)) ) then<a name='1312'>
               <font color=#447700>!jh:of WhHERE (abs_deltlf &gt; 0.1 .AND. abs_deltlf &lt; ABS(deltlfy) )<a name='1313'></font>
               deltlfy(i) = deltlf(i)<a name='1314'>
               tlfy(i) = tlfx(i)<a name='1315'>
               rny(i) = rnx(i)<a name='1316'>
               hcy(i) = hcx(i)<a name='1317'>
               ecy(i) = ecx(i)<a name='1318'>
               rdy(i,1) = rdx(i,1)<a name='1319'>
               rdy(i,2) = rdx(i,2)<a name='1320'>
               an_y(i,1) = anx(i,1)<a name='1321'>
               an_y(i,2) = anx(i,2)<a name='1322'>
               <font color=#447700>! save last values calculated for ssoil%evapfbl<a name='1323'></font>
               oldevapfbl(i,1) = ssoil%evapfbl(i,1)<a name='1324'>
               oldevapfbl(i,2) = ssoil%evapfbl(i,2)<a name='1325'>
               oldevapfbl(i,3) = ssoil%evapfbl(i,3)<a name='1326'>
               oldevapfbl(i,4) = ssoil%evapfbl(i,4)<a name='1327'>
               oldevapfbl(i,5) = ssoil%evapfbl(i,5)<a name='1328'>
               oldevapfbl(i,6) = ssoil%evapfbl(i,6)<a name='1329'>
            endif <a name='1330'>
            if(abs_deltlf(i) &gt; 0.1) &amp;<a name='1331'>
               <font color=#447700>! after 4 iterations, take mean value of current &amp; previous estimates<a name='1332'></font>
               <font color=#447700>! as the next estimate of leaf temperature, to avoid oscillation<a name='1333'></font>
               tlfx(i) = (0.5*(MAX(0,k-5)/(k-4.9999))) *tlfxx(i) + &amp;<a name='1334'>
                     (1.0- (0.5*(MAX(0,k-5)/(k-4.9999))))*tlfx(i)<a name='1335'>
        <a name='1336'>
            IF(k==1) THEN<a name='1337'>
               <font color=#447700>! take the first iterated estimates as the defaults<a name='1338'></font>
               tlfy(i) = tlfx(i)<a name='1339'>
               rny(i) = rnx(i)<a name='1340'>
               hcy(i) = hcx(i)<a name='1341'>
               ecy(i) = ecx(i)<a name='1342'>
               rdy(i,:) = rdx(i,:)<a name='1343'>
               an_y(i,:) = anx(i,:)<a name='1344'>
               <font color=#447700>! save last values calculated for ssoil%evapfbl<a name='1345'></font>
               oldevapfbl(i,:) = ssoil%evapfbl(i,:)<a name='1346'>
            END IF<a name='1347'>
         END DO <font color=#447700>!over mp <a name='1348'></font>
<a name='1349'>
<a name='1350'>
      END DO  <font color=#447700>! DO WHILE (ANY(abs_deltlf &gt; 0.1) .AND.  k &lt; maxiter)<a name='1351'></font>
<a name='1352'>
      <font color=#447700>! dry canopy flux<a name='1353'></font>
      canopy%fevc = (1.0-canopy%fwet) * ecy<a name='1354'>
      <font color=#447700>! Recalculate ssoil%evapfbl as ecy may not be updated with the ecx<a name='1355'></font>
      <font color=#447700>! calculated in the last iteration.<a name='1356'></font>
      <font color=#447700>! DO NOT use simple scaling as there are times that ssoil%evapfbl is zero.<a name='1357'></font>
      <font color=#447700>! ** ssoil%evapfbl(i,:) = ssoil%evapfbl(i,:) * ecy(i) / ecx(i) **<a name='1358'></font>
      DO i = 1, mp<a name='1359'>
         IF (ecy(i) &gt; 0.0 .AND. canopy%fwet(i) &lt; 1.0) THEN<a name='1360'>
            IF (ABS(ecy(i)-ecx(i)) &gt; 1.0e-6 ) THEN<a name='1361'>
               IF (ABS(canopy%fevc(i) - (SUM(oldevapfbl(i,:))*air%rlam(i)/dels)) &amp;<a name='1362'>
                     &gt; 1.0e-4 ) THEN<a name='1363'>
                  PRINT *, 'Error<font color=#447700>! oldevapfbl not right.', ktau_gl, i<a name='1364'></font>
                  PRINT *, 'ecx, ecy = ', ecx(i), ecy(i)<a name='1365'>
                  PRINT *, 'or in mm = ',ecx(i)*(1.0-canopy%fwet(i))/air%rlam(i)*dels, &amp;<a name='1366'>
                                         ecy(i)*(1.0-canopy%fwet(i))/air%rlam(i)*dels<a name='1367'>
                  PRINT *,'fevc = ',canopy%fevc(i),SUM(oldevapfbl(i,:))*air%rlam(i)/dels<a name='1368'>
                  PRINT *, 'fwet = ', canopy%fwet(i)<a name='1369'>
                  PRINT *, 'oldevapfbl = ', oldevapfbl(i,:)<a name='1370'>
                  PRINT *, 'ssoil%evapfbl before rescaling: ', ssoil%evapfbl(i,:)<a name='1371'>
                  STOP<a name='1372'>
               ELSE<a name='1373'>
                  ssoil%evapfbl(i,:) = oldevapfbl(i,:)<a name='1374'>
               END IF<a name='1375'>
            END IF<a name='1376'>
         END IF<a name='1377'>
      END DO<a name='1378'>
<a name='1379'>
      canopy%frday = 12.0 * SUM(rdy, 2)<a name='1380'>
      canopy%fpn = -12.0 * SUM(an_y, 2)<a name='1381'>
      canopy%evapfbl = ssoil%evapfbl<a name='1382'>
<a name='1383'>
      return<a name='1384'>
   END SUBROUTINE dryLeaf<a name='1385'>
<a name='1386'>
<A NAME='PHOTOSYNTHESIS'><A href='../../html_code/science/cable_canopy.F90.html#PHOTOSYNTHESIS' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1387'>
  <font color=#993300>SUBROUTINE </font><font color=#cc0000>photosynthesis</font>(csxz,cx1z,cx2z,gswminz,rdxz,vcmxt3z,vcmxt4z, &amp; <A href='../../call_to/PHOTOSYNTHESIS.html' TARGET='index'>1</A>,<A href='../../call_from/PHOTOSYNTHESIS.html' TARGET='index'>3</A><a name='1388'>
                    vx3z,vx4z,xleuningz,vlaiz,deltlfz,anxz)<a name='1389'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#PHOTOSYNTHESIS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_15"><a name='1390'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#PHOTOSYNTHESIS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_5">, only : LAI_THRESH<a name='1391'>
      <font color=#447700>!use math_constants<a name='1392'></font>
      <font color=#447700>!use physical_constants<a name='1393'></font>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#PHOTOSYNTHESIS' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_3">, only : rgswc<a name='1394'>
      implicit none<a name='1395'>
    <font color=#447700>! inputs:<a name='1396'></font>
    REAL(r_2), DIMENSION(mp,mf), INTENT(IN) :: csxz<a name='1397'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: cx1z<a name='1398'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: cx2z<a name='1399'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: gswminz<a name='1400'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: rdxz<a name='1401'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: vcmxt3z<a name='1402'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: vcmxt4z<a name='1403'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: vx4z<a name='1404'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: vx3z<a name='1405'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: xleuningz<a name='1406'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: vlaiz<a name='1407'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(IN) :: deltlfz<a name='1408'>
    REAL(r_1), DIMENSION(mp,mf), INTENT(INOUT) :: anxz<a name='1409'>
    <font color=#447700>!local variables<a name='1410'></font>
    REAL(r_2), DIMENSION(mp,mf) :: coef0z,coef1z,coef2z<a name='1411'>
    REAL(r_2), DIMENSION(mp,mf) :: ciz,delcxz<a name='1412'>
    REAL(r_2), DIMENSION(mp,mf) :: anrubiscoz,anrubpz,ansinkz<a name='1413'>
    REAL(r_1), PARAMETER  :: effc4 = 4000.0  <font color=#447700>! Vc=effc4*Ci*Vcmax (see<a name='1414'></font>
                                             <font color=#447700>! Bonan,LSM version 1.0, p106)<a name='1415'></font>
    INTEGER :: i,j   <font color=#447700>!kdcorbin, 09/10<a name='1416'></font>
<a name='1417'>
    <font color=#447700>! rgswc - inherited from canopy_module's USE photosynthetic_constants<a name='1418'></font>
    <font color=#447700>! mp - inherited from canopy_module<a name='1419'></font>
    <font color=#447700>! mf - inherited from canopy_module<a name='1420'></font>
   <a name='1421'>
   DO i=1,mp<a name='1422'>
      IF (sum(vlaiz(i,:)) .gt. LAI_THRESH) Then<a name='1423'>
      DO j=1,mf<a name='1424'>
         IF (vlaiz(i,j) .gt. LAI_THRESH .AND. deltlfz(i,j) .gt. 0.1) Then<a name='1425'>
<a name='1426'>
   <font color=#447700>! Rubisco limited:<a name='1427'></font>
     coef2z(i,j) = gswminz(i,j)/rgswc+xleuningz(i,j) * &amp;<a name='1428'>
                   (vcmxt3z(i,j)-(rdxz(i,j)-vcmxt4z(i,j)))<a name='1429'>
     coef1z(i,j) = (1.0-csxz(i,j)*xleuningz(i,j)) * &amp;<a name='1430'>
                   (vcmxt3z(i,j)+vcmxt4z(i,j)-rdxz(i,j)) &amp;<a name='1431'>
                   + (gswminz(i,j)/rgswc)*(cx1z(i,j)-csxz(i,j)) &amp;<a name='1432'>
                   - xleuningz(i,j)*(vcmxt3z(i,j)*cx2z(i,j)/2.0 &amp;<a name='1433'>
                   + cx1z(i,j)*(rdxz(i,j)-vcmxt4z(i,j)))<a name='1434'>
     coef0z(i,j) = -(1.0-csxz(i,j)*xleuningz(i,j)) * &amp;<a name='1435'>
                    (vcmxt3z(i,j)*cx2z(i,j)/2.0  &amp;<a name='1436'>
                   + cx1z(i,j)*(rdxz(i,j)-vcmxt4z(i,j))) &amp;<a name='1437'>
                   -(gswminz(i,j)/rgswc)*cx1z(i,j)*csxz(i,j)<a name='1438'>
<a name='1439'>
     <font color=#447700>!kdcorbin,09/10 - new calculations<a name='1440'></font>
     IF (ABS(coef2z(i,j)) .gt. 1.0e-9 .AND. &amp;<a name='1441'>
           ABS(coef1z(i,j)) .lt. 1.0e-9) Then<a name='1442'>
       <font color=#447700>! no solution, give it a huge number<a name='1443'></font>
       ciz(i,j) = 99999.0 <font color=#447700>! quadratic below cannot handle zero denominator<a name='1444'></font>
       anrubiscoz(i,j) = 99999.0    <font color=#447700>!should ciz=0 and anrubiscoz calculated?<a name='1445'></font>
     ENDIF<a name='1446'>
<a name='1447'>
     <font color=#447700>! solve linearly<a name='1448'></font>
     IF (ABS(coef2z(i,j)) &lt; 1.e-9 .AND. ABS(coef1z(i,j)) &gt;= 1e-9) Then<a name='1449'>
       ciz(i,j) = -1.0 * coef0z(i,j) / coef1z(i,j)   <font color=#447700>! same reason as above<a name='1450'></font>
       ciz(i,j)    = MAX(0.0_r_2,ciz(i,j))<a name='1451'>
       anrubiscoz(i,j) = vcmxt3z(i,j)*(ciz(i,j)-cx2z(i,j)/2.0) / &amp;<a name='1452'>
                         (ciz(i,j) + cx1z(i,j)) + vcmxt4z(i,j) - rdxz(i,j)<a name='1453'>
     ENDIF<a name='1454'>
<a name='1455'>
     <font color=#447700>! solve quadratic (only take the more positive solution)<a name='1456'></font>
     IF (ABS(coef2z(i,j)) &gt;= 1.e-9) Then<a name='1457'>
       delcxz(i,j) = coef1z(i,j)**2 -4.0*coef0z(i,j)*coef2z(i,j)<a name='1458'>
       ciz(i,j) = (-coef1z(i,j)+SQRT(MAX(0.0_r_2,delcxz(i,j)))) &amp;<a name='1459'>
                      /(2.0*coef2z(i,j))<a name='1460'>
       ciz(i,j) = MAX(0.0_r_2,ciz(i,j))   <font color=#447700>! must be positive, why?<a name='1461'></font>
       anrubiscoz(i,j) = vcmxt3z(i,j)*(ciz(i,j)-cx2z(i,j)/2.0) / &amp;<a name='1462'>
              (ciz(i,j) + cx1z(i,j)) + vcmxt4z(i,j) - rdxz(i,j)<a name='1463'>
     ENDIF<a name='1464'>
<a name='1465'>
   <font color=#447700>! RuBP limited:<a name='1466'></font>
     coef2z(i,j) = gswminz(i,j)/rgswc+xleuningz(i,j) &amp;<a name='1467'>
                    *(vx3z(i,j)-(rdxz(i,j)-vx4z(i,j)))<a name='1468'>
     coef1z(i,j) = (1.0-csxz(i,j)*xleuningz(i,j)) * &amp;<a name='1469'>
                   (vx3z(i,j)+vx4z(i,j)-rdxz(i,j))    &amp;<a name='1470'>
                   + (gswminz(i,j)/rgswc)* &amp;<a name='1471'>
                     (cx2z(i,j)-csxz(i,j))-xleuningz(i,j)  &amp;<a name='1472'>
                   *(vx3z(i,j)*cx2z(i,j)/2.0 + cx2z(i,j)* &amp;<a name='1473'>
                     (rdxz(i,j)-vx4z(i,j)))<a name='1474'>
     coef0z(i,j) = -(1.0-csxz(i,j)*xleuningz(i,j)) * &amp;<a name='1475'>
                     (vx3z(i,j)*cx2z(i,j)/2.0  &amp;<a name='1476'>
                   + cx2z(i,j)*(rdxz(i,j)-vx4z(i,j))) &amp;<a name='1477'>
                   -(gswminz(i,j)/rgswc)*cx2z(i,j)*csxz(i,j)<a name='1478'>
<a name='1479'>
     <font color=#447700>!kdcorbin, 09/10 - new calculations<a name='1480'></font>
     <font color=#447700>! no solution, give it a huge number<a name='1481'></font>
     IF (ABS(coef2z(i,j)) &lt; 1.0e-9 .AND. ABS(coef1z(i,j)) &lt; 1.0e-9) Then<a name='1482'>
       ciz(i,j) = 99999.0<a name='1483'>
       anrubpz(i,j)  = 99999.0<a name='1484'>
     ENDIF<a name='1485'>
     <font color=#447700>! solve linearly<a name='1486'></font>
     IF (ABS(coef2z(i,j)) &lt; 1.e-9 .AND. ABS(coef1z(i,j)) &gt;= 1.e-9) Then<a name='1487'>
        ciz(i,j) = -1.0 * coef0z(i,j) / coef1z(i,j)<a name='1488'>
        ciz(i,j) = MAX(0.0_r_2,ciz(i,j))<a name='1489'>
        anrubpz(i,j) = vx3z(i,j)*(ciz(i,j)-cx2z(i,j)/2.0) / &amp;<a name='1490'>
                (ciz(i,j)+cx2z(i,j)) +vx4z(i,j)-rdxz(i,j)<a name='1491'>
     ENDIF<a name='1492'>
     <font color=#447700>! solve quadratic (only take the more positive solution)<a name='1493'></font>
     IF (ABS(coef2z(i,j)) &gt;= 1.e-9) Then<a name='1494'>
         delcxz(i,j) = coef1z(i,j)**2 -4.0*coef0z(i,j)*coef2z(i,j)<a name='1495'>
         ciz(i,j) = (-coef1z(i,j)+SQRT(MAX(0.0_r_2,delcxz(i,j)))) &amp;<a name='1496'>
                      /(2.0*coef2z(i,j))<a name='1497'>
         ciz(i,j) = MAX(0.0_r_2,ciz(i,j)) <a name='1498'>
         anrubpz(i,j)  = vx3z(i,j)*(ciz(i,j)-cx2z(i,j)/2.0) / &amp;<a name='1499'>
               (ciz(i,j)+cx2z(i,j)) +vx4z(i,j)-rdxz(i,j)<a name='1500'>
     ENDIF<a name='1501'>
       <a name='1502'>
   <font color=#447700>! Sink limited:<a name='1503'></font>
     coef2z(i,j) = xleuningz(i,j)<a name='1504'>
     coef1z(i,j) = gswminz(i,j)/rgswc + xleuningz(i,j) &amp;<a name='1505'>
                     * (rdxz(i,j) - 0.5*vcmxt3z(i,j))  &amp;<a name='1506'>
                     + effc4 * vcmxt4z(i,j) - xleuningz(i,j) &amp;<a name='1507'>
                     * csxz(i,j) * effc4 * vcmxt4z(i,j)<a name='1508'>
     coef0z(i,j) = -(gswminz(i,j)/rgswc)*csxz(i,j)*effc4*vcmxt4z(i,j) + &amp;<a name='1509'>
                    (rdxz(i,j) -0.5*vcmxt3z(i,j))*gswminz(i,j)/rgswc<a name='1510'>
<a name='1511'>
     <font color=#447700>! no solution, give it a huge number<a name='1512'></font>
     IF (ABS(coef2z(i,j)) &lt; 1.0e-9 .AND. ABS(coef1z(i,j)) &lt; 1.0e-9) Then<a name='1513'>
       ciz(i,j) = 99999.0<a name='1514'>
       ansinkz(i,j)  = 99999.0<a name='1515'>
     ENDIF<a name='1516'>
<a name='1517'>
     <font color=#447700>! solve linearly<a name='1518'></font>
     IF (ABS(coef2z(i,j)) &lt; 1.e-9 .AND. ABS(coef1z(i,j)) &gt;= 1.e-9) Then<a name='1519'>
        ciz(i,j) = -1.0 * coef0z(i,j) / coef1z(i,j)<a name='1520'>
        ansinkz(i,j)  = ciz(i,j)<a name='1521'>
     ENDIF<a name='1522'>
     <font color=#447700>! solve quadratic (only take the more positive solution)<a name='1523'></font>
     IF (ABS(coef2z(i,j)) &gt;= 1.e-9) Then<a name='1524'>
        delcxz(i,j) = coef1z(i,j)**2 -4.0*coef0z(i,j)*coef2z(i,j)<a name='1525'>
        ciz(i,j) = (-coef1z(i,j)+SQRT(MAX(0.0_r_2,delcxz(i,j)))) &amp;<a name='1526'>
                     /(2.0*coef2z(i,j))<a name='1527'>
        ansinkz(i,j) = ciz(i,j)<a name='1528'>
     ENDIF<a name='1529'>
       <a name='1530'>
   <font color=#447700>! minimal of three limited rates<a name='1531'></font>
     anxz(i,j) = MIN(anrubiscoz(i,j),anrubpz(i,j),ansinkz(i,j))<a name='1532'>
     ENDIF<a name='1533'>
    ENDDO<a name='1534'>
    ENDIF<a name='1535'>
   ENDDO<a name='1536'>
     <a name='1537'>
  END SUBROUTINE photosynthesis<a name='1538'>
    <font color=#447700>!---------------------------------------------------------<a name='1539'></font>
<a name='1540'>
<a name='1541'>
<a name='1542'>
<A NAME='EJ3X'><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1543'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>ej3x</font>(parx,x) result(z) <A href='../../call_to/EJ3X.html' TARGET='index'>2</A>,<A href='../../call_from/EJ3X.html' TARGET='index'>5</A><a name='1544'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_16"><a name='1545'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_6"><a name='1546'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_3"><a name='1547'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_6"><a name='1548'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ3X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_4"><font color=#447700>!, only : gsw03<a name='1549'></font>
      REAL(r_1), INTENT(IN)     :: parx<a name='1550'>
      REAL(r_1), INTENT(IN)     :: x<a name='1551'>
      REAL(r_1)                 :: z<a name='1552'>
      z = max(0.0, &amp;<a name='1553'>
           0.25*((alpha3*parx+x-sqrt((alpha3*parx+x)**2 - &amp;<a name='1554'>
           4.0*convx3*alpha3*parx*x)) /(2.0*convx3)) )<a name='1555'>
    END FUNCTION ej3x<a name='1556'>
    <font color=#447700>!---------------------------------------------------------<a name='1557'></font>
<A NAME='EJ4X'><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1558'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>ej4x</font>(parx,x) result(z) <A href='../../call_to/EJ4X.html' TARGET='index'>2</A>,<A href='../../call_from/EJ4X.html' TARGET='index'>5</A><a name='1559'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_17"><a name='1560'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_7"><a name='1561'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_4"><a name='1562'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_7"><a name='1563'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#EJ4X' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_5"><font color=#447700>!, only : gsw03<a name='1564'></font>
      REAL(r_1), INTENT(IN)     :: parx<a name='1565'>
      REAL(r_1), INTENT(IN)     :: x<a name='1566'>
      REAL(r_1)                 :: z<a name='1567'>
      z = max(0.0, &amp;<a name='1568'>
           (alpha4*parx+x-sqrt((alpha4*parx+x)**2 - &amp;<a name='1569'>
           4.0*convx4*alpha4*parx*x))/(2.0*convx4))<a name='1570'>
    END FUNCTION ej4x<a name='1571'>
    <font color=#447700>!---------------------------------------------------------<a name='1572'></font>
    <font color=#447700>! Explicit array dimensions as temporary work around for NEC inlining problem<a name='1573'></font>
<A NAME='XVCMXT4'><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1574'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>xvcmxt4</font>(x) result(z) <A href='../../call_to/XVCMXT4.html' TARGET='index'>1</A>,<A href='../../call_from/XVCMXT4.html' TARGET='index'>5</A><a name='1575'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_18"><a name='1576'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_8"><a name='1577'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_5"><a name='1578'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_8"><a name='1579'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT4' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_6"><font color=#447700>!, only : gsw03<a name='1580'></font>
      REAL(r_1), PARAMETER      :: q10c4 = 2.0<a name='1581'>
<a name='1582'>
      <font color=#447700>! modifying input to single real - kdcorbin, 09/10<a name='1583'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp), INTENT(IN)   :: x<a name='1584'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp)                  :: z<a name='1585'></font>
      REAL(r_1), INTENT(IN) :: x<a name='1586'>
      REAL(r_1) :: z<a name='1587'>
<a name='1588'>
      z = q10c4 ** (0.1 * x - 2.5) / &amp;<a name='1589'>
           ((1.0 + exp(0.3 * (13.0 - x))) * (1.0 + exp(0.3 * (x - 36.0))))<a name='1590'>
    END FUNCTION xvcmxt4<a name='1591'>
    <font color=#447700>!---------------------------------------------------------<a name='1592'></font>
<A NAME='XVCMXT3'><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1593'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>xvcmxt3</font>(x) result(z) <A href='../../call_to/XVCMXT3.html' TARGET='index'>1</A>,<A href='../../call_from/XVCMXT3.html' TARGET='index'>5</A><a name='1594'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_19"><a name='1595'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_9"><a name='1596'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_6"><a name='1597'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_9"><a name='1598'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XVCMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_7"><font color=#447700>!, only : gsw03<a name='1599'></font>
      <font color=#447700>!  leuning 2002 (p c &amp; e) equation for temperature response<a name='1600'></font>
      <font color=#447700>!  used for vcmax for c3 plants<a name='1601'></font>
<a name='1602'>
      <font color=#447700>! modifying input to single real - kdcorbin, 09/10<a name='1603'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp), INTENT(IN)   :: x<a name='1604'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp)               :: xvcnum<a name='1605'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp)               :: xvcden<a name='1606'></font>
      <font color=#447700>!REAL(r_1), DIMENSION(mp)               :: z<a name='1607'></font>
<a name='1608'>
      REAL(r_1), INTENT(IN) :: x<a name='1609'>
      REAL(r_1) :: xvcnum,xvcden,z<a name='1610'>
<a name='1611'>
      REAL(r_1), PARAMETER  :: EHaVc  = 73637.0  <font color=#447700>! J/mol (Leuning 2002)<a name='1612'></font>
      REAL(r_1), PARAMETER  :: EHdVc  = 149252.0 <font color=#447700>! J/mol (Leuning 2002)<a name='1613'></font>
      REAL(r_1), PARAMETER  :: EntropVc = 486.0  <font color=#447700>! J/mol/K (Leuning 2002)<a name='1614'></font>
      REAL(r_1), PARAMETER  :: xVccoef = 1.17461 <font color=#447700>! derived parameter<a name='1615'></font>
                        <font color=#447700>! xVccoef=1.0+exp((EntropJx*TrefK-EHdJx)/(Rconst*TrefK))<a name='1616'></font>
<a name='1617'>
      xvcnum=xvccoef*exp((ehavc/(rgas*trefk))*(1.-trefk/x))<a name='1618'>
      xvcden=1.0+exp((entropvc*x-ehdvc)/(rgas*x))<a name='1619'>
      z = max(0.0,xvcnum/xvcden)<a name='1620'>
    END FUNCTION xvcmxt3<a name='1621'>
    <font color=#447700>!---------------------------------------------------------<a name='1622'></font>
<A NAME='XEJMXT3'><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='top_target'><IMG SRC="../../gif/bar_green.gif" border=0></A><a name='1623'>
    <font color=#993300>FUNCTION </font><font color=#cc0000>xejmxt3</font>(x) result(z) <A href='../../call_to/XEJMXT3.html' TARGET='index'>1</A>,<A href='../../call_from/XEJMXT3.html' TARGET='index'>5</A><a name='1624'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_20"><a name='1625'>
      use <A href='../../html_code/common/cable_other_constants.F90.html#OTHER_CONSTANTS'>other_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="OTHER_CONSTANTS_10"><a name='1626'>
      use <A href='../../html_code/common/cable_math_constants.F90.html#MATH_CONSTANTS'>math_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="MATH_CONSTANTS_7"><a name='1627'>
      use <A href='../../html_code/common/cable_physical_constants.F90.html#PHYSICAL_CONSTANTS'>physical_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHYSICAL_CONSTANTS_10"><a name='1628'>
      use <A href='../../html_code/common/cable_photosynthetic_constants.F90.html#PHOTOSYNTHETIC_CONSTANTS'>photosynthetic_constants</A><A href='../../html_code/science/cable_canopy.F90.html#XEJMXT3' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="PHOTOSYNTHETIC_CONSTANTS_8"><font color=#447700>!, only : gsw03<a name='1629'></font>
      <font color=#447700>!  leuning 2002 (p c &amp; e) equation for temperature response<a name='1630'></font>
      <font color=#447700>!  used for jmax for c3 plants<a name='1631'></font>
<a name='1632'>
      REAL(r_1), INTENT(IN) :: x<a name='1633'>
      REAL(r_1) :: xjxnum,xjxden,z   <a name='1634'>
<a name='1635'>
      REAL(r_1), PARAMETER  :: EHaJx  = 50300.0  <font color=#447700>! J/mol (Leuning 2002)<a name='1636'></font>
      REAL(r_1), PARAMETER  :: EHdJx  = 152044.0 <font color=#447700>! J/mol (Leuning 2002)<a name='1637'></font>
      REAL(r_1), PARAMETER  :: EntropJx = 495.0  <font color=#447700>! J/mol/K (Leuning 2002)<a name='1638'></font>
      REAL(r_1), PARAMETER  :: xjxcoef = 1.16715 <font color=#447700>! derived parameter<a name='1639'></font>
<a name='1640'>
      xjxnum=xjxcoef*exp((ehajx/(rgas*trefk))*(1.-trefk/x))<a name='1641'>
      xjxden=1.0+exp((entropjx*x-ehdjx)/(rgas*x))<a name='1642'>
      z = max(0.0, xjxnum/xjxden)<a name='1643'>
    END FUNCTION xejmxt3<a name='1644'>
    <font color=#447700>!---------------------------------------------------------<a name='1645'></font>
<a name='1646'>
<A NAME='FWSOIL_CALC_STD'><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_STD' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1647'>
      <font color=#993300>subroutine </font><font color=#cc0000>fwsoil_calc_std</font>(fwsoil, soil, ssoil, veg)  <A href='../../call_to/FWSOIL_CALC_STD.html' TARGET='index'>1</A>,<A href='../../call_from/FWSOIL_CALC_STD.html' TARGET='index'>2</A><a name='1648'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_STD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_8"><a name='1649'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_STD' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_21"><a name='1650'>
         implicit none<a name='1651'>
      type (soil_snow_type), intent(inout):: ssoil<a name='1652'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='1653'>
      type (veg_parameter_type), intent(inout)    :: veg<a name='1654'>
         real(r_1), intent(out), dimension(:):: fwsoil <font color=#447700>! soil water modifier of stom. cond<a name='1655'></font>
         REAL(r_1), DIMENSION(mp) :: rwater <font color=#447700>! soil water availability<a name='1656'></font>
<a name='1657'>
         rwater = MAX(1.0e-4_r_2, &amp;<a name='1658'>
              SUM(veg%froot * MAX(0.024,MIN(1.0_r_2,ssoil%wb - &amp;<a name='1659'>
                   SPREAD(soil%swilt, 2, ms))),2) /(soil%sfc-soil%swilt))<a name='1660'>
        <a name='1661'>
            fwsoil = MAX(1.0e-4,MIN(1.0, veg%vbeta * rwater))<a name='1662'>
            <a name='1663'>
         return   <a name='1664'>
      end subroutine fwsoil_calc_std <a name='1665'>
<a name='1666'>
<a name='1667'>
<A NAME='FWSOIL_CALC_NON_LINEAR'><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_NON_LINEAR' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1668'>
      <font color=#993300>subroutine </font><font color=#cc0000>fwsoil_calc_non_linear</font>(fwsoil, soil, ssoil, veg)  <A href='../../call_to/FWSOIL_CALC_NON_LINEAR.html' TARGET='index'>1</A>,<A href='../../call_from/FWSOIL_CALC_NON_LINEAR.html' TARGET='index'>2</A><a name='1669'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_NON_LINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_9"><a name='1670'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_NON_LINEAR' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_22"><a name='1671'>
         implicit none<a name='1672'>
      type (soil_snow_type), intent(inout):: ssoil<a name='1673'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='1674'>
      type (veg_parameter_type), intent(inout)    :: veg<a name='1675'>
         real(r_1), intent(out), dimension(:):: fwsoil <font color=#447700>! soil water modifier of stom. cond<a name='1676'></font>
         REAL(r_1), DIMENSION(mp) :: rwater <font color=#447700>! soil water availability<a name='1677'></font>
         REAL(r_1), DIMENSION(mp,3)          :: xi, ti, si<a name='1678'>
      integer :: j<a name='1679'>
 <a name='1680'>
         rwater = MAX(1.0e-4_r_2, &amp;<a name='1681'>
              SUM(veg%froot * MAX(0.024,MIN(1.0_r_2,ssoil%wb - &amp;<a name='1682'>
                   SPREAD(soil%swilt, 2, ms))),2) /(soil%sfc-soil%swilt))<a name='1683'>
         fwsoil = 1.<a name='1684'>
<a name='1685'>
         rwater = soil%swilt + rwater * (soil%sfc-soil%swilt)<a name='1686'>
         xi(:,1) = soil%swilt<a name='1687'>
         xi(:,2) = soil%swilt + (soil%sfc - soil%swilt)/2.0<a name='1688'>
         xi(:,3) = soil%sfc<a name='1689'>
         ti(:,1) = 0.<a name='1690'>
         ti(:,2) = 0.9<a name='1691'>
         ti(:,3) = 1.0<a name='1692'>
         si(:,1) = (rwater - xi(:,2)) / ( xi(:,1) - xi(:,2)) *  &amp;<a name='1693'>
                   (rwater - xi(:,3)) / ( xi(:,1) - xi(:,3))<a name='1694'>
         si(:,2) = (rwater - xi(:,1)) / ( xi(:,2) - xi(:,1)) *  &amp;<a name='1695'>
                   (rwater - xi(:,3)) / ( xi(:,2) - xi(:,3))<a name='1696'>
         si(:,3) = (rwater - xi(:,1)) / ( xi(:,3) - xi(:,1)) *  &amp;<a name='1697'>
                   (rwater - xi(:,2)) / ( xi(:,3) - xi(:,2))<a name='1698'>
         do j=1,mp<a name='1699'>
            if (rwater(j) &lt; soil%sfc(j) - 0.02) &amp;<a name='1700'>
               fwsoil(j) = max(0.,min(1., ti(j,1)*si(j,1) + &amp;<a name='1701'>
                             ti(j,2)*si(j,2) + ti(j,3)*si(j,3)))<a name='1702'>
         enddo<a name='1703'>
<a name='1704'>
         return   <a name='1705'>
      end subroutine fwsoil_calc_non_linear <a name='1706'>
<a name='1707'>
<a name='1708'>
      <font color=#447700>! ypw 19/may/2010 soil water uptake efficiency (see Lai and Ktaul 2000)<a name='1709'></font>
<A NAME='FWSOIL_CALC_LAI_KTAUL'><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_LAI_KTAUL' TARGET='top_target'><IMG SRC="../../gif/bar_red.gif" border=0></A><a name='1710'>
      <font color=#993300>subroutine </font><font color=#cc0000>fwsoil_calc_Lai_Ktaul</font>(fwsoil, soil, ssoil, veg)  <A href='../../call_to/FWSOIL_CALC_LAI_KTAUL.html' TARGET='index'>1</A>,<A href='../../call_from/FWSOIL_CALC_LAI_KTAUL.html' TARGET='index'>2</A><a name='1711'>
      use <A href='../../html_code/common/cable_define_types.F90.html#DEFINE_TYPES'>define_types</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_LAI_KTAUL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_TYPES_10"><a name='1712'>
      use <A href='../../html_code/common/cable_define_dimensions.F90.html#DEFINE_DIMENSIONS'>define_dimensions</A><A href='../../html_code/science/cable_canopy.F90.html#FWSOIL_CALC_LAI_KTAUL' TARGET='bottom_target'><IMG SRC="../../gif/cyan.gif" border=0></a><A NAME="DEFINE_DIMENSIONS_23"><a name='1713'>
         implicit none<a name='1714'>
      type (soil_snow_type), intent(inout):: ssoil<a name='1715'>
      type (soil_parameter_type), intent(inout)   :: soil<a name='1716'>
      type (veg_parameter_type), intent(inout)    :: veg<a name='1717'>
         real(r_1), intent(out), dimension(:):: fwsoil <font color=#447700>! soil water modifier of stom. cond<a name='1718'></font>
         REAL(r_1), DIMENSION(mp) :: rwater <font color=#447700>! soil water availability<a name='1719'></font>
         INTEGER(i_d)   :: ns<a name='1720'>
         REAL(r_1), parameter ::rootgamma = 0.01   <font color=#447700>! (19may2010)<a name='1721'></font>
         REAL(r_1), DIMENSION(mp)  :: dummy, normFac<a name='1722'>
         <font color=#447700>!--- local level dependent rwater <a name='1723'></font>
         REAL(r_1), DIMENSION(mp,ms)  :: frwater<a name='1724'>
    <a name='1725'>
            fwsoil(:) = 1.0e-4<a name='1726'>
            normFac(:) = 0.0<a name='1727'>
            do ns=1,ms<a name='1728'>
               dummy(:) = rootgamma/max(1.0e-3,ssoil%wb(:,ns)-soil%swilt(:))<a name='1729'>
               frwater(:,ns) =MAX(1.0e-4,((ssoil%wb(:,ns)-soil%swilt(:))/soil%ssat(:)) &amp;<a name='1730'>
                     ** dummy)<a name='1731'>
               fwsoil(:) = min(1.0,max(fwsoil(:),frwater(:,ns)))<a name='1732'>
               normFac(:) = normFac(:) + frwater(:,ns) * veg%froot(:,ns)<a name='1733'>
             enddo<a name='1734'>
         return<a name='1735'>
      end subroutine fwsoil_calc_Lai_Ktaul<a name='1736'>
<a name='1737'>
<a name='1738'>
<a name='1739'>
<a name='1740'>
<a name='1741'>
<a name='1742'>
<a name='1743'>
<a name='1744'>
END MODULE canopy_module<a name='1745'>
</pre></body></html>